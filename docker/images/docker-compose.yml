version: '3.8'

services:
  postgres:
    image: postgres:16.10-alpine
    restart: always
    environment:
      - POSTGRES_DB=n8n
      - POSTGRES_USER=n8n
      - POSTGRES_PASSWORD=n8n
    volumes:
      - ./postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7.4-alpine
    restart: always
    volumes:
      - ./redis_data:/data

  n8n-main:
    image: n8nio/n8n:local
    restart: always
    depends_on:
      - postgres
      - redis
    ports:
      - "5678:5678"
      - "5679:5679"  # 任务代理端口
    environment:
      # 数据库
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=n8n

      # runners 配置
      # 启用任务运行器功能
      - N8N_RUNNERS_ENABLED=true
      # 设置运行器模式为外部模式
      - N8N_RUNNERS_MODE=external
      # 任务代理监听地址
      - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0
      # 运行器认证令牌，用于安全连接
      - N8N_RUNNERS_AUTH_TOKEN=your-secret-token

      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - GENERIC_TIMEZONE=Asia/Shanghai
      - N8N_DEFAULT_LOCALE=zh-CN
    volumes:
      - ./n8n_data:/home/node/.n8n

  n8n-runners:
    image: n8nio/n8n-runners:local
    restart: always
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n-main:5679
      - N8N_RUNNERS_AUTH_TOKEN=your-secret-token
    depends_on:
      - n8n-main

volumes:
  n8n_data:
  postgres_data:
  redis_data:
