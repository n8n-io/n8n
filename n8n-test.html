<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>n8n å¤–éƒ¨è®¤è¯æµ‹è¯•é¡µé¢</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 20px;
		}

		.container {
			background: white;
			border-radius: 16px;
			padding: 40px;
			max-width: 600px;
			width: 100%;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
		}

		h1 {
			color: #333;
			margin-bottom: 10px;
			font-size: 28px;
		}

		.subtitle {
			color: #666;
			margin-bottom: 30px;
			font-size: 14px;
		}

		.section {
			margin-bottom: 30px;
			padding: 20px;
			background: #f8f9fa;
			border-radius: 8px;
		}

		.section h2 {
			color: #667eea;
			margin-bottom: 15px;
			font-size: 18px;
		}

		.input-group {
			margin-bottom: 15px;
		}

		label {
			display: block;
			margin-bottom: 5px;
			color: #555;
			font-weight: 500;
			font-size: 14px;
		}

		input,
		select {
			width: 100%;
			padding: 12px;
			border: 2px solid #e0e0e0;
			border-radius: 6px;
			font-size: 14px;
			transition: border-color 0.3s;
			background: white;
		}

		input:focus,
		select:focus {
			outline: none;
			border-color: #667eea;
		}

		select {
			cursor: pointer;
		}

		button {
			width: 100%;
			padding: 14px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			border-radius: 6px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.2s, box-shadow 0.2s;
		}

		button:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
		}

		button:active {
			transform: translateY(0);
		}

		.result {
			margin-top: 15px;
			padding: 15px;
			border-radius: 6px;
			font-size: 14px;
			line-height: 1.6;
			display: none;
		}

		.result.success {
			background: #d4edda;
			border: 1px solid #c3e6cb;
			color: #155724;
		}

		.result.error {
			background: #f8d7da;
			border: 1px solid #f5c6cb;
			color: #721c24;
		}

		.result pre {
			margin-top: 10px;
			background: rgba(0, 0, 0, 0.05);
			padding: 10px;
			border-radius: 4px;
			overflow-x: auto;
			font-size: 12px;
		}

		.tip {
			background: #fff3cd;
			border: 1px solid #ffeaa7;
			color: #856404;
			padding: 12px;
			border-radius: 6px;
			margin-top: 20px;
			font-size: 13px;
			line-height: 1.6;
		}

		.tip strong {
			display: block;
			margin-bottom: 5px;
		}

		.permission-info {
			background: white;
			border-radius: 6px;
			padding: 15px;
			margin-top: 10px;
		}

		.permission-info h3 {
			color: #667eea;
			font-size: 16px;
			margin-bottom: 10px;
		}

		.permission-item {
			display: flex;
			justify-content: space-between;
			padding: 8px 0;
			border-bottom: 1px solid #e0e0e0;
		}

		.permission-item:last-child {
			border-bottom: none;
		}

		.permission-label {
			font-weight: 500;
			color: #555;
		}

		.permission-value {
			color: #667eea;
			font-weight: 600;
		}

		.project-list {
			margin-top: 10px;
		}

		.project-item {
			background: #f8f9fa;
			padding: 10px;
			border-radius: 4px;
			margin-bottom: 8px;
			border-left: 3px solid #667eea;
		}

		.project-name {
			font-weight: 600;
			color: #333;
			margin-bottom: 4px;
		}

		.project-type {
			display: inline-block;
			padding: 2px 8px;
			background: #667eea;
			color: white;
			border-radius: 3px;
			font-size: 11px;
			margin-right: 8px;
		}

		.project-role {
			color: #666;
			font-size: 13px;
		}

		code {
			background: rgba(0, 0, 0, 0.05);
			padding: 2px 6px;
			border-radius: 3px;
			font-family: 'Courier New', monospace;
			font-size: 12px;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>ğŸš€ n8n å¤–éƒ¨è®¤è¯ & æƒé™ç®¡ç†æµ‹è¯•</h1>
		<p class="subtitle">æµ‹è¯•å•ç‚¹ç™»å½•ã€æƒé™æŸ¥çœ‹å’Œæƒé™è®¾ç½®åŠŸèƒ½</p>

		<!-- é…ç½®éƒ¨åˆ† -->
		<div class="section">
			<h2>âš™ï¸ é…ç½®</h2>
			<div class="input-group">
				<label for="n8nUrl">n8n åœ°å€</label>
				<input type="text" id="n8nUrl" value="http://localhost:5678" placeholder="http://localhost:5678">
			</div>
			<div class="input-group">
				<label for="authSecret">è®¤è¯å¯†é’¥</label>
				<input type="text" id="authSecret" value="n8n-secret-key-2025" placeholder="ä¸ n8n æœåŠ¡å™¨ä¸€è‡´">
			</div>
		</div>

		<!-- æ­¥éª¤1ï¼šåˆ›å»ºç”¨æˆ· -->
		<div class="section">
			<h2>ğŸ“ æ­¥éª¤ 1ï¼šåˆ›å»ºç”¨æˆ·</h2>
			<div class="input-group">
				<label for="createUserId">ç”¨æˆ· ID</label>
				<input type="text" id="createUserId" value="user123" placeholder="ä¾‹å¦‚ï¼šuser123 æˆ– 10001">
			</div>
			<div class="input-group">
				<label for="firstName">åï¼ˆå¯é€‰ï¼‰</label>
				<input type="text" id="firstName" value="å¼ " placeholder="å">
			</div>
			<div class="input-group">
				<label for="lastName">å§“ï¼ˆå¯é€‰ï¼‰</label>
				<input type="text" id="lastName" value="ä¸‰" placeholder="å§“">
			</div>
			<button onclick="createUser()">åˆ›å»ºç”¨æˆ·</button>
			<div id="createResult" class="result"></div>
		</div>

		<!-- æ­¥éª¤2ï¼šSSO ç™»å½• -->
		<div class="section">
			<h2>ğŸ” æ­¥éª¤ 2ï¼šSSO ç™»å½•</h2>
			<div class="input-group">
				<label for="loginUserId">ç”¨æˆ· ID</label>
				<input type="text" id="loginUserId" value="user123" placeholder="ä¸åˆ›å»ºæ—¶çš„ userId ä¸€è‡´">
			</div>
			<button onclick="ssoLogin()">ç™»å½•å¹¶è·³è½¬åˆ° n8n</button>
			<div id="loginResult" class="result"></div>
		</div>

		<!-- æ­¥éª¤3ï¼šæŸ¥çœ‹ç”¨æˆ·æƒé™ -->
		<div class="section">
			<h2>ğŸ‘ï¸ æ­¥éª¤ 3ï¼šæŸ¥çœ‹ç”¨æˆ·æƒé™</h2>
			<div class="input-group">
				<label for="viewPermUserId">ç”¨æˆ· ID</label>
				<input type="text" id="viewPermUserId" value="user123" placeholder="è¦æŸ¥çœ‹æƒé™çš„ç”¨æˆ· ID">
			</div>
			<button onclick="viewPermissions()">æŸ¥çœ‹æƒé™</button>
			<div id="viewPermResult" class="result"></div>
		</div>

		<!-- æ­¥éª¤4ï¼šè®¾ç½®ç”¨æˆ·æƒé™ -->
		<div class="section">
			<h2>âš¡ æ­¥éª¤ 4ï¼šè®¾ç½®ç”¨æˆ·æƒé™</h2>
			<div class="input-group">
				<label for="setPermUserId">ç”¨æˆ· ID</label>
				<input type="text" id="setPermUserId" value="user123" placeholder="è¦è®¾ç½®æƒé™çš„ç”¨æˆ· ID">
			</div>
			<div class="input-group">
				<label for="globalRole">å…¨å±€è§’è‰²</label>
				<select id="globalRole">
					<option value="">-- ä¸ä¿®æ”¹å…¨å±€è§’è‰² --</option>
					<option value="global:owner">global:owner (å®ä¾‹æ‹¥æœ‰è€…)</option>
					<option value="global:admin">global:admin (å…¨å±€ç®¡ç†å‘˜)</option>
					<option value="global:member">global:member (æ™®é€šæˆå‘˜)</option>
				</select>
			</div>
			<div class="input-group">
				<label for="projectId">é¡¹ç›® IDï¼ˆå¯é€‰ï¼‰</label>
				<input type="text" id="projectId" placeholder="ä¾‹å¦‚ï¼šproj-team-456">
				<small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
					ğŸ’¡ æç¤ºï¼šé¡¹ç›®IDå¯ä»¥åœ¨"æŸ¥çœ‹æƒé™"ç»“æœä¸­æ‰¾åˆ°
				</small>
			</div>
			<div class="input-group">
				<label for="projectRole">é¡¹ç›®è§’è‰²ï¼ˆå¯é€‰ï¼‰</label>
				<select id="projectRole">
					<option value="">-- è¯·é€‰æ‹© --</option>
					<option value="project:admin">project:admin (é¡¹ç›®ç®¡ç†å‘˜)</option>
					<option value="project:editor">project:editor (é¡¹ç›®ç¼–è¾‘è€…)</option>
					<option value="project:viewer">project:viewer (é¡¹ç›®æŸ¥çœ‹è€…)</option>
				</select>
			</div>
			<button onclick="setPermissions()">è®¾ç½®æƒé™</button>
			<div id="setPermResult" class="result"></div>
		</div>

		<!-- æƒé™è¯´æ˜ -->
		<div class="tip" style="background: #e3f2fd; border-color: #90caf9; color: #1565c0;">
			<strong>ğŸ“– æƒé™è¯´æ˜ï¼š</strong>
			<strong style="margin-top: 8px;">å…¨å±€è§’è‰²ï¼š</strong>
			â€¢ <code>global:owner</code> - å®ä¾‹æ‹¥æœ‰è€…ï¼Œæ‹¥æœ‰æœ€é«˜æƒé™<br>
			â€¢ <code>global:admin</code> - å…¨å±€ç®¡ç†å‘˜ï¼Œå¯ç®¡ç†ç”¨æˆ·å’Œå…¨å±€è®¾ç½®<br>
			â€¢ <code>global:member</code> - æ™®é€šæˆå‘˜ï¼ŒåŸºç¡€æƒé™<br>
			<strong style="margin-top: 8px;">é¡¹ç›®è§’è‰²ï¼š</strong>
			â€¢ <code>project:admin</code> - é¡¹ç›®ç®¡ç†å‘˜ï¼Œå¯ç®¡ç†é¡¹ç›®è®¾ç½®ã€æˆå‘˜ã€å·¥ä½œæµã€å‡­è¯<br>
			â€¢ <code>project:editor</code> - é¡¹ç›®ç¼–è¾‘è€…ï¼Œå¯åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤å·¥ä½œæµå’Œå‡­è¯<br>
			â€¢ <code>project:viewer</code> - é¡¹ç›®æŸ¥çœ‹è€…ï¼Œåªè¯»è®¿é—®
		</div>

		<!-- æç¤º -->
		<div class="tip">
			<strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong>
			1. ç¡®ä¿ n8n æœåŠ¡å·²å¯åŠ¨ï¼ˆhttp://localhost:5678ï¼‰<br>
			2. å…ˆç‚¹å‡»"åˆ›å»ºç”¨æˆ·"ï¼Œç­‰å¾…æˆåŠŸåå†ç‚¹å‡»"ç™»å½•"<br>
			3. ç™»å½•æˆåŠŸä¼šåœ¨æ–°çª—å£ä¸­è‡ªåŠ¨è·³è½¬åˆ° n8n ä¸»é¡µ<br>
			4. ä½¿ç”¨"æŸ¥çœ‹æƒé™"å¯ä»¥çœ‹åˆ°ç”¨æˆ·å½“å‰çš„å…¨å±€è§’è‰²å’Œé¡¹ç›®è§’è‰²<br>
			5. ä½¿ç”¨"è®¾ç½®æƒé™"å¯ä»¥ä¿®æ”¹ç”¨æˆ·çš„å…¨å±€è§’è‰²æˆ–é¡¹ç›®è§’è‰²
		</div>
	</div>

	<script>
		// è·å–é…ç½®
		function getConfig ()
		{
			return {
				n8nUrl: document.getElementById('n8nUrl').value.trim(),
				authSecret: document.getElementById('authSecret').value.trim(),
			};
		}

		// æ˜¾ç¤ºç»“æœ
		function showResult (elementId, success, message, data = null)
		{
			const resultDiv = document.getElementById(elementId);
			resultDiv.className = `result ${success ? 'success' : 'error'}`;
			resultDiv.style.display = 'block';

			let html = `<strong>${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</strong><br>${message}`;

			if (data) {
				html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
			}

			resultDiv.innerHTML = html;
		}

		// åˆ›å»ºç”¨æˆ·
		async function createUser ()
		{
			const config = getConfig();
			const userId = document.getElementById('createUserId').value.trim();
			const firstName = document.getElementById('firstName').value.trim();
			const lastName = document.getElementById('lastName').value.trim();

			if (!userId) {
				showResult('createResult', false, 'è¯·è¾“å…¥ç”¨æˆ· ID');
				return;
			}

			try {
				const response = await fetch(`${config.n8nUrl}/rest/external-auth/create-user`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						userId: userId,
						firstName: firstName || 'ç”¨æˆ·',
						lastName: lastName || userId.substring(0, 8),
						authSecret: config.authSecret,
					}),
				});

				console.log('response status:', response.status);
				console.log('response ok:', response.ok);
				console.log('response headers:', response.headers.get('content-type'));

				// æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
				const contentType = response.headers.get('content-type');
				if (!contentType || !contentType.includes('application/json')) {
					const text = await response.text();
					console.error('Response is not JSON:', text);
					throw new Error(`æœåŠ¡å™¨è¿”å›äº†é JSON å“åº” (çŠ¶æ€ç : ${response.status})`);
				}

				const result = await response.json();
				console.log('result:', result);

				if (response.ok) {
					showResult('createResult', true, 'ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼ç°åœ¨å¯ä»¥è¿›è¡Œ SSO ç™»å½•äº†ã€‚', result);
					// è‡ªåŠ¨å¡«å……ç™»å½•è¡¨å•
					document.getElementById('loginUserId').value = userId;
				} else {
					showResult('createResult', false, result.message || 'åˆ›å»ºå¤±è´¥', result);
				}
			} catch (error) {
				console.error('Create user error:', error);
				showResult('createResult', false, `è¯·æ±‚å¤±è´¥: ${error.message}<br><small>è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</small>`);
			}
		}

		// SSO ç™»å½•
		async function ssoLogin ()
		{
			const config = getConfig();
			const userId = document.getElementById('loginUserId').value.trim();

			if (!userId) {
				showResult('loginResult', false, 'è¯·è¾“å…¥ç”¨æˆ· ID');
				return;
			}

			showResult('loginResult', true, 'æ­£åœ¨æ‰“å¼€æ–°çª—å£å¹¶ç™»å½•...');

			// åˆ›å»ºä¸€ä¸ªä¸´æ—¶ HTML é¡µé¢ï¼Œåœ¨æ–°çª—å£ä¸­è°ƒç”¨ç™»å½•æ¥å£
			const loginHtml = `
				<!DOCTYPE html>
				<html>
				<head>
					<meta charset="UTF-8">
					<title>æ­£åœ¨ç™»å½• n8n...</title>
					<style>
						body {
							display: flex;
							justify-content: center;
							align-items: center;
							height: 100vh;
							margin: 0;
							font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
							background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
							color: white;
						}
						.container {
							text-align: center;
						}
						.spinner {
							border: 4px solid rgba(255, 255, 255, 0.3);
							border-radius: 50%;
							border-top: 4px solid white;
							width: 40px;
							height: 40px;
							animation: spin 1s linear infinite;
							margin: 0 auto 20px;
						}
						@keyframes spin {
							0% { transform: rotate(0deg); }
							100% { transform: rotate(360deg); }
						}
						.error {
							background: rgba(255, 59, 48, 0.2);
							border: 1px solid rgba(255, 59, 48, 0.5);
							border-radius: 8px;
							padding: 20px;
							margin-top: 20px;
							display: none;
						}
					</style>
				</head>
				<body>
					<div class="container">
						<div class="spinner"></div>
						<h2>æ­£åœ¨ç™»å½•å·¥ä½œæµç³»ç»Ÿ...</h2>
						<p>è¯·ç¨å€™ï¼Œå³å°†è‡ªåŠ¨è·³è½¬</p>
						<div class="error" id="error">
							<p style="font-size: 18px; margin: 0 0 10px 0;">âŒ ç™»å½•å¤±è´¥</p>
							<div id="error-message"></div>
						</div>
					</div>
					<script>
						(async function() {
							try {
								const response = await fetch('${config.n8nUrl}/rest/external-auth/login', {
									method: 'POST',
									headers: { 'Content-Type': 'application/json' },
									credentials: 'include',
									body: JSON.stringify({
										userIdentifier: '${userId}',
										authSecret: '${config.authSecret}'
									})
								});

								if (response.ok) {
									setTimeout(() => {
										window.location.href = '${config.n8nUrl}';
									}, 1500);
								} else {
									const error = await response.json();
									throw new Error(error.message || 'ç™»å½•å¤±è´¥');
								}
							} catch (e) {
								document.querySelector('.spinner').style.display = 'none';
								document.getElementById('error').style.display = 'block';
								document.getElementById('error-message').innerHTML =
									'<p>é”™è¯¯åŸå› ï¼š' + e.message + '</p>' +
									'<p style="margin-top: 10px; font-size: 12px;">è¯·å…³é—­æ­¤çª—å£å¹¶é‡è¯•</p>';
							}
						})();
					<\/script>
				</body>
				</html>
			`;

			// åœ¨æ–°çª—å£ä¸­æ‰“å¼€è¿™ä¸ª HTML
			const newWindow = window.open('', '_blank');
			if (newWindow) {
				newWindow.document.write(loginHtml);
				newWindow.document.close();
				showResult('loginResult', true, 'æ–°çª—å£å·²æ‰“å¼€ï¼Œæ­£åœ¨è‡ªåŠ¨ç™»å½•...');
			} else {
				showResult('loginResult', false, 'æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—æ‹¦æˆªè®¾ç½®');
			}
		}

		// æŸ¥çœ‹ç”¨æˆ·æƒé™
		async function viewPermissions ()
		{
			const config = getConfig();
			const userId = document.getElementById('viewPermUserId').value.trim();

			if (!userId) {
				showResult('viewPermResult', false, 'è¯·è¾“å…¥ç”¨æˆ· ID');
				return;
			}

			try {
				const response = await fetch(`${config.n8nUrl}/rest/external-auth/get-permissions`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						userId: userId,
						authSecret: config.authSecret,
					}),
				});

				console.log('get-permissions status:', response.status);

				// æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
				const contentType = response.headers.get('content-type');
				if (!contentType || !contentType.includes('application/json')) {
					const text = await response.text();
					console.error('Response is not JSON:', text);
					throw new Error(`æœåŠ¡å™¨è¿”å›äº†é JSON å“åº” (çŠ¶æ€ç : ${response.status})`);
				}

				const result = await response.json();
				console.log('get-permissions result:', result);

				if (response.ok) {
					// æ„å»ºæ¼‚äº®çš„æƒé™å±•ç¤º
					let html = '<strong>âœ… æˆåŠŸ</strong><br>ç”¨æˆ·æƒé™ä¿¡æ¯ï¼š';
					html += '<div class="permission-info">';

					// ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
					html += '<h3>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h3>';
					html += `<div class="permission-item">
						<span class="permission-label">å§“åï¼š</span>
						<span class="permission-value">${result.data.user.firstName} ${result.data.user.lastName}</span>
					</div>`;

					// å…¨å±€è§’è‰²
					html += '<h3 style="margin-top: 15px;">ğŸŒ å…¨å±€è§’è‰²</h3>';
					html += `<div class="permission-item">
						<span class="permission-label">è§’è‰²ï¼š</span>
						<span class="permission-value">${result.data.permissions.globalRole}</span>
					</div>`;

					// é¡¹ç›®åˆ—è¡¨
					if (result.data.permissions.projects && result.data.permissions.projects.length > 0) {
						html += '<h3 style="margin-top: 15px;">ğŸ“ é¡¹ç›®æƒé™</h3>';
						html += '<div class="project-list">';

						result.data.permissions.projects.forEach(proj =>
						{
							html += `<div class="project-item">
								<div class="project-name">
									<span class="project-type">${proj.projectType}</span>
									${proj.projectName}
								</div>
								<div class="project-role">
									<strong>è§’è‰²ï¼š</strong> ${proj.role}<br>
									<strong>é¡¹ç›®IDï¼š</strong> ${proj.projectId}
								</div>
							</div>`;
						});

						html += '</div>';
					} else {
						html += '<p style="margin-top: 10px; color: #666;">è¯¥ç”¨æˆ·è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•é¡¹ç›®ã€‚</p>';
					}

					html += '</div>';

					const resultDiv = document.getElementById('viewPermResult');
					resultDiv.className = 'result success';
					resultDiv.style.display = 'block';
					resultDiv.innerHTML = html;
				} else {
					showResult('viewPermResult', false, result.message || 'è·å–æƒé™å¤±è´¥', result);
				}
			} catch (error) {
				console.error('Get permissions error:', error);
				showResult('viewPermResult', false, `è¯·æ±‚å¤±è´¥: ${error.message}<br><small>è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</small>`);
			}
		}

		// è®¾ç½®ç”¨æˆ·æƒé™
		async function setPermissions ()
		{
			const config = getConfig();
			const userId = document.getElementById('setPermUserId').value.trim();
			const globalRole = document.getElementById('globalRole').value;
			const projectId = document.getElementById('projectId').value.trim();
			const projectRole = document.getElementById('projectRole').value;

			if (!userId) {
				showResult('setPermResult', false, 'è¯·è¾“å…¥ç”¨æˆ· ID');
				return;
			}

			if (!globalRole && !projectId) {
				showResult('setPermResult', false, 'è¯·è‡³å°‘é€‰æ‹©è¦ä¿®æ”¹å…¨å±€è§’è‰²æˆ–å¡«å†™é¡¹ç›® ID');
				return;
			}

			if (projectId && !projectRole) {
				showResult('setPermResult', false, 'å¡«å†™äº†é¡¹ç›® IDï¼Œè¯·é€‰æ‹©é¡¹ç›®è§’è‰²');
				return;
			}

			// æ„å»ºè¯·æ±‚ä½“
			const requestBody = {
				userId: userId,
				authSecret: config.authSecret,
			};

			if (globalRole) {
				requestBody.globalRole = globalRole;
			}

			if (projectId && projectRole) {
				requestBody.projectPermissions = [
					{
						projectId: projectId,
						role: projectRole,
					}
				];
			}

			try {
				console.log('set-permissions request:', requestBody);

				const response = await fetch(`${config.n8nUrl}/rest/external-auth/set-permissions`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(requestBody),
				});

				console.log('set-permissions status:', response.status);

				// æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
				const contentType = response.headers.get('content-type');
				if (!contentType || !contentType.includes('application/json')) {
					const text = await response.text();
					console.error('Response is not JSON:', text);
					throw new Error(`æœåŠ¡å™¨è¿”å›äº†é JSON å“åº” (çŠ¶æ€ç : ${response.status})`);
				}

				const result = await response.json();
				console.log('set-permissions result:', result);

				if (response.ok) {
					let message = 'æƒé™è®¾ç½®æˆåŠŸï¼<br><br>';
					if (globalRole) {
						message += `âœ“ å…¨å±€è§’è‰²å·²æ›´æ–°ä¸ºï¼š<strong>${globalRole}</strong><br>`;
					}
					if (projectId && projectRole) {
						message += `âœ“ é¡¹ç›® ${projectId} çš„è§’è‰²å·²æ›´æ–°ä¸ºï¼š<strong>${projectRole}</strong><br>`;
					}
					message += '<br><small>ğŸ’¡ æç¤ºï¼šå¯ä»¥ç‚¹å‡»"æŸ¥çœ‹æƒé™"éªŒè¯æ›´æ–°ç»“æœ</small>';

					showResult('setPermResult', true, message);

					// è‡ªåŠ¨æ›´æ–°æŸ¥çœ‹æƒé™çš„ç”¨æˆ·ID
					document.getElementById('viewPermUserId').value = userId;
				} else {
					showResult('setPermResult', false, result.message || 'è®¾ç½®æƒé™å¤±è´¥', result);
				}
			} catch (error) {
				console.error('Set permissions error:', error);
				showResult('setPermResult', false, `è¯·æ±‚å¤±è´¥: ${error.message}<br><small>è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</small>`);
			}
		}

		// å›è½¦é”®è§¦å‘
		document.addEventListener('keypress', function (e)
		{
			if (e.key === 'Enter') {
				const activeElement = document.activeElement;
				const section = activeElement.closest('.section');
				if (!section) return;

				const heading = section.querySelector('h2')?.textContent;
				if (heading?.includes('æ­¥éª¤ 1')) {
					createUser();
				} else if (heading?.includes('æ­¥éª¤ 2')) {
					ssoLogin();
				} else if (heading?.includes('æ­¥éª¤ 3')) {
					viewPermissions();
				} else if (heading?.includes('æ­¥éª¤ 4')) {
					setPermissions();
				}
			}
		});
	</script>
</body>

</html>
