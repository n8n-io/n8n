name: Sync with upstream

on:
  schedule:
    # æ¯å¤© UTC 0 ç‚¹è‡ªåŠ¨åŒæ­¥ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # éœ€è¦å†™å…¥æƒé™æ¥æŽ¨é€ä»£ç 

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Add upstream remote
        run: |
          # æ£€æŸ¥ upstream æ˜¯å¦å·²å­˜åœ¨
          if ! git remote get-url upstream &> /dev/null; then
            git remote add upstream https://github.com/n8n-io/n8n.git
            echo "âœ… Added upstream remote"
          else
            echo "â„¹ï¸  Upstream remote already exists"
          fi

      - name: Fetch upstream
        run: |
          git fetch upstream
          echo "âœ… Fetched upstream"

      - name: Check for updates
        id: check
        run: |
          # è®¡ç®—æœ¬åœ° master ä¸Žä¸Šæ¸¸ master çš„å·®è·
          COMMITS=$(git rev-list --count HEAD..upstream/master)
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

          if [ $COMMITS -eq 0 ]; then
            echo "âœ… Already up to date with upstream"
            echo "status=up_to_date" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ Found $COMMITS new commits from upstream"
            echo "status=has_updates" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        if: steps.check.outputs.status == 'has_updates'
        run: |
          echo "ðŸ”„ Merging upstream changes..."
          git merge upstream/master --no-edit
          echo "âœ… Merged upstream changes"

      - name: Push to origin
        if: steps.check.outputs.status == 'has_updates'
        run: |
          echo "ðŸš€ Pushing to origin..."
          git push origin master
          echo "âœ… Pushed to origin"

      - name: Create summary
        run: |
          if [ ${{ steps.check.outputs.status }} == "up_to_date" ]; then
            echo "## âœ… Sync Status: Up to date" >> $GITHUB_STEP_SUMMARY
            echo "Your repository is already synchronized with upstream n8n/n8n." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Sync Status: Synchronized" >> $GITHUB_STEP_SUMMARY
            echo "Successfully synchronized with upstream n8n/n8n." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**New commits from upstream:**" >> $GITHUB_STEP_SUMMARY
            git log --oneline HEAD..upstream/master --pretty="- %s (%h)" >> $GITHUB_STEP_SUMMARY
          fi
