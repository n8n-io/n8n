name: åŒæ­¥ä¸Šæ¸¸æ›´æ–°åˆ°Masteråˆ†æ”¯

on:
  schedule:
    # æ¯å¤© UTC 0 ç‚¹è‡ªåŠ¨åŒæ­¥ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # éœ€è¦å†™å…¥æƒé™æ¥æŽ¨é€ä»£ç 

jobs:
  sync:
    runs-on: ubuntu-latest
    # åªåœ¨ master åˆ†æ”¯ä¸Šè¿è¡Œ
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          # æ˜Žç¡®æŒ‡å®š master åˆ†æ”¯
          ref: master

      - name: Setup git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Add upstream remote
        run: |
          # æ£€æŸ¥ upstream æ˜¯å¦å·²å­˜åœ¨
          if ! git remote get-url upstream &> /dev/null; then
            git remote add upstream https://github.com/n8n-io/n8n.git
            echo "âœ… Added upstream remote"
          else
            echo "â„¹ï¸  Upstream remote already exists"
          fi

      - name: Fetch upstream
        run: |
          git fetch upstream
          echo "âœ… Fetched upstream"

      - name: Check for updates
        id: check
        run: |
          # è®¡ç®—æœ¬åœ° master ä¸Žä¸Šæ¸¸ master çš„å·®è·
          COMMITS=$(git rev-list --count HEAD..upstream/master)
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

          if [ $COMMITS -eq 0 ]; then
            echo "âœ… Already up to date with upstream"
            echo "status=up_to_date" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ Found $COMMITS new commits from upstream"
            echo "status=has_updates" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        if: steps.check.outputs.status == 'has_updates'
        run: |
          echo "ðŸ”„ Merging upstream changes..."
          git merge upstream/master --no-edit
          echo "âœ… Merged upstream changes"

      - name: Push to origin master branch
        if: steps.check.outputs.status == 'has_updates'
        run: |
          echo "ðŸš€ Pushing to origin master branch..."
          git push origin master
          echo "âœ… Pushed to master branch"

      - name: Create summary
        run: |
          if [ ${{ steps.check.outputs.status }} == "up_to_date" ]; then
            echo "## âœ… Masteråˆ†æ”¯åŒæ­¥çŠ¶æ€ï¼šå·²æ˜¯æœ€æ–°" >> $GITHUB_STEP_SUMMARY
            echo "Masteråˆ†æ”¯å·²ä¸Žä¸Šæ¸¸ n8n/n8n ä¿æŒåŒæ­¥ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ³¨æ„ï¼š**æ­¤å·¥ä½œæµä»…åŒæ­¥masteråˆ†æ”¯ã€‚å…¶ä»–å¼€å‘åˆ†æ”¯çš„åŒæ­¥ç”±å¼€å‘è€…è‡ªè¡Œå†³å®šã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Masteråˆ†æ”¯åŒæ­¥çŠ¶æ€ï¼šå·²åŒæ­¥" >> $GITHUB_STEP_SUMMARY
            echo "Masteråˆ†æ”¯å·²æˆåŠŸä¸Žä¸Šæ¸¸ n8n/n8n åŒæ­¥ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ä¸Šæ¸¸æ–°å¢žæäº¤ï¼š**" >> $GITHUB_STEP_SUMMARY
            git log --oneline HEAD..upstream/master --pretty="- %s (%h)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ³¨æ„ï¼š**æ­¤å·¥ä½œæµä»…åŒæ­¥masteråˆ†æ”¯ã€‚å…¶ä»–å¼€å‘åˆ†æ”¯çš„åŒæ­¥ç”±å¼€å‘è€…è‡ªè¡Œå†³å®šã€‚" >> $GITHUB_STEP_SUMMARY
          fi
