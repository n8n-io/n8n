name: E2E Tests for CI

on:
  workflow_call:
    inputs:
      is_fork:
        description: 'Whether this is a fork PR'
        required: false
        type: boolean
        default: false
      docker_image:
        description: 'Pre-built n8n Docker image to use (for internal PRs)'
        required: false
        type: string
        default: ''
      runners_image:
        description: 'Pre-built runners Docker image to use (for internal PRs)'
        required: false
        type: string
        default: ''

jobs:
  # Multi-main: postgres + redis + caddy + 2 mains + 1 worker
  # Only runs for internal PRs (not community/fork PRs)
  # Uses pre-built images from docker-build-pr job (docker-pull mode)
  multi-main-ui:
    name: 'Multi-Main: UI'
    if: ${{ !inputs.is_fork && inputs.docker_image != '' }}
    uses: ./.github/workflows/playwright-test-reusable.yml
    with:
      test-mode: docker-build
      test-command: pnpm --filter=n8n-playwright test:container:multi-main:ui
      shards: '[1, 2, 3, 4, 5, 6, 7, 8]'
      runner: blacksmith-4vcpu-ubuntu-2204
      workers: '1'
    secrets: inherit

  multi-main-isolated:
    name: 'Multi-Main: Isolated'
    if: ${{ !inputs.is_fork && inputs.docker_image != '' }}
    uses: ./.github/workflows/playwright-test-reusable.yml
    with:
      test-mode: docker-build
      test-command: pnpm --filter=n8n-playwright test:container:multi-main:isolated
      shards: '[1]'
      runner: blacksmith-4vcpu-ubuntu-2204
      workers: '1'
    secrets: inherit

  # Community PR tests: Local mode with SQLite (no container building, no secrets required)
  # Runs on GitHub-hosted runners without Currents reporting
  community-ui:
    name: 'Community: UI'
    if: ${{ inputs.is_fork || inputs.docker_image == '' }}
    uses: ./.github/workflows/playwright-test-reusable.yml
    with:
      test-mode: local
      test-command: pnpm --filter=n8n-playwright test:local
      shards: '[1, 2, 3, 4, 5]'
      runner: ubuntu-latest
      workers: '2'

  community-isolated:
    name: 'Community: Isolated'
    if: ${{ inputs.is_fork || inputs.docker_image == '' }}
    uses: ./.github/workflows/playwright-test-reusable.yml
    with:
      test-mode: local
      test-command: pnpm --filter=n8n-playwright test:local:isolated
      shards: '[1]'
      runner: ubuntu-latest
      workers: '1'
