name: 'Release: Push to Channel'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'n8n Release version to push to a channel (e.g., 1.2.3 or 1.2.3-beta.4)'
        required: true
        type: string

      release-channel:
        description: 'Release channel (stable: v2 production, 1: v1 maintenance, beta: prereleases)'
        required: true
        type: choice
        default: 'beta'
        options:
          - beta
          - stable
          - 1

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check_version.outputs.version }}
      release_channel: ${{ github.event.inputs.release-channel }}
      major: ${{ steps.check_version.outputs.major }}
      minor: ${{ steps.check_version.outputs.minor }}
      patch: ${{ steps.check_version.outputs.patch }}
      is_prerelease: ${{ steps.check_version.outputs.is_prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install script dependencies
        run: npm install --prefix=.github/scripts --no-package-lock

      - name: Validate and Parse Version
        id: check_version
        run: |
          node .github/scripts/classify-version.mjs --version "${{ github.event.inputs.version }}"
          echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"

      - name: Validate Channel-Version Compatibility
        env:
          VERSION: ${{ github.event.inputs.version }}
          CHANNEL: ${{ github.event.inputs.release-channel }}
          MAJOR: ${{ steps.check_version.outputs.major }}
          IS_PRERELEASE: ${{ steps.check_version.outputs.is_prerelease }}
        run: |
          echo "Validating version ${VERSION} for channel ${CHANNEL}..."

          # Invariant 1: Channel '1' only accepts MAJOR == 1
          if [[ "$CHANNEL" == "1" && "$MAJOR" != "1" ]]; then
            echo "::error::Cannot promote v${MAJOR} version to channel '1'. Channel '1' is for v1 maintenance releases only."
            echo "::error::Hint: Use channel 'stable' for v2+ releases."
            exit 1
          fi

          # Invariant 2: Channels 'stable' and '1' reject prerelease versions
          if [[ ( "$CHANNEL" == "stable" || "$CHANNEL" == "1" ) && "$IS_PRERELEASE" == "true" ]]; then
            echo "::error::Cannot promote prerelease version ${VERSION} to channel '${CHANNEL}'."
            echo "::error::Prerelease versions (containing -rc, -beta, -dev, etc.) can only be promoted to 'beta' channel."
            echo "::error::Hint: Remove prerelease suffix before promoting to ${CHANNEL}, or use channel 'beta'."
            exit 1
          fi

          echo "âœ… Channel-version compatibility validated successfully"

  release-to-npm:
    name: Release to NPM
    runs-on: ubuntu-latest
    needs: validate-inputs
    timeout-minutes: 5
    steps:
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.x

      - run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: Add beta/next tags to NPM
        if: needs.validate-inputs.outputs.release_channel == 'beta'
        run: |
          VERSION="${{ needs.validate-inputs.outputs.version }}"
          MAJOR="${{ needs.validate-inputs.outputs.major }}"
          MINOR="${{ needs.validate-inputs.outputs.major }}.${{ needs.validate-inputs.outputs.minor }}"
          npm dist-tag add "n8n@${VERSION}" next
          npm dist-tag add "n8n@${VERSION}" beta
          npm dist-tag add "n8n@${VERSION}" "${MAJOR}"
          npm dist-tag add "n8n@${VERSION}" "${MINOR}"

      - name: Add latest/stable tags to NPM
        if: needs.validate-inputs.outputs.release_channel == 'stable'
        run: |
          VERSION="${{ needs.validate-inputs.outputs.version }}"
          MAJOR="${{ needs.validate-inputs.outputs.major }}"
          MINOR="${{ needs.validate-inputs.outputs.major }}.${{ needs.validate-inputs.outputs.minor }}"
          npm dist-tag add "n8n@${VERSION}" latest
          npm dist-tag add "n8n@${VERSION}" stable
          npm dist-tag add "n8n@${VERSION}" "${MAJOR}"
          npm dist-tag add "n8n@${VERSION}" "${MINOR}"

      - name: Add v1 maintenance tags to NPM
        if: needs.validate-inputs.outputs.release_channel == '1'
        run: |
          VERSION="${{ needs.validate-inputs.outputs.version }}"
          MAJOR="${{ needs.validate-inputs.outputs.major }}"
          MINOR="${{ needs.validate-inputs.outputs.major }}.${{ needs.validate-inputs.outputs.minor }}"
          npm dist-tag add "n8n@${VERSION}" "${MAJOR}"
          npm dist-tag add "n8n@${VERSION}" "${MINOR}"

  release-to-docker-hub:
    name: Release to DockerHub
    runs-on: ubuntu-latest
    needs: validate-inputs
    timeout-minutes: 5
    steps:
      - uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag stable/latest Docker image
        if: needs.validate-inputs.outputs.release_channel == 'stable'
        run: |
          VERSION="${{ needs.validate-inputs.outputs.version }}"
          MAJOR="${{ needs.validate-inputs.outputs.major }}"
          MINOR="${{ needs.validate-inputs.outputs.major }}.${{ needs.validate-inputs.outputs.minor }}"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"

          # n8n image tags
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:stable" "${DOCKER_USER}/n8n:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:latest" "${DOCKER_USER}/n8n:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:${MAJOR}" "${DOCKER_USER}/n8n:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:${MINOR}" "${DOCKER_USER}/n8n:${VERSION}"

          # runners (Alpine) tags
          docker buildx imagetools create -t "${DOCKER_USER}/runners:stable" "${DOCKER_USER}/runners:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:latest" "${DOCKER_USER}/runners:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MAJOR}" "${DOCKER_USER}/runners:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MINOR}" "${DOCKER_USER}/runners:${VERSION}"

          # runners-distroless tags
          docker buildx imagetools create -t "${DOCKER_USER}/runners:stable-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:latest-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MAJOR}-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MINOR}-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"

      - name: Tag beta/next Docker image
        if: needs.validate-inputs.outputs.release_channel == 'beta'
        run: |
          VERSION="${{ needs.validate-inputs.outputs.version }}"
          MAJOR="${{ needs.validate-inputs.outputs.major }}"
          MINOR="${{ needs.validate-inputs.outputs.major }}.${{ needs.validate-inputs.outputs.minor }}"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"

          # n8n image tags
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:beta" "${DOCKER_USER}/n8n:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:next" "${DOCKER_USER}/n8n:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:${MAJOR}" "${DOCKER_USER}/n8n:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:${MINOR}" "${DOCKER_USER}/n8n:${VERSION}"

          # runners (Alpine) tags
          docker buildx imagetools create -t "${DOCKER_USER}/runners:beta" "${DOCKER_USER}/runners:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:next" "${DOCKER_USER}/runners:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MAJOR}" "${DOCKER_USER}/runners:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MINOR}" "${DOCKER_USER}/runners:${VERSION}"

          # runners-distroless tags
          docker buildx imagetools create -t "${DOCKER_USER}/runners:beta-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:next-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MAJOR}-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MINOR}-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"

      - name: Tag v1 maintenance Docker images
        if: needs.validate-inputs.outputs.release_channel == '1'
        run: |
          VERSION="${{ needs.validate-inputs.outputs.version }}"
          MAJOR="${{ needs.validate-inputs.outputs.major }}"
          MINOR="${{ needs.validate-inputs.outputs.major }}.${{ needs.validate-inputs.outputs.minor }}"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"

          # n8n image pointer tags
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:${MAJOR}" "${DOCKER_USER}/n8n:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/n8n:${MINOR}" "${DOCKER_USER}/n8n:${VERSION}"

          # runners (Alpine) pointer tags
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MAJOR}" "${DOCKER_USER}/runners:${VERSION}"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MINOR}" "${DOCKER_USER}/runners:${VERSION}"

          # runners-distroless pointer tags
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MAJOR}-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${DOCKER_USER}/runners:${MINOR}-distroless" "${DOCKER_USER}/runners:${VERSION}-distroless"

  release-to-github-container-registry:
    name: Release to GitHub Container Registry
    runs-on: ubuntu-latest
    needs: validate-inputs
    timeout-minutes: 5
    steps:
      - uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag stable/latest GHCR image
        if: needs.validate-inputs.outputs.release_channel == 'stable'
        run: |
          VERSION="${{ needs.validate-inputs.outputs.version }}"
          MAJOR="${{ needs.validate-inputs.outputs.major }}"
          MINOR="${{ needs.validate-inputs.outputs.major }}.${{ needs.validate-inputs.outputs.minor }}"
          GHCR_BASE="ghcr.io/${{ github.repository_owner }}"

          # n8n image tags
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:stable" "${GHCR_BASE}/n8n:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:latest" "${GHCR_BASE}/n8n:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:${MAJOR}" "${GHCR_BASE}/n8n:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:${MINOR}" "${GHCR_BASE}/n8n:${VERSION}"

          # runners (Alpine) tags
          docker buildx imagetools create -t "${GHCR_BASE}/runners:stable" "${GHCR_BASE}/runners:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:latest" "${GHCR_BASE}/runners:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MAJOR}" "${GHCR_BASE}/runners:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MINOR}" "${GHCR_BASE}/runners:${VERSION}"

          # runners-distroless tags
          docker buildx imagetools create -t "${GHCR_BASE}/runners:stable-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:latest-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MAJOR}-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MINOR}-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"

      - name: Tag beta/next GHCR image
        if: needs.validate-inputs.outputs.release_channel == 'beta'
        run: |
          VERSION="${{ needs.validate-inputs.outputs.version }}"
          MAJOR="${{ needs.validate-inputs.outputs.major }}"
          MINOR="${{ needs.validate-inputs.outputs.major }}.${{ needs.validate-inputs.outputs.minor }}"
          GHCR_BASE="ghcr.io/${{ github.repository_owner }}"

          # n8n image tags
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:beta" "${GHCR_BASE}/n8n:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:next" "${GHCR_BASE}/n8n:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:${MAJOR}" "${GHCR_BASE}/n8n:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:${MINOR}" "${GHCR_BASE}/n8n:${VERSION}"

          # runners (Alpine) tags
          docker buildx imagetools create -t "${GHCR_BASE}/runners:beta" "${GHCR_BASE}/runners:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:next" "${GHCR_BASE}/runners:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MAJOR}" "${GHCR_BASE}/runners:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MINOR}" "${GHCR_BASE}/runners:${VERSION}"

          # runners-distroless tags
          docker buildx imagetools create -t "${GHCR_BASE}/runners:beta-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:next-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MAJOR}-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MINOR}-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"

      - name: Tag v1 maintenance GHCR images
        if: needs.validate-inputs.outputs.release_channel == '1'
        run: |
          VERSION="${{ needs.validate-inputs.outputs.version }}"
          MAJOR="${{ needs.validate-inputs.outputs.major }}"
          MINOR="${{ needs.validate-inputs.outputs.major }}.${{ needs.validate-inputs.outputs.minor }}"
          GHCR_BASE="ghcr.io/${{ github.repository_owner }}"

          # n8n image pointer tags
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:${MAJOR}" "${GHCR_BASE}/n8n:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/n8n:${MINOR}" "${GHCR_BASE}/n8n:${VERSION}"

          # runners (Alpine) pointer tags
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MAJOR}" "${GHCR_BASE}/runners:${VERSION}"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MINOR}" "${GHCR_BASE}/runners:${VERSION}"

          # runners-distroless pointer tags
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MAJOR}-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"
          docker buildx imagetools create -t "${GHCR_BASE}/runners:${MINOR}-distroless" "${GHCR_BASE}/runners:${VERSION}-distroless"

  update-docs:
    name: Update latest and next in the docs
    runs-on: ubuntu-latest
    needs: [validate-inputs, release-to-npm, release-to-docker-hub]
    steps:
      - continue-on-error: true
        run: curl -u docsWorkflows:${{ secrets.N8N_WEBHOOK_DOCS_PASSWORD }} --request GET 'https://internal.users.n8n.cloud/webhook/update-latest-next'
