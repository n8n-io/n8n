name: 'Manual: Full CI'

# TEMPORARY: This workflow exists because release PRs created with GITHUB_TOKEN
# don't trigger the normal PR workflows. Remove once we switch to a GitHub App
# token for release PR creation.

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test (e.g., release-pr/2.2.0)'
        required: true
        type: string

jobs:
  unit-tests:
    name: Unit Tests
    uses: ./.github/workflows/units-tests-reusable.yml
    with:
      ref: ${{ inputs.branch }}
    secrets: inherit

  lint:
    name: Lint
    uses: ./.github/workflows/linting-reusable.yml
    with:
      ref: ${{ inputs.branch }}

  typecheck:
    name: Typecheck
    runs-on: blacksmith-4vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.branch }}

      - name: Setup Node.js
        uses: ./.github/actions/setup-nodejs
        with:
          build-command: pnpm typecheck

  multi-main-e2e:
    name: 'Multi-Main: E2E'
    uses: ./.github/workflows/playwright-test-reusable.yml
    with:
      branch: ${{ inputs.branch }}
      test-mode: docker-build
      test-command: pnpm --filter=n8n-playwright test:container:multi-main:e2e
      shards: 14
      runner: blacksmith-2vcpu-ubuntu-2204
      workers: '1'
      use-custom-orchestration: true
    secrets: inherit

  multi-main-isolated:
    name: 'Multi-Main: Isolated'
    uses: ./.github/workflows/playwright-test-reusable.yml
    with:
      branch: ${{ inputs.branch }}
      test-mode: docker-build
      test-command: pnpm --filter=n8n-playwright test:container:multi-main:isolated
      shards: 2
      runner: blacksmith-2vcpu-ubuntu-2204
      workers: '1'
    secrets: inherit
