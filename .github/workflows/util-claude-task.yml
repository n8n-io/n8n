name: 'Util: Claude Task Runner'

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Task description - what should Claude do?'
        required: true
        type: string
      create_pr:
        description: 'Create PR after completing task'
        required: false
        type: boolean
        default: true
      base_branch:
        description: 'Base branch for PR'
        required: false
        type: string
        default: 'master'

jobs:
  run-claude-task:
    runs-on: blacksmith-4vcpu-ubuntu-2204
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        with:
          app-id: ${{ secrets.N8N_ASSISTANT_APP_ID }}
          private-key: ${{ secrets.N8N_ASSISTANT_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0
          ref: ${{ inputs.base_branch }}

      - name: Setup Node.js
        uses: ./.github/actions/setup-nodejs
        with:
          build-command: 'echo "Skipping build - Claude will build if needed"'

      - name: Generate branch name
        id: branch
        shell: bash
        env:
          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
        run: |
          echo "name=claude/task-${RUN_ID}-${RUN_ATTEMPT}" >> "$GITHUB_OUTPUT"

      - name: Create working branch
        shell: bash
        run: |
          git checkout -b "${{ steps.branch.outputs.name }}"

      - name: Configure git author
        id: git-author
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTOR: ${{ github.actor }}
        run: |
          # Set git author to the user who triggered the workflow
          USER_DATA=$(gh api "/users/$ACTOR")
          USER_NAME=$(echo "$USER_DATA" | jq -r '.name // .login')
          USER_ID=$(echo "$USER_DATA" | jq -r '.id')
          USER_EMAIL="${USER_ID}+${ACTOR}@users.noreply.github.com"
          git config user.name "$USER_NAME"
          git config user.email "$USER_EMAIL"
          # Export for Claude action to use
          {
            echo "GIT_AUTHOR_NAME=$USER_NAME"
            echo "GIT_AUTHOR_EMAIL=$USER_EMAIL"
            echo "GIT_COMMITTER_NAME=$USER_NAME"
            echo "GIT_COMMITTER_EMAIL=$USER_EMAIL"
          } >> "$GITHUB_ENV"
          echo "Git author configured as: $USER_NAME <$USER_EMAIL>"

      - name: Prepare Claude prompt
        id: prompt
        shell: bash
        env:
          INPUT_TASK: ${{ inputs.task }}
        run: |
          # Build the prompt with task and pointer to templates
          {
            echo 'CLAUDE_PROMPT<<EOF'
            echo "# Task"
            echo "$INPUT_TASK"
            echo ""
            echo "# Guidelines"
            echo "Check .github/claude-templates/ for relevant guides before starting."
            echo "Read any templates that match your task type (e.g., security-fix.md for CVE fixes)."
            echo ""
            echo "# Instructions"
            echo "1. Read relevant templates from .github/claude-templates/ first"
            echo "2. Complete the task described above"
            echo "3. Follow the guidelines from the templates"
            echo "4. Make commits as you work with descriptive messages"
            echo "5. IMPORTANT: End every commit message with: Co-authored-by: Claude <noreply@anthropic.com>"
            echo "6. Ensure code passes linting and type checks before finishing"
            echo "7. When done, output a PR title on a single line starting with 'PR_TITLE:' (e.g. 'PR_TITLE: fix: Update smithy dependency to resolve CVE')"
            echo ""
            echo "# Token Optimization"
            echo "When running lint/typecheck, suppress verbose output:"
            echo "  pnpm lint 2>&1 | tail -30"
            echo "  pnpm typecheck 2>&1 | tail -30"
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: Run Claude
        id: claude
        uses: anthropics/claude-code-action@1b8ee3b94104046d71fde52ec3557651ad8c0d71 # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          prompt: ${{ env.CLAUDE_PROMPT }}
          claude_args: |
            --allowedTools Bash,Read,Write,Edit,Glob,Grep,WebFetch,WebSearch,TodoWrite

      - name: Push branch
        shell: bash
        env:
          INPUT_BASE_BRANCH: ${{ inputs.base_branch }}
          BRANCH_NAME: ${{ steps.branch.outputs.name }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Configure git to use app token for push
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          # Check if there are any commits to push
          if git log "origin/$INPUT_BASE_BRANCH..HEAD" --oneline | grep -q .; then
            git push -u origin "$BRANCH_NAME"
            echo "CHANGES_MADE=true" >> "$GITHUB_ENV"
          else
            echo "No commits were made by Claude"
            echo "CHANGES_MADE=false" >> "$GITHUB_ENV"
          fi

      - name: Create Pull Request
        if: inputs.create_pr && env.CHANGES_MADE == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          INPUT_TASK: ${{ inputs.task }}
          INPUT_BASE_BRANCH: ${{ inputs.base_branch }}
          BRANCH_NAME: ${{ steps.branch.outputs.name }}
          TRIGGERED_BY: ${{ github.actor }}
          CLAUDE_CONCLUSION: ${{ steps.claude.outputs.conclusion }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Extract PR title from Claude's output (looks for PR_TITLE: prefix)
          PR_TITLE=$(echo "$CLAUDE_CONCLUSION" | grep -oP 'PR_TITLE:\s*\K.*' | head -1 || echo "")

          # Fallback to generic title if Claude didn't provide one
          if [ -z "$PR_TITLE" ]; then
            PR_TITLE="chore: Claude automated task (run ${{ github.run_id }})"
          fi

          # Create PR with task description in body
          gh pr create \
            --title "$PR_TITLE" \
            --body "## Summary
          Automated task completed by Claude.

          ### Task Description
          $INPUT_TASK

          ### Generated by
          [Workflow Run #${{ github.run_id }}]($RUN_URL)

          ---
          *Triggered by @$TRIGGERED_BY via the Claude Task Runner workflow.*" \
            --base "$INPUT_BASE_BRANCH"

      - name: Summary
        shell: bash
        env:
          INPUT_TASK: ${{ inputs.task }}
          INPUT_CREATE_PR: ${{ inputs.create_pr }}
          BRANCH_NAME: ${{ steps.branch.outputs.name }}
        run: |
          {
            echo "## Claude Task Runner Summary"
            echo ""
            echo "**Task:** $INPUT_TASK"
            echo "**Branch:** $BRANCH_NAME"
            echo "**Changes Made:** $CHANGES_MADE"
            if [ "$CHANGES_MADE" == "true" ] && [ "$INPUT_CREATE_PR" == "true" ]; then
              echo "**PR Created:** Yes (Draft)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
