name: Playwright Tests - Reusable

on:
  workflow_call:
    inputs:
      branch:
        description: 'GitHub branch to test.'
        required: false
        type: string
      test-mode:
        description: 'Test mode: local (pnpm start from local), docker-build, or docker-pull'
        required: false
        default: 'local'
        type: string
      test-command:
        description: 'Test command to run'
        required: false
        default: 'pnpm --filter=n8n-playwright test:local'
        type: string
      shards:
        description: 'Shards for parallel execution'
        required: false
        default: '[1, 2, 3, 4, 5, 6, 7, 8]'
        type: string
      docker-image:
        description: 'Docker image to use (for docker-pull mode)'
        required: false
        default: 'n8nio/n8n:nightly'
        type: string
      workers:
        description: 'Number of parallel workers'
        required: false
        default: ''
        type: string
      runner:
        description: 'GitHub runner to use'
        required: false
        default: 'blacksmith-2vcpu-ubuntu-2204'
        type: string

    secrets:
      CURRENTS_RECORD_KEY:
        required: false
      QA_PERFORMANCE_METRICS_WEBHOOK_URL:
        required: false
      QA_PERFORMANCE_METRICS_WEBHOOK_USER:
        required: false
      QA_PERFORMANCE_METRICS_WEBHOOK_PASSWORD:
        required: false
      N8N_LICENSE_ACTIVATION_KEY:
        required: false
      N8N_ENCRYPTION_KEY:
        required: false

env:
  PLAYWRIGHT_BROWSERS_PATH: ms-playwright-cache
  NODE_OPTIONS: --max-old-space-size=3072
  # Disable Ryuk to avoid issues with Docker since it needs privileged access, containers are cleaned on teardown anyway
  TESTCONTAINERS_RYUK_DISABLED: true
  PLAYWRIGHT_WORKERS: ${{ inputs.workers || '2' }}
  # Must match CI's COVERAGE_ENABLED to ensure Turbo cache hits (it's a globalEnv in turbo.json)
  COVERAGE_ENABLED: 'true'

jobs:
  test:
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJSON(inputs.shards || '[1, 2, 3, 4, 5, 6, 7, 8]') }}
    name: Test (Machine ${{ matrix.shard }})

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          ref: ${{ inputs.branch || github.ref }}

      - name: Setup Environment
        uses: ./.github/actions/setup-nodejs-blacksmith
        with:
          build-command: ${{ inputs.test-mode == 'docker-build' && 'pnpm build:docker' || 'pnpm turbo build:playwright' }}
          enable-docker-cache: ${{ inputs.test-mode != 'local' }}
        env:
          INCLUDE_TEST_CONTROLLER: ${{ inputs.test-mode == 'docker-build' && 'true' || '' }}

      - name: Install Browsers
        run: pnpm turbo install-browsers:ci

      - name: Pre-pull Test Container Images
        if: ${{ !contains(inputs.test-command, 'test:local') }}
        run: |
          # Pre-pull all test container images to avoid network changes during test execution
          npx tsx packages/testing/containers/pull-test-images.ts || true
        env:
          N8N_DOCKER_IMAGE: ${{ inputs.test-mode == 'docker-build' && 'n8nio/n8n:local' || inputs.docker-image }}

      - name: Prepare Test Image
        if: inputs.test-mode == 'docker-pull'
        run: pnpm --filter=n8n-playwright prepare-test-image ${{ inputs.docker-image }}

      - name: Run Tests
        run: |
          if echo "${{ inputs.test-command }}" | grep -q "pwc-p"; then
            ${{ inputs.test-command }} --workers=${{ env.PLAYWRIGHT_WORKERS }}
          else
            ${{ inputs.test-command }} --shard=${{ matrix.shard }}/${{ strategy.job-total }} --workers=${{ env.PLAYWRIGHT_WORKERS }}
          fi
        env:
          N8N_DOCKER_IMAGE: ${{ inputs.test-mode == 'docker-build' && 'n8nio/n8n:local' || inputs.docker-image }}
          CURRENTS_RECORD_KEY: ${{ secrets.CURRENTS_RECORD_KEY }}
          PLAYWRIGHT_WORKERS: ${{ env.PLAYWRIGHT_WORKERS }}
          QA_PERFORMANCE_METRICS_WEBHOOK_URL: ${{ secrets.QA_PERFORMANCE_METRICS_WEBHOOK_URL }}
          QA_PERFORMANCE_METRICS_WEBHOOK_USER: ${{ secrets.QA_PERFORMANCE_METRICS_WEBHOOK_USER }}
          QA_PERFORMANCE_METRICS_WEBHOOK_PASSWORD: ${{ secrets.QA_PERFORMANCE_METRICS_WEBHOOK_PASSWORD }}
          N8N_LICENSE_ACTIVATION_KEY: ${{ secrets.N8N_LICENSE_ACTIVATION_KEY }}
