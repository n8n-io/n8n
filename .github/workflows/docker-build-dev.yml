name: 'Docker: Build Dev Image'

# This workflow builds a Docker image for development branches
# and pushes it to GitHub Container Registry (GHCR)
# Images are tagged as: ghcr.io/OWNER/n8n:branch-BRANCH_NAME

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build (defaults to current branch)'
        required: false
        type: string
      push_to_registry:
        description: 'Push image to GHCR'
        required: false
        type: boolean
        default: true

  push:
    branches:
      - 'master'
    paths:
      - 'packages/**'
      - 'docker/images/n8n/**'
      - '.github/workflows/docker-build-dev.yml'

env:
  NODE_OPTIONS: '--max-old-space-size=7168'
  NODE_VERSION: '22.21.0'

jobs:
  build-dev-image:
    name: Build Dev Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}
          fetch-depth: 0

      - name: Determine branch name and tags
        id: vars
        run: |
          # Get branch name
          if [[ -n "${{ inputs.branch }}" ]]; then
            BRANCH_NAME="${{ inputs.branch }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi

          # Sanitize branch name for Docker tag
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | tr '/' '-' | tr -cd '[:alnum:]-_')

          echo "branch=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          echo "safe_branch=$SAFE_BRANCH" >> "$GITHUB_OUTPUT"
          echo "image_tag=ghcr.io/${{ github.repository_owner }}/n8n:branch-$SAFE_BRANCH" >> "$GITHUB_OUTPUT"

          echo "Building branch: $BRANCH_NAME"
          echo "Docker tag: ghcr.io/${{ github.repository_owner }}/n8n:branch-$SAFE_BRANCH"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build:n8n

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/images/n8n/Dockerfile
          platforms: linux/amd64
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            N8N_VERSION=branch-${{ steps.vars.outputs.safe_branch }}
            N8N_RELEASE_TYPE=dev
          push: true
          tags: ${{ steps.vars.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image info
        if: success()
        run: |
          echo "### âœ… Docker Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ steps.vars.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.vars.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Use this image in docker-compose:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "services:" >> $GITHUB_STEP_SUMMARY
          echo "  n8n:" >> $GITHUB_STEP_SUMMARY
          echo "    image: ${{ steps.vars.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Pull the image:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.vars.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
