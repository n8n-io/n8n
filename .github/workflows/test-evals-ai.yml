name: 'Test: Evals AI'

on:
  push:
    branches:
      - master
    paths:
      - 'packages/@n8n/ai-workflow-builder.ee/**'
      - '.github/workflows/test-evals-ai.yml'
      - '.github/workflows/test-evals-ai-reusable.yml'
  schedule:
    - cron: '0 22 * * 6'
  workflow_dispatch:
    inputs:
      branch:
        description: 'GitHub branch to test.'
        required: false
        default: 'master'
      dataset:
        description: 'LangSmith dataset to use.'
        required: false
        default: 'workflow-builder-canvas-prompts'
      repetitions:
        description: 'Number of repetitions to run.'
        required: false
        default: '3'
      num_judges:
        description: 'Number of judges to use.'
        required: false
        default: '3'

jobs:
  determine-config:
    name: Determine Configuration
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.config.outputs.branch }}
      dataset: ${{ steps.config.outputs.dataset }}
      repetitions: ${{ steps.config.outputs.repetitions }}
      num_judges: ${{ steps.config.outputs.num_judges }}
      experiment_prefix: ${{ steps.config.outputs.experiment_prefix }}
    steps:
      - name: Set configuration based on trigger
        id: config
        run: |
          EVENT_NAME="${{ github.event_name }}"

          if [ "$EVENT_NAME" = "push" ]; then
            # Merge to master: lighter config (1 rep, 1 judge)
            {
              echo "branch=${{ github.ref_name }}"
              echo "dataset=workflow-builder-canvas-prompts"
              echo "repetitions=1"
              echo "num_judges=1"
              echo "experiment_prefix="
            } >> "$GITHUB_OUTPUT"
          elif [ "$EVENT_NAME" = "schedule" ]; then
            # Scheduled run: full config (3 reps, 3 judges)
            {
              echo "branch=master"
              echo "dataset=prompts-v2"
              echo "repetitions=3"
              echo "num_judges=3"
              echo "experiment_prefix=CI_scheduled"
            } >> "$GITHUB_OUTPUT"
          else
            # Manual dispatch: use provided values
            {
              echo "branch=${{ inputs.branch || 'master' }}"
              echo "dataset=${{ inputs.dataset || 'workflow-builder-canvas-prompts' }}"
              echo "repetitions=${{ inputs.repetitions || '3' }}"
              echo "num_judges=${{ inputs.num_judges || '3' }}"
              echo "experiment_prefix=CI_manual"
            } >> "$GITHUB_OUTPUT"
          fi

  run-evals:
    name: Run Evaluations
    needs: determine-config
    uses: ./.github/workflows/test-evals-ai-reusable.yml
    with:
      branch: ${{ needs.determine-config.outputs.branch }}
      dataset: ${{ needs.determine-config.outputs.dataset }}
      repetitions: ${{ fromJson(needs.determine-config.outputs.repetitions) }}
      num_judges: ${{ fromJson(needs.determine-config.outputs.num_judges) }}
      experiment_name_prefix: ${{ needs.determine-config.outputs.experiment_prefix }}
    secrets: inherit
