name: 'Util: Cleanup PR Docker Images'

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: 'Delete PR images'
    if: ${{ !github.event.pull_request.head.repo.fork }}
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Delete all images for this PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          echo "Cleaning up images for PR #$PR_NUMBER..."

          # Fetch all versions with pr-{number}-* tags
          VERSIONS=$(gh api /orgs/n8n-io/packages/container/n8n/versions \
            --paginate \
            --jq ".[] | select(.metadata.container.tags | any(startswith(\"pr-${PR_NUMBER}-\"))) | {id, tags: .metadata.container.tags}" \
          ) || { echo "No images found or API error"; exit 0; }

          if [ -z "$VERSIONS" ]; then
            echo "No images found for PR #$PR_NUMBER"
            exit 0
          fi

          while IFS= read -r version; do
            [ -z "$version" ] && continue

            ID=$(echo "$version" | jq -r '.id')
            TAGS=$(echo "$version" | jq -r '.tags | join(", ")')

            echo "Deleting: $TAGS"
            gh api --method DELETE "/orgs/n8n-io/packages/container/n8n/versions/$ID" || echo "  Failed"
          done <<< "$VERSIONS"

          echo "Cleanup complete"
