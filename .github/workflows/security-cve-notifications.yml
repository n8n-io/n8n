# ============================================================================
# CVE Notification System - Alert on New Critical Vulnerabilities
# ============================================================================
#
# This workflow checks for new CVEs in n8n and sends notifications
# when CRITICAL vulnerabilities are discovered.
#
# Runs: Every 6 hours
# Notifications: GitHub Issues (can be extended to Discord/Slack)
# ============================================================================

name: Security - CVE Notifications

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

  workflow_dispatch:

permissions:
  contents: read
  issues: write  # For creating GitHub Issues

jobs:
  # ===================================
  # CVE Monitoring Job
  # ===================================
  check-cves:
    name: Check for New CVEs
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ----- Check NVD for n8n CVEs -----
      - name: Check NVD Database for n8n CVEs
        id: nvd-check
        continue-on-error: true
        run: |
          echo "Checking NVD for n8n vulnerabilities..."

          # Query NVD API for n8n CVEs from last 7 days
          RESPONSE=$(curl -s "https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=n8n&resultsPerPage=20" || echo "")

          if [ -z "$RESPONSE" ]; then
            echo "Failed to fetch CVE data from NVD"
            echo "has_cves=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Parse for CRITICAL CVEs (CVSS >= 9.0)
          CRITICAL_CVES=$(echo "$RESPONSE" | jq -r '
            .vulnerabilities[]? |
            select(
              .cve.metrics.cvssMetricV31[]?.cvssData.baseScore >= 9.0 or
              .cve.metrics.cvssMetricV30[]?.cvssData.baseScore >= 9.0
            ) |
            {
              id: .cve.id,
              score: (.cve.metrics.cvssMetricV31[0]?.cvssData.baseScore // .cve.metrics.cvssMetricV30[0]?.cvssData.baseScore),
              description: .cve.descriptions[0]?.value
            } |
            "\(.id) (CVSS \(.score))"
          ' 2>/dev/null || echo "")

          if [ ! -z "$CRITICAL_CVES" ]; then
            echo "Critical CVEs found!"
            echo "$CRITICAL_CVES"
            echo "has_cves=true" >> $GITHUB_OUTPUT
            echo "cves<<EOF" >> $GITHUB_OUTPUT
            echo "$CRITICAL_CVES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "No critical CVEs found"
            echo "has_cves=false" >> $GITHUB_OUTPUT
          fi

      # ----- Check GitHub Security Advisories -----
      - name: Check GitHub Security Advisories
        id: ghsa-check
        continue-on-error: true
        run: |
          echo "Checking GitHub Security Advisories..."

          # Query GitHub GraphQL API for n8n security advisories
          QUERY='{"query":"{ securityVulnerabilities(first: 10, ecosystem: NPM, package: \"n8n\") { nodes { advisory { ghsaId severity publishedAt summary } firstPatchedVersion { identifier } } } }"}'

          RESPONSE=$(curl -s -H "Authorization: bearer ${{ secrets.GITHUB_TOKEN }}" \
            -X POST \
            -d "$QUERY" \
            https://api.github.com/graphql 2>/dev/null || echo "")

          if [ ! -z "$RESPONSE" ]; then
            echo "GHSA Response:"
            echo "$RESPONSE" | jq -r '.data.securityVulnerabilities.nodes[]? | "\(.advisory.ghsaId) - \(.advisory.severity)"' | head -5
          fi

      # ----- Create GitHub Issue for Critical CVEs -----
      - name: Create GitHub Issue
        if: steps.nvd-check.outputs.has_cves == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const cves = `${{ steps.nvd-check.outputs.cves }}`;
            const issueTitle = 'ðŸš¨ CRITICAL CVE Alert - n8n Vulnerabilities Detected';
            const issueBody = `
            ## Critical CVE Alert

            New CRITICAL vulnerabilities have been detected in n8n:

            \`\`\`
            ${cves}
            \`\`\`

            ### Immediate Actions Required:

            1. **Check version**: Verify current n8n version in \`package.json\`
            2. **Sync upstream**: Run upstream sync to get latest patches
               \`\`\`bash
               git fetch upstream master
               git merge upstream/master
               \`\`\`
            3. **Review Dependabot PRs**: Check for available security patches
            4. **Do NOT deploy** until vulnerabilities are patched

            ### Resources:
            - [NVD Database](https://nvd.nist.gov/vuln/search/results?form_type=Basic&results_type=overview&query=n8n)
            - [GitHub Security Advisories](https://github.com/n8n-io/n8n/security/advisories)
            - [n8n Releases](https://github.com/n8n-io/n8n/releases)

            ### Auto-generated by workflow
            This issue was created automatically by the CVE monitoring system.
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            **Labels**: security, critical, automated
            `;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'critical,security',
              per_page: 10
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('CRITICAL CVE Alert')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Updated CVE Alert\n\n${issueBody}`
              });
              console.log('Updated existing issue:', existingIssue.html_url);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['security', 'critical', 'automated']
              });
              console.log('Created new issue:', issue.data.html_url);
            }

# ============================================================================
# EXTENDING WITH DISCORD/SLACK NOTIFICATIONS
# ============================================================================
#
# To add Discord notifications:
#
# 1. Create Discord Webhook:
#    - Server Settings > Integrations > Webhooks > New Webhook
#    - Copy Webhook URL
#
# 2. Add webhook as GitHub Secret:
#    - Settings > Secrets > Actions > New secret
#    - Name: DISCORD_WEBHOOK
#    - Value: Your webhook URL
#
# 3. Add this step after "Create GitHub Issue":
#
#   - name: Send Discord notification
#     if: steps.nvd-check.outputs.has_cves == 'true'
#     run: |
#       curl -H "Content-Type: application/json" \
#         -d '{
#           "content": "ðŸš¨ **CRITICAL CVE ALERT**",
#           "embeds": [{
#             "title": "n8n Security Vulnerabilities Detected",
#             "description": "${{ steps.nvd-check.outputs.cves }}",
#             "color": 15158332,
#             "fields": [{
#               "name": "Action Required",
#               "value": "Check GitHub Issues for details"
#             }]
#           }]
#         }' \
#         ${{ secrets.DISCORD_WEBHOOK }}
#
# ============================================================================
# EXTENDING WITH SLACK NOTIFICATIONS
# ============================================================================
#
# To add Slack notifications:
#
# 1. Create Slack Incoming Webhook:
#    - https://api.slack.com/messaging/webhooks
#
# 2. Add webhook as GitHub Secret:
#    - Name: SLACK_WEBHOOK
#    - Value: Your webhook URL
#
# 3. Add this step:
#
#   - name: Send Slack notification
#     if: steps.nvd-check.outputs.has_cves == 'true'
#     run: |
#       curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
#         -H 'Content-Type: application/json' \
#         -d '{
#           "text": "ðŸš¨ CRITICAL CVE Alert - n8n",
#           "blocks": [{
#             "type": "section",
#             "text": {
#               "type": "mrkdwn",
#               "text": "*Critical vulnerabilities detected in n8n:*\n```${{ steps.nvd-check.outputs.cves }}```"
#             }
#           }]
#         }'
#
# ============================================================================
