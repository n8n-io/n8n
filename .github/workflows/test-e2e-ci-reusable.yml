name: 'Test: E2E CI'

on:
  workflow_call:
    inputs:
      branch:
        description: 'GitHub branch/ref to test'
        required: false
        type: string
        default: ''

jobs:
  # E2E tests for internal PRs (not community/fork PRs)
  # Runs in local mode with SQLite
  e2e:
    name: 'E2E'
    if: ${{ !github.event.pull_request.head.repo.fork }}
    uses: ./.github/workflows/test-e2e-reusable.yml
    with:
      branch: ${{ inputs.branch }}
      test-mode: local
      test-command: pnpm --filter=n8n-playwright test:local:e2e-only
      shards: 6
      runner: blacksmith-2vcpu-ubuntu-2204
    secrets: inherit

  e2e-isolated:
    name: 'E2E: Isolated'
    if: ${{ !github.event.pull_request.head.repo.fork }}
    uses: ./.github/workflows/test-e2e-reusable.yml
    with:
      branch: ${{ inputs.branch }}
      test-mode: local
      test-command: pnpm --filter=n8n-playwright test:local:isolated
      shards: 2
      runner: blacksmith-2vcpu-ubuntu-2204
    secrets: inherit

  # Community PR tests: Local mode with SQLite (no container building, no secrets required)
  # Runs on GitHub-hosted runners without Currents reporting
  community-e2e:
    name: 'Community: E2E'
    if: ${{ github.event.pull_request.head.repo.fork }}
    uses: ./.github/workflows/test-e2e-reusable.yml
    with:
      branch: ${{ inputs.branch }}
      test-mode: local
      test-command: pnpm --filter=n8n-playwright test:local:e2e-only
      shards: 6
      runner: ubuntu-latest
      workers: '1'
      upload-failure-artifacts: true

  community-isolated:
    name: 'Community: Isolated'
    if: ${{ github.event.pull_request.head.repo.fork }}
    uses: ./.github/workflows/test-e2e-reusable.yml
    with:
      branch: ${{ inputs.branch }}
      test-mode: local
      test-command: pnpm --filter=n8n-playwright test:local:isolated
      shards: 2
      runner: ubuntu-latest
      workers: '1'
      upload-failure-artifacts: true
