name: 'Blacksmith Node.js Build Setup'
description: 'Configures Node.js with pnpm, installs dependencies, enables Turborepo caching, (optional) sets up Docker layer caching, and builds the project or an optional command.'

inputs:
  node-version:
    description: 'Node.js version to use. Uses latest 22.x by default.'
    required: false
    default: '22.x'
  enable-docker-cache:
    description: 'Whether to set up Blacksmith Buildx for Docker layer caching.'
    required: false
    default: 'false'
    type: boolean
  build-command:
    description: 'Command to execute for building the project or an optional command. Leave empty to skip build step.'
    required: false
    default: 'pnpm build'
    type: string

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: useblacksmith/setup-node@65c6ca86fdeb0ab3d85e78f57e4f6a7e4780b391 # v5.0.4
      with:
        node-version: ${{ inputs.node-version }}

    - name: Setup pnpm and Install Dependencies
      uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
      with:
        run_install: true

    # - name: Configure Turborepo Cache
    #   uses: useblacksmith/caching-for-turbo@bafb57e7ebdbf1185762286ec94d24648cd3938a # v1

    - name: Start MinIO
      run: |
        docker run -d \
          --name minio \
          -p 9000:9000 \
          -e MINIO_ROOT_USER=minioadmin \
          -e MINIO_ROOT_PASSWORD=minioadmin123 \
          minio/minio server /data

        # Wait for MinIO to be ready
        sleep 5

        # Create the bucket
        docker run --rm \
          --network host \
          minio/mc \
          alias set local http://localhost:9000 minioadmin minioadmin123

        docker run --rm \
          --network host \
          minio/mc \
          mb local/turborepo-cache --ignore-existing
      shell: bash

    - name: Turborepo Cache Server
      # ALWAYS use a pinned version of the action
      # As we don't ship the latest versions of the binary on the main branch
      # PLEASE see the latest versions here:
      # https://github.com/brunojppb/turbo-cache-server/releases
      uses: brunojppb/turbo-cache-server@952f44334c0b4c914d755a4a5d5ea535c83f02ed # 2.0.6
      env:
        PORT: '8585'
        S3_BUCKET_NAME: 'turborepo-cache'
        # Region defaults to "eu-central-1"
        S3_REGION: 'us-east-1'
        # Optional: If you need to provide specific auth keys, separate from default AWS credentials
        S3_ACCESS_KEY: 'minioadmin'
        S3_SECRET_KEY: 'minioadmin123'
        # Optional: If not using AWS, provide endpoint like `https://minio` for your instance.
        S3_ENDPOINT: 'http://localhost:9000'
        # Optional: If your S3-compatible store does not support requests
        # like https://bucket.hostname.domain/. Setting `S3_USE_PATH_STYLE`
        # to true configures the S3 client to make requests like
        # https://hostname.domain/bucket instead.
        # Defaults to "false"
        S3_USE_PATH_STYLE: 'true'
        # Max payload size for each cache object sent by Turborepo
        # Defaults to 100 MB
        # Requests larger than that, will get "HTTP 413: Entity Too Large" errors
        MAX_PAYLOAD_SIZE_IN_MB: '100'
        TURBO_TOKEN: 'secret-turbo-token'

    - name: Setup Docker Builder for Docker Cache
      if: ${{ inputs.enable-docker-cache == 'true' }}
      uses: useblacksmith/setup-docker-builder@0b434dfbb431f4e3a2bcee7a773a56bd363184c5 # v1

    - name: Build Project
      run: ${{ inputs.build-command }}
      shell: bash
      env:
        TURBO_API: 'http://localhost:8585'
        TURBO_TEAM: 'NAME_OF_YOUR_REPO_HERE'
        # The value of TURBO_TOKEN will be checked by the cache server
        TURBO_TOKEN: 'secret-turbo-token'

    - name: Build Project
      run: ${{ inputs.build-command }}
      shell: bash
      env:
        TURBO_API: 'http://127.0.0.1:8585'
        TURBO_TEAM: 'turborepo-cache'
        # The value of TURBO_TOKEN will be checked by the cache server
        TURBO_TOKEN: 'secret-turbo-token'
