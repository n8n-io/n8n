<script lang="ts" setup>
import { computed, ref, useCssModule } from 'vue';
import { useAsyncState } from '@vueuse/core';
import { ElSwitch } from 'element-plus';
import { N8nHeading, N8nText } from '@n8n/design-system';
import { useI18n } from '@n8n/i18n';
import { useRootStore } from '@n8n/stores/useRootStore';
import { useToast } from '@/app/composables/useToast';
import * as securitySettingsApi from '@n8n/rest-api-client/api/security-settings';
import type { UpdateSecuritySettingsDto } from '@n8n/api-types';
import { useMessage } from '@/app/composables/useMessage';
import { MODAL_CONFIRM } from '@/app/constants/modals';

const $style = useCssModule();
const rootStore = useRootStore();
const i18n = useI18n();
const { showToast, showError } = useToast();
const message = useMessage();
const pendingSecuritySettingUpdate = ref({
	personalSpacePublishing: false,
	personalSpaceSharing: false,
});

const { state, isLoading } = useAsyncState(async () => {
	const settings = await securitySettingsApi.getSecuritySettings(rootStore.restApiContext);
	return settings;
}, undefined);

const personalSpacePublishing = computed({
	get: () => state.value?.personalSpacePublishing ?? false,
	set: async (value: boolean) => {
		if (!value) {
			const confirmDisablingPublishing = await promptConfirmDisablingPersonalSpacePublishing();
			if (confirmDisablingPublishing !== MODAL_CONFIRM) {
				return;
			}
		}

		pendingSecuritySettingUpdate.value.personalSpacePublishing = true;
		await updateSecuritySettings({ personalSpacePublishing: value });
	},
});

const personalSpaceSharing = computed({
	get: () => state.value?.personalSpaceSharing ?? false,
	set: async (value: boolean) => {
		if (!value) {
			const confirmDisablingSharing = await promptConfirmDisablingPersonalSpaceSharing();
			if (confirmDisablingSharing !== MODAL_CONFIRM) {
				return;
			}
		}

		pendingSecuritySettingUpdate.value.personalSpaceSharing = true;
		await updateSecuritySettings({ personalSpaceSharing: value });
	},
});

async function promptConfirmDisablingPersonalSpacePublishing() {
	const confirmAction = await message.confirm(
		i18n.baseText('settings.security.personalSpace.publishing.confirmMessage.disable.message'),
		i18n.baseText('settings.security.personalSpace.publishing.confirmMessage.disable.headline'),
		{
			cancelButtonText: i18n.baseText('generic.cancel'),
			confirmButtonText: i18n.baseText('generic.confirm'),
		},
	);
	return confirmAction;
}

async function promptConfirmDisablingPersonalSpaceSharing() {
	const confirmAction = await message.confirm(
		i18n.baseText('settings.security.personalSpace.sharing.confirmMessage.disable.message'),
		i18n.baseText('settings.security.personalSpace.sharing.confirmMessage.disable.headline'),
		{
			cancelButtonText: i18n.baseText('generic.cancel'),
			confirmButtonText: i18n.baseText('generic.confirm'),
		},
	);
	return confirmAction;
}

async function updateSecuritySettings(updatedSetting: Partial<UpdateSecuritySettingsDto>) {
	const { personalSpacePublishing, personalSpaceSharing } = updatedSetting;
	const tooltipMessageNamespace = personalSpacePublishing !== undefined ? 'publishing' : 'sharing';
	try {
		const data: UpdateSecuritySettingsDto = {
			personalSpacePublishing: personalSpacePublishing ?? state.value!.personalSpacePublishing,
			personalSpaceSharing: personalSpaceSharing ?? state.value!.personalSpaceSharing,
		};

		state.value = await securitySettingsApi.updateSecuritySettings(rootStore.restApiContext, data);

		const isEnablingSetting = Object.values(updatedSetting)[0];
		const tooltipTitleKey = isEnablingSetting
			? `settings.security.personalSpace.${tooltipMessageNamespace}.success.enabled`
			: `settings.security.personalSpace.${tooltipMessageNamespace}.success.disabled`;
		showToast({
			type: 'success',
			title: i18n.baseText(tooltipTitleKey),
			message: '',
		});
	} catch (error) {
		showError(
			error,
			i18n.baseText(`settings.security.personalSpace.${tooltipMessageNamespace}.error`),
		);
	} finally {
		pendingSecuritySettingUpdate.value = {
			personalSpacePublishing: false,
			personalSpaceSharing: false,
		};
	}
}
</script>

<template>
	<div :class="$style.container">
		<N8nHeading tag="h1" size="2xlarge" class="mb-xl">
			{{ i18n.baseText('settings.security') }}
		</N8nHeading>

		<N8nHeading tag="h2" size="large" class="mb-l">
			{{ i18n.baseText('settings.security.personalSpace.title') }}
		</N8nHeading>

		<div :class="$style.settingsContainer">
			<div :class="$style.settingsContainerInfo">
				<N8nText :bold="true">{{
					i18n.baseText('settings.security.personalSpace.sharing.title')
				}}</N8nText>
				<N8nText size="small" color="text-light">
					{{ i18n.baseText('settings.security.personalSpace.sharing.description') }}
				</N8nText>
			</div>
			<div :class="$style.settingsContainerAction">
				<ElSwitch
					v-model="personalSpaceSharing"
					:loading="isLoading || pendingSecuritySettingUpdate.personalSpaceSharing"
					size="large"
					data-test-id="security-personal-space-sharing-toggle"
				/>
			</div>
		</div>
		<div :class="$style.settingsContainer">
			<div :class="$style.settingsContainerInfo">
				<N8nText :bold="true">
					{{ i18n.baseText('settings.security.personalSpace.publishing.title') }}
				</N8nText>
				<N8nText size="small" color="text-light">
					{{ i18n.baseText('settings.security.personalSpace.publishing.description') }}
				</N8nText>
			</div>
			<div :class="$style.settingsContainerAction">
				<ElSwitch
					v-model="personalSpacePublishing"
					:loading="isLoading || pendingSecuritySettingUpdate.personalSpaceSharing"
					size="large"
					data-test-id="security-personal-space-publishing-toggle"
				/>
			</div>
		</div>
	</div>
</template>

<style module>
.container {
	padding-bottom: var(--spacing--md);
}

.settingsContainer {
	display: flex;
	align-items: center;
	padding-left: var(--spacing--sm);
	margin-bottom: var(--spacing--lg);
	justify-content: space-between;
	flex-shrink: 0;
	border-radius: var(--radius);
	border: var(--border-width) var(--border-style) var(--color--foreground);
	max-width: 600px;
}

.settingsContainerInfo {
	display: flex;
	padding: var(--spacing--2xs) 0;
	flex-direction: column;
	justify-content: center;
	align-items: flex-start;
	gap: var(--spacing--5xs);
	flex: 1;
	min-width: 0;
}

.settingsContainerAction {
	display: flex;
	padding: var(--spacing--md) var(--spacing--sm);
	justify-content: flex-end;
	align-items: center;
	flex-shrink: 0;
}
</style>
