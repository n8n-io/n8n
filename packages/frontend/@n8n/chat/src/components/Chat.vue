<script setup lang="ts">
import Close from 'virtual:icons/mdi/close';
import { computed, nextTick, onMounted, ref } from 'vue';

import GetStarted from '@n8n/chat/components/GetStarted.vue';
import GetStartedFooter from '@n8n/chat/components/GetStartedFooter.vue';
import Input from '@n8n/chat/components/Input.vue';
import type { ArrowKeyDownPayload } from '@n8n/chat/components/Input.vue';
import Layout from '@n8n/chat/components/Layout.vue';
import MessagesList from '@n8n/chat/components/MessagesList.vue';
import { useI18n, useChat, useOptions } from '@n8n/chat/composables';
import { chatEventBus } from '@n8n/chat/event-buses';

const { t } = useI18n();
const chatStore = useChat();

const { messages, currentSessionId } = chatStore;
const { options } = useOptions();

const showCloseButton = computed(() => options.mode === 'window' && options.showWindowCloseButton);

// Message history navigation
const messageHistoryIndex = ref(-1);
const currentInputBuffer = ref('');
const userMessages = computed(() =>
	messages.value
		.filter((m) => m.sender === 'user')
		.map((m) => ('text' in m && typeof m.text === 'string' ? m.text : '')),
);

function getStarted() {
	if (!chatStore.startNewSession) {
		return;
	}
	void chatStore.startNewSession();
	void nextTick(() => {
		chatEventBus.emit('scrollToBottom');
	});
}

async function initialize() {
	if (!chatStore.loadPreviousSession) {
		return;
	}
	await chatStore.loadPreviousSession();
	void nextTick(() => {
		chatEventBus.emit('scrollToBottom');
	});
}

function closeChat() {
	chatEventBus.emit('close');
}

function onArrowKeyDown(payload: ArrowKeyDownPayload) {
	const userMessagesList = userMessages.value;

	if (userMessagesList.length === 0) {
		return;
	}

	// Save current input if we're starting navigation
	if (messageHistoryIndex.value === -1 && payload.currentInputValue.length > 0) {
		currentInputBuffer.value = payload.currentInputValue;
	}

	if (payload.key === 'ArrowUp') {
		// Temporarily blur to avoid cursor position issues
		chatEventBus.emit('blurInput');

		// Navigate to previous message
		if (messageHistoryIndex.value < userMessagesList.length - 1) {
			messageHistoryIndex.value++;
			const messageText = userMessagesList[userMessagesList.length - 1 - messageHistoryIndex.value];
			chatEventBus.emit('setInputValue', messageText);
		}

		// Refocus and move cursor to end
		chatEventBus.emit('focusInput');
	} else if (payload.key === 'ArrowDown') {
		// Only navigate if we're in history mode
		if (messageHistoryIndex.value === -1) return;

		// Temporarily blur to avoid cursor position issues
		chatEventBus.emit('blurInput');

		// Navigate to next message or restore original input
		if (messageHistoryIndex.value > 0) {
			messageHistoryIndex.value--;
			const messageText = userMessagesList[userMessagesList.length - 1 - messageHistoryIndex.value];
			chatEventBus.emit('setInputValue', messageText);
		} else if (messageHistoryIndex.value === 0) {
			// Reached the end - restore original input or clear
			messageHistoryIndex.value = -1;
			chatEventBus.emit('setInputValue', currentInputBuffer.value);
			currentInputBuffer.value = '';
		}

		// Refocus and move cursor to end
		chatEventBus.emit('focusInput');
	}
}

function onEscapeKeyDown() {
	// Only handle escape if we're in history navigation mode
	if (messageHistoryIndex.value === -1) return;

	// Exit history mode and restore original input
	messageHistoryIndex.value = -1;
	chatEventBus.emit('setInputValue', currentInputBuffer.value);
	currentInputBuffer.value = '';
}

onMounted(async () => {
	await initialize();
	if (!options.showWelcomeScreen && !currentSessionId.value) {
		getStarted();
	}

	// Reset history index and buffer when a new message is sent
	chatEventBus.on('messageSent', () => {
		messageHistoryIndex.value = -1;
		currentInputBuffer.value = '';
	});
});
</script>

<template>
	<Layout class="chat-wrapper">
		<template #header>
			<div class="chat-heading">
				<h1>
					{{ t('title') }}
				</h1>
				<button
					v-if="showCloseButton"
					class="chat-close-button"
					:title="t('closeButtonTooltip')"
					@click="closeChat"
				>
					<Close height="18" width="18" />
				</button>
			</div>
			<p v-if="t('subtitle')">{{ t('subtitle') }}</p>
		</template>
		<GetStarted v-if="!currentSessionId && options.showWelcomeScreen" @click:button="getStarted" />
		<MessagesList v-else :messages="messages" />
		<template #footer>
			<Input
				v-if="currentSessionId"
				@arrow-key-down="onArrowKeyDown"
				@escape-key-down="onEscapeKeyDown"
			/>
			<GetStartedFooter v-else />
		</template>
	</Layout>
</template>

<style lang="scss">
.chat-heading {
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.chat-close-button {
	display: flex;
	border: none;
	background: none;
	cursor: pointer;

	&:hover {
		color: var(--chat--close--button--color-hover, var(--chat--color--primary));
	}
}
</style>
