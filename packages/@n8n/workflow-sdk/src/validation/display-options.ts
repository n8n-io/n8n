/**
 * Centralized displayOptions Resolution
 *
 * This module provides displayOptions matching logic aligned with n8n core
 * (packages/workflow/src/node-helpers.ts). It supports:
 * - Simple value inclusion (legacy)
 * - _cnd operators (eq, not, gte, lte, gt, lt, between, includes, startsWith, endsWith, regex, exists)
 * - Root paths (/ prefix)
 * - @version meta-property
 * - Resource locator unwrapping (__rl)
 * - Expression handling (values starting with =)
 *
 * Note: @tool and @feature meta-properties are not supported as they require
 * nodeTypeDescription context which is not available in this SDK context.
 */

import get from 'lodash/get';
import isEqual from 'lodash/isEqual';

// =============================================================================
// Types
// =============================================================================

/**
 * Supported operators for _cnd conditions
 */
export type DisplayConditionOperator =
	| 'eq'
	| 'not'
	| 'gte'
	| 'lte'
	| 'gt'
	| 'lt'
	| 'between'
	| 'includes'
	| 'startsWith'
	| 'endsWith'
	| 'regex'
	| 'exists';

/**
 * A condition using the _cnd operator syntax
 */
export type DisplayCondition = {
	_cnd: Partial<Record<DisplayConditionOperator, unknown>>;
};

/**
 * Display options for conditional field visibility
 */
export type DisplayOptions = {
	show?: Record<string, unknown[]>;
	hide?: Record<string, unknown[]>;
};

/**
 * Context for evaluating displayOptions
 */
export type DisplayOptionsContext = {
	/** Current parameter values at this level */
	parameters: Record<string, unknown>;
	/** Node version for @version meta-property */
	nodeVersion?: number;
	/** Root parameter values for / prefix paths */
	rootParameters?: Record<string, unknown>;
};

// =============================================================================
// Helper: isDisplayCondition
// =============================================================================

function isDisplayCondition(value: unknown): value is DisplayCondition {
	return (
		value !== null &&
		typeof value === 'object' &&
		'_cnd' in value &&
		Object.keys(value).length === 1
	);
}

// =============================================================================
// Core Functions
// =============================================================================

/**
 * Check if conditions are met against actual values.
 *
 * Aligned with n8n core checkConditions function.
 *
 * For simple values: returns true if ANY actual value is in the conditions list.
 * For _cnd operators: returns true if ALL actual values satisfy the condition.
 *
 * @param conditions - Array of allowed values or _cnd conditions
 * @param actualValues - Array of actual property values to check
 * @returns true if conditions are satisfied
 */
export function checkConditions(conditions: unknown[], actualValues: unknown[]): boolean {
	return conditions.some((condition) => {
		if (isDisplayCondition(condition)) {
			const [key, targetValue] = Object.entries(condition._cnd)[0];

			// Special case: empty array handling
			if (actualValues.length === 0) {
				if (key === 'not') return true; // Value is not present, so 'not' is true
				return false; // For all other keys, empty array means condition is not met
			}

			return actualValues.every((propertyValue) => {
				if (key === 'eq') {
					return isEqual(propertyValue, targetValue);
				}
				if (key === 'not') {
					return !isEqual(propertyValue, targetValue);
				}
				if (key === 'gte') {
					return (propertyValue as number) >= (targetValue as number);
				}
				if (key === 'lte') {
					return (propertyValue as number) <= (targetValue as number);
				}
				if (key === 'gt') {
					return (propertyValue as number) > (targetValue as number);
				}
				if (key === 'lt') {
					return (propertyValue as number) < (targetValue as number);
				}
				if (key === 'between') {
					const { from, to } = targetValue as { from: number; to: number };
					return (propertyValue as number) >= from && (propertyValue as number) <= to;
				}
				if (key === 'includes') {
					return (propertyValue as string).includes(targetValue as string);
				}
				if (key === 'startsWith') {
					return (propertyValue as string).startsWith(targetValue as string);
				}
				if (key === 'endsWith') {
					return (propertyValue as string).endsWith(targetValue as string);
				}
				if (key === 'regex') {
					return new RegExp(targetValue as string).test(propertyValue as string);
				}
				if (key === 'exists') {
					return propertyValue !== null && propertyValue !== undefined && propertyValue !== '';
				}
				return false;
			});
		}

		// Simple value inclusion check
		return actualValues.includes(condition);
	});
}

/**
 * Get property values from context for a given property name.
 *
 * Handles special cases:
 * - Root paths (/ prefix): Gets value from rootParameters
 * - @version: Returns node version
 * - Resource locator (__rl): Unwraps to the inner value
 *
 * @param context - The display options context
 * @param propertyName - The property name to get (may include path or special prefix)
 * @returns Array of values (single values are wrapped in array)
 */
export function getPropertyValue(context: DisplayOptionsContext, propertyName: string): unknown[] {
	let value: unknown;

	if (propertyName.charAt(0) === '/') {
		// Get the value from root parameters
		const rootParams = context.rootParameters ?? context.parameters;
		value = get(rootParams, propertyName.slice(1));
	} else if (propertyName === '@version') {
		value = context.nodeVersion ?? 0;
	} else {
		// Get the value from current level parameters
		value = get(context.parameters, propertyName);
	}

	// Unwrap resource locator values
	if (value && typeof value === 'object' && '__rl' in value) {
		const rlValue = value as Record<string, unknown>;
		if (rlValue.__rl === true && 'value' in rlValue) {
			value = rlValue.value;
		}
	}

	// Return as array
	if (!Array.isArray(value)) {
		return [value];
	}
	return value;
}

/**
 * Check if a field should be visible based on displayOptions and current context.
 *
 * Aligned with n8n core displayParameter function.
 *
 * Logic:
 * - If no displayOptions, return true
 * - All show conditions must match (AND)
 * - Any hide condition matching returns false
 * - Expression values (starting with =) cause show to return true (can't statically evaluate)
 *
 * @param context - The context with parameters and metadata
 * @param displayOptions - The show/hide conditions
 * @returns true if the field should be displayed
 */
export function matchesDisplayOptions(
	context: DisplayOptionsContext,
	displayOptions: DisplayOptions,
): boolean {
	const { show, hide } = displayOptions;

	if (show) {
		// All show conditions must match
		for (const propertyName of Object.keys(show)) {
			const values = getPropertyValue(context, propertyName);

			// If any value is an expression, we can't evaluate it statically - show the field
			if (values.some((v) => typeof v === 'string' && v.charAt(0) === '=')) {
				return true;
			}

			if (!checkConditions(show[propertyName], values)) {
				return false;
			}
		}
	}

	if (hide) {
		// Any matching hide condition hides the field
		for (const propertyName of Object.keys(hide)) {
			const values = getPropertyValue(context, propertyName);

			// Don't apply hide if actualValues is empty (property doesn't exist)
			if (values.length !== 0 && checkConditions(hide[propertyName], values)) {
				return false;
			}
		}
	}

	return true;
}
