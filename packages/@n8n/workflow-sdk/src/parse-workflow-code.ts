/**
 * Parser for generated TypeScript SDK code.
 * Takes code generated by generateWorkflowCode() and parses it back to WorkflowJSON.
 */
import { workflow as workflowFn } from './workflow-builder';
import { node as nodeFn, trigger as triggerFn, sticky as stickyFn } from './node-builder';
import {
	languageModel as languageModelFn,
	memory as memoryFn,
	tool as toolFn,
	outputParser as outputParserFn,
	embedding as embeddingFn,
	vectorStore as vectorStoreFn,
	retriever as retrieverFn,
	documentLoader as documentLoaderFn,
	textSplitter as textSplitterFn,
} from './subnode-builders';
import { merge as mergeFn } from './merge';
import { ifBranch as ifBranchFn } from './if-branch';
import { switchCase as switchCaseFn } from './switch-case';
import type { WorkflowJSON } from './types/base';

/**
 * Parses generated TypeScript SDK code back into WorkflowJSON.
 *
 * @param code - TypeScript code generated by generateWorkflowCode()
 * @returns The parsed workflow JSON
 *
 * @example
 * const code = generateWorkflowCode(originalJson);
 * const parsed = parseWorkflowCode(code);
 * // parsed should match originalJson
 */
export function parseWorkflowCode(code: string): WorkflowJSON {
	// Transform the generated code to be executable
	// Replace `const wf = ...` with `return ...` to capture the workflow
	const executableCode = code.replace(/const\s+wf\s*=\s*/, 'return ');

	// Create a function that takes our SDK functions and returns the workflow
	// eslint-disable-next-line @typescript-eslint/no-implied-eval
	const factory = new Function(
		'workflow',
		'node',
		'trigger',
		'sticky',
		'languageModel',
		'memory',
		'tool',
		'outputParser',
		'embedding',
		'vectorStore',
		'retriever',
		'documentLoader',
		'textSplitter',
		'merge',
		'ifBranch',
		'switchCase',
		executableCode,
	);

	// Execute with our SDK functions (including subnode factories and composites)
	const wf = factory(
		workflowFn,
		nodeFn,
		triggerFn,
		stickyFn,
		languageModelFn,
		memoryFn,
		toolFn,
		outputParserFn,
		embeddingFn,
		vectorStoreFn,
		retrieverFn,
		documentLoaderFn,
		textSplitterFn,
		mergeFn,
		ifBranchFn,
		switchCaseFn,
	);

	// Return the JSON representation
	return wf.toJSON();
}
