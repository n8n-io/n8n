/**
 * Parser for generated TypeScript SDK code.
 * Takes code generated by generateWorkflowCode() and parses it back to WorkflowJSON.
 */
import { workflow as workflowFn } from './workflow-builder';
import { node as nodeFn, trigger as triggerFn, sticky as stickyFn } from './node-builder';
import type { WorkflowJSON } from './types/base';

/**
 * Parses generated TypeScript SDK code back into WorkflowJSON.
 *
 * @param code - TypeScript code generated by generateWorkflowCode()
 * @returns The parsed workflow JSON
 *
 * @example
 * const code = generateWorkflowCode(originalJson);
 * const parsed = parseWorkflowCode(code);
 * // parsed should match originalJson
 */
export function parseWorkflowCode(code: string): WorkflowJSON {
	// Transform the generated code to be executable
	// Replace `const wf = ...` with `return ...` to capture the workflow
	const executableCode = code.replace(/const\s+wf\s*=\s*/, 'return ');

	// Create a function that takes our SDK functions and returns the workflow
	// eslint-disable-next-line @typescript-eslint/no-implied-eval
	const factory = new Function('workflow', 'node', 'trigger', 'sticky', executableCode);

	// Execute with our SDK functions
	const wf = factory(workflowFn, nodeFn, triggerFn, stickyFn);

	// Return the JSON representation
	return wf.toJSON();
}
