const wf = workflow('', 'YTB Metadata Generator', { executionOrder: 'v1' })
	.add(
		trigger({
			type: 'n8n-nodes-base.rssFeedReadTrigger',
			version: 1,
			config: {
				parameters: {
					feedUrl: 'https://www.youtube.com/feeds/videos.xml?channel_id=[YOUR_CHANNEL_ID]',
					pollTimes: { item: [{ mode: 'everyX', unit: 'minutes', value: 10 }] },
				},
				position: [-880, 20],
				name: 'Trigger New Video Posted',
			},
		}),
	)
	.then(
		node({
			type: 'n8n-nodes-base.if',
			version: 2.2,
			config: {
				parameters: {
					options: {},
					conditions: {
						options: {
							version: 2,
							leftValue: '',
							caseSensitive: true,
							typeValidation: 'strict',
						},
						combinator: 'and',
						conditions: [
							{
								id: '',
								operator: { type: 'number', operation: 'gt' },
								leftValue: '={{ new Date($json["pubDate"]).getTime() }}',
								rightValue: '={{ new Date().getTime() - 10 * 60 * 1000 }}',
							},
						],
					},
				},
				position: [-660, 20],
				name: 'If Recent',
			},
		}),
	)
	.output(0)
	.then(
		node({
			type: 'n8n-nodes-base.httpRequest',
			version: 4.2,
			config: {
				parameters: {
					url: 'https://api.apify.com/v2/acts/streamers~youtube-scraper/runs?token=YOUR_TOKEN_HERE',
					method: 'POST',
					options: {},
					jsonBody:
						'={\n    "downloadSubtitles": true,\n    "preferAutoGeneratedSubtitles": false,\n    "startUrls": [\n        {\n            "url": "{{ $(\'Trigger New Video Posted\').item.json.link }}",\n            "method": "GET"\n        }\n    ],\n    "subtitlesLanguage": "en"\n}',
					sendBody: true,
					sendHeaders: true,
					specifyBody: 'json',
					headerParameters: {
						parameters: [{ name: 'Content-Type', value: 'application/json' }],
					},
				},
				position: [-440, -80],
				name: 'Scrape Video',
			},
		}),
	)
	.then(
		node({
			type: 'n8n-nodes-base.httpRequest',
			version: 4.2,
			config: {
				parameters: {
					url: 'https://api.apify.com/v2/acts/streamers~youtube-scraper/runs/last?token=YOUR_TOKEN_HERE',
					options: {},
				},
				position: [-160, -80],
				name: 'Check IF Finished',
			},
		}),
	)
	.then(
		node({
			type: 'n8n-nodes-base.if',
			version: 2.2,
			config: {
				parameters: {
					options: {},
					conditions: {
						options: {
							version: 2,
							leftValue: '',
							caseSensitive: true,
							typeValidation: 'strict',
						},
						combinator: 'and',
						conditions: [
							{
								id: '',
								operator: {
									name: 'filter.operator.equals',
									type: 'string',
									operation: 'equals',
								},
								leftValue: '={{ $json.data.status }}',
								rightValue: 'SUCCEEDED',
							},
						],
					},
				},
				position: [20, -80],
				name: 'If Finished',
			},
		}),
	)
	.output(0)
	.then(
		node({
			type: 'n8n-nodes-base.httpRequest',
			version: 4.2,
			config: {
				parameters: {
					url: 'https://api.apify.com/v2/acts/streamers~youtube-scraper/runs/last/dataset/items?token=YOUR_TOKEN_HERE',
					options: {},
				},
				position: [240, -100],
				name: 'Get DataSet',
			},
		}),
	)
	.then(
		node({
			type: 'n8n-nodes-base.if',
			version: 2.2,
			config: {
				parameters: {
					options: {},
					conditions: {
						options: {
							version: 2,
							leftValue: '',
							caseSensitive: true,
							typeValidation: 'strict',
						},
						combinator: 'and',
						conditions: [
							{
								id: '',
								operator: { type: 'string', operation: 'notContains' },
								leftValue: '={{ $json.text }}',
								rightValue: '00:00',
							},
						],
					},
				},
				position: [460, -100],
				name: 'If Not Generated',
			},
		}),
	)
	.output(0)
	.then(
		node({
			type: '@n8n/n8n-nodes-langchain.chainLlm',
			version: 1.5,
			config: {
				parameters: {
					text: 'You are given the full script of a YouTube video. Your task is to extract metadata in a structured format to be used in a YouTube upload.',
					messages: {
						messageValues: [
							{
								type: 'HumanMessagePromptTemplate',
								message:
									'=Script Input:\n{{ $json.subtitles[0].srt }}\n\nFinal Output Format:\n\nPreview:\n[short preview description]\n\nTimestamps:\n00:00 [Title]\n00:30 [Title]\n...\n\nTags:\ntag1,tag2,tag3,...\n\nFollow these instructions strictly:\n\n1. Short Preview Description\nWrite a short preview (100‚Äì200 characters max) of the video.\nUse engaging language, and include relevant keywords from the topic of the video.\nThis should be a single sentence or two, no hashtags, no line breaks.\n\n2. Timestamps\nFormat: MM:SS Timestamp Title (each on a new line)\nMust start with 00:00\nEach timestamp section must be at least 30 seconds apart\nOnly 3 to 7 total timestamps\nEach timestamp title should be maximum 3 words, summarize the section clearly\nExample format:\n"00:00 Intro  \n00:47 Key Concept  \n02:12 Real Example"\n\n3. Tags\nProvide 5 to 10 relevant SEO-friendly keywords separated by commas\nNo hashtags\nFormat like this:\n"automation,n8n,ai workflows,youtube growth,openai"\n',
							},
						],
					},
					promptType: 'define',
					hasOutputParser: true,
				},
				subnodes: {
					model: languageModel({
						type: '@n8n/n8n-nodes-langchain.lmChatMistralCloud',
						version: 1,
						config: {
							parameters: { model: 'mistral-large-latest', options: {} },
							credentials: {
								mistralCloudApi: { id: 'credential-id', name: 'mistralCloudApi Credential' },
							},
							name: 'Mistral Cloud Chat Model',
						},
					}),
					outputParser: outputParser({
						type: '@n8n/n8n-nodes-langchain.outputParserStructured',
						version: 1.2,
						config: {
							parameters: {
								jsonSchemaExample:
									'[\n  {\n    "name": "preview",\n    "type": "string",\n    "description": "Short preview (100‚Äì200 characters, no hashtags)"\n  },\n  {\n    "name": "timestamps",\n    "type": "string",\n    "description": "YouTube-style timestamps, each on a new line, starts with 00:00"\n  },\n  {\n    "name": "tags",\n    "type": "string",\n    "description": "Comma-separated keywords (no hashtags)"\n  }\n]\n',
							},
							name: 'Structured Output Parser',
						},
					}),
				},
				position: [700, -200],
				name: 'Generate Description',
			},
		}),
	)
	.then(
		node({
			type: 'n8n-nodes-base.code',
			version: 2,
			config: {
				parameters: {
					jsCode:
						'// Assuming input data contains preview, timestamps, tags\nconst preview = $input.first().json.output[0].description;\nconst timestamps = $input.first().json.output[1].description;\n\n// Hardcoded links section (edit as needed)\nconst links = `\nLinks:\n- Website: https://example.com\n- Twitter: https://twitter.com/example\n- GitHub: https://github.com/example\n`;\n\n// Format description string\nconst description = preview + "\\n" +links + "\\n" +timestamps \n\n// Return the formatted description\nreturn [\n  {\n    json: {\n      description: description.trim(),\n    },\n  },\n];\n',
				},
				position: [1100, -200],
				name: 'Format ',
			},
		}),
	)
	.then(
		node({
			type: 'n8n-nodes-base.youTube',
			version: 1,
			config: {
				parameters: {
					title: "={{ $('Get DataSet').item.json.title }}",
					videoId: "={{ $('Get DataSet').item.json.id }}",
					resource: 'video',
					operation: 'update',
					regionCode: 'US',
					updateFields: {
						tags: "={{ $('Generate Description').item.json.output[2].description }}",
						description: '={{ $json.description }}',
					},
				},
				credentials: {
					youTubeOAuth2Api: { id: 'credential-id', name: 'youTubeOAuth2Api Credential' },
				},
				position: [1280, -200],
				name: 'Update YTB Video',
			},
		}),
	)
	.output(1)
	.then(
		node({
			type: 'n8n-nodes-base.noOp',
			version: 1,
			config: { position: [700, 100], name: 'No Operation, do nothing1' },
		}),
	)
	.output(1)
	.then(
		node({
			type: 'n8n-nodes-base.wait',
			version: 1.1,
			config: { position: [180, 120], name: 'Wait' },
		}),
	)
	.output(1)
	.then(
		node({
			type: 'n8n-nodes-base.noOp',
			version: 1,
			config: { position: [-440, 120], name: 'No Operation, do nothing' },
		}),
	)
	.add(
		sticky(
			'## 1- Input\nEnter the ID of the YTB channel to trigger the workflow when a new video is posted',
			{ name: 'Sticky Note3', color: 7, position: [-940, -100], width: 420, height: 340 },
		),
	)
	.add(
		sticky('## 2- Create DataSet\nApify scrape the last YTB video of the channel', {
			color: 7,
			position: [-500, -180],
			height: 480,
		}),
	)
	.add(
		sticky(
			'## 4- Check and Generate Metadata\nVerify if Metadata are not already generated and generate them with LLM\n',
			{ name: 'Sticky Note1', color: 7, position: [420, -280], width: 600, height: 580 },
		),
	)
	.add(
		sticky('## 5- Output\nFormat all the data created and update YTB Video', {
			name: 'Sticky Note2',
			color: 7,
			position: [1040, -280],
			width: 460,
			height: 240,
		}),
	)
	.add(
		sticky(
			'## 3- Wait for Completion & Get DataSet\nWait until the dataset is completed in Apify and get it',
			{ name: 'Sticky Note4', color: 7, position: [-240, -180], width: 640, height: 500 },
		),
	)
	.add(
		sticky(
			'## How it works?\n**1 -** Enter the ID of the YTB channel to trigger the workflow when a new video is posted\n**2 -** Apify scrape the last YTB video of the channel\n**3 -** Wait until the dataset is completed in Apify and get it\n**4 -** Verify if Metadata are not already generated and generate them with LLM\n**5 -** Format all the data created and update YTB Video\n\n**üì∫ Youtube Video Tutorial : https://youtu.be/HaQPAa6l5bU**\n**üõ†Ô∏è Need Help with Your Workflows ? https://tally.so/r/wayeqB**\n**üë®‚Äçüíª¬†More Workflows : https://n8n.io/creators/nasser/**',
			{ name: 'Sticky Note5', color: 7, position: [-940, -800], width: 780, height: 240 },
		),
	)
	.add(
		sticky(
			'## SETUP\n\n**Setup Input YTB Chanel :** Go to the channel\'s page on YouTube, and look at the URL of the page. The channel ID is the value that comes after channel/ in the URL. Add it after "?channel_id=" You can also use free tools available to retrieve channel ID.\n\n**Setup Output YTB Video Update :** Connect your YTB account to your n8n instance thanks to the Google Cloud Console. You can find tutorials by typing "youtube api Oauth" on Google.\n\n**APIs :** For the following third-party integrations, replace [YOUR_API_TOKEN] with your API Token or connect your account via Client ID / Secret to your n8n instance : \n- Apify : https://docs.apify.com/api/v2/getting-started\n- Youtube : https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.youtube/?utm_source=n8n_app&utm_medium=node_settings_modal-credential_link&utm_campaign=n8n-nodes-base.youTube#templates-and-examples',
			{ name: 'Sticky Note6', color: 7, position: [-940, -540], width: 780, height: 340 },
		),
	);
