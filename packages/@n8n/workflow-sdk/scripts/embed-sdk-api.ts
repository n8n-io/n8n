/**
 * Embed SDK API Script
 *
 * Reads the sdk-api.ts file and generates sdk-api-content.ts with
 * the content embedded as a constant string. This avoids disk reads
 * at runtime.
 *
 * Usage:
 *   pnpm embed-sdk-api
 *
 * Output:
 *   src/types/sdk-api-content.ts
 */

import * as fs from 'fs';
import * as path from 'path';

// =============================================================================
// Configuration
// =============================================================================

const SDK_API_PATH = path.resolve(__dirname, '../src/types/sdk-api.ts');
const OUTPUT_PATH = path.resolve(__dirname, '../src/types/sdk-api-content.ts');

// =============================================================================
// Core Functions
// =============================================================================

/**
 * Read the sdk-api.ts file and generate TypeScript code with
 * the content embedded as a constant.
 *
 * @returns Generated TypeScript code with SDK_API_CONTENT constant
 */
export async function embedSdkApi(): Promise<string> {
	// Read the source file
	const content = await fs.promises.readFile(SDK_API_PATH, 'utf-8');

	// Escape backticks and dollar signs for template literal
	const escapedContent = content
		.replace(/\\/g, '\\\\') // Escape backslashes first
		.replace(/`/g, '\\`') // Escape backticks
		.replace(/\$/g, '\\$'); // Escape dollar signs to prevent interpolation

	// Generate the output file content
	const output = `/**
 * Embedded SDK API Content
 *
 * This file is auto-generated by scripts/embed-sdk-api.ts
 * Do not edit manually.
 *
 * Contains the raw TypeScript content of sdk-api.ts as a string constant
 * for embedding in prompts without disk reads at runtime.
 *
 * To regenerate:
 *   pnpm embed-sdk-api
 */

export const SDK_API_CONTENT = \`${escapedContent}\`;
`;

	return output;
}

/**
 * Write the embedded SDK API content to sdk-api-content.ts
 */
export async function writeEmbeddedSdkApi(): Promise<void> {
	const content = await embedSdkApi();
	await fs.promises.writeFile(OUTPUT_PATH, content, 'utf-8');
	console.log(`Generated ${OUTPUT_PATH}`);
}

// =============================================================================
// Main Entry Point
// =============================================================================

if (require.main === module) {
	writeEmbeddedSdkApi().catch((error) => {
		console.error('Failed to embed SDK API:', error);
		process.exit(1);
	});
}
