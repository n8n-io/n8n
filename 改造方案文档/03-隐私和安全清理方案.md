# n8n éšç§å’Œå®‰å…¨æ¸…ç†æ–¹æ¡ˆ

> **ç›®æ ‡**: ç§»é™¤æ‰€æœ‰ n8n å®˜æ–¹çš„é¥æµ‹ã€è¿½è¸ªå’Œäº‘æœåŠ¡è¿æ¥
> **ä¼˜å…ˆçº§**: ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆPhase 1 å‰ç½®ä»»åŠ¡ï¼‰
> **å·¥æœŸ**: 1-2 å¤©

---

## ä¸€ã€æ¸…ç†èŒƒå›´

### 1.1 å¿…é¡»ç§»é™¤ï¼ˆå½±å“éšç§å’Œå•†ä¸šå®‰å…¨ï¼‰

#### âœ… å·²å®Œæˆ
- [x] æ‹›è˜æ¨ªå¹…ï¼ˆHIRING_BANNERï¼‰

#### ğŸ”´ é«˜ä¼˜å…ˆçº§ - ç«‹å³ç§»é™¤

1. **é¥æµ‹ç³»ç»Ÿ**
   - [ ] RudderStack è¿½è¸ª
   - [ ] PostHog åˆ†æ
   - [ ] Telemetry äº‹ä»¶ä¸ŠæŠ¥

2. **äº‘æœåŠ¡è¿æ¥**
   - [ ] CloudPlan Store
   - [ ] Cloud API è°ƒç”¨ï¼ˆ/cloud/*, /admin/cloud-planï¼‰
   - [ ] äº‘ç”¨æˆ·ä¿¡æ¯è·å–

3. **æ•°æ®æ”¶é›†**
   - [ ] ä¸ªæ€§åŒ–è°ƒæŸ¥ï¼ˆPersonalizationModalï¼‰
   - [ ] ä½¿ç”¨æ•°æ®ç»Ÿè®¡
   - [ ] æµè§ˆå™¨æŒ‡çº¹ï¼ˆBrowser IDï¼‰

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ - å¯é€‰ä¿ç•™

1. **å¤–éƒ¨æ¨¡æ¿æœåŠ¡**
   - [ ] è¯„ä¼°æ˜¯å¦éœ€è¦å®˜æ–¹æ¨¡æ¿
   - [ ] è€ƒè™‘è‡ªå»ºæ¨¡æ¿åº“

2. **ç¤¾åŒºèŠ‚ç‚¹**
   - [ ] è¯„ä¼° npm registry ä¾èµ–
   - [ ] è€ƒè™‘ç§æœ‰ registry

---

## äºŒã€è¯¦ç»†æ¸…ç†æ­¥éª¤

### 2.1 ç¦ç”¨ RudderStack é¥æµ‹

**æ–‡ä»¶ä½ç½®**: `packages/frontend/editor-ui/src/app/plugins/telemetry/index.ts`

**æ–¹æ¡ˆ A: ç¯å¢ƒå˜é‡ç¦ç”¨ï¼ˆæ¨èï¼‰**
```bash
# .env
N8N_DIAGNOSTICS_ENABLED=false
N8N_PERSONALIZATION_ENABLED=false
```

**æ–¹æ¡ˆ B: ä»£ç çº§ç§»é™¤**
```typescript
// ä¿®æ”¹ init æ–¹æ³•ï¼Œç›´æ¥è¿”å›
init(telemetrySettings, config) {
  // å®Œå…¨ç¦ç”¨é¥æµ‹
  return;
}
```

**éªŒè¯**:
```javascript
// æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥
window.rudderanalytics === undefined // åº”ä¸º true
```

---

### 2.2 ç§»é™¤ PostHog è¿½è¸ª

**æ–‡ä»¶ä½ç½®**: `packages/frontend/editor-ui/src/app/stores/posthog.store.ts`

**æ­¥éª¤**:

1. **ä¿®æ”¹é…ç½®**
```typescript
// packages/cli/src/services/frontend.service.ts
posthog: {
  enabled: false,  // å¼ºåˆ¶ç¦ç”¨
  apiHost: '',
  apiKey: '',
  autocapture: false,
  disableSessionRecording: true,
  debug: false,
  proxy: '',
}
```

2. **ç§»é™¤åˆå§‹åŒ–ä»£ç **
```typescript
// packages/frontend/editor-ui/src/app/stores/posthog.store.ts
init() {
  // ä¸æ‰§è¡Œä»»ä½•åˆå§‹åŒ–
  this.isEnabled = false;
  return;
}
```

**éªŒè¯**:
```javascript
// æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥
window.posthog === undefined // åº”ä¸º true
```

---

### 2.3 åˆ é™¤äº‘æœåŠ¡è¿æ¥

**æ¶‰åŠæ–‡ä»¶**:
- `packages/frontend/editor-ui/src/app/stores/cloudPlan.store.ts`
- `packages/frontend/@n8n/rest-api-client/src/api/cloudPlans.ts`
- `packages/cli/src/controllers/cloud.controller.ts` (å¦‚æœå­˜åœ¨)

**æ­¥éª¤**:

1. **ç§»é™¤ CloudPlan Store**
```bash
# åˆ é™¤æ–‡ä»¶
rm packages/frontend/editor-ui/src/app/stores/cloudPlan.store.ts

# ç§»é™¤å¼•ç”¨
# åœ¨æ‰€æœ‰æ–‡ä»¶ä¸­æœç´¢ useCloudPlanStore å¹¶åˆ é™¤è°ƒç”¨
```

2. **ç§»é™¤ Cloud API**
```bash
rm packages/frontend/@n8n/rest-api-client/src/api/cloudPlans.ts
```

3. **ç§»é™¤åç«¯è·¯ç”±**
```typescript
// packages/cli/src/Server.ts (ç¤ºä¾‹)
// åˆ é™¤ä»¥ä¸‹è·¯ç”±
app.get('/cloud/*', ...)
app.get('/admin/cloud-plan', ...)
```

---

### 2.4 ç§»é™¤ä¸ªæ€§åŒ–è°ƒæŸ¥

**æ–‡ä»¶ä½ç½®**: `packages/frontend/editor-ui/src/features/settings/users/components/PersonalizationModal.vue`

**æ–¹æ¡ˆ A: ç¦ç”¨æ˜¾ç¤º**
```typescript
// packages/cli/src/services/frontend.service.ts
personalizationSurveyEnabled: false,
```

**æ–¹æ¡ˆ B: å®Œå…¨åˆ é™¤ç»„ä»¶**
```bash
rm packages/frontend/editor-ui/src/features/settings/users/components/PersonalizationModal.vue
# å¹¶ç§»é™¤æ‰€æœ‰å¼•ç”¨
```

---

### 2.5 æ¸…ç†æµè§ˆå™¨è¿½è¸ª

**Browser ID æ¸…ç†**

```typescript
// packages/frontend/@n8n/rest-api-client/src/utils.ts

const getBrowserId = () => {
  // æ–¹æ¡ˆ A: è¿”å›å›ºå®šå€¼
  return 'local-instance';

  // æ–¹æ¡ˆ B: æ³¨é‡Šæ‰æ•´ä¸ªå‡½æ•°
  // ç§»é™¤æ‰€æœ‰ localStorage ç›¸å…³çš„è¿½è¸ª
};
```

**æ¸…ç† LocalStorage é”®**:
```typescript
// ç§»é™¤ä»¥ä¸‹é”®çš„å†™å…¥é€»è¾‘
const TRACKING_KEYS = [
  'n8n-recent-workflows',    // å¯é€‰ä¿ç•™ï¼ˆåŠŸèƒ½æ€§ï¼‰
  'n8n-recent-nodes',        // å¯é€‰ä¿ç•™ï¼ˆåŠŸèƒ½æ€§ï¼‰
  'BROWSER_ID_STORAGE_KEY',  // å¿…é¡»ç§»é™¤
];
```

---

## ä¸‰ã€é…ç½®æ–‡ä»¶æ¸…ç†

### 3.1 ä¿®æ”¹é»˜è®¤é…ç½®

**æ–‡ä»¶**: `packages/@n8n/config/src/index.ts`

**éœ€è¦å¼ºåˆ¶è®¾ç½®çš„é…ç½®**:
```typescript
@Config
export class GlobalConfig {
  // é¥æµ‹ç›¸å…³
  @Env('N8N_DIAGNOSTICS_ENABLED')
  diagnosticsEnabled: boolean = false;  // æ”¹ä¸º false

  @Env('N8N_PERSONALIZATION_ENABLED')
  personalizationEnabled: boolean = false;  // æ”¹ä¸º false

  // äº‘æœåŠ¡ç›¸å…³
  @Env('N8N_CLOUD_ENABLED')
  cloudEnabled: boolean = false;  // æ–°å¢é…ç½®

  // æ¨¡æ¿æœåŠ¡ï¼ˆå¯é€‰ï¼‰
  @Nested
  templates: TemplatesConfig;  // è¯„ä¼°æ˜¯å¦ç¦ç”¨
}
```

---

## å››ã€å‰ç«¯ API ç±»å‹æ¸…ç†

**æ–‡ä»¶**: `packages/@n8n/api-types/src/frontend-settings.ts`

**ç§»é™¤ä»¥ä¸‹ç±»å‹**:
```typescript
// åˆ é™¤
export interface ITelemetrySettings { ... }
export interface ITelemetryClientConfig { ... }

// ä» FrontendSettings ä¸­ç§»é™¤
export interface FrontendSettings {
  // telemetry: ITelemetrySettings;  // åˆ é™¤
  // posthog: { ... };                // åˆ é™¤
  // cloudPlan: { ... };              // åˆ é™¤
  personalizationSurveyEnabled: boolean;  // æ”¹ä¸ºå§‹ç»ˆ false
}
```

---

## äº”ã€ç½‘ç»œè¯·æ±‚ç™½åå•

### 5.1 å…è®¸çš„å¤–éƒ¨è¿æ¥ï¼ˆå¯é€‰ï¼‰

```typescript
// å¦‚æœéœ€è¦ä¿ç•™æŸäº›åŠŸèƒ½ï¼Œåªå…è®¸è¿™äº›åŸŸå
const ALLOWED_DOMAINS = [
  // 'templates.n8n.io',  // å¯é€‰ï¼šå®˜æ–¹æ¨¡æ¿
  // 'registry.npmjs.org', // ç¤¾åŒºèŠ‚ç‚¹éœ€è¦
];

// é˜»æ­¢çš„åŸŸåï¼ˆå¿…é¡»é˜»æ­¢ï¼‰
const BLOCKED_DOMAINS = [
  'api.n8n.io',      // n8n API
  'n8n.cloud',       // n8n äº‘æœåŠ¡
  '*.posthog.com',   // PostHog
  '*.rudderstack.com', // RudderStack
];
```

### 5.2 å®ç°ç½‘ç»œæ‹¦æˆªï¼ˆå¯é€‰ï¼‰

```typescript
// packages/frontend/@n8n/rest-api-client/src/utils.ts

export async function request(config) {
  const { endpoint } = config;

  // é˜»æ­¢äº‘æœåŠ¡è°ƒç”¨
  if (endpoint.startsWith('/cloud/') ||
      endpoint.startsWith('/admin/cloud')) {
    console.warn('Cloud API calls are disabled');
    return null;
  }

  // åŸæœ‰é€»è¾‘
  // ...
}
```

---

## å…­ã€éªŒè¯æ¸…å•

### 6.1 è¿è¡Œæ—¶éªŒè¯

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// 1. æ£€æŸ¥é¥æµ‹
console.log('RudderStack:', window.rudderanalytics);  // åº”ä¸º undefined
console.log('PostHog:', window.posthog);              // åº”ä¸º undefined

// 2. æ£€æŸ¥æœ¬åœ°å­˜å‚¨
Object.keys(localStorage).filter(k => k.includes('n8n'));

// 3. æ£€æŸ¥ç½‘ç»œè¯·æ±‚
// æ‰“å¼€ Network é¢æ¿ï¼Œç­›é€‰ï¼š
// - api.n8n.io (ä¸åº”æœ‰è¯·æ±‚)
// - n8n.cloud (ä¸åº”æœ‰è¯·æ±‚)
// - posthog (ä¸åº”æœ‰è¯·æ±‚)
// - rudderstack (ä¸åº”æœ‰è¯·æ±‚)
```

### 6.2 ä»£ç éªŒè¯

```bash
# æœç´¢æ®‹ç•™çš„é¥æµ‹è°ƒç”¨
grep -r "rudderstack\|posthog\|telemetry" packages/frontend/editor-ui/src/
grep -r "/cloud/\|cloud-plan" packages/

# æ£€æŸ¥é…ç½®æ–‡ä»¶
grep -r "DIAGNOSTICS_ENABLED\|PERSONALIZATION_ENABLED" packages/@n8n/config/
```

---

## ä¸ƒã€é£é™©è¯„ä¼°

### 7.1 ç§»é™¤åå¯èƒ½å½±å“çš„åŠŸèƒ½

| åŠŸèƒ½ | å½±å“ | æ›¿ä»£æ–¹æ¡ˆ |
|------|------|----------|
| é”™è¯¯ä¸ŠæŠ¥ | âš ï¸ æ— æ³•è‡ªåŠ¨ä¸ŠæŠ¥é”™è¯¯ | è‡ªå»º Sentry/æ—¥å¿—ç³»ç»Ÿ |
| ä½¿ç”¨ç»Ÿè®¡ | âš ï¸ æ— å®˜æ–¹ç»Ÿè®¡æ•°æ® | è‡ªå»ºåˆ†æç³»ç»Ÿ |
| åŠŸèƒ½æ ‡å¿— | âš ï¸ PostHog Feature Flags å¤±æ•ˆ | è‡ªå»ºåŠŸèƒ½å¼€å…³ |
| å®˜æ–¹æ¨¡æ¿ | âš ï¸ æ— æ³•è®¿é—®å®˜æ–¹æ¨¡æ¿åº“ | è‡ªå»ºæ¨¡æ¿åº“ |
| ç‰ˆæœ¬æ›´æ–°é€šçŸ¥ | âš ï¸ æ— è‡ªåŠ¨æ›´æ–°æé†’ | æ‰‹åŠ¨æ£€æŸ¥æ›´æ–° |

### 7.2 å•†ä¸šé£é™©

**å¦‚æœä¸æ¸…ç†**:
1. âŒ n8n å®˜æ–¹å¯ä»¥çœ‹åˆ°ä½ çš„ç§Ÿæˆ·æ•°æ®
2. âŒ ç”¨æˆ·éšç§æ•°æ®è¢«ç¬¬ä¸‰æ–¹æ”¶é›†
3. âŒ äº‘æœåŠ¡é™åˆ¶å¯èƒ½å¹²æ‰°ä½ çš„è®¡è´¹ç­–ç•¥
4. âŒ ä¸ç¬¦åˆ GDPR/éšç§æ³•è§„è¦æ±‚

**æ¸…ç†åçš„ä¼˜åŠ¿**:
1. âœ… å®Œå…¨çš„æ•°æ®éšç§
2. âœ… ç‹¬ç«‹çš„å•†ä¸šå†³ç­–
3. âœ… ç¬¦åˆéšç§æ³•è§„
4. âœ… é¿å…ä¸ n8n å®˜æ–¹äº‘æœåŠ¡å†²çª

---

## å…«ã€å®æ–½è®¡åˆ’

### Day 1: é¥æµ‹å’Œè¿½è¸ªæ¸…ç†
- [ ] 09:00-10:00: ç¦ç”¨ RudderStack
- [ ] 10:00-11:00: ç¦ç”¨ PostHog
- [ ] 11:00-12:00: ç§»é™¤ Telemetry è°ƒç”¨
- [ ] 14:00-15:00: æ¸…ç† Browser ID
- [ ] 15:00-16:00: æµ‹è¯•éªŒè¯

### Day 2: äº‘æœåŠ¡å’Œé…ç½®æ¸…ç†
- [ ] 09:00-10:30: åˆ é™¤ CloudPlan Store
- [ ] 10:30-12:00: ç§»é™¤ Cloud API
- [ ] 14:00-15:00: ç§»é™¤ä¸ªæ€§åŒ–è°ƒæŸ¥
- [ ] 15:00-16:00: ä¿®æ”¹é»˜è®¤é…ç½®
- [ ] 16:00-17:00: å…¨é¢æµ‹è¯•éªŒè¯

---

## ä¹ã€æµ‹è¯•ç”¨ä¾‹

### 9.1 åŠŸèƒ½æµ‹è¯•

```typescript
describe('Privacy & Security Cleanup', () => {
  it('should not initialize RudderStack', () => {
    expect(window.rudderanalytics).toBeUndefined();
  });

  it('should not initialize PostHog', () => {
    expect(window.posthog).toBeUndefined();
  });

  it('should not call cloud APIs', async () => {
    // Mock network requests
    const spy = jest.spyOn(axios, 'request');

    // Trigger app initialization
    await app.init();

    // Verify no cloud API calls
    const cloudCalls = spy.mock.calls.filter(call =>
      call[0].url?.includes('/cloud/') ||
      call[0].url?.includes('api.n8n.io')
    );

    expect(cloudCalls).toHaveLength(0);
  });
});
```

### 9.2 ç½‘ç»œè¯·æ±‚ç›‘æ§æµ‹è¯•

åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼š

```javascript
// ç›‘æ§æ‰€æœ‰ç½‘ç»œè¯·æ±‚
const originalFetch = window.fetch;
const originalXHR = XMLHttpRequest.prototype.open;

const blockedDomains = ['api.n8n.io', 'n8n.cloud', 'posthog', 'rudderstack'];

window.fetch = async (...args) => {
  const url = args[0];
  if (blockedDomains.some(d => url.includes(d))) {
    console.error('âŒ Blocked request to:', url);
    throw new Error('Blocked by privacy filter');
  }
  return originalFetch.apply(this, args);
};
```

---

## åã€æ–‡æ¡£æ›´æ–°

æ¸…ç†å®Œæˆåï¼Œéœ€è¦æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ï¼š

1. **README.md**: è¯´æ˜å·²ç§»é™¤æ‰€æœ‰é¥æµ‹
2. **ç¯å¢ƒå˜é‡æ–‡æ¡£**: æ›´æ–°é»˜è®¤é…ç½®
3. **éšç§æ”¿ç­–**: æ˜ç¡®è¯´æ˜ä¸æ”¶é›†ç”¨æˆ·æ•°æ®
4. **éƒ¨ç½²æ–‡æ¡£**: ç§»é™¤äº‘æœåŠ¡ç›¸å…³é…ç½®

---

## åä¸€ã€åç»­ä¼˜åŒ–å»ºè®®

### 11.1 è‡ªå»ºåˆ†æç³»ç»Ÿï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦äº†è§£ç”¨æˆ·ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥è‡ªå»ºï¼š

```typescript
// è‡ªå»ºç®€å•çš„åŒ¿åç»Ÿè®¡
class PrivateAnalytics {
  track(event: string, properties?: object) {
    // å‘é€åˆ°è‡ªå·±çš„æœåŠ¡å™¨
    // ä¸åŒ…å«ä»»ä½•ä¸ªäººä¿¡æ¯
    await fetch('/api/internal/analytics', {
      method: 'POST',
      body: JSON.stringify({
        event,
        timestamp: Date.now(),
        // ä¸åŒ…å« userId, instanceId ç­‰
      }),
    });
  }
}
```

### 11.2 åŠŸèƒ½å¼€å…³ç³»ç»Ÿ

æ›¿ä»£ PostHog Feature Flagsï¼š

```typescript
// åŸºäºç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶çš„åŠŸèƒ½å¼€å…³
class FeatureFlags {
  isEnabled(feature: string): boolean {
    return process.env[`FEATURE_${feature.toUpperCase()}`] === 'true';
  }
}
```

---

**æœ€åæ›´æ–°**: 2025-11-04
**æ–‡æ¡£çŠ¶æ€**: âœ… å¯ç«‹å³å®æ–½
**é¢„è®¡å·¥æœŸ**: 1-2 å¤©
**ä¼˜å…ˆçº§**: ğŸ”´ Phase 1 å‰ç½®ä»»åŠ¡
