# n8n 多租户 SaaS 改造方案文档

> **项目：** n8n 多租户 SaaS 改造
> **目标：** 实现 Coze 风格的工作空间架构，支持个人 + 团队客户
> **基于分支：** 20251102
> **文档版本：** v1.0
> **创建日期：** 2025-11-03

---

## 📚 文档索引

### 核心文档

| 文档 | 说明 | 状态 |
|------|------|------|
| [01-架构底层改造方案.md](./01-架构底层改造方案.md) | 多租户 SaaS 架构：数据库、后端、前端层完整改造方案 | ✅ 已完成 |
| [02-Telemetry独立管理平台方案.md](./02-Telemetry独立管理平台方案.md) | 自托管 Telemetry 分析平台：数据收集、分析、可视化 | ✅ 已完成 |
| [02-架构图和流程图.md](./02-架构图和流程图.md) | Mermaid 架构图和流程图 | ✅ 已完成 |
| [03-品牌替换指南.md](./03-品牌替换指南.md) | 品牌定制化：将 n8n 替换为 quanyuge（全域阁） | ✅ 已完成 |

### 待补充文档（根据实施进度）

| 文档 | 说明 | 状态 |
|------|------|------|
| 03-API接口文档.md | RESTful API 详细接口文档 | ⏸️ 待编写 |
| 04-数据库迁移指南.md | 数据库迁移脚本和执行步骤 | ⏸️ 待编写 |
| 05-测试用例清单.md | 单元测试、集成测试、E2E 测试 | ⏸️ 待编写 |
| 06-计费系统设计方案.md | Phase 2 计费系统详细设计 | ⏸️ 待工作流运行模式改造后 |
| 07-部署和运维指南.md | 生产环境部署、监控、告警 | ⏸️ 待编写 |

---

## 🎯 改造目标

### Phase 1：架构底层改造（本文档覆盖范围）

**实现功能：**
1. ✅ 工作空间切换（个人空间/团队空间）
2. ✅ 团队协作（创建团队、邀请成员、角色管理）
3. ✅ 权限管理（Admin/Editor/Viewer 三级权限）
4. ✅ 数据隔离（工作空间级别的资源隔离）

**工期估算：** 5-6 周

### Phase 2：计费系统（待后续规划）

**实现功能：**
- ⏸️ 余额管理
- ⏸️ 消费记录追踪
- ⏸️ 充值系统
- ⏸️ 订阅计划管理
- ⏸️ 按量计费

**前置条件：** 工作流运行模式改造完成

---

## 📖 文档快速导航

### 1. 我是产品经理/决策者

**推荐阅读：**
1. [01-架构底层改造方案.md](./01-架构底层改造方案.md) 的"一、改造范围与目标"章节
2. [01-架构底层改造方案.md](./01-架构底层改造方案.md) 的"二、架构核心设计"章节
3. [02-架构图和流程图.md](./02-架构图和流程图.md) 的"七、用户体验流程"章节

**关键问题：**
- 改造后用户能获得什么体验？→ 见"用户旅程图"
- 和 Coze 的差距在哪？→ 见"Coze 架构对标"
- 工期和成本？→ 见"实施步骤（5-6 周）"

### 2. 我是架构师/技术负责人

**推荐阅读：**
1. [01-架构底层改造方案.md](./01-架构底层改造方案.md) 的"二、架构核心设计"章节
2. [02-架构图和流程图.md](./02-架构图和流程图.md) 的"一、数据库 E-R 关系图"
3. [02-架构图和流程图.md](./02-架构图和流程图.md) 的"二、架构对比图"

**关键问题：**
- 为什么这样设计？→ 见"关键决策总览"
- 性能影响如何？→ 见"数据查询优化"
- 如何保证数据隔离？→ 见"数据隔离验证流程"

### 3. 我是后端开发工程师

**推荐阅读：**
1. [01-架构底层改造方案.md](./01-架构底层改造方案.md) 的"三、数据库层改造"章节
2. [01-架构底层改造方案.md](./01-架构底层改造方案.md) 的"四、后端层改造"章节
3. [02-架构图和流程图.md](./02-架构图和流程图.md) 的"三、工作空间管理流程"

**关键问题：**
- 数据库需要改哪些表？→ 见"核心表结构变更"
- Repository 如何重构？→ 见"Repository 层重构"
- Service 新增哪些方法？→ 见"Service 层改造"

### 4. 我是前端开发工程师

**推荐阅读：**
1. [01-架构底层改造方案.md](./01-架构底层改造方案.md) 的"五、前端层改造"章节
2. [02-架构图和流程图.md](./02-架构图和流程图.md) 的"四、工作空间切换流程"
3. [02-架构图和流程图.md](./02-架构图和流程图.md) 的"七、用户体验流程"

**关键问题：**
- 状态如何管理？→ 见"状态管理（projects.store.ts）"
- 组件如何设计？→ 见"WorkspaceSwitcher 组件"
- 页面如何响应切换？→ 见"页面自动刷新"

### 5. 我是测试工程师

**推荐阅读：**
1. [01-架构底层改造方案.md](./01-架构底层改造方案.md) 的"八、风险和注意事项"章节
2. [01-架构底层改造方案.md](./01-架构底层改造方案.md) 的"九、成功标准"章节
3. [02-架构图和流程图.md](./02-架构图和流程图.md) 的"五、权限管理架构"

**关键问题：**
- 需要测试哪些场景？→ 见"成功标准"
- 如何测试权限？→ 见"权限检查流程"
- 如何测试数据隔离？→ 见"数据隔离验证流程"

---

## 🔑 核心概念速查

### 术语对照表

| Coze 术语 | n8n 术语 | 说明 |
|-----------|----------|------|
| Workspace | Project | 工作空间（顶级隔离单位） |
| Personal Workspace | Project (type='personal') | 个人空间 |
| Team Workspace | Project (type='team') | 团队空间 |
| Bot | Workflow | 工作流 |
| Knowledge Base | Credentials | 凭证 |
| Member | ProjectRelation | 成员关系 |
| Admin/Editor/Viewer | project:admin/editor/viewer | 角色权限 |

### 关键决策

| 决策点 | 方案 | 理由 |
|--------|------|------|
| 顶级隔离单位 | Project = Workspace | 对标 Coze，概念清晰 |
| 资源归属 | Workflow/Credentials 直接属于 Project | 简化查询链路 |
| Team 实体 | 不引入独立的 Team 表 | Project 的 type 字段足够表达 |
| SharedWorkflow | 删除（方案 A） | 减少查询层级，提升性能 |
| 权限模型 | 基于 ProjectRelation 的 RBAC | 统一权限管理 |

---

## 📊 实施计划概览

```
Week 1: 数据库层改造
  └─ 迁移脚本、表结构扩展、索引优化

Week 2: Repository + Service 层
  └─ 查询路径优化、业务逻辑实现

Week 3: API 层改造
  └─ 中间件、Controller、接口调整

Week 4: 前端层改造
  └─ 状态管理、组件开发、页面响应

Week 5: 初始化 + 测试
  └─ 数据迁移、E2E 测试、性能测试

Week 6: 优化 + 上线
  └─ Bug 修复、安全审计、灰度发布
```

---

## ⚠️ 重要提示

### 给开发团队

1. **SharedWorkflow 删除决策**
   - 需要全面搜索代码依赖
   - 确认是否有特殊业务逻辑依赖
   - 建议渐进式删除

2. **数据库结构变更**
   - 在测试环境充分验证 SQL 脚本
   - 确保所有索引正确创建
   - 验证外键约束和级联删除

3. **向后兼容性**
   - API 接口调整需要考虑兼容性
   - 前后端同步上线
   - 灰度发布验证

### 给测试团队

1. **重点测试场景**
   - 用户注册后自动创建个人空间
   - 工作空间切换后数据隔离
   - 权限控制（Admin/Editor/Viewer）
   - 成员邀请和移除
   - 跨工作空间数据隔离

2. **性能基准**
   - 工作流列表查询 < 200ms
   - 工作空间切换 < 500ms
   - 成员列表查询 < 100ms

---

## 🔗 相关资源

### 参考文档

- Coze 官方文档：https://www.coze.cn/docs
- n8n 官方文档：https://docs.n8n.io/
- feature/exclusive-project-mode 分支分析（内部文档）

### 技术栈

- **后端：** Node.js + TypeScript + Express + TypeORM
- **前端：** Vue 3 + TypeScript + Pinia
- **数据库：** PostgreSQL 17.5 (Neon Cloud)
- **测试：** Jest (单元) + Playwright (E2E)

---

## 📝 版本历史

| 版本 | 日期 | 说明 | 作者 |
|------|------|------|------|
| v1.0 | 2025-11-03 | 初始版本：架构底层改造方案 | Claude Code |
| v1.1 | 2025-11-04 | 新增：Telemetry 独立管理平台方案 | Claude Code |
| v1.1 | 2025-11-04 | 清理：删除 5 个过时文档 | Claude Code |
| v1.2 | 2025-11-04 | 新增：品牌替换指南（n8n → quanyuge） | Claude Code |

---

## 📞 联系方式

如有疑问，请通过以下方式联系：

- **技术问题：** 在项目仓库提 Issue
- **方案讨论：** 通过团队协作工具沟通

---

**最后更新：** 2025-11-04
**文档状态：** ✅ 可用于实施
