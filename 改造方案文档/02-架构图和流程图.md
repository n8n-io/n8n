# n8n 多租户架构图和流程图

> **配套文档：** 01-架构底层改造方案.md
> **版本：** v1.0
> **日期：** 2025-11-03

---

## 一、数据库 E-R 关系图

### 1.1 核心实体关系

```mermaid
erDiagram
    User ||--o{ ProjectRelation : "belongs to"
    Project ||--o{ ProjectRelation : "has"
    Project ||--o{ Workflow : "owns"
    Project ||--o{ Credentials : "owns"
    Workflow ||--o{ Execution : "generates"

    User {
        uuid id PK
        string email
        string firstName
        string tier
        int max_projects
        jsonb settings
    }

    Project {
        uuid id PK
        string name
        string type
        string slug
        text description
        boolean is_default
        string status
        jsonb settings
    }

    ProjectRelation {
        uuid id PK
        uuid project_id FK
        uuid user_id FK
        string role
        timestamp joined_at
        uuid invited_by FK
    }

    Workflow {
        uuid id PK
        string name
        uuid project_id FK
        boolean active
        jsonb nodes
        jsonb connections
    }

    Credentials {
        uuid id PK
        string name
        uuid project_id FK
        string type
        text data
    }

    Execution {
        uuid id PK
        string workflow_id FK
        uuid billing_user_id FK
        string status
        decimal cost
        timestamp finished_at
    }
```

### 1.2 项目类型说明

```mermaid
graph TD
    Project[Project 项目]

    Project -->|type='personal'| Personal[个人空间]
    Project -->|type='team'| Team[团队空间]

    Personal --> P1[特征: 一个所有者]
    Personal --> P2[特征: isDefault=true]
    Personal --> P3[特征: settings=空]

    Team --> T1[特征: 多个成员]
    Team --> T2[特征: isDefault=false]
    Team --> T3[特征: settings.maxMembers]
    Team --> T4[特征: settings.billingMode]
```

---

## 二、架构对比图

### 2.1 改造前后查询路径对比

**改造前（4层JOIN）：**

```mermaid
graph LR
    User[用户] --> PR[ProjectRelation]
    PR --> Project[项目]
    Project --> SW[SharedWorkflow]
    SW --> Workflow[工作流]

    style SW fill:#ff6b6b
    style SW stroke:#ff0000,stroke-width:3px
```

**改造后（3层JOIN）：**

```mermaid
graph LR
    User[用户] --> PR[ProjectRelation]
    PR --> Project[工作空间]
    Project --> Workflow[工作流]

    style Project fill:#51cf66
    style Project stroke:#00ff00,stroke-width:3px
```

**性能提升：** ~30%

### 2.2 Coze 架构对标

```mermaid
graph TB
    subgraph Coze架构
        CUser[User] --> CWS1[Personal Workspace]
        CUser --> CWS2[Team Workspace]
        CWS1 --> CB1[Bot]
        CWS2 --> CB2[Bot]
        CWS2 --> CMembers[Members]
    end

    subgraph n8n改造后
        NUser[User] --> NP1[Project type=personal]
        NUser --> NP2[Project type=team]
        NP1 --> NW1[Workflow]
        NP2 --> NW2[Workflow]
        NP2 --> NPR[ProjectRelation]
    end

    CUser -.对应.-> NUser
    CWS1 -.对应.-> NP1
    CWS2 -.对应.-> NP2
    CB1 -.对应.-> NW1
    CB2 -.对应.-> NW2
    CMembers -.对应.-> NPR
```

---

## 三、工作空间管理流程

### 3.1 用户注册流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant A as AuthController
    participant US as UserService
    participant PS as ProjectService
    participant DB as 数据库

    U->>F: 填写注册信息
    F->>A: POST /auth/register
    A->>US: registerUser(data)
    US->>DB: 创建 User
    DB-->>US: user
    US->>PS: createPersonalWorkspace(user)
    PS->>DB: 创建 Project (type='personal', isDefault=true)
    DB-->>PS: project
    PS->>DB: 创建 ProjectRelation (role='project:admin')
    DB-->>PS: relation
    PS-->>US: project
    US-->>A: user
    A-->>F: { token, user, workspaces }
    F-->>U: 注册成功，自动登录
```

### 3.2 创建团队空间流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant W as WorkspacesController
    participant PS as ProjectService
    participant DB as 数据库

    U->>F: 点击"创建团队空间"
    F->>W: POST /workspaces
    W->>PS: createTeamWorkspace(user, data)

    PS->>DB: 检查用户配额 (user.maxProjects)
    DB-->>PS: 当前项目数

    alt 配额已满
        PS-->>W: Error: Project limit exceeded
        W-->>F: 403 Forbidden
        F-->>U: "已达到工作空间数量上限"
    else 配额充足
        PS->>DB: 创建 Project (type='team')
        DB-->>PS: project
        PS->>DB: 创建 ProjectRelation (创建者为admin)
        DB-->>PS: relation
        PS-->>W: project
        W-->>F: { project }
        F-->>U: "团队空间创建成功"
    end
```

### 3.3 邀请成员流程

```mermaid
sequenceDiagram
    participant Admin as 管理员
    participant F as 前端
    participant W as WorkspacesController
    participant PS as ProjectService
    participant DB as 数据库
    participant Member as 被邀请成员

    Admin->>F: 输入成员邮箱和角色
    F->>W: POST /workspaces/:id/members
    W->>PS: isUserAdmin(workspaceId, adminId)
    PS->>DB: 检查管理员权限

    alt 不是管理员
        PS-->>W: false
        W-->>F: 403 Forbidden
        F-->>Admin: "需要管理员权限"
    else 是管理员
        PS-->>W: true
        W->>PS: addMember(workspaceId, userId, role)
        PS->>DB: 检查成员数量限制

        alt 超过限制
            PS-->>W: Error: Member limit exceeded
            W-->>F: 400 Bad Request
            F-->>Admin: "成员数量已达上限"
        else 未超过限制
            PS->>DB: 创建 ProjectRelation
            DB-->>PS: relation
            PS-->>W: success
            W-->>F: { success: true }
            F-->>Admin: "成员添加成功"
            F->>Member: 发送邀请通知（可选）
        end
    end
```

---

## 四、工作空间切换流程

### 4.1 前端切换流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant WS as WorkspaceSwitcher
    participant Store as ProjectsStore
    participant LS as localStorage
    participant View as WorkflowsView
    participant API as 后端API

    U->>WS: 点击切换工作空间
    WS->>Store: setActiveWorkspace(workspaceId)
    Store->>LS: 保存 activeWorkspaceId
    LS-->>Store: 保存成功
    Store->>Store: 更新 currentWorkspaceId

    Note over Store,View: 触发 watch 监听

    View->>Store: 监听到 currentWorkspaceId 变化
    View->>API: GET /workflows?workspaceId=xxx
    API-->>View: { workflows }
    View->>View: 更新工作流列表
    View-->>U: 显示新工作空间的数据
```

### 4.2 数据隔离验证流程

```mermaid
graph TD
    Start[用户请求工作流] --> Extract[提取 workspaceId]
    Extract --> Validate[WorkspaceContextService.validateAccess]

    Validate --> CheckRelation{是否是工作空间成员?}
    CheckRelation -->|否| Deny[返回 403 Forbidden]
    CheckRelation -->|是| CheckRole{检查角色权限}

    CheckRole -->|Viewer| ReadOnly[只能查看]
    CheckRole -->|Editor| CanEdit[可以编辑]
    CheckRole -->|Admin| FullAccess[完全权限]

    ReadOnly --> Execute[执行业务逻辑]
    CanEdit --> Execute
    FullAccess --> Execute

    Execute --> Query[查询数据: WHERE projectId = workspaceId]
    Query --> Return[返回结果]

    Deny --> End[结束]
    Return --> End
```

---

## 五、权限管理架构

### 5.1 三级权限模型

```mermaid
graph TB
    subgraph 工作空间级权限
        Admin[project:admin<br/>管理员]
        Editor[project:editor<br/>编辑者]
        Viewer[project:viewer<br/>查看者]
    end

    Admin --> A1[创建/编辑/删除工作流]
    Admin --> A2[邀请/移除成员]
    Admin --> A3[修改工作空间设置]
    Admin --> A4[归档工作空间]

    Editor --> E1[创建/编辑工作流]
    Editor --> E2[查看成员列表]
    Editor -.不能.-> E3[管理成员]

    Viewer --> V1[查看工作流]
    Viewer -.不能.-> V2[编辑工作流]
    Viewer -.不能.-> V3[创建工作流]

    style Admin fill:#ff6b6b
    style Editor fill:#ffd93d
    style Viewer fill:#51cf66
```

### 5.2 权限检查流程

```mermaid
flowchart TD
    Request[API 请求] --> Extract[提取 workspaceId + userId]
    Extract --> CheckAccess{是否有访问权限?}

    CheckAccess -->|否| Return403[返回 403]
    CheckAccess -->|是| GetRole[获取用户角色]

    GetRole --> CheckAction{检查操作类型}

    CheckAction -->|读操作| AnyRole{任何角色?}
    CheckAction -->|写操作| EditorOrAdmin{Editor 或 Admin?}
    CheckAction -->|管理操作| AdminOnly{仅 Admin?}

    AnyRole -->|是| Allow[允许操作]
    AnyRole -->|否| Deny[拒绝操作]

    EditorOrAdmin -->|是| Allow
    EditorOrAdmin -->|否| Deny

    AdminOnly -->|是| Allow
    AdminOnly -->|否| Deny

    Allow --> Execute[执行业务逻辑]
    Deny --> Return403

    Execute --> Response[返回结果]
    Return403 --> End[结束]
    Response --> End
```

---

## 六、数据查询优化

### 6.1 查询性能对比

```mermaid
graph TB
    subgraph 改造前
        U1[User] -.1.-> PR1[ProjectRelation]
        PR1 -.2.-> P1[Project]
        P1 -.3.-> SW[SharedWorkflow]
        SW -.4.-> W1[Workflow]
    end

    subgraph 改造后
        U2[User] -.1.-> PR2[ProjectRelation]
        PR2 -.2.-> P2[Project]
        P2 -.3.-> W2[Workflow]
    end

    Note1[4 层 JOIN<br/>查询时间: ~150ms]
    Note2[3 层 JOIN<br/>查询时间: ~100ms<br/>性能提升: 33%]

    style SW fill:#ff6b6b
    style W2 fill:#51cf66
```

### 6.2 索引策略

```mermaid
graph LR
    subgraph 关键索引
        I1[project.type]
        I2[project.status]
        I3[project.slug]
        I4[workflow.projectId]
        I5[workflow.projectId + active]
        I6[credentials.projectId]
        I7[project_relation.projectId]
        I8[project_relation.userId]
    end

    subgraph 查询优化
        Q1[获取用户工作空间] --> I7
        Q1 --> I8
        Q2[获取工作空间工作流] --> I4
        Q3[获取活跃工作流] --> I5
        Q4[获取工作空间凭证] --> I6
    end
```

---

## 七、用户体验流程

### 7.1 完整用户旅程

```mermaid
journey
    title 用户从注册到团队协作的旅程
    section 注册
      填写信息: 5: 用户
      自动创建个人空间: 5: 系统
      进入主页: 5: 用户
    section 个人使用
      创建工作流: 4: 用户
      配置凭证: 4: 用户
      执行工作流: 5: 用户
    section 团队协作
      创建团队空间: 4: 用户
      邀请同事: 4: 用户
      同事加入: 5: 同事
      协同编辑: 5: 用户, 同事
    section 工作空间切换
      点击切换器: 5: 用户
      选择团队空间: 5: 用户
      查看团队数据: 5: 用户
      切换回个人空间: 5: 用户
```

### 7.2 工作空间切换交互流程

```mermaid
stateDiagram-v2
    [*] --> 个人空间: 用户登录
    个人空间 --> 工作空间切换器: 点击左上角
    工作空间切换器 --> 个人空间: 选择个人空间
    工作空间切换器 --> 团队空间A: 选择团队空间A
    工作空间切换器 --> 团队空间B: 选择团队空间B
    工作空间切换器 --> 创建新空间: 点击"创建"

    团队空间A --> 工作空间切换器: 点击切换
    团队空间B --> 工作空间切换器: 点击切换

    state 个人空间 {
        [*] --> 显示个人工作流
        显示个人工作流 --> 创建工作流
        创建工作流 --> 执行工作流
    }

    state 团队空间A {
        [*] --> 显示团队工作流
        显示团队工作流 --> 协同编辑
        协同编辑 --> 成员管理
    }

    创建新空间 --> 团队空间B: 创建成功
```

---

## 八、计费系统架构预留（Phase 2）

### 8.1 计费数据流

```mermaid
flowchart TD
    User[用户触发执行] --> Workflow[工作流执行]
    Workflow --> CheckBalance{检查余额}

    CheckBalance -->|余额不足| Stop[拒绝执行]
    CheckBalance -->|余额充足| Execute[执行工作流]

    Execute --> CalcCost[计算成本]
    CalcCost --> Deduct[扣除余额]

    Deduct --> CreateRecord[创建消费记录]
    CreateRecord --> CheckMode{检查计费模式}

    CheckMode -->|个人空间| BillUser[从用户扣费]
    CheckMode -->|团队空间 + owner_pays| BillOwner[从团队所有者扣费]
    CheckMode -->|团队空间 + member_pays| BillMember[从执行成员扣费]

    BillUser --> UpdateBalance[更新余额]
    BillOwner --> UpdateBalance
    BillMember --> UpdateBalance

    UpdateBalance --> ExecutionComplete[执行完成]
    Stop --> End[结束]
    ExecutionComplete --> End
```

### 8.2 计费相关表结构（预留）

```mermaid
erDiagram
    User ||--o| UserBalance : "has"
    User ||--o{ UsageRecord : "generates"
    User ||--o{ RechargeRecord : "makes"
    Execution ||--o| UsageRecord : "creates"

    UserBalance {
        uuid id PK
        uuid user_id FK
        decimal balance
        string currency
        timestamp updated_at
    }

    UsageRecord {
        uuid id PK
        uuid user_id FK
        uuid billing_user_id FK
        string resource_type
        uuid resource_id FK
        decimal amount
        jsonb metadata
        timestamp created_at
    }

    RechargeRecord {
        uuid id PK
        uuid user_id FK
        decimal amount
        string payment_method
        string transaction_id
        string status
        timestamp completed_at
    }
```

---

## 九、部署架构

### 9.1 系统架构图

```mermaid
graph TB
    subgraph 前端层
        UI[Vue.js 前端]
        WS[WorkspaceSwitcher]
    end

    subgraph API层
        Gateway[API Gateway]
        Auth[AuthController]
        Workspaces[WorkspacesController]
        Workflows[WorkflowsController]
    end

    subgraph 服务层
        WCS[WorkspaceContextService]
        PS[ProjectService]
        WFS[WorkflowService]
    end

    subgraph 数据层
        Repo[Repositories]
        DB[(PostgreSQL)]
    end

    UI --> Gateway
    WS --> Gateway
    Gateway --> Auth
    Gateway --> Workspaces
    Gateway --> Workflows

    Auth --> WCS
    Workspaces --> PS
    Workflows --> WFS

    WCS --> Repo
    PS --> Repo
    WFS --> Repo

    Repo --> DB
```

### 9.2 微服务拆分（未来可选）

```mermaid
graph LR
    subgraph 当前单体架构
        M[Monolith<br/>n8n Server]
    end

    subgraph 未来微服务架构
        Gateway[API Gateway]
        Auth[Auth Service]
        Workspace[Workspace Service]
        Workflow[Workflow Service]
        Execution[Execution Service]
        Billing[Billing Service]
    end

    M -.演进.-> Gateway
    Gateway --> Auth
    Gateway --> Workspace
    Gateway --> Workflow
    Gateway --> Execution
    Gateway --> Billing
```

---

## 十、监控和可观测性

### 10.1 关键指标监控

```mermaid
graph TD
    subgraph 性能指标
        M1[工作流列表查询时间]
        M2[工作空间切换时间]
        M3[成员列表查询时间]
        M4[权限检查耗时]
    end

    subgraph 业务指标
        B1[活跃工作空间数]
        B2[团队空间占比]
        B3[平均成员数]
        B4[工作空间切换频率]
    end

    subgraph 告警规则
        A1[查询时间 > 500ms]
        A2[错误率 > 1%]
        A3[权限拒绝率 > 5%]
    end

    M1 --> A1
    M2 --> A1
    M3 --> A1
    M4 --> A2

    A1 -.触发.-> Alert[告警通知]
    A2 -.触发.-> Alert
    A3 -.触发.-> Alert
```

---

## 十一、附录

### 11.1 图例说明

| 符号 | 含义 |
|------|------|
| `-->` | 强关联/必需 |
| `-.->` | 弱关联/可选 |
| `||--o{` | 一对多关系 |
| `||--||` | 一对一关系 |
| `o{--o{` | 多对多关系 |

### 11.2 颜色说明

- 🔴 红色：需要删除或废弃的部分
- 🟢 绿色：新增或优化的部分
- 🟡 黄色：需要注意的部分
- 🔵 蓝色：预留但未实现的部分

---

**文档版本：** v1.0
**最后更新：** 2025-11-03
**配套文档：** 01-架构底层改造方案.md
