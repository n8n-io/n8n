# n8n å¤šç§Ÿæˆ·æ¶æ„å›¾å’Œæµç¨‹å›¾ï¼ˆæ¿€è¿›æ”¹é€ ç‰ˆï¼‰

> **é…å¥—æ–‡æ¡£ï¼š** 01-æ¶æ„åº•å±‚æ”¹é€ æ–¹æ¡ˆ.md (v3.0)
> **ç‰ˆæœ¬ï¼š** v2.0 (æ¿€è¿›æ”¹é€ ç‰ˆ + Coze å¯¹æ ‡)
> **æ—¥æœŸï¼š** 2025-11-07

---

## ä¸€ã€æ•°æ®åº“ E-R å…³ç³»å›¾

### 1.1 æ ¸å¿ƒå®ä½“å…³ç³»ï¼ˆæ¿€è¿›æ”¹é€ åï¼‰

```mermaid
erDiagram
    User ||--o{ ProjectRelation : "belongs to"
    Project ||--o{ ProjectRelation : "has"
    Project ||--o{ Workflow : "owns (direct FK)"
    Project ||--o{ Credentials : "owns (direct FK)"
    Project ||--|| WorkspaceBalance : "has balance"
    Workflow ||--o{ Execution : "generates"
    Execution ||--o| UsageRecord : "creates billing record"
    WorkspaceBalance ||--o{ UsageRecord : "pays for"
    WorkspaceBalance ||--o{ RechargeRecord : "receives"
    PlatformService ||--o{ UsageRecord : "consumed via"
    PlatformRagService ||--o{ UsageRecord : "consumed via"

    User {
        uuid id PK
        string email
        string firstName
        string tier
        int max_projects
        jsonb settings
        boolean is_admin "åå°ç®¡ç†å‘˜æ ‡è¯†"
    }

    Project {
        uuid id PK
        string name
        string type "personal | team"
        string slug
        text description
        boolean is_default
        string status "active | archived | suspended"
        jsonb settings
    }

    ProjectRelation {
        uuid id PK
        uuid project_id FK
        uuid user_id FK
        string role "project:admin | project:editor | project:viewer"
        timestamp joined_at
        uuid invited_by FK
    }

    Workflow {
        uuid id PK
        string name
        uuid project_id FK "ç›´æ¥å¤–é”®,æ— éœ€ SharedWorkflow"
        boolean active
        jsonb nodes
        jsonb connections
    }

    Credentials {
        uuid id PK
        string name
        uuid project_id FK "ç›´æ¥å¤–é”®,æ— éœ€ SharedCredentials"
        string type
        text data
        boolean is_managed "å¹³å°æ‰˜ç®¡å‡­è¯"
    }

    Execution {
        uuid id PK
        string workflow_id FK
        uuid workspace_id FK "è®¡è´¹å·¥ä½œç©ºé—´"
        string status
        timestamp finished_at
    }

    WorkspaceBalance {
        uuid id PK
        uuid workspace_id FK "å…³è” Project"
        decimal balance_cny "äººæ°‘å¸ä½™é¢"
        decimal low_balance_threshold_cny
        string currency "CNY"
        timestamp updated_at
    }

    PlatformService {
        string service_key PK "å¦‚ gpt-4-turbo"
        string service_type "ai_model | tts | stt | image_gen"
        string name
        jsonb pricing_config "è®¡è´¹é…ç½®"
        boolean is_active
    }

    PlatformRagService {
        string service_key PK "å¦‚ legal-rag-cn"
        string name
        string domain "legal | medical | finance"
        decimal price_per_query_cny
        jsonb metadata
        boolean is_active
    }

    UsageRecord {
        uuid id PK
        uuid workspace_id FK
        uuid user_id FK
        string service_key FK "PlatformService æˆ– PlatformRagService"
        string service_type
        int tokens_used
        int calls_count
        decimal amount_cny "æ¶ˆè´¹é‡‘é¢(RMB)"
        jsonb metadata
        timestamp created_at
    }

    RechargeRecord {
        uuid id PK
        uuid workspace_id FK
        uuid user_id FK "å……å€¼å‘èµ·äºº"
        decimal amount_cny
        string payment_method
        string transaction_id
        string status "pending | completed | failed"
        timestamp completed_at
    }
```

### 1.2 æ”¹é€ å‰åå¯¹æ¯”

**æ ¸å¿ƒå˜åŒ–ï¼š**

| é¡¹ç›® | æ”¹é€ å‰ (v1.0) | æ”¹é€ å (v2.0 æ¿€è¿›ç‰ˆ) |
|------|---------------|---------------------|
| **Workflow å…³è”** | `Workflow â†’ SharedWorkflow â†’ Project` | `Workflow.projectId â†’ Project` |
| **Credentials å…³è”** | `Credentials â†’ SharedCredentials â†’ Project` | `Credentials.projectId â†’ Project` |
| **æŸ¥è¯¢å±‚çº§** | 4 å±‚ JOIN | 3 å±‚ JOIN |
| **æ€§èƒ½æå‡** | - | 30-40% |
| **ä»£ç ç®€åŒ–** | - | åˆ é™¤ 147 å¤„ SharedWorkflow å¼•ç”¨<br/>åˆ é™¤ 95 å¤„ SharedCredentials å¼•ç”¨ |
| **è®¡è´¹ç³»ç»Ÿ** | é¢„ç•™ (UserBalance) | å®é™…å®ç° (WorkspaceBalance + RMB) |
| **å¹³å°æœåŠ¡** | æ—  | PlatformService + PlatformRagService |

---

## äºŒã€æ¶æ„å¯¹æ¯”å›¾

### 2.1 æ”¹é€ å‰åæŸ¥è¯¢è·¯å¾„å¯¹æ¯”

**æ”¹é€ å‰ï¼ˆ4å±‚JOIN - å·²åºŸå¼ƒï¼‰ï¼š**

```mermaid
graph LR
    User[ç”¨æˆ·] --> PR[ProjectRelation]
    PR --> Project[é¡¹ç›®]
    Project --> SW[SharedWorkflow âŒ]
    SW --> Workflow[å·¥ä½œæµ]

    style SW fill:#ff6b6b
    style SW stroke:#ff0000,stroke-width:3px
```

**æ”¹é€ åï¼ˆ3å±‚JOIN - æ¿€è¿›æ”¹é€ ï¼‰ï¼š**

```mermaid
graph LR
    User[ç”¨æˆ·] --> PR[ProjectRelation]
    PR --> Project[å·¥ä½œç©ºé—´]
    Project --> Workflow[å·¥ä½œæµ âœ…]
    Project --> Credentials[å‡­è¯ âœ…]

    style Project fill:#51cf66
    style Project stroke:#00ff00,stroke-width:3px
    style Workflow fill:#51cf66
    style Credentials fill:#51cf66
```

**å…³é”®æ”¹è¿›ï¼š**
- âŒ åˆ é™¤ `SharedWorkflow` è¡¨åŠæ‰€æœ‰å¼•ç”¨ï¼ˆ147 å¤„ï¼‰
- âŒ åˆ é™¤ `SharedCredentials` è¡¨åŠæ‰€æœ‰å¼•ç”¨ï¼ˆ95 å¤„ï¼‰
- âœ… ç›´æ¥åœ¨ `Workflow.projectId` å¤–é”®å…³è”
- âœ… ç›´æ¥åœ¨ `Credentials.projectId` å¤–é”®å…³è”
- âš¡ æ€§èƒ½æå‡ 30-40%

### 2.2 Coze å•†ä¸šç‰ˆæ¶æ„å¯¹æ ‡

```mermaid
graph TB
    subgraph Cozeå•†ä¸šç‰ˆæ¶æ„
        CUser[User<br/>ç”¨æˆ·] --> CWS1[Personal Workspace<br/>ä¸ªäººç©ºé—´]
        CUser --> CWS2[Team Workspace<br/>å›¢é˜Ÿç©ºé—´]
        CWS1 --> CB1[Bot/Workflow<br/>å·¥ä½œæµ]
        CWS2 --> CB2[Bot/Workflow<br/>å›¢é˜Ÿå·¥ä½œæµ]
        CWS2 --> CMembers[Members<br/>å›¢é˜Ÿæˆå‘˜]

        CUser --> CBilling[Billing Center<br/>è®¡è´¹ä¸­å¿ƒ]
        CBilling --> CRGPT[GPT-4 è°ƒç”¨<br/>æŒ‰é‡è®¡è´¹]
        CBilling --> CRKnowledge[çŸ¥è¯†åº“å­˜å‚¨<br/>æŒ‰GBè®¡è´¹]
    end

    subgraph n8næ”¹é€ åæ¶æ„
        NUser[User<br/>ç”¨æˆ·] --> NP1[Project type=personal<br/>ä¸ªäººç©ºé—´]
        NUser --> NP2[Project type=team<br/>å›¢é˜Ÿç©ºé—´]
        NP1 --> NW1[Workflow<br/>å·¥ä½œæµ]
        NP2 --> NW2[Workflow<br/>å›¢é˜Ÿå·¥ä½œæµ]
        NP2 --> NPR[ProjectRelation<br/>æˆå‘˜å…³ç³»]

        NP1 --> NBalance1[WorkspaceBalance<br/>ä¸ªäººä½™é¢Â¥]
        NP2 --> NBalance2[WorkspaceBalance<br/>å›¢é˜Ÿä½™é¢Â¥]
        NBalance1 --> NRGPT[PlatformService<br/>AIæ¨¡å‹è°ƒç”¨]
        NBalance2 --> NRRag[PlatformRagService<br/>å‚ç›´RAGæœåŠ¡]
    end

    CUser -.å¯¹åº”.-> NUser
    CWS1 -.å¯¹åº”.-> NP1
    CWS2 -.å¯¹åº”.-> NP2
    CB1 -.å¯¹åº”.-> NW1
    CB2 -.å¯¹åº”.-> NW2
    CMembers -.å¯¹åº”.-> NPR
    CBilling -.å¯¹åº”.-> NBalance1
    CRGPT -.å¯¹åº”.-> NRGPT
    CRKnowledge -.å¯¹åº”.-> NRRag

    style CUser fill:#e3f2fd
    style NUser fill:#e8f5e9
    style CBilling fill:#fff3e0
    style NBalance1 fill:#fff8e1
    style NBalance2 fill:#fff8e1
```

**Coze å¯¹æ ‡è¯´æ˜ï¼š**

| Coze æ¦‚å¿µ | n8n å®ç° | è¯´æ˜ |
|-----------|----------|------|
| Personal Workspace | `Project (type='personal')` | ä¸ªäººç©ºé—´ï¼Œé»˜è®¤åˆ›å»º |
| Team Workspace | `Project (type='team')` | å›¢é˜Ÿç©ºé—´ï¼Œæ”¯æŒå¤šæˆå‘˜ |
| Bot | `Workflow` | å·¥ä½œæµå³ä¸º Bot |
| Billing Center | `WorkspaceBalance` | å·¥ä½œç©ºé—´ä½™é¢(RMB) |
| GPT-4 è°ƒç”¨ | `PlatformService` | AI æ¨¡å‹æŒ‰ token è®¡è´¹ |
| çŸ¥è¯†åº“å­˜å‚¨ | `PlatformRagService` | å‚ç›´é¢†åŸŸ RAG æŒ‰æŸ¥è¯¢è®¡è´¹ |

---

## ä¸‰ã€å¹³å° RAG æœåŠ¡æ¶æ„

### 3.1 å¹³å° RAG æœåŠ¡æ¦‚å¿µ

**âŒ ä¸åšï¼š**
- ä¸æä¾›é€šç”¨çŸ¥è¯†åº“å­˜å‚¨ï¼ˆç”¨æˆ·è‡ªå·±ç”¨ n8n è¿æ¥å‘é‡æ•°æ®åº“ï¼‰
- ä¸åšæŒ‰ GB å­˜å‚¨è®¡è´¹

**âœ… è¦åšï¼š**
- æä¾›å‚ç›´é¢†åŸŸä¸“ä¸šçŸ¥è¯†åº“ï¼ˆæ³•å¾‹ã€åŒ»ç–—ã€é‡‘èç­‰ï¼‰
- ä½œä¸ºå¹³å°æ’ä»¶/èŠ‚ç‚¹ä¾›ç”¨æˆ·è°ƒç”¨
- æŒ‰æŸ¥è¯¢æ¬¡æ•°è®¡è´¹ï¼ˆRMBï¼‰

### 3.2 å¹³å° RAG æœåŠ¡æ¶æ„å›¾

```mermaid
graph TB
    subgraph ç”¨æˆ·å·¥ä½œæµ
        UserWorkflow[User Workflow<br/>ç”¨æˆ·å·¥ä½œæµ]
        RagNode[Platform RAG Node<br/>å¹³å° RAG èŠ‚ç‚¹]
    end

    subgraph å¹³å° RAG æœåŠ¡å±‚
        RagGateway[RAG Service Gateway<br/>RAG æœåŠ¡ç½‘å…³]
        LegalRag[Legal RAG Service<br/>æ³•å¾‹çŸ¥è¯†åº“]
        MedicalRag[Medical RAG Service<br/>åŒ»ç–—çŸ¥è¯†åº“]
        FinanceRag[Finance RAG Service<br/>é‡‘èçŸ¥è¯†åº“]
    end

    subgraph å¹³å°å‘é‡æ•°æ®åº“
        LegalVectorDB[(Legal Vector DB<br/>æ³•å¾‹å‘é‡åº“)]
        MedicalVectorDB[(Medical Vector DB<br/>åŒ»ç–—å‘é‡åº“)]
        FinanceVectorDB[(Finance Vector DB<br/>é‡‘èå‘é‡åº“)]
    end

    subgraph è®¡è´¹ç³»ç»Ÿ
        BillingService[BillingService<br/>è®¡è´¹æœåŠ¡]
        WorkspaceBalance[WorkspaceBalance<br/>å·¥ä½œç©ºé—´ä½™é¢]
    end

    UserWorkflow --> RagNode
    RagNode --> RagGateway

    RagGateway --> LegalRag
    RagGateway --> MedicalRag
    RagGateway --> FinanceRag

    LegalRag --> LegalVectorDB
    MedicalRag --> MedicalVectorDB
    FinanceRag --> FinanceVectorDB

    RagGateway --> BillingService
    BillingService --> WorkspaceBalance

    style RagNode fill:#ffd93d
    style BillingService fill:#ff6b6b
    style WorkspaceBalance fill:#ff6b6b
```

### 3.3 å¹³å° RAG æœåŠ¡è°ƒç”¨æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·å·¥ä½œæµ
    participant Node as PlatformRagNode
    participant Gateway as RAG Gateway
    participant Billing as BillingService
    participant Balance as WorkspaceBalance
    participant RagService as Legal RAG Service
    participant VectorDB as Legal Vector DB

    User->>Node: è§¦å‘ RAG æŸ¥è¯¢<br/>query: "åŠ³åŠ¨åˆåŒçº çº·æ¡ˆä¾‹"
    Node->>Gateway: POST /api/platform-rag/query
    Gateway->>Billing: checkBalance(workspaceId)
    Billing->>Balance: æŸ¥è¯¢ä½™é¢
    Balance-->>Billing: balance_cny: 100.00

    alt ä½™é¢ä¸è¶³
        Billing-->>Gateway: Error: Insufficient balance
        Gateway-->>Node: 402 Payment Required
        Node-->>User: "ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼"
    else ä½™é¢å……è¶³
        Billing-->>Gateway: OK
        Gateway->>RagService: query("åŠ³åŠ¨åˆåŒçº çº·æ¡ˆä¾‹")
        RagService->>VectorDB: å‘é‡æœç´¢
        VectorDB-->>RagService: è¿”å›ç›¸å…³æ¡ˆä¾‹
        RagService-->>Gateway: è¿”å›ç»“æœ

        Gateway->>Billing: recordUsageAndCharge({<br/>  workspaceId,<br/>  serviceKey: "legal-rag-cn",<br/>  serviceType: "rag_service",<br/>  callsCount: 1,<br/>  amountCny: 0.50<br/>})
        Billing->>Balance: æ‰£é™¤ Â¥0.50
        Billing->>UsageRecord: åˆ›å»ºä½¿ç”¨è®°å½•

        Gateway-->>Node: è¿”å› RAG ç»“æœ
        Node-->>User: æ˜¾ç¤ºæ³•å¾‹æ¡ˆä¾‹ç»“æœ
    end
```

**è®¡è´¹ç¤ºä¾‹ï¼š**
- `legal-rag-cn`: Â¥0.50/æ¬¡æŸ¥è¯¢
- `medical-rag-cn`: Â¥0.80/æ¬¡æŸ¥è¯¢
- `finance-rag-cn`: Â¥0.60/æ¬¡æŸ¥è¯¢

---

## å››ã€å·¥ä½œç©ºé—´ç®¡ç†æµç¨‹

### 4.1 ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼ˆå«ä¸ªäººä½™é¢åˆå§‹åŒ–ï¼‰

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant A as AuthController
    participant US as UserService
    participant PS as ProjectService
    participant BS as BillingService
    participant DB as æ•°æ®åº“

    U->>F: å¡«å†™æ³¨å†Œä¿¡æ¯
    F->>A: POST /auth/register
    A->>US: registerUser(data)
    US->>DB: åˆ›å»º User
    DB-->>US: user

    US->>PS: createPersonalWorkspace(user)
    PS->>DB: åˆ›å»º Project (type='personal', isDefault=true)
    DB-->>PS: project
    PS->>DB: åˆ›å»º ProjectRelation (role='project:admin')
    DB-->>PS: relation

    PS->>BS: initializeWorkspaceBalance(project.id)
    BS->>DB: åˆ›å»º WorkspaceBalance (balance_cny=0, threshold=10)
    DB-->>BS: balance

    PS-->>US: project
    US-->>A: user
    A-->>F: { token, user, workspaces }
    F-->>U: æ³¨å†ŒæˆåŠŸï¼Œè‡ªåŠ¨ç™»å½•<br/>ğŸ’° åˆå§‹ä½™é¢: Â¥0.00
```

### 4.2 åˆ›å»ºå›¢é˜Ÿç©ºé—´æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant W as WorkspacesController
    participant PS as ProjectService
    participant BS as BillingService
    participant DB as æ•°æ®åº“

    U->>F: ç‚¹å‡»"åˆ›å»ºå›¢é˜Ÿç©ºé—´"
    F->>W: POST /workspaces
    W->>PS: createTeamWorkspace(user, data)

    PS->>DB: æ£€æŸ¥ç”¨æˆ·é…é¢ (user.maxProjects)
    DB-->>PS: å½“å‰é¡¹ç›®æ•°

    alt é…é¢å·²æ»¡
        PS-->>W: Error: Project limit exceeded
        W-->>F: 403 Forbidden
        F-->>U: "å·²è¾¾åˆ°å·¥ä½œç©ºé—´æ•°é‡ä¸Šé™"
    else é…é¢å……è¶³
        PS->>DB: åˆ›å»º Project (type='team')
        DB-->>PS: project
        PS->>DB: åˆ›å»º ProjectRelation (åˆ›å»ºè€…ä¸ºadmin)
        DB-->>PS: relation

        PS->>BS: initializeWorkspaceBalance(project.id)
        BS->>DB: åˆ›å»º WorkspaceBalance (balance_cny=0)
        DB-->>BS: balance

        PS-->>W: project
        W-->>F: { project }
        F-->>U: "å›¢é˜Ÿç©ºé—´åˆ›å»ºæˆåŠŸ"<br/>ğŸ’° å›¢é˜Ÿä½™é¢: Â¥0.00
    end
```

### 4.3 å·¥ä½œç©ºé—´å……å€¼æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant BC as BillingController
    participant BS as BillingService
    participant Payment as æ”¯ä»˜ç½‘å…³
    participant DB as æ•°æ®åº“

    U->>F: ç‚¹å‡»"å……å€¼"ï¼Œè¾“å…¥é‡‘é¢ Â¥100
    F->>BC: POST /billing/recharge
    BC->>BS: createRechargeOrder({<br/>  workspaceId,<br/>  userId,<br/>  amountCny: 100<br/>})
    BS->>DB: åˆ›å»º RechargeRecord (status='pending')
    DB-->>BS: record
    BS-->>BC: { orderId, paymentUrl }
    BC-->>F: { paymentUrl }

    F->>U: è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
    U->>Payment: å®Œæˆæ”¯ä»˜
    Payment->>BC: POST /billing/recharge/callback
    BC->>BS: handleRechargeCallback(orderId)
    BS->>DB: æ›´æ–° RechargeRecord (status='completed')
    BS->>DB: æ›´æ–° WorkspaceBalance (+100.00)
    DB-->>BS: success
    BS-->>BC: success
    BC-->>Payment: 200 OK

    Payment->>F: é‡å®šå‘å›å‰ç«¯
    F->>F: åˆ·æ–°ä½™é¢
    F-->>U: "å……å€¼æˆåŠŸï¼å½“å‰ä½™é¢: Â¥100.00"
```

---

## äº”ã€æƒé™ç®¡ç†æ¶æ„

### 5.1 ä¸‰çº§æƒé™æ¨¡å‹ï¼ˆä¸å˜ï¼‰

```mermaid
graph TB
    subgraph å·¥ä½œç©ºé—´çº§æƒé™
        Admin[project:admin<br/>ç®¡ç†å‘˜]
        Editor[project:editor<br/>ç¼–è¾‘è€…]
        Viewer[project:viewer<br/>æŸ¥çœ‹è€…]
    end

    Admin --> A1[åˆ›å»º/ç¼–è¾‘/åˆ é™¤å·¥ä½œæµ]
    Admin --> A2[é‚€è¯·/ç§»é™¤æˆå‘˜]
    Admin --> A3[ä¿®æ”¹å·¥ä½œç©ºé—´è®¾ç½®]
    Admin --> A4[å·¥ä½œç©ºé—´å……å€¼]
    Admin --> A5[æŸ¥çœ‹æ¶ˆè´¹æ˜ç»†]

    Editor --> E1[åˆ›å»º/ç¼–è¾‘å·¥ä½œæµ]
    Editor --> E2[æŸ¥çœ‹æˆå‘˜åˆ—è¡¨]
    Editor --> E3[æŸ¥çœ‹ä½™é¢]
    Editor -.ä¸èƒ½.-> E4[å……å€¼]
    Editor -.ä¸èƒ½.-> E5[ç®¡ç†æˆå‘˜]

    Viewer --> V1[æŸ¥çœ‹å·¥ä½œæµ]
    Viewer --> V2[æŸ¥çœ‹ä½™é¢]
    Viewer -.ä¸èƒ½.-> V3[ç¼–è¾‘å·¥ä½œæµ]
    Viewer -.ä¸èƒ½.-> V4[åˆ›å»ºå·¥ä½œæµ]

    style Admin fill:#ff6b6b
    style Editor fill:#ffd93d
    style Viewer fill:#51cf66
```

### 5.2 åå°ç®¡ç†å‘˜æƒé™æ¶æ„ï¼ˆæ–°å¢ï¼‰

```mermaid
graph TB
    subgraph è¶…çº§ç®¡ç†å‘˜æƒé™
        SuperAdmin[is_admin=true<br/>è¶…çº§ç®¡ç†å‘˜]
    end

    SuperAdmin --> SA1[ç®¡ç†å¹³å°æœåŠ¡]
    SuperAdmin --> SA2[ç®¡ç†å¹³å° RAG æœåŠ¡]
    SuperAdmin --> SA3[æŸ¥çœ‹æ‰€æœ‰å·¥ä½œç©ºé—´]
    SuperAdmin --> SA4[å·¥ä½œç©ºé—´å……å€¼/æ‰£è´¹]
    SuperAdmin --> SA5[æŸ¥çœ‹å¹³å°ç»Ÿè®¡æ•°æ®]
    SuperAdmin --> SA6[ç³»ç»Ÿé…ç½®ç®¡ç†]

    SA1 --> SA1A[åˆ›å»º/ç¼–è¾‘/ç¦ç”¨ AI æ¨¡å‹]
    SA1 --> SA1B[é…ç½® AI æ¨¡å‹ä»·æ ¼]

    SA2 --> SA2A[åˆ›å»º/ç¼–è¾‘ RAG æœåŠ¡]
    SA2 --> SA2B[é…ç½® RAG æœåŠ¡ä»·æ ¼]

    SA3 --> SA3A[æœç´¢å·¥ä½œç©ºé—´]
    SA3 --> SA3B[æŸ¥çœ‹å·¥ä½œç©ºé—´è¯¦æƒ…]
    SA3 --> SA3C[æš‚åœ/æ¢å¤å·¥ä½œç©ºé—´]

    SA4 --> SA4A[ç®¡ç†å‘˜å……å€¼]
    SA4 --> SA4B[ç®¡ç†å‘˜æ‰£è´¹]
    SA4 --> SA4C[æŸ¥çœ‹å……å€¼è®°å½•]

    SA5 --> SA5A[å¹³å°æ”¶å…¥ç»Ÿè®¡]
    SA5 --> SA5B[æœåŠ¡ä½¿ç”¨æ’è¡Œ]
    SA5 --> SA5C[æ´»è·ƒå·¥ä½œç©ºé—´ç»Ÿè®¡]

    style SuperAdmin fill:#9c27b0
    style SA1 fill:#e1bee7
    style SA2 fill:#e1bee7
    style SA3 fill:#e1bee7
    style SA4 fill:#e1bee7
    style SA5 fill:#e1bee7
```

---

## å…­ã€åå°ç®¡ç†ç³»ç»Ÿæ¶æ„

### 6.1 åå°ç®¡ç†ç³»ç»Ÿ E-R å›¾

```mermaid
erDiagram
    User ||--o{ AdminLog : "operates"
    PlatformService ||--o{ UsageRecord : "consumed"
    PlatformRagService ||--o{ UsageRecord : "consumed"

    User {
        uuid id PK
        string email
        boolean is_admin "ç®¡ç†å‘˜æ ‡è¯†"
    }

    AdminLog {
        uuid id PK
        uuid admin_id FK
        string action "create_service | edit_service | recharge | suspend_workspace"
        string target_type "platform_service | workspace | rag_service"
        uuid target_id
        jsonb metadata
        timestamp created_at
    }

    PlatformService {
        string service_key PK
        string service_type "ai_model | tts | stt | image_gen"
        string name
        jsonb pricing_config
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }

    PlatformRagService {
        string service_key PK
        string name
        string domain
        decimal price_per_query_cny
        jsonb metadata
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }
```

### 6.2 åå°ç®¡ç†ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph åå°å‰ç«¯å±‚
        AdminUI[Admin UI<br/>åå°ç®¡ç†å‰ç«¯]
        Dashboard[Dashboard<br/>ç»Ÿè®¡é¢æ¿]
        ServiceMgmt[Service Management<br/>æœåŠ¡ç®¡ç†]
        WorkspaceMgmt[Workspace Management<br/>å·¥ä½œç©ºé—´ç®¡ç†]
    end

    subgraph åå° API å±‚
        AdminAuth[AdminAuthMiddleware<br/>ç®¡ç†å‘˜é‰´æƒ]
        AdminPlatformSvc[AdminPlatformServicesController]
        AdminWorkspace[AdminWorkspacesController]
        AdminStats[AdminStatsController]
    end

    subgraph æœåŠ¡å±‚
        PlatformSvcService[PlatformServiceService]
        BillingService[BillingService]
        StatsService[StatsService]
    end

    subgraph æ•°æ®å±‚
        DB[(PostgreSQL)]
    end

    AdminUI --> AdminAuth
    Dashboard --> AdminAuth
    ServiceMgmt --> AdminAuth
    WorkspaceMgmt --> AdminAuth

    AdminAuth --> AdminPlatformSvc
    AdminAuth --> AdminWorkspace
    AdminAuth --> AdminStats

    AdminPlatformSvc --> PlatformSvcService
    AdminWorkspace --> BillingService
    AdminStats --> StatsService

    PlatformSvcService --> DB
    BillingService --> DB
    StatsService --> DB

    style AdminAuth fill:#9c27b0
    style AdminPlatformSvc fill:#e1bee7
    style AdminWorkspace fill:#e1bee7
    style AdminStats fill:#e1bee7
```

### 6.3 å¹³å°æœåŠ¡ç®¡ç†æµç¨‹

```mermaid
sequenceDiagram
    participant Admin as ç®¡ç†å‘˜
    participant UI as åå° UI
    participant API as AdminPlatformServicesController
    participant Service as PlatformServiceService
    participant DB as æ•°æ®åº“

    Admin->>UI: ç™»å½•åå°ç®¡ç†ç³»ç»Ÿ
    UI->>API: GET /admin/platform-services
    API->>Service: listAllServices()
    Service->>DB: æŸ¥è¯¢ platform_services å’Œ platform_rag_services
    DB-->>Service: æœåŠ¡åˆ—è¡¨
    Service-->>API: è¿”å›æœåŠ¡
    API-->>UI: { services: [...] }
    UI-->>Admin: æ˜¾ç¤ºæœåŠ¡åˆ—è¡¨

    Admin->>UI: ç‚¹å‡»"æ–°å¢ AI æ¨¡å‹"
    UI->>Admin: æ˜¾ç¤ºè¡¨å•
    Admin->>UI: å¡«å†™ä¿¡æ¯ï¼ˆservice_key, name, pricing_configï¼‰
    UI->>API: POST /admin/platform-services
    API->>Service: createService(data)
    Service->>DB: INSERT INTO platform_services
    DB-->>Service: service
    Service->>DB: INSERT INTO admin_logs (action='create_service')
    Service-->>API: success
    API-->>UI: { service }
    UI-->>Admin: "AI æ¨¡å‹åˆ›å»ºæˆåŠŸ"

    Admin->>UI: ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®
    UI->>Admin: æ˜¾ç¤ºç¼–è¾‘è¡¨å•
    Admin->>UI: ä¿®æ”¹ä»·æ ¼é…ç½®
    UI->>API: PATCH /admin/platform-services/:key
    API->>Service: updateService(serviceKey, updates)
    Service->>DB: UPDATE platform_services
    Service->>DB: INSERT INTO admin_logs (action='edit_service')
    Service-->>API: success
    API-->>UI: { service }
    UI-->>Admin: "ä»·æ ¼æ›´æ–°æˆåŠŸ"
```

### 6.4 å·¥ä½œç©ºé—´ç®¡ç†æµç¨‹ï¼ˆç®¡ç†å‘˜å……å€¼ï¼‰

```mermaid
sequenceDiagram
    participant Admin as ç®¡ç†å‘˜
    participant UI as åå° UI
    participant API as AdminWorkspacesController
    participant BS as BillingService
    participant DB as æ•°æ®åº“

    Admin->>UI: æœç´¢å·¥ä½œç©ºé—´
    UI->>API: GET /admin/workspaces?search=ç”¨æˆ·é‚®ç®±
    API->>DB: æŸ¥è¯¢å·¥ä½œç©ºé—´
    DB-->>API: å·¥ä½œç©ºé—´åˆ—è¡¨
    API-->>UI: { workspaces: [...] }
    UI-->>Admin: æ˜¾ç¤ºå·¥ä½œç©ºé—´åˆ—è¡¨

    Admin->>UI: ç‚¹å‡»"å……å€¼"
    UI->>Admin: æ˜¾ç¤ºå……å€¼è¡¨å•
    Admin->>UI: è¾“å…¥é‡‘é¢ Â¥500 å’Œå¤‡æ³¨
    UI->>API: POST /admin/workspaces/:id/recharge
    API->>BS: adminRecharge({<br/>  workspaceId,<br/>  adminId,<br/>  amountCny: 500,<br/>  note: "ç®¡ç†å‘˜è¡¥å¿å……å€¼"<br/>})
    BS->>DB: åˆ›å»º RechargeRecord (status='completed', payment_method='admin')
    BS->>DB: æ›´æ–° WorkspaceBalance (+500.00)
    BS->>DB: åˆ›å»º AdminLog (action='admin_recharge')
    DB-->>BS: success
    BS-->>API: success
    API-->>UI: { success: true }
    UI-->>Admin: "å……å€¼æˆåŠŸï¼å·¥ä½œç©ºé—´ä½™é¢å·²æ›´æ–°"
```

### 6.5 å¹³å°ç»Ÿè®¡æ•°æ®æµç¨‹

```mermaid
sequenceDiagram
    participant Admin as ç®¡ç†å‘˜
    participant UI as Dashboard
    participant API as AdminStatsController
    participant Stats as StatsService
    participant DB as æ•°æ®åº“

    Admin->>UI: æ‰“å¼€ç»Ÿè®¡é¢æ¿
    UI->>API: GET /admin/stats/overview
    API->>Stats: getOverview(dateRange)

    Stats->>DB: æŸ¥è¯¢ usage_records (èšåˆ)
    DB-->>Stats: æ€»æ”¶å…¥ã€æ€»è°ƒç”¨æ¬¡æ•°

    Stats->>DB: æŸ¥è¯¢ workspace_balance (èšåˆ)
    DB-->>Stats: å¹³å°æ€»ä½™é¢

    Stats->>DB: æŸ¥è¯¢ project (èšåˆ)
    DB-->>Stats: æ´»è·ƒå·¥ä½œç©ºé—´æ•°

    Stats->>DB: æŸ¥è¯¢ recharge_records (èšåˆ)
    DB-->>Stats: å……å€¼ç»Ÿè®¡

    Stats-->>API: { overview: {...} }
    API-->>UI: { overview: {...} }
    UI-->>Admin: æ˜¾ç¤ºç»Ÿè®¡å›¾è¡¨

    Admin->>UI: æŸ¥çœ‹çƒ­é—¨æœåŠ¡æ’è¡Œ
    UI->>API: GET /admin/stats/popular-services
    API->>Stats: getPopularServices()
    Stats->>DB: æŸ¥è¯¢ usage_records (GROUP BY service_key, ORDER BY calls_count DESC)
    DB-->>Stats: æœåŠ¡æ’è¡Œæ•°æ®
    Stats-->>API: { services: [...] }
    API-->>UI: { services: [...] }
    UI-->>Admin: æ˜¾ç¤ºæœåŠ¡æ’è¡Œæ¦œ
```

---

## ä¸ƒã€è®¡è´¹ç³»ç»Ÿæ¶æ„ï¼ˆå®é™…å®ç°ï¼‰

### 7.1 è®¡è´¹æ•°æ®æµï¼ˆRMB ç›´æ¥è®¡è´¹ï¼‰

```mermaid
flowchart TD
    User[ç”¨æˆ·è§¦å‘æ‰§è¡Œ] --> Workflow[å·¥ä½œæµæ‰§è¡Œ]
    Workflow --> CheckNode{æ˜¯å¦è°ƒç”¨å¹³å°æœåŠ¡?}

    CheckNode -->|å¦| NormalExec[æ™®é€šæ‰§è¡Œ,ä¸è®¡è´¹]
    CheckNode -->|æ˜¯| IdentifyService[è¯†åˆ«æœåŠ¡ç±»å‹]

    IdentifyService --> TypeCheck{æœåŠ¡ç±»å‹?}
    TypeCheck -->|AI æ¨¡å‹| AIModel[PlatformService<br/>AI æ¨¡å‹è°ƒç”¨]
    TypeCheck -->|RAG æœåŠ¡| RagService[PlatformRagService<br/>RAG æŸ¥è¯¢]
    TypeCheck -->|TTS/STT/å›¾åƒ| OtherService[å…¶ä»–å¹³å°æœåŠ¡]

    AIModel --> CheckBalance{æ£€æŸ¥ä½™é¢}
    RagService --> CheckBalance
    OtherService --> CheckBalance

    CheckBalance -->|ä½™é¢ä¸è¶³| Stop[æ‹’ç»æ‰§è¡Œ<br/>è¿”å› 402]
    CheckBalance -->|ä½™é¢å……è¶³| Execute[æ‰§è¡ŒæœåŠ¡è°ƒç”¨]

    Execute --> CalcCost[è®¡ç®—æˆæœ¬<br/>åŸºäº pricing_config]
    CalcCost --> Deduct[æ‰£é™¤ä½™é¢<br/>WorkspaceBalance]

    Deduct --> CreateRecord[åˆ›å»º UsageRecord<br/>è®°å½•æ¶ˆè´¹è¯¦æƒ…]
    CreateRecord --> CheckThreshold{ä½™é¢ä½äºé˜ˆå€¼?}

    CheckThreshold -->|æ˜¯| SendAlert[å‘é€ä½ä½™é¢å‘Šè­¦]
    CheckThreshold -->|å¦| ExecutionComplete[æ‰§è¡Œå®Œæˆ]

    Stop --> End[ç»“æŸ]
    NormalExec --> End
    SendAlert --> ExecutionComplete
    ExecutionComplete --> End
```

### 7.2 AI æ¨¡å‹è°ƒç”¨è®¡è´¹ç¤ºä¾‹

```mermaid
sequenceDiagram
    participant Workflow as ç”¨æˆ·å·¥ä½œæµ
    participant Node as AI Model Node
    participant Billing as BillingService
    participant Balance as WorkspaceBalance
    participant LLM as OpenAI API
    participant Usage as UsageRecord

    Workflow->>Node: è§¦å‘ GPT-4 è°ƒç”¨
    Node->>Billing: checkBalance(workspaceId)
    Billing->>Balance: æŸ¥è¯¢ä½™é¢
    Balance-->>Billing: balance_cny: 50.00

    alt ä½™é¢ä¸è¶³ (< Â¥0.10)
        Billing-->>Node: Error: Insufficient balance
        Node-->>Workflow: "ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼"
    else ä½™é¢å……è¶³
        Billing-->>Node: OK
        Node->>LLM: POST /chat/completions
        LLM-->>Node: { tokens: 1500 }

        Node->>Billing: recordUsageAndCharge({<br/>  workspaceId,<br/>  serviceKey: "gpt-4-turbo",<br/>  tokensUsed: 1500<br/>})

        Billing->>Billing: è®¡ç®—æˆæœ¬<br/>Â¥0.015/1k tokens Ã— 1.5 = Â¥0.0225
        Billing->>Balance: æ‰£é™¤ Â¥0.0225
        Balance-->>Billing: æ–°ä½™é¢: Â¥49.9775

        Billing->>Usage: åˆ›å»ºä½¿ç”¨è®°å½•
        Usage-->>Billing: record created

        Billing-->>Node: success
        Node-->>Workflow: è¿”å› AI ç»“æœ
    end
```

### 7.3 è®¡è´¹ç›¸å…³è¡¨ç»“æ„ï¼ˆå®é™…å®ç°ï¼‰

```mermaid
erDiagram
    WorkspaceBalance ||--o{ UsageRecord : "pays for"
    WorkspaceBalance ||--o{ RechargeRecord : "receives"
    PlatformService ||--o{ UsageRecord : "consumed via"
    PlatformRagService ||--o{ UsageRecord : "consumed via"

    WorkspaceBalance {
        uuid id PK
        uuid workspace_id FK
        decimal balance_cny "äººæ°‘å¸ä½™é¢"
        decimal low_balance_threshold_cny "ä½ä½™é¢å‘Šè­¦é˜ˆå€¼"
        string currency "CNY"
        timestamp updated_at
    }

    UsageRecord {
        uuid id PK
        uuid workspace_id FK
        uuid user_id FK
        string service_key FK
        string service_type "ai_model | rag_service | tts | stt | image_gen"
        int tokens_used "ä»… AI æ¨¡å‹"
        int calls_count "è°ƒç”¨æ¬¡æ•°"
        decimal amount_cny "æ¶ˆè´¹é‡‘é¢(RMB)"
        jsonb metadata "è¯¦ç»†ä¿¡æ¯"
        timestamp created_at
    }

    RechargeRecord {
        uuid id PK
        uuid workspace_id FK
        uuid user_id FK
        decimal amount_cny "å……å€¼é‡‘é¢(RMB)"
        string payment_method "alipay | wechat | admin"
        string transaction_id "äº¤æ˜“ID"
        string status "pending | completed | failed"
        timestamp completed_at
    }

    PlatformService {
        string service_key PK
        string service_type
        string name
        jsonb pricing_config "{ pricePerToken: 0.00001, currency: 'CNY' }"
        boolean is_active
    }

    PlatformRagService {
        string service_key PK
        string name
        decimal price_per_query_cny "æ¯æ¬¡æŸ¥è¯¢ä»·æ ¼"
        boolean is_active
    }
```

---

## å…«ã€ç”¨æˆ·ä½“éªŒæµç¨‹

### 8.1 å®Œæ•´ç”¨æˆ·æ—…ç¨‹ï¼ˆå«è®¡è´¹ï¼‰

```mermaid
journey
    title ç”¨æˆ·ä»æ³¨å†Œåˆ°å¹³å°æœåŠ¡ä½¿ç”¨çš„æ—…ç¨‹
    section æ³¨å†Œ
      å¡«å†™ä¿¡æ¯: 5: ç”¨æˆ·
      è‡ªåŠ¨åˆ›å»ºä¸ªäººç©ºé—´: 5: ç³»ç»Ÿ
      åˆå§‹åŒ–ä½™é¢(Â¥0): 5: ç³»ç»Ÿ
      è¿›å…¥ä¸»é¡µ: 5: ç”¨æˆ·
    section ä¸ªäººä½¿ç”¨
      åˆ›å»ºå·¥ä½œæµ: 4: ç”¨æˆ·
      æ·»åŠ  AI èŠ‚ç‚¹: 4: ç”¨æˆ·
      å‘ç°ä½™é¢ä¸è¶³: 2: ç”¨æˆ·
      å……å€¼ Â¥100: 3: ç”¨æˆ·
      æ‰§è¡Œå·¥ä½œæµ: 5: ç”¨æˆ·
    section å¹³å°æœåŠ¡ä½¿ç”¨
      è°ƒç”¨ GPT-4: 5: ç”¨æˆ·
      æŸ¥è¯¢æ³•å¾‹ RAG: 5: ç”¨æˆ·
      æŸ¥çœ‹æ¶ˆè´¹æ˜ç»†: 4: ç”¨æˆ·
      ä½™é¢å‘Šè­¦: 2: ç”¨æˆ·
      å†æ¬¡å……å€¼: 3: ç”¨æˆ·
    section å›¢é˜Ÿåä½œ
      åˆ›å»ºå›¢é˜Ÿç©ºé—´: 4: ç”¨æˆ·
      å›¢é˜Ÿå……å€¼ Â¥500: 4: ç”¨æˆ·
      é‚€è¯·åŒäº‹: 4: ç”¨æˆ·
      åŒäº‹ä½¿ç”¨å›¢é˜Ÿä½™é¢: 5: åŒäº‹
      ååŒç¼–è¾‘: 5: ç”¨æˆ·, åŒäº‹
```

### 8.2 å·¥ä½œç©ºé—´åˆ‡æ¢äº¤äº’æµç¨‹ï¼ˆå«ä½™é¢æ˜¾ç¤ºï¼‰

```mermaid
stateDiagram-v2
    [*] --> ä¸ªäººç©ºé—´: ç”¨æˆ·ç™»å½•

    state ä¸ªäººç©ºé—´ {
        [*] --> æ˜¾ç¤ºä¸ªäººå·¥ä½œæµ
        æ˜¾ç¤ºä¸ªäººå·¥ä½œæµ --> æ˜¾ç¤ºä½™é¢_ä¸ªäºº: ğŸ’° ä½™é¢: Â¥50.00
        æ˜¾ç¤ºä½™é¢_ä¸ªäºº --> åˆ›å»ºå·¥ä½œæµ
        åˆ›å»ºå·¥ä½œæµ --> æ‰§è¡Œå·¥ä½œæµ
        æ‰§è¡Œå·¥ä½œæµ --> æ‰£è´¹_ä¸ªäºº: æ¶ˆè´¹ Â¥0.50
        æ‰£è´¹_ä¸ªäºº --> æ˜¾ç¤ºä½™é¢_ä¸ªäºº
    }

    ä¸ªäººç©ºé—´ --> å·¥ä½œç©ºé—´åˆ‡æ¢å™¨: ç‚¹å‡»å·¦ä¸Šè§’
    å·¥ä½œç©ºé—´åˆ‡æ¢å™¨ --> ä¸ªäººç©ºé—´: é€‰æ‹©ä¸ªäººç©ºé—´
    å·¥ä½œç©ºé—´åˆ‡æ¢å™¨ --> å›¢é˜Ÿç©ºé—´A: é€‰æ‹©å›¢é˜Ÿç©ºé—´A
    å·¥ä½œç©ºé—´åˆ‡æ¢å™¨ --> åˆ›å»ºæ–°ç©ºé—´: ç‚¹å‡»"åˆ›å»º"

    state å›¢é˜Ÿç©ºé—´A {
        [*] --> æ˜¾ç¤ºå›¢é˜Ÿå·¥ä½œæµ
        æ˜¾ç¤ºå›¢é˜Ÿå·¥ä½œæµ --> æ˜¾ç¤ºä½™é¢_å›¢é˜Ÿ: ğŸ’° å›¢é˜Ÿä½™é¢: Â¥200.00
        æ˜¾ç¤ºä½™é¢_å›¢é˜Ÿ --> ååŒç¼–è¾‘
        ååŒç¼–è¾‘ --> æˆå‘˜ç®¡ç†
        æˆå‘˜ç®¡ç† --> å……å€¼: ç®¡ç†å‘˜å……å€¼
        å……å€¼ --> æ˜¾ç¤ºä½™é¢_å›¢é˜Ÿ
    }

    å›¢é˜Ÿç©ºé—´A --> å·¥ä½œç©ºé—´åˆ‡æ¢å™¨: ç‚¹å‡»åˆ‡æ¢
    åˆ›å»ºæ–°ç©ºé—´ --> å›¢é˜Ÿç©ºé—´A: åˆ›å»ºæˆåŠŸ
```

---

## ä¹ã€éƒ¨ç½²æ¶æ„

### 9.1 ç³»ç»Ÿæ¶æ„å›¾ï¼ˆå«åå°ç®¡ç†ï¼‰

```mermaid
graph TB
    subgraph ç”¨æˆ·å‰ç«¯å±‚
        UserUI[Vue.js ç”¨æˆ·å‰ç«¯]
        WS[WorkspaceSwitcher<br/>å·¥ä½œç©ºé—´åˆ‡æ¢å™¨]
    end

    subgraph ç®¡ç†å‘˜å‰ç«¯å±‚
        AdminUI[Vue.js åå°ç®¡ç†å‰ç«¯]
    end

    subgraph API Gateway
        Gateway[Nginx / API Gateway]
    end

    subgraph ç”¨æˆ· API å±‚
        Auth[AuthController]
        Workspaces[WorkspacesController]
        Workflows[WorkflowsController]
        Billing[BillingController]
    end

    subgraph ç®¡ç†å‘˜ API å±‚
        AdminAuth[AdminAuthMiddleware]
        AdminPlatform[AdminPlatformServicesController]
        AdminWorkspace[AdminWorkspacesController]
        AdminStats[AdminStatsController]
    end

    subgraph æœåŠ¡å±‚
        WCS[WorkspaceContextService]
        PS[ProjectService]
        WFS[WorkflowService]
        BS[BillingService]
        PlatformSvc[PlatformServiceService]
        StatsService[StatsService]
    end

    subgraph å¹³å°æœåŠ¡å±‚
        RagGateway[RAG Service Gateway]
        LLMProxy[LLM API Proxy]
    end

    subgraph æ•°æ®å±‚
        Repo[Repositories]
        DB[(PostgreSQL)]
        Redis[(Redis Cache)]
    end

    UserUI --> Gateway
    WS --> Gateway
    AdminUI --> Gateway

    Gateway --> Auth
    Gateway --> Workspaces
    Gateway --> Workflows
    Gateway --> Billing
    Gateway --> AdminAuth

    AdminAuth --> AdminPlatform
    AdminAuth --> AdminWorkspace
    AdminAuth --> AdminStats

    Auth --> WCS
    Workspaces --> PS
    Workflows --> WFS
    Billing --> BS

    AdminPlatform --> PlatformSvc
    AdminWorkspace --> BS
    AdminStats --> StatsService

    WFS --> RagGateway
    WFS --> LLMProxy
    BS --> PlatformSvc

    WCS --> Repo
    PS --> Repo
    WFS --> Repo
    BS --> Repo
    PlatformSvc --> Repo
    StatsService --> Repo

    Repo --> DB
    Repo --> Redis

    style AdminUI fill:#9c27b0
    style AdminAuth fill:#e1bee7
    style AdminPlatform fill:#e1bee7
    style AdminWorkspace fill:#e1bee7
    style AdminStats fill:#e1bee7
```

### 9.2 æ•°æ®åº“ç´¢å¼•ç­–ç•¥ï¼ˆä¼˜åŒ–ï¼‰

```mermaid
graph TB
    subgraph æ ¸å¿ƒç´¢å¼•
        I1[project.type<br/>å·¥ä½œç©ºé—´ç±»å‹æŸ¥è¯¢]
        I2[project.status<br/>çŠ¶æ€è¿‡æ»¤]
        I3[project.slug<br/>å”¯ä¸€æ ‡è¯†æŸ¥è¯¢]
        I4[workflow.projectId<br/>å·¥ä½œæµæŸ¥è¯¢æ ¸å¿ƒ]
        I5[workflow.projectId + active<br/>æ´»è·ƒå·¥ä½œæµæŸ¥è¯¢]
        I6[credentials.projectId<br/>å‡­è¯æŸ¥è¯¢æ ¸å¿ƒ]
        I7[project_relation.projectId<br/>æˆå‘˜æŸ¥è¯¢]
        I8[project_relation.userId<br/>ç”¨æˆ·å·¥ä½œç©ºé—´æŸ¥è¯¢]
    end

    subgraph è®¡è´¹ç›¸å…³ç´¢å¼•
        B1[workspace_balance.workspace_id<br/>ä½™é¢æŸ¥è¯¢]
        B2[usage_record.workspace_id<br/>æ¶ˆè´¹æ˜ç»†æŸ¥è¯¢]
        B3[usage_record.workspace_id + created_at<br/>æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢]
        B4[usage_record.service_key<br/>æœåŠ¡ä½¿ç”¨ç»Ÿè®¡]
        B5[recharge_record.workspace_id<br/>å……å€¼è®°å½•æŸ¥è¯¢]
        B6[recharge_record.workspace_id + status<br/>å……å€¼çŠ¶æ€æŸ¥è¯¢]
    end

    subgraph å¹³å°æœåŠ¡ç´¢å¼•
        S1[platform_service.service_key<br/>æœåŠ¡æŸ¥è¯¢ä¸»é”®]
        S2[platform_service.is_active<br/>æ´»è·ƒæœåŠ¡è¿‡æ»¤]
        S3[platform_rag_service.service_key<br/>RAG æœåŠ¡ä¸»é”®]
        S4[platform_rag_service.domain<br/>é¢†åŸŸåˆ†ç±»æŸ¥è¯¢]
    end

    style I4 fill:#51cf66,stroke:#00ff00,stroke-width:3px
    style I5 fill:#51cf66,stroke:#00ff00,stroke-width:3px
    style I6 fill:#51cf66,stroke:#00ff00,stroke-width:3px
    style B1 fill:#ffd93d
    style B2 fill:#ffd93d
    style B3 fill:#ffd93d
```

**å…³é”®æŸ¥è¯¢ä¼˜åŒ–ï¼š**

| æŸ¥è¯¢åœºæ™¯ | æ”¹é€ å‰ | æ”¹é€ å | æ€§èƒ½æå‡ |
|---------|--------|--------|---------|
| è·å–å·¥ä½œç©ºé—´å·¥ä½œæµ | 4 å±‚ JOIN | 3 å±‚ JOIN | **~35%** |
| è·å–æ´»è·ƒå·¥ä½œæµ | 4 å±‚ JOIN + WHERE | 3 å±‚ JOIN + å¤åˆç´¢å¼• | **~40%** |
| è·å–å·¥ä½œç©ºé—´å‡­è¯ | 4 å±‚ JOIN | 3 å±‚ JOIN | **~35%** |
| æŸ¥è¯¢ä½™é¢ | N/A | å•è¡¨æŸ¥è¯¢ + ç´¢å¼• | **æ–°å¢** |
| æ¶ˆè´¹è®°å½•ç»Ÿè®¡ | N/A | å¤åˆç´¢å¼• + èšåˆ | **æ–°å¢** |

---

## åã€ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### 10.1 å…³é”®æŒ‡æ ‡ç›‘æ§ï¼ˆå«è®¡è´¹æŒ‡æ ‡ï¼‰

```mermaid
graph TD
    subgraph æ€§èƒ½æŒ‡æ ‡
        M1[å·¥ä½œæµåˆ—è¡¨æŸ¥è¯¢æ—¶é—´<br/>ç›®æ ‡: < 100ms]
        M2[å·¥ä½œç©ºé—´åˆ‡æ¢æ—¶é—´<br/>ç›®æ ‡: < 50ms]
        M3[æƒé™æ£€æŸ¥è€—æ—¶<br/>ç›®æ ‡: < 10ms]
        M4[ä½™é¢æŸ¥è¯¢æ—¶é—´<br/>ç›®æ ‡: < 20ms]
    end

    subgraph ä¸šåŠ¡æŒ‡æ ‡
        B1[æ´»è·ƒå·¥ä½œç©ºé—´æ•°<br/>æŒ‰æ—¥/å‘¨/æœˆç»Ÿè®¡]
        B2[å¹³å°æ€»ä½™é¢<br/>å®æ—¶ç›‘æ§]
        B3[æ—¥å……å€¼é‡‘é¢<br/>è´¢åŠ¡æŒ‡æ ‡]
        B4[æ—¥æ¶ˆè´¹é‡‘é¢<br/>æ”¶å…¥æŒ‡æ ‡]
        B5[çƒ­é—¨æœåŠ¡ TOP 10<br/>è¿è¥å‚è€ƒ]
    end

    subgraph è®¡è´¹æŒ‡æ ‡
        C1[ä½ä½™é¢å·¥ä½œç©ºé—´æ•°<br/>< Â¥10]
        C2[é›¶ä½™é¢å·¥ä½œç©ºé—´æ•°<br/>= Â¥0]
        C3[å•æ—¥æ¶ˆè´¹å³°å€¼<br/>å¼‚å¸¸æ£€æµ‹]
        C4[æœåŠ¡è°ƒç”¨å¤±è´¥ç‡<br/>è´¨é‡ç›‘æ§]
    end

    subgraph å‘Šè­¦è§„åˆ™
        A1[æŸ¥è¯¢æ—¶é—´ > 500ms<br/>æ€§èƒ½å‘Šè­¦]
        A2[é”™è¯¯ç‡ > 1%<br/>ç¨³å®šæ€§å‘Šè­¦]
        A3[æ—¥å……å€¼ä¸‹é™ > 50%<br/>ä¸šåŠ¡å‘Šè­¦]
        A4[ä½ä½™é¢å·¥ä½œç©ºé—´ > 100<br/>è¿è¥å‘Šè­¦]
    end

    M1 --> A1
    M2 --> A1
    B4 --> A3
    C1 --> A4

    A1 -.è§¦å‘.-> Alert[PagerDuty / é£ä¹¦å‘Šè­¦]
    A2 -.è§¦å‘.-> Alert
    A3 -.è§¦å‘.-> Alert
    A4 -.è§¦å‘.-> Alert
```

### 10.2 åå°ç®¡ç†ç»Ÿè®¡é¢æ¿

```mermaid
graph TB
    subgraph Dashboard æ ¸å¿ƒæŒ‡æ ‡
        D1[å¹³å°æ€»æ”¶å…¥<br/>ç´¯è®¡ RMB]
        D2[ä»Šæ—¥æ”¶å…¥<br/>å®æ—¶ç»Ÿè®¡]
        D3[æ´»è·ƒå·¥ä½œç©ºé—´<br/>è¿‘ 7 æ—¥æ´»è·ƒ]
        D4[æœåŠ¡è°ƒç”¨æ€»é‡<br/>ç´¯è®¡æ¬¡æ•°]
    end

    subgraph æ”¶å…¥è¶‹åŠ¿å›¾è¡¨
        T1[è¿‘ 30 å¤©æ”¶å…¥è¶‹åŠ¿<br/>æŠ˜çº¿å›¾]
        T2[æœåŠ¡ç±»å‹æ”¶å…¥å æ¯”<br/>é¥¼å›¾]
        T3[å……å€¼æ¸ é“åˆ†å¸ƒ<br/>æŸ±çŠ¶å›¾]
    end

    subgraph æœåŠ¡æ’è¡Œæ¦œ
        R1[çƒ­é—¨ AI æ¨¡å‹ TOP 10<br/>æŒ‰è°ƒç”¨æ¬¡æ•°]
        R2[çƒ­é—¨ RAG æœåŠ¡ TOP 5<br/>æŒ‰æ”¶å…¥]
        R3[å¤§å®¢æˆ·å·¥ä½œç©ºé—´ TOP 10<br/>æŒ‰æ¶ˆè´¹é‡‘é¢]
    end

    Dashboard --> D1
    Dashboard --> D2
    Dashboard --> D3
    Dashboard --> D4

    Dashboard --> T1
    Dashboard --> T2
    Dashboard --> T3

    Dashboard --> R1
    Dashboard --> R2
    Dashboard --> R3

    style D1 fill:#51cf66
    style D2 fill:#ffd93d
    style D3 fill:#51cf66
    style D4 fill:#51cf66
```

---

## åä¸€ã€é™„å½•

### 11.1 æ¿€è¿›æ”¹é€ æ ¸å¿ƒå˜æ›´å¯¹æ¯”

| é¡¹ç›® | v1.0 (æ¸è¿›å¼) | v2.0 (æ¿€è¿›æ”¹é€ ) | è¯´æ˜ |
|------|---------------|-----------------|------|
| **SharedWorkflow** | ä¿ç•™ï¼Œé€æ­¥è¿ç§» | **ç›´æ¥åˆ é™¤** | åˆ é™¤æ‰€æœ‰ 147 å¤„å¼•ç”¨ |
| **SharedCredentials** | ä¿ç•™ï¼Œé€æ­¥è¿ç§» | **ç›´æ¥åˆ é™¤** | åˆ é™¤æ‰€æœ‰ 95 å¤„å¼•ç”¨ |
| **æ•°æ®åº“è¿ç§»** | åŒå†™ â†’ è¿ç§» â†’ åˆ é™¤ | **ä¸€æ¬¡æ€§é‡å†™** | ç›´æ¥æ·»åŠ  projectId å­—æ®µ |
| **å…¼å®¹æ€§** | ä¿æŒå‘åå…¼å®¹ | **ä¸ä¿æŒå…¼å®¹** | é€‚åˆæœªä¸Šçº¿é¡¹ç›® |
| **è®¡è´¹ç³»ç»Ÿ** | é¢„ç•™è®¾è®¡ | **å®Œæ•´å®ç°** | WorkspaceBalance + RMB |
| **å¹³å°æœåŠ¡** | æœªè§„åˆ’ | **å®Œæ•´è®¾è®¡** | PlatformService + RagService |
| **åå°ç®¡ç†** | æœªè§„åˆ’ | **å®Œæ•´å®ç°** | ç®¡ç†å‘˜æƒé™ + ç»Ÿè®¡é¢æ¿ |
| **å®æ–½å‘¨æœŸ** | 6-8 å‘¨ | **15-16 å‘¨** | åŒ…å«è®¡è´¹å’Œåå°ç³»ç»Ÿ |

### 11.2 å›¾ä¾‹è¯´æ˜

| ç¬¦å· | å«ä¹‰ |
|------|------|
| `-->` | å¼ºå…³è”/å¿…éœ€ |
| `-.->` | å¼±å…³è”/å¯é€‰ |
| `||--o{` | ä¸€å¯¹å¤šå…³ç³» |
| `||--||` | ä¸€å¯¹ä¸€å…³ç³» |
| `o{--o{` | å¤šå¯¹å¤šå…³ç³» |

### 11.3 é¢œè‰²è¯´æ˜

- ğŸ”´ çº¢è‰² (#ff6b6b)ï¼šéœ€è¦åˆ é™¤æˆ–åºŸå¼ƒçš„éƒ¨åˆ† (SharedWorkflow)
- ğŸŸ¢ ç»¿è‰² (#51cf66)ï¼šæ–°å¢æˆ–ä¼˜åŒ–çš„éƒ¨åˆ† (ç›´æ¥ projectId)
- ğŸŸ¡ é»„è‰² (#ffd93d)ï¼šéœ€è¦æ³¨æ„çš„éƒ¨åˆ† (è®¡è´¹ç›¸å…³)
- ğŸ”µ è“è‰² (#e3f2fd)ï¼šå¯¹æ ‡å‚è€ƒ (Coze æ¶æ„)
- ğŸŸ£ ç´«è‰² (#9c27b0)ï¼šç®¡ç†å‘˜åŠŸèƒ½ (åå°ç³»ç»Ÿ)

### 11.4 å…³é”®å®ä½“å­—æ®µå˜æ›´

**Project (å·¥ä½œç©ºé—´):**
```typescript
// æ–°å¢å­—æ®µ
slug: string;                    // URL å‹å¥½æ ‡è¯†
isDefault: boolean;              // æ˜¯å¦é»˜è®¤ä¸ªäººç©ºé—´
status: 'active' | 'archived' | 'suspended';
settings: {
  maxMembers?: number;           // å›¢é˜Ÿç©ºé—´æˆå‘˜ä¸Šé™
  billingMode?: 'owner_pays' | 'member_pays';
};
```

**Workflow (å·¥ä½œæµ):**
```typescript
// æ–°å¢å­—æ®µ
projectId: string;               // ç›´æ¥å¤–é”® â†’ Project (åˆ é™¤ SharedWorkflow)
```

**Credentials (å‡­è¯):**
```typescript
// æ–°å¢å­—æ®µ
projectId: string;               // ç›´æ¥å¤–é”® â†’ Project (åˆ é™¤ SharedCredentials)
isManaged: boolean;              // æ˜¯å¦å¹³å°æ‰˜ç®¡å‡­è¯
```

**User (ç”¨æˆ·):**
```typescript
// æ–°å¢å­—æ®µ
isAdmin: boolean;                // åå°ç®¡ç†å‘˜æ ‡è¯†
```

### 11.5 è¿ç§» SQL ç¤ºä¾‹ï¼ˆæ¿€è¿›ç‰ˆï¼‰

```sql
-- âš ï¸ æ¿€è¿›æ”¹é€ ï¼šç›´æ¥åˆ é™¤ SharedWorkflow å’Œ SharedCredentials

-- ç¬¬ä¸€æ­¥ï¼šä¸º Workflow æ·»åŠ  projectId
ALTER TABLE workflow ADD COLUMN project_id UUID;

-- ç¬¬äºŒæ­¥ï¼šæ•°æ®è¿ç§»ï¼ˆä» SharedWorkflow è¿ç§»ï¼‰
UPDATE workflow w
SET project_id = (
  SELECT sw.project_id
  FROM shared_workflow sw
  WHERE sw.workflow_id = w.id
  AND sw.role = 'workflow:owner'
  LIMIT 1
);

-- ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE workflow
  ADD CONSTRAINT fk_workflow_project
  FOREIGN KEY (project_id) REFERENCES project(id) ON DELETE CASCADE;

-- ç¬¬å››æ­¥ï¼šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_workflow_project_id ON workflow(project_id);
CREATE INDEX idx_workflow_project_active ON workflow(project_id, active);

-- ç¬¬äº”æ­¥ï¼šåˆ é™¤ SharedWorkflowï¼ˆæ¿€è¿›ï¼ï¼‰
DROP TABLE shared_workflow;

-- ç¬¬å…­æ­¥ï¼šé‡å¤ Credentials çš„ç›¸åŒæ­¥éª¤
ALTER TABLE credentials ADD COLUMN project_id UUID;
UPDATE credentials c
SET project_id = (
  SELECT sc.project_id FROM shared_credentials sc
  WHERE sc.credentials_id = c.id
  LIMIT 1
);
ALTER TABLE credentials
  ADD CONSTRAINT fk_credentials_project
  FOREIGN KEY (project_id) REFERENCES project(id) ON DELETE CASCADE;
CREATE INDEX idx_credentials_project_id ON credentials(project_id);
DROP TABLE shared_credentials;

-- ç¬¬ä¸ƒæ­¥ï¼šæ·»åŠ è®¡è´¹ç›¸å…³è¡¨
CREATE TABLE workspace_balance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL UNIQUE REFERENCES project(id) ON DELETE CASCADE,
  balance_cny NUMERIC(10, 4) DEFAULT 0.0000,
  low_balance_threshold_cny NUMERIC(10, 4) DEFAULT 10.0000,
  currency VARCHAR(3) DEFAULT 'CNY',
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE platform_service (
  service_key VARCHAR(100) PRIMARY KEY,
  service_type VARCHAR(50) NOT NULL,
  name VARCHAR(200) NOT NULL,
  pricing_config JSONB NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE platform_rag_service (
  service_key VARCHAR(100) PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  domain VARCHAR(50) NOT NULL,
  price_per_query_cny NUMERIC(10, 4) NOT NULL,
  metadata JSONB,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE usage_record (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES user(id),
  service_key VARCHAR(100) NOT NULL,
  service_type VARCHAR(50) NOT NULL,
  tokens_used INT,
  calls_count INT DEFAULT 1,
  amount_cny NUMERIC(10, 4) NOT NULL,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_usage_record_workspace ON usage_record(workspace_id);
CREATE INDEX idx_usage_record_workspace_date ON usage_record(workspace_id, created_at);
CREATE INDEX idx_usage_record_service ON usage_record(service_key);

CREATE TABLE recharge_record (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES user(id),
  amount_cny NUMERIC(10, 2) NOT NULL,
  payment_method VARCHAR(50) NOT NULL,
  transaction_id VARCHAR(200),
  status VARCHAR(20) DEFAULT 'pending',
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_recharge_workspace ON recharge_record(workspace_id);
CREATE INDEX idx_recharge_status ON recharge_record(workspace_id, status);

-- ç¬¬å…«æ­¥ï¼šåˆå§‹åŒ–æ‰€æœ‰ç°æœ‰ Project çš„ä½™é¢
INSERT INTO workspace_balance (workspace_id, balance_cny)
SELECT id, 0.0 FROM project
ON CONFLICT (workspace_id) DO NOTHING;
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.0 (æ¿€è¿›æ”¹é€ ç‰ˆ)
**æœ€åæ›´æ–°ï¼š** 2025-11-07
**é…å¥—æ–‡æ¡£ï¼š** 01-æ¶æ„åº•å±‚æ”¹é€ æ–¹æ¡ˆ.md (v3.0)
**é€‚ç”¨åœºæ™¯ï¼š** æœªä¸Šçº¿ç”Ÿäº§ç¯å¢ƒçš„ n8n é¡¹ç›®ï¼Œå¯æ¥å—ç ´åæ€§æ›´æ”¹
