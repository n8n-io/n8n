# æ•°æ®åº“è¿ç§»æµ‹è¯•è®¡åˆ’

> **è¿ç§»åç§°ï¼š** MultitenantTransformation (1762511301780)
> **æµ‹è¯•æ—¥æœŸï¼š** å¾…å®š
> **æµ‹è¯•ç¯å¢ƒï¼š** æœ¬åœ°å¼€å‘ç¯å¢ƒ / æµ‹è¯•ç¯å¢ƒ

---

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯ MultitenantTransformation è¿ç§»çš„æ­£ç¡®æ€§ã€å®Œæ•´æ€§å’Œå¯é€†æ€§ã€‚

---

## ğŸ§ª æµ‹è¯•ç¯å¢ƒå‡†å¤‡

### 1. æ•°æ®åº“å‡†å¤‡

#### SQLiteï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰
```bash
# 1. å¤‡ä»½ç°æœ‰æ•°æ®åº“
cp ~/.n8n/database.sqlite ~/.n8n/database.sqlite.backup

# 2. å‡†å¤‡æµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰
# åˆ›å»ºæµ‹è¯• workflows å’Œ credentials
```

#### PostgreSQLï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
```bash
# 1. åˆ›å»ºæµ‹è¯•æ•°æ®åº“
createdb n8n_migration_test

# 2. æ¢å¤ç”Ÿäº§æ•°æ®å¿«ç…§ï¼ˆè„±æ•ï¼‰
pg_restore -d n8n_migration_test production_snapshot.dump

# 3. å¤‡ä»½æµ‹è¯•æ•°æ®
pg_dump n8n_migration_test > n8n_migration_test.backup.sql
```

#### MySQLï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
```bash
# 1. åˆ›å»ºæµ‹è¯•æ•°æ®åº“
mysql -e "CREATE DATABASE n8n_migration_test;"

# 2. å¯¼å…¥æ•°æ®
mysql n8n_migration_test < production_snapshot.sql

# 3. å¤‡ä»½æµ‹è¯•æ•°æ®
mysqldump n8n_migration_test > n8n_migration_test.backup.sql
```

### 2. ä»£ç ç¯å¢ƒ

```bash
# 1. åˆ‡æ¢åˆ°æµ‹è¯•åˆ†æ”¯
git checkout 20251102

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. æ„å»ºé¡¹ç›®
pnpm build
```

---

## ğŸ“‹ æµ‹è¯•ç”¨ä¾‹

### TC01: è¿ç§»å‰æ•°æ®å‡†å¤‡

**ç›®çš„ï¼š** ç¡®ä¿æµ‹è¯•æ•°æ®ç¬¦åˆè¿ç§»è¦æ±‚

**æµ‹è¯•æ­¥éª¤ï¼š**

1. åˆ›å»ºæµ‹è¯• Project
```sql
INSERT INTO project (id, name, type, createdAt, updatedAt)
VALUES
  ('proj-test-001', 'Test Personal Project', 'personal', NOW(), NOW()),
  ('proj-test-002', 'Test Team Project', 'team', NOW(), NOW());
```

2. åˆ›å»ºæµ‹è¯• Workflow
```sql
INSERT INTO workflow_entity (id, name, active, nodes, connections, createdAt, updatedAt)
VALUES
  ('wf-001', 'Test Workflow 1', true, '[]', '{}', NOW(), NOW()),
  ('wf-002', 'Test Workflow 2', false, '[]', '{}', NOW(), NOW());
```

3. åˆ›å»º SharedWorkflow å…³ç³»
```sql
INSERT INTO shared_workflow (workflowId, projectId, role, createdAt, updatedAt)
VALUES
  ('wf-001', 'proj-test-001', 'workflow:owner', NOW(), NOW()),
  ('wf-001', 'proj-test-002', 'workflow:editor', NOW(), NOW()),
  ('wf-002', 'proj-test-002', 'workflow:owner', NOW(), NOW());
```

4. åˆ›å»ºæµ‹è¯• Credentials
```sql
INSERT INTO credentials_entity (id, name, type, data, createdAt, updatedAt)
VALUES
  ('cred-001', 'Test Cred 1', 'httpBasicAuth', '{}', NOW(), NOW()),
  ('cred-002', 'Test Cred 2', 'httpHeaderAuth', '{}', NOW(), NOW());
```

5. åˆ›å»º SharedCredentials å…³ç³»
```sql
INSERT INTO shared_credentials (credentialsId, projectId, role, createdAt, updatedAt)
VALUES
  ('cred-001', 'proj-test-001', 'credential:owner', NOW(), NOW()),
  ('cred-002', 'proj-test-002', 'credential:owner', NOW(), NOW());
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ‰€æœ‰æ•°æ®æ’å…¥æˆåŠŸ
- âœ… æ¯ä¸ª workflow è‡³å°‘æœ‰ä¸€ä¸ª owner
- âœ… æ¯ä¸ª credential è‡³å°‘æœ‰ä¸€ä¸ª owner

---

### TC02: è¿ç§»å‰æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

**ç›®çš„ï¼š** éªŒè¯æ•°æ®æ»¡è¶³è¿ç§»å‰ç½®æ¡ä»¶

**æµ‹è¯•æ­¥éª¤ï¼š**

```sql
-- 1. æ£€æŸ¥å­¤å„¿ workflow
SELECT COUNT(*) as orphaned_workflows FROM workflow_entity W
WHERE NOT EXISTS (
  SELECT 1 FROM shared_workflow SW
  WHERE SW.workflowId = W.id AND SW.role = 'workflow:owner'
);

-- 2. æ£€æŸ¥å­¤å„¿ credentials
SELECT COUNT(*) as orphaned_credentials FROM credentials_entity C
WHERE NOT EXISTS (
  SELECT 1 FROM shared_credentials SC
  WHERE SC.credentialsId = C.id AND SC.role = 'credential:owner'
);

-- 3. æ£€æŸ¥æ— æ•ˆçš„ project å¼•ç”¨
SELECT COUNT(*) as invalid_project_refs FROM shared_workflow SW
WHERE NOT EXISTS (
  SELECT 1 FROM project P WHERE P.id = SW.projectId
);
```

**é¢„æœŸç»“æœï¼š**
- âœ… orphaned_workflows = 0
- âœ… orphaned_credentials = 0
- âœ… invalid_project_refs = 0

---

### TC03: æ‰§è¡Œæ­£å‘è¿ç§»ï¼ˆUpï¼‰

**ç›®çš„ï¼š** æ‰§è¡Œè¿ç§»å¹¶éªŒè¯æˆåŠŸ

**æµ‹è¯•æ­¥éª¤ï¼š**

```bash
# 1. è¿è¡Œè¿ç§»
cd packages/cli
pnpm typeorm migration:run

# 2. æŸ¥çœ‹è¿ç§»çŠ¶æ€
pnpm typeorm migration:show
```

**é¢„æœŸç»“æœï¼š**
- âœ… è¿ç§»æ‰§è¡ŒæˆåŠŸï¼Œæ— é”™è¯¯
- âœ… MultitenantTransformation æ˜¾ç¤ºä¸ºå·²æ‰§è¡Œï¼ˆâœ“ï¼‰
- âœ… æ—¥å¿—æ˜¾ç¤ºæ‰€æœ‰æ­¥éª¤æˆåŠŸå®Œæˆ

---

### TC04: è¿ç§»åæ•°æ®éªŒè¯

**ç›®çš„ï¼š** éªŒè¯è¿ç§»åçš„æ•°æ®æ­£ç¡®æ€§

**æµ‹è¯•æ­¥éª¤ï¼š**

1. éªŒè¯ workflow_entity è¡¨ç»“æ„
```sql
-- æ£€æŸ¥ projectId åˆ—å­˜åœ¨ä¸”ä¸º NOT NULL
DESCRIBE workflow_entity;
-- æˆ– PostgreSQL: \d workflow_entity
```

2. éªŒè¯æ•°æ®è¿ç§»æ­£ç¡®æ€§
```sql
-- æ£€æŸ¥ workflow çš„ projectId
SELECT id, name, projectId FROM workflow_entity;

-- éªŒè¯ projectId å¯¹åº”åŸæ¥çš„ owner
SELECT W.id, W.name, W.projectId, SW.projectId as original_projectId
FROM workflow_entity W
LEFT JOIN shared_workflow SW ON W.id = SW.workflowId AND SW.role = 'workflow:owner'
WHERE W.projectId != SW.projectId;
-- åº”è¯¥è¿”å› 0 è¡Œï¼ˆè¡¨å·²åˆ é™¤ä¼šæŠ¥é”™ï¼Œè¯´æ˜è¿ç§»æˆåŠŸï¼‰
```

3. éªŒè¯å¤–é”®çº¦æŸ
```sql
-- å°è¯•æ’å…¥æ— æ•ˆçš„ projectIdï¼ˆåº”è¯¥å¤±è´¥ï¼‰
INSERT INTO workflow_entity (id, name, active, nodes, connections, projectId)
VALUES ('wf-invalid', 'Invalid Workflow', false, '[]', '{}', 'non-existent-project');
-- é¢„æœŸï¼šå¤–é”®çº¦æŸé”™è¯¯
```

4. éªŒè¯ç´¢å¼•åˆ›å»º
```sql
-- MySQL/PostgreSQL
SHOW INDEX FROM workflow_entity WHERE Key_name LIKE 'idx_workflow_%';

-- SQLite
SELECT * FROM sqlite_master WHERE type='index' AND tbl_name='workflow_entity';
```

5. éªŒè¯ credentials_entity è¡¨ï¼ˆé‡å¤ä¸Šè¿°æ­¥éª¤ï¼‰
```sql
DESCRIBE credentials_entity;
SELECT id, name, projectId FROM credentials_entity;
```

6. ç¡®è®¤æ—§è¡¨å·²åˆ é™¤
```sql
-- å°è¯•æŸ¥è¯¢ shared_workflowï¼ˆåº”è¯¥æŠ¥é”™ï¼šè¡¨ä¸å­˜åœ¨ï¼‰
SELECT COUNT(*) FROM shared_workflow;

-- å°è¯•æŸ¥è¯¢ shared_credentialsï¼ˆåº”è¯¥æŠ¥é”™ï¼šè¡¨ä¸å­˜åœ¨ï¼‰
SELECT COUNT(*) FROM shared_credentials;
```

**é¢„æœŸç»“æœï¼š**
- âœ… workflow_entity æœ‰ projectId åˆ—ï¼ˆVARCHAR(36), NOT NULLï¼‰
- âœ… credentials_entity æœ‰ projectId åˆ—ï¼ˆVARCHAR(36), NOT NULLï¼‰
- âœ… æ‰€æœ‰ workflow çš„ projectId æ­£ç¡®ï¼ˆå¯¹åº”åŸ owner çš„ projectIdï¼‰
- âœ… æ‰€æœ‰ credentials çš„ projectId æ­£ç¡®
- âœ… å¤–é”®çº¦æŸç”Ÿæ•ˆ
- âœ… ç´¢å¼•åˆ›å»ºæˆåŠŸ
- âœ… shared_workflow å’Œ shared_credentials è¡¨ä¸å­˜åœ¨

---

### TC05: çº§è”åˆ é™¤æµ‹è¯•

**ç›®çš„ï¼š** éªŒè¯ CASCADE DELETE å¤–é”®çº¦æŸ

**æµ‹è¯•æ­¥éª¤ï¼š**

1. è®°å½•æµ‹è¯•æ•°æ®
```sql
SELECT COUNT(*) as workflow_count FROM workflow_entity WHERE projectId = 'proj-test-001';
SELECT COUNT(*) as cred_count FROM credentials_entity WHERE projectId = 'proj-test-001';
```

2. åˆ é™¤ Project
```sql
DELETE FROM project WHERE id = 'proj-test-001';
```

3. éªŒè¯çº§è”åˆ é™¤
```sql
-- åº”è¯¥è¿”å› 0
SELECT COUNT(*) FROM workflow_entity WHERE projectId = 'proj-test-001';
SELECT COUNT(*) FROM credentials_entity WHERE projectId = 'proj-test-001';
```

**é¢„æœŸç»“æœï¼š**
- âœ… Project åˆ é™¤æˆåŠŸ
- âœ… å…³è”çš„ workflows è¢«è‡ªåŠ¨åˆ é™¤
- âœ… å…³è”çš„ credentials è¢«è‡ªåŠ¨åˆ é™¤

---

### TC06: æ‰§è¡Œå›æ»šè¿ç§»ï¼ˆDownï¼‰

**ç›®çš„ï¼š** éªŒè¯è¿ç§»å¯ä»¥æˆåŠŸå›æ»š

**æµ‹è¯•æ­¥éª¤ï¼š**

1. æ‰§è¡Œå›æ»š
```bash
cd packages/cli
pnpm typeorm migration:revert
```

2. éªŒè¯å›æ»šæˆåŠŸ
```sql
-- 1. shared_workflow è¡¨åº”è¯¥é‡æ–°åˆ›å»º
SELECT COUNT(*) FROM shared_workflow;

-- 2. shared_credentials è¡¨åº”è¯¥é‡æ–°åˆ›å»º
SELECT COUNT(*) FROM shared_credentials;

-- 3. workflow_entity ä¸åº”è¯¥æœ‰ projectId åˆ—
DESCRIBE workflow_entity;

-- 4. credentials_entity ä¸åº”è¯¥æœ‰ projectId åˆ—
DESCRIBE credentials_entity;

-- 5. éªŒè¯æ•°æ®å›æ»šæ­£ç¡®
SELECT W.id, SW.workflowId, SW.projectId, SW.role
FROM workflow_entity W
LEFT JOIN shared_workflow SW ON W.id = SW.workflowId;
```

**é¢„æœŸç»“æœï¼š**
- âœ… å›æ»šæ‰§è¡ŒæˆåŠŸ
- âœ… shared_workflow å’Œ shared_credentials è¡¨æ¢å¤
- âœ… projectId åˆ—è¢«åˆ é™¤
- âœ… æ•°æ®æ­£ç¡®æ¢å¤åˆ° shared è¡¨
- âœ… æ‰€æœ‰ owner å…³ç³»æ¢å¤

---

### TC07: é‡æ–°æ‰§è¡Œæ­£å‘è¿ç§»

**ç›®çš„ï¼š** éªŒè¯è¿ç§»å¯ä»¥é‡å¤æ‰§è¡Œ

**æµ‹è¯•æ­¥éª¤ï¼š**

1. å†æ¬¡æ‰§è¡Œæ­£å‘è¿ç§»
```bash
cd packages/cli
pnpm typeorm migration:run
```

2. éªŒè¯ç»“æœï¼ˆå‚è€ƒ TC04ï¼‰

**é¢„æœŸç»“æœï¼š**
- âœ… è¿ç§»å†æ¬¡æˆåŠŸæ‰§è¡Œ
- âœ… æ•°æ®çŠ¶æ€ä¸ç¬¬ä¸€æ¬¡è¿ç§»åä¸€è‡´

---

### TC08: æ€§èƒ½æµ‹è¯•ï¼ˆå¯é€‰ï¼Œé’ˆå¯¹å¤§æ•°æ®é‡ï¼‰

**ç›®çš„ï¼š** è¯„ä¼°è¿ç§»æ€§èƒ½

**æµ‹è¯•åœºæ™¯ï¼š**
- å°æ•°æ®é‡ï¼š< 1000 æ¡ workflows
- ä¸­æ•°æ®é‡ï¼š1000-10000 æ¡
- å¤§æ•°æ®é‡ï¼š> 10000 æ¡

**æµ‹è¯•æ­¥éª¤ï¼š**

1. ç”Ÿæˆæµ‹è¯•æ•°æ®
```sql
-- ä½¿ç”¨å¾ªç¯æˆ–è„šæœ¬ç”Ÿæˆå¤§é‡æµ‹è¯•æ•°æ®
-- è¯¦ç»†è„šæœ¬è§é™„å½•
```

2. è®°å½•è¿ç§»æ—¶é—´
```bash
time pnpm typeorm migration:run
```

3. ç›‘æ§æ•°æ®åº“æ€§èƒ½
- CPU ä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨
- ç£ç›˜ I/O
- æ•°æ®åº“è¿æ¥æ•°

**é¢„æœŸç»“æœï¼š**
- âœ… è¿ç§»åœ¨åˆç†æ—¶é—´å†…å®Œæˆï¼ˆ< 30åˆ†é’Ÿï¼‰
- âœ… æ•°æ®åº“èµ„æºä½¿ç”¨åœ¨å¯æ¥å—èŒƒå›´å†…
- âœ… æ— æ­»é”æˆ–è¶…æ—¶é”™è¯¯

---

### TC09: å¹¶å‘æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

**ç›®çš„ï¼š** æµ‹è¯•è¿ç§»è¿‡ç¨‹ä¸­çš„å¹¶å‘åœºæ™¯

**æµ‹è¯•æ­¥éª¤ï¼š**

1. åœ¨è¿ç§»è¿‡ç¨‹ä¸­å°è¯•è®¿é—®æ•°æ®ï¼ˆæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒï¼‰
2. éªŒè¯é”æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

**é¢„æœŸç»“æœï¼š**
- âœ… è¿ç§»æœŸé—´å…¶ä»–æ“ä½œè¢«é˜»å¡æˆ–ä¼˜é›…å¤±è´¥
- âœ… è¿ç§»å®Œæˆåæ­£å¸¸æ¢å¤

---

## ğŸ“Š æµ‹è¯•ç»“æœè®°å½•

### æµ‹è¯•æ‰§è¡Œè®°å½•è¡¨

| æµ‹è¯•ç”¨ä¾‹ | æ‰§è¡Œæ—¥æœŸ | æ•°æ®åº“ç±»å‹ | æ•°æ®é‡ | æ‰§è¡Œæ—¶é•¿ | ç»“æœ | å¤‡æ³¨ |
|---------|---------|-----------|--------|---------|------|------|
| TC01 | | SQLite | 10 | | â¬œ | |
| TC02 | | SQLite | 10 | | â¬œ | |
| TC03 | | SQLite | 10 | | â¬œ | |
| TC04 | | SQLite | 10 | | â¬œ | |
| TC05 | | SQLite | 10 | | â¬œ | |
| TC06 | | SQLite | 10 | | â¬œ | |
| TC07 | | SQLite | 10 | | â¬œ | |
| TC08 | | PostgreSQL | 1000 | | â¬œ | |
| TC09 | | MySQL | 100 | | â¬œ | |

**å›¾ä¾‹ï¼š**
- â¬œ æœªæµ‹è¯•
- âœ… é€šè¿‡
- âŒ å¤±è´¥
- âš ï¸ éƒ¨åˆ†é€šè¿‡

---

## ğŸ› é—®é¢˜è¿½è¸ª

### å‘ç°çš„é—®é¢˜

| é—®é¢˜ID | ä¸¥é‡ç¨‹åº¦ | æè¿° | å¤ç°æ­¥éª¤ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
|-------|---------|------|---------|------|---------|
| | | | | | |

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### è¿ç§»å‰æ£€æŸ¥

- [ ] å¤‡ä»½æ•°æ®åº“
- [ ] å‡†å¤‡æµ‹è¯•æ•°æ®
- [ ] éªŒè¯æ•°æ®å®Œæ•´æ€§
- [ ] è®°å½•åŸºçº¿æŒ‡æ ‡

### è¿ç§»æ‰§è¡Œæ£€æŸ¥

- [ ] æ‰§è¡Œæ­£å‘è¿ç§»æˆåŠŸ
- [ ] æ— é”™è¯¯æ—¥å¿—
- [ ] è¿ç§»æ—¶é•¿å¯æ¥å—
- [ ] æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡

### è¿ç§»åæ£€æŸ¥

- [ ] è¡¨ç»“æ„æ­£ç¡®
- [ ] æ•°æ®è¿ç§»æ­£ç¡®
- [ ] å¤–é”®çº¦æŸç”Ÿæ•ˆ
- [ ] ç´¢å¼•åˆ›å»ºæˆåŠŸ
- [ ] çº§è”åˆ é™¤æµ‹è¯•é€šè¿‡

### å›æ»šæ£€æŸ¥

- [ ] å›æ»šæ‰§è¡ŒæˆåŠŸ
- [ ] æ•°æ®æ¢å¤æ­£ç¡®
- [ ] å¯ä»¥é‡æ–°æ‰§è¡Œè¿ç§»

### æ€§èƒ½æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰

- [ ] æ€§èƒ½æµ‹è¯•å®Œæˆ
- [ ] æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- [ ] æ— æ€§èƒ½ç“¶é¢ˆ

---

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```markdown
# MultitenantTransformation è¿ç§»æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸï¼š** YYYY-MM-DD
**æµ‹è¯•äººå‘˜ï¼š** [å§“å]
**æµ‹è¯•ç¯å¢ƒï¼š** [ç¯å¢ƒæè¿°]

## æµ‹è¯•æ‘˜è¦

- æ€»æµ‹è¯•ç”¨ä¾‹æ•°ï¼š9
- é€šè¿‡ï¼šX
- å¤±è´¥ï¼šY
- æœªæµ‹è¯•ï¼šZ

## æµ‹è¯•è¯¦æƒ…

[è¯¦ç»†æµ‹è¯•ç»“æœ]

## å‘ç°çš„é—®é¢˜

[é—®é¢˜åˆ—è¡¨]

## ç»“è®ºä¸å»ºè®®

[æµ‹è¯•ç»“è®º]

**ç­¾å­—ï¼š** _____________
**æ—¥æœŸï¼š** _____________
```

---

## ğŸ”§ é™„å½•ï¼šæµ‹è¯•æ•°æ®ç”Ÿæˆè„šæœ¬

### ç”Ÿæˆå¤§é‡æµ‹è¯•æ•°æ®ï¼ˆPostgreSQLï¼‰

```sql
-- ç”Ÿæˆ 10000 ä¸ªæµ‹è¯• workflows
DO $$
DECLARE
  i INTEGER;
BEGIN
  FOR i IN 1..10000 LOOP
    INSERT INTO workflow_entity (id, name, active, nodes, connections, versionId, createdAt, updatedAt)
    VALUES (
      'wf-perf-' || LPAD(i::TEXT, 5, '0'),
      'Performance Test Workflow ' || i,
      (RANDOM() < 0.5),
      '[]',
      '{}',
      GEN_RANDOM_UUID()::TEXT,
      NOW(),
      NOW()
    );

    INSERT INTO shared_workflow (workflowId, projectId, role, createdAt, updatedAt)
    VALUES (
      'wf-perf-' || LPAD(i::TEXT, 5, '0'),
      'proj-test-001',
      'workflow:owner',
      NOW(),
      NOW()
    );
  END LOOP;
END $$;
```

### æ¸…ç†æµ‹è¯•æ•°æ®

```sql
-- åˆ é™¤æ€§èƒ½æµ‹è¯•æ•°æ®
DELETE FROM shared_workflow WHERE workflowId LIKE 'wf-perf-%';
DELETE FROM workflow_entity WHERE id LIKE 'wf-perf-%';
DELETE FROM shared_credentials WHERE credentialsId LIKE 'cred-perf-%';
DELETE FROM credentials_entity WHERE id LIKE 'cred-perf-%';
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2025-01-07
**ç»´æŠ¤äººï¼š** [ç»´æŠ¤äººåç§°]
