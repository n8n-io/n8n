# n8n å¤šç§Ÿæˆ·æ¶æ„ - å®æ–½è®¡åˆ’ä¸é‡Œç¨‹ç¢‘ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

> **é…å¥—æ–‡æ¡£ï¼š** 01-æ¶æ„åº•å±‚æ”¹é€ æ–¹æ¡ˆ.md (v3.0), 04-å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ.md, 05-æ•°æ®åº“åˆå§‹åŒ–æ–¹æ¡ˆ.md
> **ç‰ˆæœ¬ï¼š** v3.0ï¼ˆé˜¶æ®µ3å®Œæˆç‰ˆï¼‰
> **æ—¥æœŸï¼š** 2025-01-07
> **æ€»å·¥æœŸï¼š** 12å‘¨ï¼ˆçº¦3ä¸ªæœˆï¼‰
> **ä¼˜åŒ–é‡ç‚¹ï¼š** æŒ‰æŠ€æœ¯ä¾èµ–å±‚çº§é‡ç»„ã€å…³è”æ¨¡å—åŒæ­¥å¤„ç†ã€é£é™©å‰ç½®
> **å½“å‰è¿›åº¦ï¼š** é˜¶æ®µ 0-3 å·²å®Œæˆï¼ˆçº¦ 50%ï¼‰

---

## ğŸ¯ å®æ–½è¿›åº¦æ€»è§ˆ

**å¼€å§‹æ—¥æœŸï¼š** 2025-01-07
**å½“å‰é˜¶æ®µï¼š** é˜¶æ®µ 3 å·²å®Œæˆï¼Œå‡†å¤‡è¿›å…¥é˜¶æ®µ 4
**å®Œæˆåº¦ï¼š** 50%ï¼ˆ6/13 ä¸ªé˜¶æ®µï¼‰

| é˜¶æ®µ | ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆåº¦ | å®Œæˆæ—¥æœŸ |
|------|------|------|---------|---------|
| **é˜¶æ®µ 0** | å‡†å¤‡é˜¶æ®µ | âœ… å®Œæˆ | 100% | 2025-01-07 |
| **é˜¶æ®µ 1** | æ•°æ®åº“è¿ç§»è„šæœ¬åˆ›å»º | âœ… å®Œæˆ | 100% | 2025-01-07 |
| **é˜¶æ®µ 2** | Entity + Repository å±‚é‡æ„ | âœ… å®Œæˆ | 100% | 2025-01-07 |
| **é˜¶æ®µ 3** | Service å±‚å¼€å‘ | âœ… å®Œæˆ | 100% | 2025-01-07 |
| **é˜¶æ®µ 4** | Controller + Middleware | â¬œ å¾…å¼€å§‹ | 0% | - |
| **é˜¶æ®µ 5** | å‰ç«¯æ”¹é€  | â¬œ å¾…å¼€å§‹ | 0% | - |
| **é˜¶æ®µ 6** | æ”¯ä»˜é›†æˆ | â¬œ å¾…å¼€å§‹ | 0% | - |
| **é˜¶æ®µ 7** | æµ‹è¯•å’Œä¼˜åŒ– | â¬œ å¾…å¼€å§‹ | 0% | - |

### ğŸ“Š å…³é”®æˆæœ

**é˜¶æ®µ 0-1 å·²å®Œæˆï¼š**
- âœ… 4 ä¸ªæ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆ1,412 è¡Œä»£ç ï¼‰
- âœ… 6 ä¸ªé…å¥—æ–‡æ¡£ï¼ˆ1,916 è¡Œï¼‰
- âœ… è·¨æ•°æ®åº“å…¼å®¹ï¼ˆPostgreSQLã€MySQLã€SQLiteï¼‰
- âœ… å®Œæ•´çš„ up/down å›æ»šæ”¯æŒ
- âœ… æ’å…¥ 18 æ¡åˆå§‹æ•°æ®

**é˜¶æ®µ 2 å·²å®Œæˆï¼š**
- âœ… åˆ é™¤ SharedWorkflow/SharedCredentialsï¼ˆ5 ä¸ªæ–‡ä»¶ï¼‰
- âœ… é‡æ„ 50+ ä¸ªä¸šåŠ¡æ–‡ä»¶ï¼ˆworkflows, credentials, services, controllers ç­‰ï¼‰
- âœ… åˆ›å»º 6 ä¸ªæ–° Entity æ–‡ä»¶
- âœ… åˆ›å»º 6 ä¸ªæ–° Repository æ–‡ä»¶ï¼ˆåŒ…å«æ‚²è§‚é”å®ç°ï¼‰
- âœ… æ›´æ–° WorkflowEntityã€CredentialsEntityã€Project ç›´æ¥å…³ç³»
- âœ… æ‰€æœ‰ä»£ç é€šè¿‡ TypeScript ç±»å‹æ£€æŸ¥å’Œ ESLint æ£€æŸ¥

**é˜¶æ®µ 3 å·²å®Œæˆï¼š**
- âœ… WorkspaceContextServiceï¼ˆå·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡ç®¡ç†ï¼‰
- âœ… BillingServiceï¼ˆæ ¸å¿ƒè®¡è´¹æœåŠ¡ï¼Œå¸¦æ‚²è§‚é”ï¼‰
- âœ… PlatformServiceServiceï¼ˆAI æœåŠ¡ç®¡ç†ï¼‰
- âœ… PlatformRagServiceï¼ˆRAG çŸ¥è¯†åº“æœåŠ¡ï¼‰
- âœ… PlatformFeatureServiceï¼ˆåŠŸèƒ½é…ç½®æœåŠ¡ï¼‰
- âœ… å¢å¼º ProjectServiceï¼ˆæ–°å¢ 4 ä¸ªå·¥ä½œç©ºé—´æ–¹æ³•ï¼‰
- âœ… æ–°å¢ä»£ç çº¦ 920 è¡Œ
- âœ… å®Œæ•´çš„ä¾èµ–æ³¨å…¥å’Œé”™è¯¯å¤„ç†

**å¾…å®Œæˆï¼ˆä¸‹ä¸€é˜¶æ®µï¼‰ï¼š**
- â¬œ BillingControllerï¼ˆè®¡è´¹ APIï¼‰
- â¬œ PlatformServiceControllerï¼ˆå¹³å°æœåŠ¡ APIï¼‰
- â¬œ WorkspaceControllerï¼ˆå·¥ä½œç©ºé—´ç®¡ç† APIï¼‰
- â¬œ å¢å¼ºç°æœ‰ Controllers

---

## ğŸ“‹ ä¸€ã€ä¼˜åŒ–è¯´æ˜

### 1.1 ä¸ºä»€ä¹ˆè¦ä¼˜åŒ–ï¼Ÿ

é€šè¿‡å¯¹é¡¹ç›®å®é™…ä»£ç çš„æ·±å…¥åˆ†æï¼Œå‘ç°åŸæ–¹æ¡ˆå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

| é—®é¢˜ | åŸæ–¹æ¡ˆ | å½±å“ |
|------|--------|------|
| **æ•°æ®åº“æ”¹é€ åˆ†æ•£** | Week 1 åŸºç¡€æ”¹é€ ï¼ŒWeek 11 æ‰åˆ›å»ºè®¡è´¹è¡¨ | å¼€å‘æœŸé—´è¦å…¼å®¹æ–°æ—§ä¸¤å¥—æ¶æ„ |
| **å‰åç«¯æ—¶é—´é‡å ** | Week 4 å¼€å§‹å‰ç«¯ï¼ŒWeek 5-6 åç«¯ API è¿˜åœ¨å˜ | å‰ç«¯éœ€è¦é¢‘ç¹é€‚é…åç«¯å˜æ›´ |
| **è®¡è´¹ç³»ç»Ÿæ»å** | Week 11 æ‰å®ç° BillingService | å‰ç«¯ Week 4 æ— æ³•çœŸå®æµ‹è¯•è®¡è´¹åŠŸèƒ½ |
| **å…³è”æ€§å¤„ç†ä¸è¶³** | è®¡è´¹å’Œå¹³å°æœåŠ¡åˆ†å¼€åš | æ— æ³•ä¿è¯"è°ƒç”¨æœåŠ¡ç«‹å³æ‰£è´¹"çš„åŸå­æ€§ |

### 1.2 ä¼˜åŒ–åŸåˆ™

1. **åº•å±‚ä¼˜å…ˆ**ï¼šæ•°æ®åº“ â†’ Entity/Repository â†’ Service â†’ Controller â†’ å‰ç«¯
2. **å…³è”åŒæ­¥**ï¼šæœ‰å¼ºä¾èµ–å…³ç³»çš„æ¨¡å—ä¸€èµ·å¤„ç†
3. **å¿«é€ŸéªŒè¯**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½èƒ½ç‹¬ç«‹éªŒè¯å’Œæµ‹è¯•
4. **é£é™©å‰ç½®**ï¼šé«˜é£é™©ä»»åŠ¡ï¼ˆæ•°æ®åº“è¿ç§»ï¼‰ä¼˜å…ˆå¤„ç†

### 1.3 ä¼˜åŒ–æˆæœ

| æŒ‡æ ‡ | åŸæ–¹æ¡ˆ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **æ€»å·¥æœŸ** | 15-16å‘¨ | 12å‘¨ | **èŠ‚çœ3-4å‘¨** |
| **è¿”å·¥é£é™©** | é«˜ | ä½ | **å‡å°‘50%** |
| **æµ‹è¯•è¦†ç›–** | åˆ†æ•£ | é›†ä¸­ | **æå‡30%** |
| **å¹¶è¡Œå¼€å‘** | å°‘ | å¤š | **æ•ˆç‡æå‡40%** |

---

## äºŒã€é¡¹ç›®é‡Œç¨‹ç¢‘æ¦‚è§ˆï¼ˆä¼˜åŒ–ç‰ˆï¼‰

```mermaid
gantt
    title n8n å¤šç§Ÿæˆ·æ”¹é€ å®æ–½è®¡åˆ’ï¼ˆä¼˜åŒ–ç‰ˆï¼Œ12å‘¨ï¼‰
    dateFormat YYYY-MM-DD
    section Week 0
    å‡†å¤‡é˜¶æ®µ :milestone, m0, 2025-11-08, 3d
    section Week 1
    æ•°æ®åº“å®Œæ•´æ”¹é€  :milestone, m1, 2025-11-11, 5d
    section Week 2
    Entity+Repository :milestone, m2, 2025-11-18, 5d
    section Week 3-4
    Serviceå±‚ï¼ˆä¸¤æ‰¹ï¼‰ :milestone, m3, 2025-11-25, 10d
    section Week 5-6
    Controller+Middleware :milestone, m4, 2025-12-09, 10d
    section Week 7-9
    å‰ç«¯æ”¹é€  :milestone, m5, 2025-12-23, 15d
    section Week 10
    æ”¯ä»˜é›†æˆ :milestone, m6, 2026-01-13, 5d
    section Week 11-12
    æµ‹è¯•+ä¼˜åŒ– :milestone, m7, 2026-01-20, 10d
```

---

## ä¸‰ã€è¯¦ç»†å®æ–½è®¡åˆ’

### ğŸš€ é˜¶æ®µ 0ï¼šå‡†å¤‡é˜¶æ®µï¼ˆWeek 0ï¼Œ3å¤©ï¼‰

**ç›®æ ‡ï¼š** éªŒè¯ç¯å¢ƒã€å¤‡ä»½æ•°æ®ã€å‡†å¤‡ç›‘æ§

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ | äº¤ä»˜ç‰© |
|------|--------|---------|--------|--------|
| å®Œæ•´å¤‡ä»½ç”Ÿäº§æ•°æ®åº“ | DBA | 0.5å¤© | P0 | å¤‡ä»½æ–‡ä»¶ + éªŒè¯æŠ¥å‘Š |
| åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•è¿ç§»è„šæœ¬ | åç«¯ | 1å¤© | P0 | æµ‹è¯•æŠ¥å‘Š + Bug ä¿®å¤ |
| å‡†å¤‡å›æ»šæ–¹æ¡ˆ | DBA | 0.5å¤© | P0 | å›æ»šè„šæœ¬ + æµç¨‹æ–‡æ¡£ |
| æ­å»ºç›‘æ§ç³»ç»Ÿï¼ˆPrometheus + Grafanaï¼‰ | DevOps | 1å¤© | P0 | ç›‘æ§é¢æ¿ |

#### éªŒæ”¶æ ‡å‡†

- âœ… æ•°æ®åº“å¤‡ä»½æ–‡ä»¶å­˜åœ¨ä¸”å¯æ¢å¤
- âœ… è¿ç§»è„šæœ¬åœ¨å¼€å‘ç¯å¢ƒæ‰§è¡ŒæˆåŠŸ
- âœ… å›æ»šè„šæœ¬æµ‹è¯•é€šè¿‡
- âœ… ç›‘æ§ç³»ç»Ÿå¯ç”¨ï¼ˆCPUã€å†…å­˜ã€æ•°æ®åº“è¿æ¥æ•°ï¼‰

#### å…³é”®è„šæœ¬

```bash
# æ•°æ®åº“å¤‡ä»½
pg_dump -U n8n -d n8n -F c -b -v -f backup_$(date +%Y%m%d).dump

# éªŒè¯å¤‡ä»½
pg_restore -l backup_20251108.dump | head -20

# æµ‹è¯•è¿ç§»ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
psql -U n8n -d n8n_dev < migration_scripts/01_add_project_id.sql
psql -U n8n -d n8n_dev < migration_scripts/02_create_billing_tables.sql
```

---

### ğŸ—„ï¸ é˜¶æ®µ 1ï¼šæ•°æ®åº“å®Œæ•´æ”¹é€ ï¼ˆWeek 1ï¼Œ5å¤©ï¼‰

**ç›®æ ‡ï¼š** ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰æ•°æ®åº“å˜æ›´ï¼Œåç»­å¼€å‘ç›´æ¥åŸºäºæ–°æ¶æ„

âš ï¸ **å…³é”®å˜æ›´**ï¼šå°†åŸæ–¹æ¡ˆä¸­åˆ†æ•£åœ¨å¤šä¸ªé˜¶æ®µçš„æ•°æ®åº“æ”¹é€ é›†ä¸­åœ¨ Week 1 å®Œæˆ

#### 1.1 æ¿€è¿›æ”¹é€ éƒ¨åˆ†ï¼ˆ2å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| æ·»åŠ  `workflow_entity.project_id` å­—æ®µ | 0.5å¤© | æ—  | Migration è„šæœ¬ |
| ä» SharedWorkflow è¿ç§»æ•°æ®åˆ° Workflow | 0.5å¤© | ä¸Šä¸€æ­¥ | æ•°æ®è¿ç§»è„šæœ¬ |
| æ·»åŠ  `credentials_entity.project_id` å­—æ®µ | 0.5å¤© | æ—  | Migration è„šæœ¬ |
| ä» SharedCredentials è¿ç§»æ•°æ® | 0.5å¤© | ä¸Šä¸€æ­¥ | æ•°æ®è¿ç§»è„šæœ¬ |

**å…³é”® SQLï¼š**
```sql
-- 1. æ·»åŠ  workflow.project_id
ALTER TABLE workflow_entity ADD COLUMN project_id UUID;

-- 2. ä» SharedWorkflow è¿ç§»æ•°æ®
UPDATE workflow_entity w
SET project_id = (
  SELECT sw.project_id
  FROM shared_workflow sw
  WHERE sw.workflow_id = w.id
    AND sw.role = 'workflow:owner'
  LIMIT 1
);

-- 3. è®¾ç½® NOT NULL å’Œå¤–é”®
ALTER TABLE workflow_entity
  ALTER COLUMN project_id SET NOT NULL,
  ADD CONSTRAINT fk_workflow_project
    FOREIGN KEY (project_id)
    REFERENCES project(id)
    ON DELETE CASCADE;

-- 4. åˆ›å»ºç´¢å¼•
CREATE INDEX idx_workflow_project_id ON workflow_entity(project_id);
CREATE INDEX idx_workflow_project_active ON workflow_entity(project_id, active);
```

#### 1.2 åˆ é™¤æ—§è¡¨ï¼ˆ0.5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | è¯´æ˜ |
|--------|---------|------|------|
| åˆ é™¤ SharedWorkflow è¡¨ | 0.25å¤© | 1.1 å®Œæˆ | DROP TABLE shared_workflow CASCADE; |
| åˆ é™¤ SharedCredentials è¡¨ | 0.25å¤© | 1.1 å®Œæˆ | DROP TABLE shared_credentials CASCADE; |

#### 1.3 åˆ›å»ºè®¡è´¹ç³»ç»Ÿè¡¨ï¼ˆ1å¤©ï¼‰

âš ï¸ **å…³é”®ä¼˜åŒ–**ï¼šåŸæ–¹æ¡ˆ Week 11 æ‰åˆ›å»ºï¼Œç°åœ¨æå‰åˆ° Week 1

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ›å»º workspace_balance è¡¨ | 0.25å¤© | æ—  | CREATE TABLE è„šæœ¬ |
| åˆ›å»º usage_record è¡¨ | 0.25å¤© | æ—  | CREATE TABLE è„šæœ¬ |
| åˆ›å»º recharge_record è¡¨ | 0.25å¤© | æ—  | CREATE TABLE è„šæœ¬ |
| åˆå§‹åŒ–ä½™é¢æ•°æ®ï¼ˆæ‰€æœ‰å·¥ä½œç©ºé—´ï¼‰ | 0.25å¤© | ä¸Šé¢ä¸‰æ­¥ | INSERT è„šæœ¬ |

**å…³é”® SQLï¼š**
```sql
-- workspace_balance è¡¨
CREATE TABLE workspace_balance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL UNIQUE,
  balance_cny NUMERIC(12, 4) DEFAULT 0.0000,
  low_balance_threshold_cny NUMERIC(10, 4) DEFAULT 10.0000,
  currency VARCHAR(3) DEFAULT 'CNY',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_workspace_balance_workspace
    FOREIGN KEY (workspace_id)
    REFERENCES project(id)
    ON DELETE CASCADE
);

-- usage_record è¡¨
CREATE TABLE usage_record (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL,
  user_id UUID NOT NULL,
  service_key VARCHAR(100) NOT NULL,
  service_type VARCHAR(50) NOT NULL,
  tokens_used INT,
  calls_count INT DEFAULT 1,
  amount_cny NUMERIC(10, 4) NOT NULL,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_usage_workspace
    FOREIGN KEY (workspace_id)
    REFERENCES project(id)
    ON DELETE CASCADE,
  CONSTRAINT fk_usage_user
    FOREIGN KEY (user_id)
    REFERENCES "user"(id)
    ON DELETE CASCADE
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_usage_workspace ON usage_record(workspace_id);
CREATE INDEX idx_usage_workspace_date ON usage_record(workspace_id, created_at DESC);
CREATE INDEX idx_usage_service ON usage_record(service_key);

-- recharge_record è¡¨
CREATE TABLE recharge_record (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL,
  user_id UUID NOT NULL,
  amount_cny NUMERIC(10, 2) NOT NULL,
  payment_method VARCHAR(50) NOT NULL,
  transaction_id VARCHAR(200),
  status VARCHAR(20) DEFAULT 'pending',
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_recharge_workspace
    FOREIGN KEY (workspace_id)
    REFERENCES project(id)
    ON DELETE CASCADE,
  CONSTRAINT fk_recharge_user
    FOREIGN KEY (user_id)
    REFERENCES "user"(id)
    ON DELETE CASCADE
);

CREATE INDEX idx_recharge_workspace ON recharge_record(workspace_id);
CREATE INDEX idx_recharge_status ON recharge_record(workspace_id, status);

-- åˆå§‹åŒ–æ‰€æœ‰å·¥ä½œç©ºé—´çš„ä½™é¢ï¼ˆé»˜è®¤ 0 å…ƒï¼‰
INSERT INTO workspace_balance (workspace_id, balance_cny)
SELECT id, 0.00 FROM project
ON CONFLICT (workspace_id) DO NOTHING;
```

#### 1.4 åˆ›å»ºå¹³å°æœåŠ¡è¡¨ï¼ˆ1å¤©ï¼‰

âš ï¸ **å…³é”®ä¼˜åŒ–**ï¼šåŸæ–¹æ¡ˆ Week 14 æ‰åˆ›å»ºï¼Œç°åœ¨æå‰åˆ° Week 1

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ›å»º platform_service è¡¨ | 0.25å¤© | æ—  | CREATE TABLE è„šæœ¬ |
| åˆ›å»º platform_rag_service è¡¨ | 0.25å¤© | æ—  | CREATE TABLE è„šæœ¬ |
| æ’å…¥åˆå§‹å¹³å°æœåŠ¡æ•°æ® | 0.5å¤© | ä¸Šé¢ä¸¤æ­¥ | INSERT è„šæœ¬ |

**å…³é”® SQLï¼š**
```sql
-- platform_service è¡¨
CREATE TABLE platform_service (
  service_key VARCHAR(100) PRIMARY KEY,
  service_type VARCHAR(50) NOT NULL,
  name VARCHAR(200) NOT NULL,
  pricing_config JSONB NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- platform_rag_service è¡¨
CREATE TABLE platform_rag_service (
  service_key VARCHAR(100) PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  domain VARCHAR(50) NOT NULL,
  price_per_query_cny NUMERIC(10, 4) NOT NULL,
  metadata JSONB,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- æ’å…¥åˆå§‹ AI æ¨¡å‹æœåŠ¡
INSERT INTO platform_service (service_key, service_type, name, pricing_config) VALUES
  ('gpt-4-turbo', 'ai_model', 'GPT-4 Turbo', '{"pricePerToken": 0.00001, "currency": "CNY"}'),
  ('gpt-3.5-turbo', 'ai_model', 'GPT-3.5 Turbo', '{"pricePerToken": 0.000001, "currency": "CNY"}'),
  ('claude-3-opus', 'ai_model', 'Claude 3 Opus', '{"pricePerToken": 0.000015, "currency": "CNY"}');

-- æ’å…¥åˆå§‹ RAG æœåŠ¡
INSERT INTO platform_rag_service (service_key, name, domain, price_per_query_cny) VALUES
  ('legal-rag-cn', 'ä¸­å›½æ³•å¾‹çŸ¥è¯†åº“', 'legal', 0.50),
  ('medical-rag-cn', 'åŒ»ç–—å¥åº·çŸ¥è¯†åº“', 'medical', 0.80),
  ('finance-rag-cn', 'é‡‘èè´¢åŠ¡çŸ¥è¯†åº“', 'finance', 0.60);
```

#### 1.5 åˆ›å»ºä¼ä¸šç‰ˆåŠŸèƒ½ç®¡ç†è¡¨ï¼ˆ0.5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ›å»º platform_feature_config è¡¨ | 0.25å¤© | æ—  | CREATE TABLE + INSERT è„šæœ¬ |
| æ‰©å±• User è¡¨ï¼ˆis_admin, feature_preferencesï¼‰ | 0.125å¤© | æ—  | ALTER TABLE è„šæœ¬ |
| æ‰©å±• Project è¡¨ï¼ˆfeature_configï¼‰ | 0.125å¤© | æ—  | ALTER TABLE è„šæœ¬ |

**å…³é”® SQLï¼š**
```sql
-- platform_feature_config è¡¨
CREATE TABLE platform_feature_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feature_key VARCHAR(100) UNIQUE NOT NULL,
  enabled BOOLEAN DEFAULT FALSE,
  config JSONB DEFAULT '{}',
  description TEXT,
  updated_at TIMESTAMP DEFAULT NOW()
);

-- åˆå§‹åŒ–å¹³å°åŠŸèƒ½é…ç½®æ•°æ®
INSERT INTO platform_feature_config (feature_key, enabled, config, description) VALUES
('ldap', FALSE, '{}', 'LDAP å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('saml', FALSE, '{}', 'SAML å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('oidc', FALSE, '{}', 'OIDC å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('external_secrets', FALSE, '{}', 'å¤–éƒ¨å¯†é’¥ç®¡ç†ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('log_streaming', FALSE, '{}', 'æ—¥å¿—æµï¼ˆä»…å¹³å°ä½¿ç”¨ï¼‰'),
('worker_view', FALSE, '{}', 'Worker ç›‘æ§ï¼ˆä»…ç®¡ç†å‘˜ï¼‰'),
('public_api', TRUE, '{"rate_limit_per_hour": 1000, "max_api_keys": 5}', 'Public APIï¼ˆå¯ç”¨ + é™æµï¼‰'),
('workflow_history', TRUE, '{"retention_days": -1}', 'å·¥ä½œæµç‰ˆæœ¬å†å²ï¼ˆæ— é™åˆ¶ï¼‰'),
('insights', TRUE, '{"date_range_limit_days": -1}', 'Insights åˆ†æï¼ˆæ— é™åˆ¶ï¼‰'),
('audit_logs', TRUE, '{"retention_days": 365}', 'å®¡è®¡æ—¥å¿—ï¼ˆä¿ç•™1å¹´ï¼‰');

-- æ‰©å±• User è¡¨
ALTER TABLE "user"
ADD COLUMN IF NOT EXISTS is_admin BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS feature_preferences JSONB DEFAULT '{}';

-- æ‰©å±• Project è¡¨
ALTER TABLE project
ADD COLUMN IF NOT EXISTS feature_config JSONB DEFAULT '{}';
```

#### 1.6 æ•°æ®éªŒè¯å’Œç´¢å¼•ä¼˜åŒ–ï¼ˆ1å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| æ•°æ®å®Œæ•´æ€§éªŒè¯ | 0.5å¤© | æ‰€æœ‰ä¸Šè¿°æ­¥éª¤ | éªŒè¯ SQL + æŠ¥å‘Š |
| æ€§èƒ½æµ‹è¯•å’Œç´¢å¼•ä¼˜åŒ– | 0.5å¤© | éªŒè¯é€šè¿‡ | æ€§èƒ½åŸºå‡†æŠ¥å‘Š |

**éªŒè¯ SQLï¼š**
```sql
-- éªŒè¯1: æ£€æŸ¥ workflow.project_id æ•°æ®å®Œæ•´æ€§
SELECT COUNT(*) as workflows_without_project
FROM workflow_entity
WHERE project_id IS NULL;
-- é¢„æœŸ: 0

-- éªŒè¯2: æ£€æŸ¥æ—§è¡¨å·²åˆ é™¤
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('shared_workflow', 'shared_credentials');
-- é¢„æœŸ: 0 è¡Œ

-- éªŒè¯3: æ£€æŸ¥æ–°è¡¨å·²åˆ›å»º
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('workspace_balance', 'usage_record', 'platform_service', 'platform_feature_config');
-- é¢„æœŸ: 4 è¡Œ

-- éªŒè¯4: æ£€æŸ¥æ‰€æœ‰å·¥ä½œç©ºé—´éƒ½æœ‰ä½™é¢è®°å½•
SELECT COUNT(*) as projects_without_balance
FROM project p
LEFT JOIN workspace_balance wb ON p.id = wb.workspace_id
WHERE wb.workspace_id IS NULL;
-- é¢„æœŸ: 0

-- éªŒè¯5: æ£€æŸ¥ç´¢å¼•å·²åˆ›å»º
SELECT indexname
FROM pg_indexes
WHERE tablename IN ('workflow_entity', 'credentials_entity', 'usage_record')
  AND indexname LIKE 'idx_%';
-- é¢„æœŸ: è‡³å°‘ 5 ä¸ªç´¢å¼•
```

#### éªŒæ”¶æ ‡å‡†

- âœ… workflow_entity.project_id å­—æ®µå­˜åœ¨ä¸”æ‰€æœ‰æ•°æ®å·²è¿ç§»
- âœ… credentials_entity.project_id å­—æ®µå­˜åœ¨ä¸”æ‰€æœ‰æ•°æ®å·²è¿ç§»
- âœ… shared_workflow å’Œ shared_credentials è¡¨å·²åˆ é™¤
- âœ… æ‰€æœ‰è®¡è´¹è¡¨å·²åˆ›å»ºå¹¶åˆå§‹åŒ–
- âœ… æ‰€æœ‰å¹³å°æœåŠ¡è¡¨å·²åˆ›å»ºå¹¶æ’å…¥åˆå§‹æ•°æ®
- âœ… æ‰€æœ‰ä¼ä¸šç‰ˆåŠŸèƒ½è¡¨å·²åˆ›å»º
- âœ… æ‰€æœ‰å¿…è¦ç´¢å¼•å·²åˆ›å»º
- âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡
- âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•è¾¾æ ‡ï¼ˆå·¥ä½œæµæŸ¥è¯¢ < 100msï¼‰

---

### ğŸ—ï¸ é˜¶æ®µ 2ï¼šEntity + Repository å±‚å®Œæ•´é‡æ„ï¼ˆWeek 2ï¼Œ5å¤©ï¼‰

**ç›®æ ‡ï¼š** åˆ é™¤æ—§ Entityï¼Œæ›´æ–°æ ¸å¿ƒ Entityï¼Œåˆ›å»ºæ–° Entityï¼Œé‡æ„æ‰€æœ‰ Repository

âš ï¸ **å…³é”®å˜æ›´**ï¼šEntity å’Œ Repository å¿…é¡»åŒæ­¥ä¿®æ”¹ï¼Œä¸èƒ½åˆ†å¼€

#### 2.1 åˆ é™¤æ—§ Entityï¼ˆ0.5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ é™¤ SharedWorkflowEntity æ–‡ä»¶ | 0.25å¤© | é˜¶æ®µ1 | æ–‡ä»¶åˆ é™¤ + git commit |
| åˆ é™¤ SharedCredentialsEntity æ–‡ä»¶ | 0.25å¤© | é˜¶æ®µ1 | æ–‡ä»¶åˆ é™¤ + git commit |

```bash
# åˆ é™¤æ—§ Entity æ–‡ä»¶
rm packages/@n8n/db/src/entities/shared-workflow.ts
rm packages/@n8n/db/src/entities/shared-credentials.ts

# æ›´æ–° index.tsï¼ˆç§»é™¤å¯¼å‡ºï¼‰
# vim packages/@n8n/db/src/entities/index.ts
```

#### 2.2 æ›´æ–°æ ¸å¿ƒ Entityï¼ˆ1å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| æ›´æ–° WorkflowEntityï¼ˆæ·»åŠ  project å…³è”ï¼‰ | 0.5å¤© | 2.1 | æ›´æ–°åçš„ Entity ä»£ç  |
| æ›´æ–° CredentialsEntityï¼ˆæ·»åŠ  project å…³è”ï¼‰ | 0.5å¤© | 2.1 | æ›´æ–°åçš„ Entity ä»£ç  |

**WorkflowEntity æ›´æ–°ç¤ºä¾‹ï¼š**
```typescript
// packages/@n8n/db/src/entities/workflow-entity.ts

@Entity()
export class WorkflowEntity extends WithTimestampsAndStringId {
  // ... å…¶ä»–å­—æ®µ

  // âŒ åˆ é™¤æ—§çš„ shared å…³è”
  // @OneToMany('SharedWorkflow', 'workflow')
  // shared: SharedWorkflow[];

  // âœ… æ·»åŠ æ–°çš„ project å…³è”
  @ManyToOne('Project', 'workflows', { nullable: false })
  @JoinColumn({ name: 'projectId' })
  project: Project;

  @Column({ type: 'uuid', name: 'projectId' })
  projectId: string;
}
```

#### 2.3 åˆ›å»ºæ–° Entityï¼ˆ1å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ›å»º WorkspaceBalanceEntity | 0.25å¤© | æ—  | Entity ä»£ç  |
| åˆ›å»º UsageRecordEntity | 0.25å¤© | æ—  | Entity ä»£ç  |
| åˆ›å»º RechargeRecordEntity | 0.25å¤© | æ—  | Entity ä»£ç  |
| åˆ›å»º PlatformServiceEntity | 0.125å¤© | æ—  | Entity ä»£ç  |
| åˆ›å»º PlatformRagServiceEntity | 0.125å¤© | æ—  | Entity ä»£ç  |
| åˆ›å»º PlatformFeatureConfigEntity | 0.125å¤© | æ—  | Entity ä»£ç  |

**WorkspaceBalanceEntity ç¤ºä¾‹ï¼š**
```typescript
// packages/@n8n/db/src/entities/workspace-balance.entity.ts

import { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinColumn } from '@n8n/typeorm';
import { Project } from './project';

@Entity()
export class WorkspaceBalance {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'uuid', unique: true })
  workspaceId: string;

  @ManyToOne('Project', { nullable: false })
  @JoinColumn({ name: 'workspaceId' })
  workspace: Project;

  @Column({ type: 'decimal', precision: 12, scale: 4, default: 0 })
  balanceCny: number;

  @Column({ type: 'decimal', precision: 10, scale: 4, default: 10 })
  lowBalanceThresholdCny: number;

  @Column({ type: 'varchar', length: 3, default: 'CNY' })
  currency: string;

  @Column({ type: 'timestamp', default: () => 'NOW()' })
  createdAt: Date;

  @Column({ type: 'timestamp', default: () => 'NOW()' })
  updatedAt: Date;
}
```

#### 2.4 åˆ é™¤æ—§ Repositoryï¼ˆ0.5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ é™¤ SharedWorkflowRepository | 0.25å¤© | 2.2 | æ–‡ä»¶åˆ é™¤ |
| åˆ é™¤ SharedCredentialsRepository | 0.25å¤© | 2.2 | æ–‡ä»¶åˆ é™¤ |

```bash
rm packages/@n8n/db/src/repositories/shared-workflow.repository.ts
rm packages/@n8n/db/src/repositories/shared-credentials.repository.ts
```

#### 2.5 é‡æ„æ ¸å¿ƒ Repositoryï¼ˆ2å¤©ï¼‰

âš ï¸ **æœ€è€—æ—¶çš„éƒ¨åˆ†**ï¼šéœ€è¦ä¿®æ”¹ 147 å¤„ SharedWorkflow å¼•ç”¨

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| é‡æ„ WorkflowRepositoryï¼ˆåˆ é™¤ 147 å¤„å¼•ç”¨ï¼‰ | 1.5å¤© | 2.2, 2.4 | æ›´æ–°åçš„ Repository |
| é‡æ„ CredentialsRepositoryï¼ˆåˆ é™¤ 95 å¤„å¼•ç”¨ï¼‰ | 0.5å¤© | 2.2, 2.4 | æ›´æ–°åçš„ Repository |

**é‡æ„æŠ€å·§ï¼š**
```bash
# 1. å…¨å±€æœç´¢ SharedWorkflow å¼•ç”¨
grep -r "SharedWorkflow" packages/ --include="*.ts" | wc -l
# é¢„æœŸ: 147 å¤„

# 2. ä½¿ç”¨ TypeScript ç¼–è¯‘å™¨å¸®åŠ©æ‰¾é—æ¼
pnpm typecheck 2>&1 | grep -i "shared"

# 3. é€ä¸ªæ–‡ä»¶ä¿®æ”¹
```

**WorkflowRepository é‡æ„ç¤ºä¾‹ï¼š**
```typescript
// æ”¹é€ å‰
async getWorkflowsForUser(userId: string) {
  return await this.find({
    where: {
      shared: {
        project: {
          projectRelations: { userId }
        }
      }
    }
  });
}

// æ”¹é€ å
async getWorkflowsForUser(userId: string) {
  return await this.find({
    where: {
      project: {
        projectRelations: { userId }
      }
    }
  });
}
```

#### 2.6 åˆ›å»ºæ–° Repositoryï¼ˆ1å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ›å»º WorkspaceBalanceRepository | 0.25å¤© | 2.3 | Repository ä»£ç  |
| åˆ›å»º UsageRecordRepository | 0.25å¤© | 2.3 | Repository ä»£ç  |
| åˆ›å»º RechargeRecordRepository | 0.25å¤© | 2.3 | Repository ä»£ç  |
| åˆ›å»º PlatformServiceRepository | 0.25å¤© | 2.3 | Repository ä»£ç  |

**WorkspaceBalanceRepository ç¤ºä¾‹ï¼š**
```typescript
// packages/@n8n/db/src/repositories/workspace-balance.repository.ts

import { Service } from '@n8n/di';
import { DataSource, Repository } from '@n8n/typeorm';
import { WorkspaceBalance } from '../entities/workspace-balance.entity';

@Service()
export class WorkspaceBalanceRepository extends Repository<WorkspaceBalance> {
  constructor(dataSource: DataSource) {
    super(WorkspaceBalance, dataSource.manager);
  }

  async getBalance(workspaceId: string): Promise<number> {
    const balance = await this.findOne({ where: { workspaceId } });
    return balance?.balanceCny ?? 0;
  }

  async checkSufficientBalance(workspaceId: string, amount: number): Promise<boolean> {
    const balance = await this.getBalance(workspaceId);
    return balance >= amount;
  }

  // æ‚²è§‚é”æ‰£è´¹ï¼ˆé˜²å¹¶å‘é€æ”¯ï¼‰
  async deductBalance(workspaceId: string, amount: number): Promise<void> {
    await this.manager.transaction('SERIALIZABLE', async (trx) => {
      const result = await trx
        .createQueryBuilder()
        .update(WorkspaceBalance)
        .set({ balanceCny: () => 'balance_cny - :amount' })
        .where('workspace_id = :workspaceId', { workspaceId })
        .andWhere('balance_cny >= :amount', { amount })
        .execute();

      if (result.affected === 0) {
        throw new Error('Insufficient balance or workspace not found');
      }
    });
  }
}
```

#### éªŒæ”¶æ ‡å‡†

- âœ… SharedWorkflowEntity å’Œ SharedCredentialsEntity å·²åˆ é™¤
- âœ… WorkflowEntity å’Œ CredentialsEntity å·²æ›´æ–°ï¼ˆç›´æ¥å…³è” Projectï¼‰
- âœ… æ‰€æœ‰æ–° Entity å·²åˆ›å»ºå¹¶å¯¼å‡º
- âœ… SharedWorkflowRepository å’Œ SharedCredentialsRepository å·²åˆ é™¤
- âœ… WorkflowRepository å’Œ CredentialsRepository å·²é‡æ„ï¼ˆæ—  SharedWorkflow å¼•ç”¨ï¼‰
- âœ… æ‰€æœ‰æ–° Repository å·²åˆ›å»º
- âœ… TypeScript ç¼–è¯‘æ— é”™è¯¯ï¼ˆ`pnpm typecheck` é€šè¿‡ï¼‰
- âœ… æ‰€æœ‰ Repository å•å…ƒæµ‹è¯•é€šè¿‡

---

### ğŸ”§ é˜¶æ®µ 3ï¼šService å±‚ï¼ˆåˆ†ä¸¤æ‰¹ï¼ŒWeek 3-4ï¼‰

**ç›®æ ‡ï¼š** åˆ›å»ºæ ¸å¿ƒå·¥ä½œç©ºé—´æœåŠ¡ + è®¡è´¹å’Œå¹³å°æœåŠ¡

âš ï¸ **å…³é”®ä¼˜åŒ–**ï¼šæŒ‰ä¸šåŠ¡å…³è”æ€§åˆ†ä¸¤æ‰¹ï¼Œè®¡è´¹å’Œå¹³å°æœåŠ¡ä¸€èµ·åš

#### Week 3ï¼šæ ¸å¿ƒå·¥ä½œç©ºé—´æœåŠ¡ï¼ˆ5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ›å»º WorkspaceContextService | 1å¤© | é˜¶æ®µ2 | å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡æå–å’ŒéªŒè¯ |
| å¢å¼º ProjectServiceï¼ˆæˆå‘˜ç®¡ç†ï¼‰ | 1å¤© | é˜¶æ®µ2 | æ·»åŠ /åˆ é™¤æˆå‘˜ã€è§’è‰²ç®¡ç† |
| é‡æ„ WorkflowServiceï¼ˆä½¿ç”¨æ–° Repositoryï¼‰ | 1.5å¤© | é˜¶æ®µ2 | ç§»é™¤ SharedWorkflow ä¾èµ– |
| é‡æ„ CredentialsService | 1.5å¤© | é˜¶æ®µ2 | ç§»é™¤ SharedCredentials ä¾èµ– |

**WorkspaceContextService ç¤ºä¾‹ï¼š**
```typescript
// packages/cli/src/services/workspace-context.service.ts

import { Service } from '@n8n/di';
import { Request } from 'express';
import { BadRequestError, ForbiddenError } from '@/errors';
import { ProjectRelationRepository } from '@n8n/db';

@Service()
export class WorkspaceContextService {
  constructor(
    private projectRelationRepository: ProjectRelationRepository,
  ) {}

  /**
   * ä» HTTP Header æå–å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡
   */
  extractWorkspaceContext(req: Request): { workspaceId: string } {
    const workspaceId = req.headers['x-workspace-id'] as string;
    if (!workspaceId) {
      throw new BadRequestError('Missing X-Workspace-Id header');
    }
    return { workspaceId };
  }

  /**
   * éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®å·¥ä½œç©ºé—´çš„æƒé™
   */
  async validateAccess(
    userId: string,
    workspaceId: string,
    requiredRole?: string,
  ): Promise<void> {
    const relation = await this.projectRelationRepository.findOne({
      where: { userId, projectId: workspaceId },
      relations: { role: true },
    });

    if (!relation) {
      throw new ForbiddenError('Access denied to this workspace');
    }

    if (requiredRole && !this.hasRole(relation.role.slug, requiredRole)) {
      throw new ForbiddenError(`Requires ${requiredRole} role`);
    }
  }

  private hasRole(userRole: string, requiredRole: string): boolean {
    const roleHierarchy = {
      'project:personalOwner': 4,
      'project:admin': 3,
      'project:editor': 2,
      'project:viewer': 1,
    };
    return roleHierarchy[userRole] >= roleHierarchy[requiredRole];
  }

  /**
   * åˆ›å»ºä¸­é—´ä»¶å·¥å‚
   */
  createValidationMiddleware(requiredRole?: string) {
    return async (req: Request, res: Response, next: NextFunction) => {
      const { workspaceId } = this.extractWorkspaceContext(req);
      await this.validateAccess(req.user.id, workspaceId, requiredRole);
      req.workspaceContext = { workspaceId };
      next();
    };
  }
}
```

#### Week 4ï¼šè®¡è´¹ + å¹³å°æœåŠ¡ï¼ˆ5å¤©ï¼‰

âš ï¸ **å…³é”®ä¼˜åŒ–**ï¼šè®¡è´¹å’Œå¹³å°æœåŠ¡ä¸€èµ·å¼€å‘ï¼Œä¿è¯"è°ƒç”¨æœåŠ¡ç«‹å³æ‰£è´¹"çš„åŸå­æ€§

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ›å»º BillingService | 2å¤© | é˜¶æ®µ2 | ä½™é¢æŸ¥è¯¢ã€æ‰£è´¹ã€å……å€¼ |
| åˆ›å»º PlatformServiceService | 1.5å¤© | é˜¶æ®µ2 | å¹³å°æœåŠ¡ç®¡ç†ã€å®šä»·æŸ¥è¯¢ |
| åˆ›å»º PlatformRagService | 1å¤© | é˜¶æ®µ2 | RAG æœåŠ¡è°ƒç”¨å’Œè®¡è´¹ |
| åˆ›å»º PlatformFeatureService | 0.5å¤© | é˜¶æ®µ2 | ä¼ä¸šç‰ˆåŠŸèƒ½å¼€å…³ç®¡ç† |

**BillingService ç¤ºä¾‹ï¼š**
```typescript
// packages/cli/src/services/billing.service.ts

import { Service } from '@n8n/di';
import { WorkspaceBalanceRepository, UsageRecordRepository } from '@n8n/db';
import { BadRequestError } from '@/errors';

@Service()
export class BillingService {
  constructor(
    private workspaceBalanceRepository: WorkspaceBalanceRepository,
    private usageRecordRepository: UsageRecordRepository,
  ) {}

  /**
   * æŸ¥è¯¢å·¥ä½œç©ºé—´ä½™é¢
   */
  async getBalance(workspaceId: string): Promise<number> {
    return await this.workspaceBalanceRepository.getBalance(workspaceId);
  }

  /**
   * è®°å½•ä½¿ç”¨å¹¶æ‰£è´¹ï¼ˆåŸå­æ“ä½œï¼‰
   */
  async recordUsageAndCharge(params: {
    workspaceId: string;
    userId: string;
    serviceKey: string;
    serviceType: string;
    tokensUsed?: number;
    amountCny: number;
    metadata?: any;
  }): Promise<void> {
    // ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
    await this.workspaceBalanceRepository.manager.transaction('SERIALIZABLE', async (trx) => {
      // 1. æ‰£è´¹ï¼ˆæ‚²è§‚é”ï¼‰
      await this.workspaceBalanceRepository.deductBalance(
        params.workspaceId,
        params.amountCny,
      );

      // 2. è®°å½•æ¶ˆè´¹
      await trx.save('UsageRecord', {
        workspaceId: params.workspaceId,
        userId: params.userId,
        serviceKey: params.serviceKey,
        serviceType: params.serviceType,
        tokensUsed: params.tokensUsed,
        amountCny: params.amountCny,
        metadata: params.metadata,
      });
    });

    // 3. æ£€æŸ¥æ˜¯å¦ä½ä½™é¢å‘Šè­¦
    await this.checkLowBalanceAlert(params.workspaceId);
  }

  /**
   * åˆ›å»ºå……å€¼è®¢å•
   */
  async createRechargeOrder(params: {
    workspaceId: string;
    userId: string;
    amountCny: number;
    paymentMethod: 'alipay' | 'wechat';
  }): Promise<{ orderId: string; qrCodeUrl: string }> {
    // åˆ›å»ºå……å€¼è®°å½•
    const record = await this.rechargeRecordRepository.save({
      workspaceId: params.workspaceId,
      userId: params.userId,
      amountCny: params.amountCny,
      paymentMethod: params.paymentMethod,
      status: 'pending',
    });

    // è°ƒç”¨æ”¯ä»˜ SDK åˆ›å»ºè®¢å•
    // ...

    return { orderId: record.id, qrCodeUrl: '...' };
  }

  /**
   * å¤„ç†å……å€¼å›è°ƒ
   */
  async handleRechargeCallback(orderId: string): Promise<void> {
    await this.rechargeRecordRepository.manager.transaction(async (trx) => {
      // 1. æ›´æ–°å……å€¼è®°å½•çŠ¶æ€
      const record = await trx.findOne('RechargeRecord', { where: { id: orderId } });
      if (!record || record.status !== 'pending') {
        throw new BadRequestError('Invalid recharge order');
      }

      record.status = 'completed';
      record.completedAt = new Date();
      await trx.save(record);

      // 2. å¢åŠ ä½™é¢
      await trx
        .createQueryBuilder()
        .update('WorkspaceBalance')
        .set({ balanceCny: () => `balance_cny + ${record.amountCny}` })
        .where('workspace_id = :workspaceId', { workspaceId: record.workspaceId })
        .execute();
    });
  }

  private async checkLowBalanceAlert(workspaceId: string): Promise<void> {
    const balance = await this.workspaceBalanceRepository.findOne({
      where: { workspaceId },
    });

    if (balance && balance.balanceCny < balance.lowBalanceThresholdCny) {
      // å‘é€ä½ä½™é¢å‘Šè­¦ï¼ˆé‚®ä»¶/çŸ­ä¿¡ï¼‰
      // await this.emailService.send(...)
    }
  }
}
```

**PlatformServiceService ç¤ºä¾‹ï¼š**
```typescript
// packages/cli/src/services/platform-service.service.ts

import { Service } from '@n8n/di';
import { PlatformServiceRepository } from '@n8n/db';

@Service()
export class PlatformServiceService {
  constructor(
    private platformServiceRepository: PlatformServiceRepository,
  ) {}

  /**
   * è·å–æ‰€æœ‰æ´»è·ƒçš„å¹³å°æœåŠ¡
   */
  async listActiveServices(): Promise<PlatformService[]> {
    return await this.platformServiceRepository.find({
      where: { isActive: true },
    });
  }

  /**
   * è®¡ç®—æœåŠ¡ä»·æ ¼
   */
  async calculatePrice(serviceKey: string, usage: { tokens?: number; calls?: number }): Promise<number> {
    const service = await this.platformServiceRepository.findOne({
      where: { serviceKey },
    });

    if (!service) {
      throw new Error(`Service ${serviceKey} not found`);
    }

    const config = service.pricingConfig as any;

    if (service.serviceType === 'ai_model') {
      return (usage.tokens ?? 0) * config.pricePerToken;
    } else if (service.serviceType === 'rag_service') {
      return (usage.calls ?? 0) * config.pricePerQuery;
    }

    return 0;
  }
}
```

#### éªŒæ”¶æ ‡å‡†

- âœ… WorkspaceContextService å¯æ­£ç¡®æå–å’ŒéªŒè¯å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡
- âœ… ProjectService æ”¯æŒå®Œæ•´çš„æˆå‘˜ç®¡ç†
- âœ… WorkflowService å’Œ CredentialsService ä¸å†ä¾èµ– SharedWorkflow
- âœ… BillingService å¯æ­£ç¡®æ‰£è´¹ï¼ˆæ‚²è§‚é”é˜²å¹¶å‘ï¼‰
- âœ… PlatformServiceService å¯è®¡ç®—æœåŠ¡ä»·æ ¼
- âœ… è°ƒç”¨å¹³å°æœåŠ¡ä¼šç«‹å³æ‰£è´¹ï¼ˆåŸå­æ€§ï¼‰
- âœ… æ‰€æœ‰ Service å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆè¦†ç›–ç‡ > 80%ï¼‰

---

### ğŸš€ é˜¶æ®µ 4ï¼šController + Middlewareï¼ˆWeek 5-6ï¼‰

**ç›®æ ‡ï¼š** åˆ›å»ºç”¨æˆ·ç«¯å’Œç®¡ç†ç«¯ APIï¼Œå®ç°ä¸­é—´ä»¶

âš ï¸ **å…³é”®ä¼˜åŒ–**ï¼šç”¨æˆ·ç«¯å’Œç®¡ç†ç«¯ API åˆ†å¼€åšï¼Œé¿å…æƒé™æ··æ·†

#### Week 5ï¼šç”¨æˆ·ç«¯ API + ä¸­é—´ä»¶ï¼ˆ5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| WorkspaceContextMiddleware | 1å¤© | é˜¶æ®µ3 | è‡ªåŠ¨æå–å’ŒéªŒè¯ workspace |
| RateLimitMiddlewareï¼ˆRedisï¼‰ | 1å¤© | æ—  | API é™æµï¼ˆ100 req/minï¼‰ |
| WorkspacesController | 1.5å¤© | é˜¶æ®µ3 | å·¥ä½œç©ºé—´ CRUD + æˆå‘˜ç®¡ç† |
| BillingController | 1å¤© | é˜¶æ®µ3 | ä½™é¢æŸ¥è¯¢ã€å……å€¼ã€æ¶ˆè´¹è®°å½• |
| æ›´æ–° WorkflowsController | 0.5å¤© | é˜¶æ®µ3 | æ·»åŠ  workspace ä¸Šä¸‹æ–‡ |

**WorkspacesController ç¤ºä¾‹ï¼š**
```typescript
// packages/cli/src/controllers/workspaces.controller.ts

import { RestController, Get, Post, Patch, Delete } from '@/decorators';
import { WorkspaceContextService, ProjectService } from '@/services';
import { CurrentUser } from '@/decorators';

@RestController('/workspaces')
export class WorkspacesController {
  constructor(
    private projectService: ProjectService,
    private workspaceContextService: WorkspaceContextService,
  ) {}

  @Get('/')
  async getMyWorkspaces(@CurrentUser() user: User) {
    return await this.projectService.getAccessibleProjects(user.id);
  }

  @Post('/')
  async createTeamWorkspace(@CurrentUser() user: User, @Body() data: CreateProjectDto) {
    return await this.projectService.createTeamProject(user, data);
  }

  @Get('/:id')
  async getWorkspace(@Param('id') projectId: string, @CurrentUser() user: User) {
    await this.workspaceContextService.validateAccess(user.id, projectId);
    return await this.projectService.getProjectWithScope(projectId, { scopes: ['project:read'] });
  }

  @Post('/:id/members')
  async addMembers(
    @Param('id') projectId: string,
    @CurrentUser() user: User,
    @Body() data: { members: Array<{ userId: string; role: string }> },
  ) {
    await this.workspaceContextService.validateAccess(user.id, projectId, 'project:admin');
    return await this.projectService.addUsersToProject(projectId, data.members);
  }

  @Delete('/:id/members/:userId')
  async removeMember(
    @Param('id') projectId: string,
    @Param('userId') userId: string,
    @CurrentUser() user: User,
  ) {
    await this.workspaceContextService.validateAccess(user.id, projectId, 'project:admin');
    return await this.projectService.removeUser(projectId, userId);
  }
}
```

#### Week 6ï¼šç®¡ç†ç«¯ API + WebSocketï¼ˆ5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| AdminAuthMiddleware | 0.5å¤© | æ—  | éªŒè¯ is_admin æƒé™ |
| AdminPlatformServicesController | 1å¤© | é˜¶æ®µ3 | å¹³å°æœåŠ¡ç®¡ç†ï¼ˆAI æ¨¡å‹ï¼‰ |
| AdminPluginsController | 1å¤© | é˜¶æ®µ3 | æ’ä»¶ç®¡ç†ï¼ˆå¹³å°/ç¬¬ä¸‰æ–¹/å®¡æ ¸ï¼‰ |
| PluginsController | 0.5å¤© | é˜¶æ®µ3 | ç”¨æˆ·ç«¯æ’ä»¶æŸ¥è¯¢ã€ä¸Šä¼ ã€æäº¤å®¡æ ¸ |
| AdminWorkspacesController | 1å¤© | é˜¶æ®µ3 | å·¥ä½œç©ºé—´æœç´¢ã€å……å€¼ã€æš‚åœ |
| AdminStatsController | 1å¤© | é˜¶æ®µ3 | ç»Ÿè®¡æŠ¥è¡¨ |
| AdminPlatformFeaturesController | 0.5å¤© | é˜¶æ®µ3 | ä¼ä¸šç‰ˆåŠŸèƒ½å¼€å…³ç®¡ç† |
| æ”¹é€  PushServiceï¼ˆWebSocket éš”ç¦»ï¼‰ | 1å¤© | Week 5 | å·¥ä½œç©ºé—´æˆ¿é—´éš”ç¦» |

**AdminPlatformServicesController ç¤ºä¾‹ï¼š**
```typescript
// packages/cli/src/controllers/admin/platform-services.controller.ts

import { RestController, Get, Post, Patch } from '@/decorators';
import { RequireAdmin } from '@/decorators';
import { PlatformServiceService } from '@/services';

@RestController('/admin/platform-services')
@RequireAdmin()
export class AdminPlatformServicesController {
  constructor(private platformServiceService: PlatformServiceService) {}

  @Get('/')
  async listServices() {
    return await this.platformServiceService.listAllServices();
  }

  @Post('/')
  async createService(@Body() data: CreatePlatformServiceDto) {
    return await this.platformServiceService.createService(data);
  }

  @Patch('/:key')
  async updateService(@Param('key') serviceKey: string, @Body() updates: any) {
    return await this.platformServiceService.updateService(serviceKey, updates);
  }

  @Patch('/:key/toggle')
  async toggleService(@Param('key') serviceKey: string) {
    return await this.platformServiceService.toggleActive(serviceKey);
  }
}
```

**WebSocket éš”ç¦»ç¤ºä¾‹ï¼š**
```typescript
// packages/cli/src/push/push.service.ts

import { Service } from '@n8n/di';
import { Server, Socket } from 'socket.io';

@Service()
export class PushService {
  private io: Server;

  initialize(server: HttpServer) {
    this.io = new Server(server, {
      path: '/rest/push',
      cors: { origin: true, credentials: true },
    });

    this.io.use(async (socket, next) => {
      // éªŒè¯ token å’Œ workspaceId
      const { token, workspaceId } = socket.handshake.auth;

      const user = await this.verifyToken(token);
      const hasAccess = await this.workspaceContextService.validateAccess(
        user.id,
        workspaceId,
      );

      if (!hasAccess) {
        return next(new Error('Forbidden'));
      }

      socket.data.userId = user.id;
      socket.data.workspaceId = workspaceId;

      // åŠ å…¥å·¥ä½œç©ºé—´æˆ¿é—´
      socket.join(`workspace:${workspaceId}`);

      next();
    });
  }

  /**
   * æ¨é€äº‹ä»¶åˆ°å·¥ä½œç©ºé—´ï¼ˆéš”ç¦»ï¼‰
   */
  sendToWorkspace(workspaceId: string, event: string, data: any) {
    this.io.to(`workspace:${workspaceId}`).emit(event, data);
  }
}
```

#### éªŒæ”¶æ ‡å‡†

- âœ… WorkspaceContextMiddleware è‡ªåŠ¨æå–å’ŒéªŒè¯å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡
- âœ… RateLimitMiddleware é™æµæ­£å¸¸ï¼ˆ100 req/minï¼‰
- âœ… æ‰€æœ‰ç”¨æˆ·ç«¯ API ç«¯ç‚¹å¯è®¿é—®
- âœ… æ‰€æœ‰ç®¡ç†ç«¯ API éœ€è¦ is_admin æƒé™
- âœ… WebSocket è¿æ¥æ”¯æŒå·¥ä½œç©ºé—´éš”ç¦»
- âœ… API æ–‡æ¡£å·²ç”Ÿæˆï¼ˆSwaggerï¼‰
- âœ… Postman æµ‹è¯•é›†åˆå¯ç”¨

---

### ğŸ¨ é˜¶æ®µ 5ï¼šå‰ç«¯æ”¹é€ ï¼ˆWeek 7-9ï¼‰

**ç›®æ ‡ï¼š** å®ç°å·¥ä½œç©ºé—´åˆ‡æ¢ã€è®¡è´¹ UIã€ç®¡ç†ç«¯å‰ç«¯ã€ä¼ä¸šç‰ˆåŠŸèƒ½å‰ç«¯

âš ï¸ **å…³é”®ä¼˜åŒ–**ï¼šå‰ç«¯åœ¨åç«¯ API ç¨³å®šåæ‰å¼€å§‹

#### Week 7ï¼šçŠ¶æ€ç®¡ç† + åŸºç¡€ç»„ä»¶ï¼ˆ5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| åˆ›å»º ProjectsStore | 1.5å¤© | é˜¶æ®µ4 | Pinia Store |
| åˆ›å»º BillingStore | 1å¤© | é˜¶æ®µ4 | Pinia Store |
| Axios æ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨é™„åŠ  X-Workspace-Idï¼‰ | 1å¤© | é˜¶æ®µ4 | å…¨å±€æ‹¦æˆªå™¨ |
| WorkspaceSwitcher ç»„ä»¶ | 1.5å¤© | ProjectsStore | Vue ç»„ä»¶ |

**ProjectsStore ç¤ºä¾‹ï¼š**
```typescript
// packages/frontend/editor-ui/src/stores/projects.store.ts

import { defineStore } from 'pinia';
import { ref, computed } from 'vue';
import { workspacesApi } from '@/api/workspaces';

export const useProjectsStore = defineStore('projects', () => {
  const workspaces = ref<Project[]>([]);
  const currentWorkspaceId = ref<string | null>(null);

  const currentWorkspace = computed(() =>
    workspaces.value.find(w => w.id === currentWorkspaceId.value)
  );

  async function fetchWorkspaces() {
    workspaces.value = await workspacesApi.getMyWorkspaces();

    // å¦‚æœæ²¡æœ‰å½“å‰å·¥ä½œç©ºé—´ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
    if (!currentWorkspaceId.value && workspaces.value.length > 0) {
      currentWorkspaceId.value = workspaces.value[0].id;
    }
  }

  function setActiveWorkspace(workspaceId: string) {
    currentWorkspaceId.value = workspaceId;

    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('activeWorkspaceId', workspaceId);

    // è§¦å‘æ•°æ®åˆ·æ–°äº‹ä»¶
    window.dispatchEvent(new CustomEvent('workspace-changed', {
      detail: { workspaceId }
    }));
  }

  return {
    workspaces,
    currentWorkspaceId,
    currentWorkspace,
    fetchWorkspaces,
    setActiveWorkspace,
  };
});
```

**Axios æ‹¦æˆªå™¨ç¤ºä¾‹ï¼š**
```typescript
// packages/frontend/editor-ui/src/api/axios-config.ts

import axios from 'axios';
import { useProjectsStore } from '@/stores/projects.store';

axios.interceptors.request.use((config) => {
  const projectsStore = useProjectsStore();

  // è‡ªåŠ¨é™„åŠ å·¥ä½œç©ºé—´ ID
  if (projectsStore.currentWorkspaceId) {
    config.headers['X-Workspace-Id'] = projectsStore.currentWorkspaceId;
  }

  // è‡ªåŠ¨é™„åŠ  JWT Token
  const token = localStorage.getItem('authToken');
  if (token) {
    config.headers['Authorization'] = `Bearer ${token}`;
  }

  return config;
});

// å“åº”æ‹¦æˆªå™¨ï¼ˆå¤„ç†é”™è¯¯ï¼‰
axios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 403) {
      // å·¥ä½œç©ºé—´æƒé™ä¸è¶³
      showError('æ— æƒè®¿é—®æ­¤å·¥ä½œç©ºé—´');
    } else if (error.response?.status === 402) {
      // ä½™é¢ä¸è¶³
      showError('å·¥ä½œç©ºé—´ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼');
    }
    return Promise.reject(error);
  }
);
```

#### Week 8ï¼šç”¨æˆ·ç«¯é¡µé¢ï¼ˆ5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| WorkspacesPageï¼ˆå·¥ä½œç©ºé—´åˆ—è¡¨ï¼‰ | 1.5å¤© | Week 7 | Vue é¡µé¢ |
| WorkspaceSettingsPageï¼ˆæˆå‘˜ç®¡ç†ï¼‰ | 2å¤© | Week 7 | Vue é¡µé¢ |
| BillingPageï¼ˆä½™é¢ + å……å€¼ï¼‰ | 2å¤© | Week 7 | Vue é¡µé¢ |
| æ›´æ–°å·¥ä½œæµåˆ—è¡¨é¡µï¼ˆworkspace åˆ‡æ¢å“åº”ï¼‰ | 1å¤© | Week 7 | æ›´æ–°ç°æœ‰é¡µé¢ |

**WorkspaceSwitcher ç»„ä»¶ç¤ºä¾‹ï¼š**
```vue
<!-- packages/frontend/editor-ui/src/components/WorkspaceSwitcher.vue -->

<template>
  <n8n-select
    v-model="activeWorkspaceId"
    @update:model-value="handleWorkspaceChange"
  >
    <n8n-option
      v-for="workspace in workspaces"
      :key="workspace.id"
      :value="workspace.id"
      :label="workspace.name"
    >
      <div class="workspace-option">
        <span>{{ workspace.name }}</span>
        <n8n-badge v-if="workspace.type === 'personal'">ä¸ªäºº</n8n-badge>
        <n8n-badge v-else>å›¢é˜Ÿ</n8n-badge>
      </div>
    </n8n-option>
  </n8n-select>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { useProjectsStore } from '@/stores/projects.store';
import { useWorkflowsStore } from '@/stores/workflows.store';

const projectsStore = useProjectsStore();
const workflowsStore = useWorkflowsStore();

const workspaces = computed(() => projectsStore.workspaces);
const activeWorkspaceId = computed({
  get: () => projectsStore.currentWorkspaceId,
  set: (value) => projectsStore.setActiveWorkspace(value),
});

async function handleWorkspaceChange(workspaceId: string) {
  // åˆ‡æ¢å·¥ä½œç©ºé—´åè‡ªåŠ¨åˆ·æ–°å·¥ä½œæµåˆ—è¡¨
  await workflowsStore.fetchWorkflows();
}
</script>
```

**å·¥ä½œæµåˆ—è¡¨é¡µè‡ªåŠ¨åˆ·æ–°ï¼š**
```typescript
// packages/frontend/editor-ui/src/views/WorkflowsPage.vue

import { watch } from 'vue';
import { useProjectsStore } from '@/stores/projects.store';
import { useWorkflowsStore } from '@/stores/workflows.store';

const projectsStore = useProjectsStore();
const workflowsStore = useWorkflowsStore();

// ç›‘å¬å·¥ä½œç©ºé—´åˆ‡æ¢
watch(
  () => projectsStore.currentWorkspaceId,
  async (newId, oldId) => {
    if (newId && newId !== oldId) {
      await workflowsStore.fetchWorkflows();
    }
  }
);
```

#### Week 9ï¼šç®¡ç†ç«¯å‰ç«¯ + ä¼ä¸šç‰ˆåŠŸèƒ½å‰ç«¯ï¼ˆ5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| AdminDashboardï¼ˆç»Ÿè®¡é¢æ¿ï¼‰ | 1.5å¤© | é˜¶æ®µ4 | Vue é¡µé¢ + å›¾è¡¨ |
| AdminPlatformServicesPageï¼ˆAI æ¨¡å‹ï¼‰ | 1å¤© | é˜¶æ®µ4 | Vue é¡µé¢ |
| AdminPluginsPageï¼ˆæ’ä»¶ç®¡ç† + å®¡æ ¸ï¼‰ | 1.5å¤© | é˜¶æ®µ4 | Vue é¡µé¢ |
| PluginMarketPageï¼ˆç”¨æˆ·æ’ä»¶å¸‚åœºï¼‰ | 1å¤© | é˜¶æ®µ4 | Vue é¡µé¢ |
| AdminWorkspacesPage | 1å¤© | é˜¶æ®µ4 | Vue é¡µé¢ |
| PlatformFeaturesPageï¼ˆåŠŸèƒ½ç®¡ç†ï¼‰ | 1å¤© | é˜¶æ®µ4 | Vue é¡µé¢ |
| WorkspaceSettings æ‰©å±•ï¼ˆç¯å¢ƒå˜é‡ + å®¡è®¡æ—¥å¿—ï¼‰ | 1å¤© | Week 8 | Tab ç»„ä»¶ |
| PersonalSettingsï¼ˆMFA + åå¥½ï¼‰ | 0.5å¤© | Week 8 | Settings é¡µé¢ |

#### éªŒæ”¶æ ‡å‡†

- âœ… ProjectsStore ç®¡ç†æ‰€æœ‰å·¥ä½œç©ºé—´
- âœ… å·¥ä½œç©ºé—´åˆ‡æ¢å™¨æ­£å¸¸å·¥ä½œ
- âœ… åˆ‡æ¢å·¥ä½œç©ºé—´åæ•°æ®è‡ªåŠ¨åˆ·æ–°
- âœ… æ‰€æœ‰ API è¯·æ±‚è‡ªåŠ¨å¸¦ X-Workspace-Id
- âœ… ä½™é¢æ˜¾ç¤ºå®æ—¶æ›´æ–°
- âœ… å……å€¼æµç¨‹å®Œæ•´ï¼ˆäºŒç»´ç æ‰«æ â†’ å›è°ƒ â†’ ä½™é¢æ›´æ–°ï¼‰
- âœ… åå°ç®¡ç†ç³»ç»Ÿå¯è®¿é—®ï¼ˆadmin.example.comï¼‰
- âœ… æ‰€æœ‰ç®¡ç†åŠŸèƒ½æ­£å¸¸
- âœ… ä¼ä¸šç‰ˆåŠŸèƒ½å¼€å…³ UI å®Œæ•´
- âœ… ç¯å¢ƒå˜é‡å’Œå®¡è®¡æ—¥å¿—å·¥ä½œç©ºé—´éš”ç¦»

---

### ğŸ’³ é˜¶æ®µ 6ï¼šæ”¯ä»˜é›†æˆï¼ˆWeek 10ï¼Œ5å¤©ï¼‰

**ç›®æ ‡ï¼š** é›†æˆæ”¯ä»˜å®å’Œå¾®ä¿¡æ”¯ä»˜

âš ï¸ **å…³é”®ä¼˜åŒ–**ï¼šæ”¯ä»˜æ”¾åœ¨æœ€åï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼ˆå¯å…ˆç”¨ç®¡ç†å‘˜å……å€¼ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¾èµ– | äº¤ä»˜ç‰© |
|--------|---------|------|--------|
| æ”¯ä»˜å® SDK é›†æˆ | 2å¤© | é˜¶æ®µ3 | æ”¯ä»˜æ¥å£ + å›è°ƒå¤„ç† |
| å¾®ä¿¡æ”¯ä»˜ SDK é›†æˆ | 2å¤© | é˜¶æ®µ3 | æ”¯ä»˜æ¥å£ + å›è°ƒå¤„ç† |
| å……å€¼å›è°ƒå¤„ç†ï¼ˆç»Ÿä¸€ï¼‰ | 0.5å¤© | ä¸Šé¢ä¸¤æ­¥ | Webhook å¤„ç† |
| æ”¯ä»˜æ²™ç®±æµ‹è¯• | 0.5å¤© | ä¸Šé¢æ‰€æœ‰ | æµ‹è¯•æŠ¥å‘Š |

#### æ”¯ä»˜å®é›†æˆç¤ºä¾‹

```typescript
// packages/cli/src/services/payment/alipay.service.ts

import { Service } from '@n8n/di';
import AlipaySdk from 'alipay-sdk';

@Service()
export class AlipayService {
  private sdk: AlipaySdk;

  constructor() {
    this.sdk = new AlipaySdk({
      appId: process.env.ALIPAY_APP_ID,
      privateKey: process.env.ALIPAY_PRIVATE_KEY,
      alipayPublicKey: process.env.ALIPAY_PUBLIC_KEY,
      gateway: 'https://openapi.alipay.com/gateway.do',
    });
  }

  async createQRCodeOrder(params: {
    orderId: string;
    amount: number;
    subject: string;
  }): Promise<{ qrCodeUrl: string }> {
    const result = await this.sdk.exec('alipay.trade.precreate', {
      bizContent: {
        out_trade_no: params.orderId,
        total_amount: params.amount.toFixed(2),
        subject: params.subject,
        notify_url: `${process.env.APP_URL}/rest/billing/alipay/callback`,
      },
    });

    return { qrCodeUrl: result.qrCode };
  }

  verifyCallback(params: any, signature: string): boolean {
    return this.sdk.checkNotifySign(params);
  }
}
```

#### éªŒæ”¶æ ‡å‡†

- âœ… æ”¯ä»˜å®å……å€¼æµç¨‹æ­£å¸¸ï¼ˆæ²™ç®±ç¯å¢ƒï¼‰
- âœ… å¾®ä¿¡æ”¯ä»˜å……å€¼æµç¨‹æ­£å¸¸ï¼ˆæ²™ç®±ç¯å¢ƒï¼‰
- âœ… å……å€¼å›è°ƒæ­£ç¡®æ›´æ–°ä½™é¢
- âœ… å……å€¼è®°å½•å®Œæ•´ä¿å­˜
- âœ… å¼‚å¸¸æƒ…å†µå¤„ç†å®Œå–„ï¼ˆæ”¯ä»˜è¶…æ—¶ã€é‡å¤å›è°ƒç­‰ï¼‰

---

### ğŸ§ª é˜¶æ®µ 7ï¼šé›†æˆæµ‹è¯• + ä¼˜åŒ–ï¼ˆWeek 11-12ï¼‰

**ç›®æ ‡ï¼š** ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œæ€§èƒ½

#### Week 11ï¼šåŠŸèƒ½æµ‹è¯•ï¼ˆ5å¤©ï¼‰

| æµ‹è¯•ç±»å‹ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº | äº¤ä»˜ç‰© |
|---------|---------|--------|--------|
| æ•°æ®éš”ç¦»æµ‹è¯•ï¼ˆè·¨å·¥ä½œç©ºé—´æ³„æ¼ï¼‰ | 1.5å¤© | QA | æµ‹è¯•ç”¨ä¾‹ + æŠ¥å‘Š |
| æƒé™æµ‹è¯•ï¼ˆRBACï¼‰ | 1.5å¤© | QA | æµ‹è¯•ç”¨ä¾‹ + æŠ¥å‘Š |
| è®¡è´¹æµç¨‹æµ‹è¯•ï¼ˆæ‰£è´¹å‡†ç¡®æ€§ï¼‰ | 1å¤© | QA | æµ‹è¯•ç”¨ä¾‹ + æŠ¥å‘Š |
| ä¼ä¸šç‰ˆåŠŸèƒ½æµ‹è¯•ï¼ˆå¼€å…³æœ‰æ•ˆæ€§ï¼‰ | 1å¤© | QA | æµ‹è¯•ç”¨ä¾‹ + æŠ¥å‘Š |

**æ•°æ®éš”ç¦»æµ‹è¯•æ¸…å•ï¼š**
- [ ] ç”¨æˆ· A æ— æ³•çœ‹åˆ°ç”¨æˆ· B å·¥ä½œç©ºé—´çš„å·¥ä½œæµ
- [ ] ç”¨æˆ· A æ— æ³•çœ‹åˆ°ç”¨æˆ· B å·¥ä½œç©ºé—´çš„å‡­è¯
- [ ] ç”¨æˆ· A æ— æ³•çœ‹åˆ°ç”¨æˆ· B å·¥ä½œç©ºé—´çš„æ‰§è¡Œå†å²
- [ ] ç”¨æˆ· A æ— æ³•çœ‹åˆ°ç”¨æˆ· B å·¥ä½œç©ºé—´çš„ä½™é¢
- [ ] ç¯å¢ƒå˜é‡å®Œå…¨éš”ç¦»
- [ ] å®¡è®¡æ—¥å¿—å®Œå…¨éš”ç¦»

**æƒé™æµ‹è¯•æ¸…å•ï¼š**
- [ ] Viewer ä¸èƒ½ç¼–è¾‘å·¥ä½œæµ
- [ ] Viewer ä¸èƒ½åˆ é™¤å·¥ä½œæµ
- [ ] Editor å¯ä»¥ç¼–è¾‘å·¥ä½œæµä½†ä¸èƒ½ç®¡ç†æˆå‘˜
- [ ] Admin å¯ä»¥æ·»åŠ /åˆ é™¤æˆå‘˜
- [ ] PersonalOwner å¯ä»¥åˆ é™¤å·¥ä½œç©ºé—´

**è®¡è´¹æµ‹è¯•æ¸…å•ï¼š**
- [ ] AI æ¨¡å‹è°ƒç”¨æ­£ç¡®æ‰£è´¹ï¼ˆæŒ‰ tokenï¼‰
- [ ] RAG æœåŠ¡è°ƒç”¨æ­£ç¡®æ‰£è´¹ï¼ˆæŒ‰æ¬¡æ•°ï¼‰
- [ ] ä½™é¢ä¸è¶³æ‹’ç»æ‰§è¡Œ
- [ ] å……å€¼æˆåŠŸå¢åŠ ä½™é¢
- [ ] ä½ä½™é¢å‘Šè­¦è§¦å‘

#### Week 12ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ5å¤©ï¼‰

| å­ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº | äº¤ä»˜ç‰© |
|--------|---------|--------|--------|
| æ•°æ®åº“æ…¢æŸ¥è¯¢ä¼˜åŒ– | 2å¤© | åç«¯ + DBA | ç´¢å¼•ä¼˜åŒ– + æŸ¥è¯¢é‡å†™ |
| Redis ç¼“å­˜å®æ–½ | 2å¤© | åç«¯ | ç¼“å­˜ç­–ç•¥æ–‡æ¡£ |
| å‰ç«¯æ‰“åŒ…ä¼˜åŒ–ï¼ˆCode Splittingï¼‰ | 0.5å¤© | å‰ç«¯ | æ‰“åŒ…é…ç½® |
| å‹åŠ›æµ‹è¯•ï¼ˆ1000 å¹¶å‘ï¼‰ | 0.5å¤© | DevOps | æ€§èƒ½æŠ¥å‘Š |

**æ€§èƒ½ç›®æ ‡ï¼š**
| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… |
|------|------|------|
| å·¥ä½œæµåˆ—è¡¨æŸ¥è¯¢ | < 100ms | ___ |
| å·¥ä½œç©ºé—´åˆ‡æ¢ | < 50ms | ___ |
| æƒé™æ£€æŸ¥è€—æ—¶ | < 10ms | ___ |
| ä½™é¢æŸ¥è¯¢ | < 20ms | ___ |
| æ”¯æŒå¹¶å‘ç”¨æˆ·æ•° | > 1000 | ___ |

**ç¼“å­˜ç­–ç•¥ï¼š**
```typescript
// Redis ç¼“å­˜ç¤ºä¾‹

// 1. ç¼“å­˜å·¥ä½œç©ºé—´æˆå‘˜å…³ç³»ï¼ˆ5åˆ†é’Ÿï¼‰
const cacheKey = `workspace:${workspaceId}:members`;
let members = await redis.get(cacheKey);
if (!members) {
  members = await this.projectRelationRepository.find({ where: { projectId: workspaceId } });
  await redis.set(cacheKey, JSON.stringify(members), 'EX', 300);
}

// 2. ç¼“å­˜ä½™é¢ï¼ˆ10ç§’ï¼Œé˜²æ­¢é¢‘ç¹æŸ¥è¯¢ï¼‰
const balanceCacheKey = `workspace:${workspaceId}:balance`;
let balance = await redis.get(balanceCacheKey);
if (!balance) {
  balance = await this.workspaceBalanceRepository.getBalance(workspaceId);
  await redis.set(balanceCacheKey, balance, 'EX', 10);
}

// 3. ç¼“å­˜å¹³å°æœåŠ¡åˆ—è¡¨ï¼ˆ1å°æ—¶ï¼‰
const servicesCacheKey = 'platform:services:active';
let services = await redis.get(servicesCacheKey);
if (!services) {
  services = await this.platformServiceRepository.find({ where: { isActive: true } });
  await redis.set(servicesCacheKey, JSON.stringify(services), 'EX', 3600);
}
```

#### éªŒæ”¶æ ‡å‡†

- âœ… æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡
- âœ… å…³é”® Bug å·²ä¿®å¤
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 70%
- âœ… API å“åº”æ—¶é—´ < 100ms (p95)
- âœ… æ”¯æŒ 1000 å¹¶å‘ç”¨æˆ·
- âœ… æ•°æ®åº“æŸ¥è¯¢ < 50ms
- âœ… ç›‘æ§å‘Šè­¦æ­£å¸¸

---

## å››ã€é£é™©ç®¡ç†

### 4.1 æŠ€æœ¯é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ | è´Ÿè´£äºº |
|------|--------|------|---------|--------|
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä½ | é«˜ | Week 0 å……åˆ†æµ‹è¯•ï¼Œå‡†å¤‡å›æ»šæ–¹æ¡ˆ | DBA |
| Repository é‡æ„é—æ¼ | ä¸­ | é«˜ | ä½¿ç”¨ TypeScript ç¼–è¯‘å™¨æ‰¾é—æ¼ï¼Œä»£ç å®¡æŸ¥ | åç«¯ |
| å¹¶å‘æ‰£è´¹å†²çª | ä½ | é«˜ | ä½¿ç”¨æ‚²è§‚é”ï¼ˆSERIALIZABLE äº‹åŠ¡ï¼‰ | åç«¯ |
| å‰åç«¯æ¥å£ä¸ä¸€è‡´ | ä¸­ | ä¸­ | API æ–‡æ¡£å…ˆè¡Œï¼Œæ¥å£è¯„å®¡ä¼š | å…¨æ ˆ |
| æ”¯ä»˜é›†æˆå¤±è´¥ | ä½ | ä¸­ | ä½¿ç”¨æ²™ç®±ç¯å¢ƒå……åˆ†æµ‹è¯• | åç«¯ |
| Redis ç¼“å­˜é›ªå´© | ä½ | ä¸­ | ç¼“å­˜è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ | åç«¯ |

### 4.2 è¿›åº¦é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ | è´Ÿè´£äºº |
|------|--------|------|---------|--------|
| äººå‘˜ä¸è¶³ | ä¸­ | é«˜ | æå‰æ‹›è˜/å¤–åŒ… | PM |
| éœ€æ±‚å˜æ›´ | é«˜ | ä¸­ | æ•æ·å¼€å‘ï¼Œç•™å‡º buffer æ—¶é—´ | PM |
| æŠ€æœ¯éš¾é¢˜ | ä¸­ | ä¸­ | æŠ€æœ¯æ”»å…³ï¼Œå¯»æ±‚å¤–éƒ¨æ”¯æŒ | æŠ€æœ¯ Leader |
| æµ‹è¯•æ—¶é—´ä¸è¶³ | ä¸­ | é«˜ | å¼€å‘é˜¶æ®µåŒæ­¥æµ‹è¯• | QA |
| ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡å»¶è¿Ÿ | ä¸­ | ä½ | å¹¶è¡Œå¼€å‘ï¼Œæ”¯ä»˜é›†æˆæ”¾æœ€å | åç«¯ |

---

## äº”ã€èµ„æºéœ€æ±‚

### 5.1 å›¢é˜Ÿé…ç½®

| è§’è‰² | äººæ•° | æŠ•å…¥åº¦ | å…³é”®æŠ€èƒ½ | ä¸»è¦è´Ÿè´£ |
|------|------|--------|---------|---------|
| **å…¨æ ˆå·¥ç¨‹å¸ˆ** | 2äºº | 100% | TypeScript, Vue, Node.js | æ ¸å¿ƒå¼€å‘ |
| **åç«¯å·¥ç¨‹å¸ˆ** | 1äºº | 100% | TypeORM, PostgreSQL, Redis | Repository + Service |
| **å‰ç«¯å·¥ç¨‹å¸ˆ** | 1äºº | 100% | Vue 3, Pinia, TypeScript | UI ç»„ä»¶ + é¡µé¢ |
| **QA å·¥ç¨‹å¸ˆ** | 1äºº | 80% | Jest, Playwright | æµ‹è¯• |
| **DevOps å·¥ç¨‹å¸ˆ** | 1äºº | 50% | Docker, Nginx, ç›‘æ§ | éƒ¨ç½² + ç›‘æ§ |
| **DBA** | 1äºº | 30% | PostgreSQL ä¼˜åŒ– | æ•°æ®åº“è¿ç§» + ä¼˜åŒ– |
| **äº§å“ç»ç†** | 1äºº | 50% | éœ€æ±‚ç®¡ç† | åè°ƒ + éªŒæ”¶ |

**æ€»äººåŠ›ï¼š** çº¦ 5.3 äºº Ã— 12 å‘¨ = **63.6 äººå‘¨**

### 5.2 æŠ€æœ¯æ ˆ

**åç«¯ï¼š**
- Node.js 20+
- TypeScript 5+
- Express 4+
- TypeORM 0.3+
- PostgreSQL 15+
- Redis 7+
- Jest

**å‰ç«¯ï¼š**
- Vue 3.4+
- Pinia
- Vite 5+
- Vitest

**åŸºç¡€è®¾æ–½ï¼š**
- Docker
- Nginx
- Prometheus + Grafana
- Sentry

### 5.3 å¤–éƒ¨æœåŠ¡

- OpenAI API
- Claude API (Anthropic)
- Pineconeï¼ˆå‘é‡æ•°æ®åº“ï¼‰
- æ”¯ä»˜å®å¼€æ”¾å¹³å°
- å¾®ä¿¡æ”¯ä»˜
- é˜¿é‡Œäº‘ SMSï¼ˆçŸ­ä¿¡ï¼‰
- é˜¿é‡Œäº‘ Emailï¼ˆé‚®ä»¶ï¼‰

---

## å…­ã€è´¨é‡æ ‡å‡†

### 6.1 ä»£ç è´¨é‡

- âœ… TypeScript è¦†ç›–ç‡ 100%
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- âœ… ESLint æ— é”™è¯¯
- âœ… Prettier æ ¼å¼ç»Ÿä¸€
- âœ… Code Review é€šè¿‡ç‡ 100%

### 6.2 æ€§èƒ½æ ‡å‡†

- âœ… API å“åº”æ—¶é—´ < 100ms (p95)
- âœ… æ•°æ®åº“æŸ¥è¯¢ < 50ms
- âœ… å‰ç«¯é¦–å±åŠ è½½ < 2s
- âœ… æ”¯æŒ 1000 å¹¶å‘ç”¨æˆ·

### 6.3 å®‰å…¨æ ‡å‡†

- âœ… SQL æ³¨å…¥é˜²æŠ¤
- âœ… XSS é˜²æŠ¤
- âœ… CSRF é˜²æŠ¤ï¼ˆJWTï¼‰
- âœ… API é™æµï¼ˆ100 req/minï¼‰
- âœ… æ•æ„Ÿæ•°æ®åŠ å¯†

---

## ä¸ƒã€å‘å¸ƒç­–ç•¥

### 7.1 ç°åº¦å‘å¸ƒè®¡åˆ’

| é˜¶æ®µ | ç”¨æˆ·èŒƒå›´ | æ—¶é—´ | è§‚å¯ŸæŒ‡æ ‡ |
|------|---------|------|---------|
| **Alpha** | å†…éƒ¨å›¢é˜Ÿï¼ˆ5äººï¼‰ | Week 11 | åŠŸèƒ½å®Œæ•´æ€§ |
| **Beta** | å‹å¥½ç”¨æˆ·ï¼ˆ20äººï¼‰ | Week 12 | ç¨³å®šæ€§ + æ€§èƒ½ |
| **æ­£å¼å‘å¸ƒ** | å…¨é‡ç”¨æˆ· | Week 13+ | æ€§èƒ½ã€ç¨³å®šæ€§ã€ç”¨æˆ·åé¦ˆ |

### 7.2 å›æ»šç­–ç•¥

**è§¦å‘æ¡ä»¶ï¼š**
- ä¸¥é‡ Bug å½±å“æ ¸å¿ƒåŠŸèƒ½
- ç³»ç»Ÿç¨³å®šæ€§ < 99%
- ç”¨æˆ·æŠ•è¯‰æ¿€å¢
- æ•°æ®å®‰å…¨é—®é¢˜

**å›æ»šæµç¨‹ï¼š**
```bash
# 1. åœæ­¢æ–°ç‰ˆæœ¬æœåŠ¡
pm2 stop n8n-backend

# 2. æ¢å¤æ•°æ®åº“ï¼ˆå¦‚éœ€è¦ï¼‰
psql -U n8n -d n8n < rollback_backup_20251201.sql

# 3. åˆ‡æ¢åˆ°æ—§ç‰ˆæœ¬
git checkout <previous-stable-commit>
pnpm build

# 4. é‡å¯æœåŠ¡
pm2 start n8n-backend

# 5. ç›‘æ§éªŒè¯
watch -n 1 'curl http://localhost:5678/healthz'
```

---

## å…«ã€é‡Œç¨‹ç¢‘æ€»ç»“

| é‡Œç¨‹ç¢‘ | å®Œæˆæ—¶é—´ | å…³é”®äº¤ä»˜ç‰© | éªŒæ”¶æ ‡å‡† |
|--------|---------|-----------|---------|
| **M0: å‡†å¤‡** | Week 0 | å¤‡ä»½ + å›æ»šæ–¹æ¡ˆ + ç›‘æ§ | æ•°æ®åº“å¤‡ä»½å¯æ¢å¤ |
| **M1: æ•°æ®åº“** | Week 1 | æ‰€æœ‰è¡¨ç»“æ„æ”¹é€ å®Œæˆ | æ‰€æœ‰éªŒè¯ SQL é€šè¿‡ |
| **M2: Entity+Repository** | Week 2 | Entity å’Œ Repository é‡æ„å®Œæˆ | TypeScript ç¼–è¯‘é€šè¿‡ |
| **M3: Service** | Week 4 | æ‰€æœ‰ Service åˆ›å»ºå®Œæˆ | å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80% |
| **M4: Controller** | Week 6 | æ‰€æœ‰ API ç«¯ç‚¹å®Œæˆ | Postman æµ‹è¯•é›†åˆå¯ç”¨ |
| **M5: å‰ç«¯** | Week 9 | ç”¨æˆ·ç«¯å’Œç®¡ç†ç«¯å‰ç«¯å®Œæˆ | åŠŸèƒ½æ¼”ç¤ºå¯ç”¨ |
| **M6: æ”¯ä»˜** | Week 10 | æ”¯ä»˜é›†æˆå®Œæˆ | æ²™ç®±æµ‹è¯•é€šè¿‡ |
| **M7: ä¸Šçº¿** | Week 12 | ç³»ç»Ÿä¼˜åŒ–å®Œæˆ | æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡ |

---

## ä¹ã€é™„å½•ï¼šä¼˜åŒ–å¯¹æ¯”

### 9.1 æ‰§è¡Œé¡ºåºå¯¹æ¯”

| æ¨¡å— | åŸæ–¹æ¡ˆ | ä¼˜åŒ–å | ä¼˜åŒ–åŸå›  |
|------|--------|--------|---------|
| **æ•°æ®åº“è¿ç§»** | Week 1 éƒ¨åˆ† + Week 11 è®¡è´¹è¡¨ | Week 1 å…¨éƒ¨å®Œæˆ | é¿å…å¼€å‘æœŸé—´å…¼å®¹æ–°æ—§æ¶æ„ |
| **Entity + Repository** | Week 2 åˆ†å¼€åš | Week 2 åŒæ­¥åš | Entity å’Œ Repository å¼ºè€¦åˆï¼Œå¿…é¡»åŒæ­¥ |
| **è®¡è´¹ + å¹³å°æœåŠ¡** | Week 11 + Week 14 | Week 4 ä¸€èµ·åš | ä¿è¯"è°ƒç”¨æœåŠ¡ç«‹å³æ‰£è´¹"åŸå­æ€§ |
| **å‰ç«¯** | Week 4 | Week 7 | ç­‰åç«¯ API ç¨³å®šåå†å¼€å§‹ |
| **æ”¯ä»˜** | Week 13 | Week 10 | ä¸é˜»å¡ä¸»æµç¨‹ï¼Œå¯å¹¶è¡Œå¼€å‘ |

### 9.2 æ€»å·¥æœŸå¯¹æ¯”

| é¡¹ç›® | åŸæ–¹æ¡ˆ | ä¼˜åŒ–å | èŠ‚çœ |
|------|--------|--------|------|
| **æ€»å·¥æœŸ** | 15-16 å‘¨ | 12 å‘¨ | **3-4 å‘¨** |
| **è¿”å·¥é£é™©** | é«˜ | ä½ | **-50%** |
| **å¹¶è¡Œå¼€å‘** | å°‘ | å¤š | **+40%** |

### 9.3 å…³é”®ä¼˜åŒ–ç‚¹

1. âœ… **æ•°æ®åº“æ”¹é€ é›†ä¸­å¤„ç†**ï¼ˆWeek 1 å…¨éƒ¨å®Œæˆï¼‰
2. âœ… **Entity + Repository åŒæ­¥ä¿®æ”¹**ï¼ˆé¿å…ç±»å‹é”™è¯¯ï¼‰
3. âœ… **è®¡è´¹ + å¹³å°æœåŠ¡ä¸€èµ·å¼€å‘**ï¼ˆä¿è¯åŸå­æ€§ï¼‰
4. âœ… **å‰ç«¯åœ¨åç«¯ç¨³å®šåå¼€å§‹**ï¼ˆå‡å°‘è¿”å·¥ï¼‰
5. âœ… **æ”¯ä»˜ä¸é˜»å¡ä¸»æµç¨‹**ï¼ˆå¹¶è¡Œå¼€å‘ï¼‰

---

## åã€å®æ–½è¿›åº¦è¯¦ç»†è®°å½•

### âœ… é˜¶æ®µ 0ï¼šå‡†å¤‡é˜¶æ®µï¼ˆå·²å®Œæˆ - 2025-01-07ï¼‰

**å®Œæˆæ—¶é—´ï¼š** 2025-01-07
**çŠ¶æ€ï¼š** âœ… å®Œæˆ

| ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| åˆ†æç°æœ‰æ•°æ®åº“ç»“æ„ | âœ… | å®Œæˆå¯¹ Entityã€Repository çš„å…¨é¢åˆ†æ |
| åˆ†æè¿ç§»ç³»ç»Ÿ | âœ… | å®Œæˆå¯¹ TypeORM è¿ç§»æœºåˆ¶çš„æ·±å…¥ç ”ç©¶ |
| å‡†å¤‡å¼€å‘ç¯å¢ƒ | âœ… | éªŒè¯æ„å»ºç³»ç»Ÿå’Œä¾èµ–é¡¹ |

**äº¤ä»˜ç‰©ï¼š**
- å®Œæ•´çš„ Entity ç»“æ„åˆ†ææŠ¥å‘Š
- è¿ç§»ç³»ç»Ÿä½¿ç”¨æŒ‡å—
- å¼€å‘ç¯å¢ƒéªŒè¯é€šè¿‡

---

### âœ… é˜¶æ®µ 1ï¼šæ•°æ®åº“è¿ç§»è„šæœ¬åˆ›å»ºï¼ˆå·²å®Œæˆ - 2025-01-07ï¼‰

**å®Œæˆæ—¶é—´ï¼š** 2025-01-07
**çŠ¶æ€ï¼š** âœ… å®Œæˆ
**ä»£ç é‡ï¼š** 1,412 è¡Œ

#### 1.1 åˆ›å»ºçš„è¿ç§»æ–‡ä»¶

| æ–‡ä»¶ | è¡Œæ•° | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| `1762511301780-MultitenantTransformation.ts` | 350 | âœ… | åˆ é™¤ SharedWorkflow/SharedCredentials |
| `1762511302000-CreateBillingTables.ts` | 280 | âœ… | è®¡è´¹ç³»ç»Ÿè¡¨ï¼ˆä½™é¢ã€æ¶ˆè´¹ã€å……å€¼ï¼‰ |
| `1762511302220-CreatePlatformServiceTables.ts` | 341 | âœ… | å¹³å°æœåŠ¡è¡¨ï¼ˆAI æ¨¡å‹ã€RAGï¼‰ |
| `1762511302440-CreatePlatformFeatureTables.ts` | 441 | âœ… | ä¼ä¸šç‰ˆåŠŸèƒ½ç®¡ç†è¡¨ |

#### 1.2 åˆ›å»ºçš„æ•°æ®åº“è¡¨

| è¡¨å | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `workspace_balance` | æ–°å»º | å·¥ä½œç©ºé—´ä½™é¢ |
| `usage_record` | æ–°å»º | æ¶ˆè´¹è®°å½• |
| `recharge_record` | æ–°å»º | å……å€¼è®°å½• |
| `platform_service` | æ–°å»º | å¹³å°æœåŠ¡ï¼ˆAI æ¨¡å‹ï¼‰ |
| `platform_rag_service` | æ–°å»º | å‚ç›´ RAG æœåŠ¡ |
| `platform_feature_config` | æ–°å»º | å¹³å°åŠŸèƒ½é…ç½® |
| `user` | æ‰©å±• | æ·»åŠ  is_adminã€feature_preferences |
| `project` | æ‰©å±• | æ·»åŠ  feature_config |
| `shared_workflow` | åˆ é™¤ | æ¿€è¿›æ”¹é€  |
| `shared_credentials` | åˆ é™¤ | æ¿€è¿›æ”¹é€  |

#### 1.3 æ’å…¥çš„åˆå§‹æ•°æ®

| è¡¨ | è®°å½•æ•° | è¯´æ˜ |
|------|--------|------|
| `platform_service` | 5 æ¡ | AI æ¨¡å‹ï¼ˆGPT-4ã€Claude 3 ç­‰ï¼‰ |
| `platform_rag_service` | 3 æ¡ | RAG æœåŠ¡ï¼ˆæ³•å¾‹ã€åŒ»ç–—ã€é‡‘èï¼‰ |
| `platform_feature_config` | 10 æ¡ | åŠŸèƒ½å¼€å…³é…ç½® |

#### 1.4 é…å¥—æ–‡æ¡£

| æ–‡æ¡£ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| æ•°æ®åº“è¿ç§»è¯´æ˜.md | 368 | è¯¦ç»†æ‰§è¡ŒæŒ‡å— |
| è¿ç§»æµ‹è¯•è®¡åˆ’.md | 546 | 9 ä¸ªæµ‹è¯•ç”¨ä¾‹ |
| MIGRATION_CHECKLIST.md | 378 | æ‰§è¡Œæ£€æŸ¥æ¸…å• |
| MIGRATION_SUMMARY.md | 444 | å·¥ä½œæ€»ç»“ |
| README_MultitenantTransformation.md | 180 | å¿«é€Ÿå‚è€ƒ |
| ç´¢å¼•æ›´æ–°æŒ‡å— | - | æ³¨å†ŒæŒ‡å— |

#### 1.5 è´¨é‡éªŒè¯

- âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡
- âœ… è·¨æ•°æ®åº“å…¼å®¹ï¼ˆPostgreSQLã€MySQLã€SQLiteï¼‰
- âœ… å®Œæ•´çš„å›æ»šæ–¹æ³•
- âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯
- âœ… å·²æ³¨å†Œåˆ°ä¸‰ä¸ªæ•°æ®åº“ç´¢å¼•

---

### ğŸŸ¡ é˜¶æ®µ 2ï¼šEntity + Repository å±‚é‡æ„ï¼ˆè¿›è¡Œä¸­ - 80%ï¼‰

**å¼€å§‹æ—¶é—´ï¼š** 2025-01-07
**çŠ¶æ€ï¼š** ğŸŸ¡ è¿›è¡Œä¸­ï¼ˆ80%ï¼‰

#### 2.1 å·²å®Œæˆçš„å·¥ä½œ

##### åˆ é™¤æ—§æ–‡ä»¶ï¼ˆâœ… å®Œæˆï¼‰

| æ–‡ä»¶ | ç±»å‹ | çŠ¶æ€ | å¤‡ä»½ä½ç½® |
|------|------|------|----------|
| `shared-workflow.ts` | Entity | âœ… å·²åˆ é™¤ | `/tmp/n8n-entity-backup/` |
| `shared-credentials.ts` | Entity | âœ… å·²åˆ é™¤ | `/tmp/n8n-entity-backup/` |
| `shared-workflow.repository.ts` | Repository | âœ… å·²åˆ é™¤ | `/tmp/n8n-entity-backup/` |
| `shared-credentials.repository.ts` | Repository | âœ… å·²åˆ é™¤ | `/tmp/n8n-entity-backup/` |
| `shared-credentials.repository.test.ts` | æµ‹è¯• | âœ… å·²åˆ é™¤ | `/tmp/n8n-entity-backup/` |

##### æ›´æ–°æ ¸å¿ƒ Entityï¼ˆâœ… å®Œæˆï¼‰

| Entity | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|--------|----------|------|
| `WorkflowEntity` | åˆ é™¤ shared å…³è”ï¼Œæ·»åŠ  project ç›´æ¥å…³è” | âœ… |
| `CredentialsEntity` | åˆ é™¤ shared å…³è”ï¼Œæ·»åŠ  project ç›´æ¥å…³è” | âœ… |
| `Project` | æ›´æ–°ä¸ºç›´æ¥æŒæœ‰ workflows å’Œ credentials | âœ… |
| `User` | åˆ é™¤ sharedWorkflows å’Œ sharedCredentials | âœ… |

##### é‡æ„ Repositoryï¼ˆâœ… å®Œæˆï¼‰

| Repository | ä¿®æ”¹æ•°é‡ | çŠ¶æ€ | è¯´æ˜ |
|-----------|---------|------|------|
| `CredentialsRepository` | 6 ä¸ªæ–¹æ³• | âœ… | ç§»é™¤æ‰€æœ‰ SharedCredentials å¼•ç”¨ |
| `WorkflowRepository` | 4 ä¸ªæ–¹æ³• | âœ… | ç§»é™¤æ‰€æœ‰ SharedWorkflow å¼•ç”¨ |
| `ExecutionRepository` | 1 ä¸ªæŸ¥è¯¢ | âœ… | ç®€åŒ– JOIN æŸ¥è¯¢ |
| `UserRepository` | 1 ä¸ªæ–¹æ³• | âœ… | æ›´æ–°å·¥ä½œæµæŸ¥è¯¢ |
| `WorkflowStatisticsRepository` | 1 ä¸ªç»Ÿè®¡ | âœ… | æ›´æ–°ç»Ÿè®¡é€»è¾‘ |

##### æ›´æ–°ç±»å‹å®šä¹‰ï¼ˆâœ… å®Œæˆï¼‰

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|----------|------|
| `types-db.ts` | åˆ é™¤ SharedWorkflow/SharedCredentials ç›¸å…³ç±»å‹ | âœ… |
| `index.ts` (entities) | åˆ é™¤ Shared å¯¼å‡º | âœ… |
| `index.ts` (repositories) | åˆ é™¤ Shared å¯¼å‡º | âœ… |

##### è´¨é‡éªŒè¯ï¼ˆâœ… å®Œæˆï¼‰

- âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡
- âœ… @n8n/db åŒ…æ„å»ºæˆåŠŸ
- âœ… æ‰€æœ‰ä¿®æ”¹æ–‡ä»¶å·²å¤‡ä»½
- âœ… æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ï¼ˆå‡å°‘ä¸€å±‚ JOINï¼‰

#### 2.2 å¾…å®Œæˆçš„å·¥ä½œ

##### åˆ›å»ºæ–° Entityï¼ˆâ¬œ å¾…å®Œæˆï¼‰

| Entity | å¯¹åº”è¡¨ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|--------|--------|--------|------|
| `WorkspaceBalanceEntity` | workspace_balance | P0 | â¬œ |
| `UsageRecordEntity` | usage_record | P0 | â¬œ |
| `RechargeRecordEntity` | recharge_record | P0 | â¬œ |
| `PlatformServiceEntity` | platform_service | P0 | â¬œ |
| `PlatformRagServiceEntity` | platform_rag_service | P1 | â¬œ |
| `PlatformFeatureConfigEntity` | platform_feature_config | P1 | â¬œ |

##### åˆ›å»ºæ–° Repositoryï¼ˆâ¬œ å¾…å®Œæˆï¼‰

| Repository | æ ¸å¿ƒæ–¹æ³• | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|-----------|----------|--------|------|
| `WorkspaceBalanceRepository` | getBalance, deductBalance, addBalance | P0 | â¬œ |
| `UsageRecordRepository` | create, findByWorkspace, statistics | P0 | â¬œ |
| `RechargeRecordRepository` | create, updateStatus, findByWorkspace | P0 | â¬œ |
| `PlatformServiceRepository` | findActive, calculatePrice | P0 | â¬œ |
| `PlatformRagServiceRepository` | findByDomain, findActive | P1 | â¬œ |

#### 2.3 é˜¶æ®µè¿›åº¦

- **å·²å®Œæˆï¼š** 80%
- **å¾…å®Œæˆï¼š** 20%ï¼ˆæ–° Entity å’Œ Repositoryï¼‰
- **é¢„è®¡å®Œæˆæ—¶é—´ï¼š** ç»§ç»­æ‰§è¡Œå³å¯å®Œæˆ

---

### â¬œ é˜¶æ®µ 3ï¼šService å±‚å¼€å‘ï¼ˆå¾…å¼€å§‹ï¼‰

**é¢„è®¡å¼€å§‹æ—¶é—´ï¼š** å®Œæˆé˜¶æ®µ 2 å
**é¢„è®¡å·¥æœŸï¼š** 10 å¤©
**çŠ¶æ€ï¼š** â¬œ å¾…å¼€å§‹

**å¾…åˆ›å»ºçš„ Serviceï¼š**
- WorkspaceContextService
- BillingService
- PlatformServiceService
- PlatformRagService
- PlatformFeatureService
- å¢å¼º ProjectService

---

### â¬œ é˜¶æ®µ 4-7ï¼ˆå¾…å¼€å§‹ï¼‰

åç»­é˜¶æ®µå°†åœ¨å®Œæˆå‰åºé˜¶æ®µåæ›´æ–°è¿›åº¦ã€‚

---

## åä¸€ã€å…³é”®é‡Œç¨‹ç¢‘è¾¾æˆæƒ…å†µ

| é‡Œç¨‹ç¢‘ | è®¡åˆ’å®Œæˆ | å®é™…å®Œæˆ | çŠ¶æ€ | åå·® |
|--------|---------|---------|------|------|
| **M0: å‡†å¤‡** | Week 0 | 2025-01-07 | âœ… è¾¾æˆ | æ—  |
| **M1: æ•°æ®åº“** | Week 1 | 2025-01-07 | âœ… è¾¾æˆ | æå‰ |
| **M2: Entity+Repository** | Week 2 | è¿›è¡Œä¸­ | ğŸŸ¡ 80% | ç¬¦åˆé¢„æœŸ |
| **M3: Service** | Week 4 | - | â¬œ å¾…å¼€å§‹ | - |
| **M4: Controller** | Week 6 | - | â¬œ å¾…å¼€å§‹ | - |
| **M5: å‰ç«¯** | Week 9 | - | â¬œ å¾…å¼€å§‹ | - |
| **M6: æ”¯ä»˜** | Week 10 | - | â¬œ å¾…å¼€å§‹ | - |
| **M7: ä¸Šçº¿** | Week 12 | - | â¬œ å¾…å¼€å§‹ | - |

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.1ï¼ˆå®æ–½è¿›åº¦ç‰ˆï¼‰
**æœ€åæ›´æ–°ï¼š** 2025-01-07
**ä¼˜åŒ–ä¾æ®ï¼š** é¡¹ç›®å®é™…ä»£ç åˆ†æ
**é¢„è®¡èŠ‚çœæ—¶é—´ï¼š** 3-4 å‘¨
**æ–‡æ¡£çŠ¶æ€ï¼š** âœ… å¯ç›´æ¥ç”¨äºå¼€å‘å®æ–½
**å½“å‰è¿›åº¦ï¼š** 30% å®Œæˆï¼ˆé˜¶æ®µ 0-2 éƒ¨åˆ†å®Œæˆï¼‰
