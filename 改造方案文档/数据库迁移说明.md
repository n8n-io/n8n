# 数据库迁移说明 - MultitenantTransformation

> **迁移版本：** 1762511301780-MultitenantTransformation
> **创建日期：** 2025-01-07
> **迁移类型：** 可逆（Reversible）

## 📋 迁移概述

这是 n8n 多租户改造的核心数据库迁移脚本，将现有的 Project-based 共享模型转换为真正的多租户架构。

### 改造目标

**改造前（当前架构）：**
```
Workflow/Credentials → SharedWorkflow/SharedCredentials → Project
                       (多对多关系表)
```

**改造后（目标架构）：**
```
Workflow/Credentials → Project
(直接外键关联，一对多)
```

### 核心变化

1. **删除中间表**：移除 `shared_workflow` 和 `shared_credentials` 表
2. **直接关联**：在 `workflow_entity` 和 `credentials_entity` 表中添加 `projectId` 列
3. **简化权限**：权限管理移至 Project 层面，不再在资源层面管理

---

## 🔧 迁移步骤详解

### Up Migration（正向迁移）

#### 步骤 1：迁移 Workflow 所有权

1. 在 `workflow_entity` 表添加 `projectId` 列（VARCHAR(36)，初始可空）
2. 从 `shared_workflow` 表迁移数据，选择 `role='workflow:owner'` 的记录
3. 验证数据完整性：确保所有 workflow 都有 owner
4. 将 `projectId` 设置为 NOT NULL
5. 添加外键约束：`workflow_entity.projectId → project.id (CASCADE DELETE)`
6. 创建索引：
   - `idx_workflow_project_id`（单列索引）
   - `idx_workflow_project_active`（复合索引，用于活跃工作流查询）

#### 步骤 2：迁移 Credentials 所有权

1. 在 `credentials_entity` 表添加 `projectId` 列（VARCHAR(36)，初始可空）
2. 从 `shared_credentials` 表迁移数据，选择 `role='credential:owner'` 的记录
3. 验证数据完整性：确保所有 credentials 都有 owner
4. 将 `projectId` 设置为 NOT NULL
5. 添加外键约束：`credentials_entity.projectId → project.id (CASCADE DELETE)`
6. 创建索引：`idx_credentials_project_id`

#### 步骤 3：删除旧表

1. 删除 `shared_workflow` 表
2. 删除 `shared_credentials` 表

### Down Migration（回滚）

如果需要回滚，迁移会：

1. 重新创建 `shared_workflow` 表
2. 将 `workflow_entity.projectId` 的数据迁移回 `shared_workflow`，role 设置为 `'workflow:owner'`
3. 删除 `workflow_entity` 表的外键、索引和 `projectId` 列
4. 重新创建 `shared_credentials` 表
5. 将 `credentials_entity.projectId` 的数据迁移回 `shared_credentials`，role 设置为 `'credential:owner'`
6. 删除 `credentials_entity` 表的外键、索引和 `projectId` 列

---

## ⚠️ 迁移前置条件

### 数据完整性检查

在执行迁移前，必须确保：

1. **所有 Workflow 都有 Owner**
   ```sql
   -- 检查孤儿 workflow
   SELECT COUNT(*) FROM workflow_entity W
   WHERE NOT EXISTS (
     SELECT 1 FROM shared_workflow SW
     WHERE SW.workflowId = W.id
     AND SW.role = 'workflow:owner'
   );
   -- 结果应该为 0
   ```

2. **所有 Credentials 都有 Owner**
   ```sql
   -- 检查孤儿 credentials
   SELECT COUNT(*) FROM credentials_entity C
   WHERE NOT EXISTS (
     SELECT 1 FROM shared_credentials SC
     WHERE SC.credentialsId = C.id
     AND SC.role = 'credential:owner'
   );
   -- 结果应该为 0
   ```

3. **所有 Project 都存在且有效**
   ```sql
   -- 检查 shared_workflow 中引用的 project 是否都存在
   SELECT COUNT(*) FROM shared_workflow SW
   WHERE NOT EXISTS (
     SELECT 1 FROM project P
     WHERE P.id = SW.projectId
   );
   -- 结果应该为 0
   ```

### 环境要求

- **数据库类型**：支持 MySQL/MariaDB、PostgreSQL、SQLite
- **n8n 版本**：基于 2025-01-07 的 master 分支
- **停机时间**：建议在低峰时段执行，预计停机 5-30 分钟（取决于数据量）

---

## 🚀 执行迁移

### 自动执行（推荐）

n8n 启动时会自动检测并执行待执行的迁移：

```bash
# 启动 n8n，会自动运行迁移
pnpm start
```

### 手动执行（测试环境）

```bash
# 1. 构建项目
pnpm build

# 2. 运行迁移
cd packages/cli
pnpm typeorm migration:run

# 3. 查看迁移状态
pnpm typeorm migration:show
```

### 回滚迁移（紧急情况）

```bash
# 回滚最后一次迁移
cd packages/cli
pnpm typeorm migration:revert
```

---

## 📊 迁移影响分析

### 性能影响

**正面影响：**
- ✅ 查询性能提升：减少一次 JOIN 操作
- ✅ 索引优化：新增的索引提升查询效率
- ✅ 减少存储：删除两张中间表

**可能的短期影响：**
- ⚠️ 迁移过程中数据库锁定
- ⚠️ 大数据量情况下迁移时间较长

### 数据量估算

| 表名 | 预估记录数 | 迁移时间（估算） |
|-----|----------|---------------|
| workflow_entity | < 1000 | < 1 分钟 |
| workflow_entity | 1000-10000 | 1-5 分钟 |
| workflow_entity | > 10000 | 5-30 分钟 |

### 应用层影响

**需要修改的代码模块：**

1. **WorkflowRepository**
   - 移除 `shared_workflow` 的 JOIN 查询
   - 直接通过 `projectId` 过滤

2. **CredentialsRepository**
   - 移除 `shared_credentials` 的 JOIN 查询
   - 直接通过 `projectId` 过滤

3. **权限检查逻辑**
   - 从资源级权限改为 Project 级权限
   - 简化 ACL 逻辑

4. **API 端点**
   - `/workflows` - 根据当前 Project 过滤
   - `/credentials` - 根据当前 Project 过滤

---

## 🔍 迁移验证

### 数据完整性验证

迁移完成后，执行以下 SQL 验证：

```sql
-- 1. 验证所有 workflow 都有 projectId
SELECT COUNT(*) FROM workflow_entity WHERE projectId IS NULL;
-- 期望结果：0

-- 2. 验证所有 credentials 都有 projectId
SELECT COUNT(*) FROM credentials_entity WHERE projectId IS NULL;
-- 期望结果：0

-- 3. 验证 workflow 的 projectId 都指向有效的 project
SELECT COUNT(*) FROM workflow_entity W
WHERE NOT EXISTS (
  SELECT 1 FROM project P WHERE P.id = W.projectId
);
-- 期望结果：0

-- 4. 验证 credentials 的 projectId 都指向有效的 project
SELECT COUNT(*) FROM credentials_entity C
WHERE NOT EXISTS (
  SELECT 1 FROM project P WHERE P.id = C.projectId
);
-- 期望结果：0

-- 5. 确认 shared_workflow 和 shared_credentials 表已删除
SELECT COUNT(*) FROM information_schema.tables
WHERE table_name IN ('shared_workflow', 'shared_credentials');
-- 期望结果：0
```

### 功能验证清单

- [ ] 可以正常创建 Workflow
- [ ] 可以正常编辑 Workflow
- [ ] 可以正常删除 Workflow
- [ ] 可以正常创建 Credentials
- [ ] 可以正常编辑 Credentials
- [ ] 可以正常删除 Credentials
- [ ] 切换 Project 后，只能看到当前 Project 的资源
- [ ] 删除 Project 时，关联的 Workflow 和 Credentials 被级联删除
- [ ] 权限检查正常工作

---

## 🐛 故障排查

### 常见错误

#### 错误 1：发现孤儿 Workflow

```
Error: Found X workflows without an owner
```

**原因：** 数据库中存在没有 owner 的 workflow
**解决：**
```sql
-- 找出孤儿 workflow
SELECT W.id, W.name FROM workflow_entity W
WHERE NOT EXISTS (
  SELECT 1 FROM shared_workflow SW
  WHERE SW.workflowId = W.id
  AND SW.role = 'workflow:owner'
);

-- 为孤儿 workflow 指定 owner（需要根据实际情况调整）
INSERT INTO shared_workflow (workflowId, projectId, role)
VALUES ('workflow-id', 'project-id', 'workflow:owner');
```

#### 错误 2：外键约束冲突

```
Error: Foreign key constraint fails
```

**原因：** projectId 引用的 project 不存在
**解决：** 检查并修复数据一致性

```sql
-- 找出引用不存在的 project 的记录
SELECT SW.workflowId, SW.projectId
FROM shared_workflow SW
WHERE NOT EXISTS (
  SELECT 1 FROM project P WHERE P.id = SW.projectId
);
```

#### 错误 3：迁移超时

**原因：** 数据量过大
**解决：**
1. 在低峰时段执行
2. 增加数据库连接超时时间
3. 考虑分批迁移（需要修改迁移脚本）

---

## 📝 后续工作

迁移完成后，需要执行以下任务：

### 1. 代码适配（P0 - 必须）

- [ ] 修改 `WorkflowRepository` 移除 `shared_workflow` 依赖
- [ ] 修改 `CredentialsRepository` 移除 `shared_credentials` 依赖
- [ ] 更新权限检查逻辑（从 SharedWorkflow → WorkflowEntity.projectId）
- [ ] 更新 API 路由和控制器
- [ ] 更新前端查询逻辑

### 2. 测试（P0 - 必须）

- [ ] 单元测试：Repository 层
- [ ] 集成测试：API 端点
- [ ] E2E 测试：完整工作流
- [ ] 性能测试：大数据量场景

### 3. 文档更新（P1 - 重要）

- [ ] 更新 API 文档
- [ ] 更新架构设计文档
- [ ] 更新部署文档

### 4. 监控和日志（P2 - 建议）

- [ ] 添加迁移性能监控
- [ ] 添加迁移错误告警
- [ ] 记录迁移执行日志

---

## 📚 相关文档

- [架构底层改造方案](./01-架构底层改造方案.md)
- [实施计划与里程碑](./06-实施计划与里程碑.md)
- [CreateProject 迁移源码](../packages/@n8n/db/src/migrations/common/1714133768519-CreateProject.ts)

---

## 🔐 安全建议

1. **备份数据库**：迁移前务必完整备份
2. **测试环境验证**：先在测试环境完整测试
3. **回滚计划**：准备好快速回滚方案
4. **监控告警**：迁移过程中密切监控
5. **版本控制**：确保代码和数据库版本一致

---

## 👥 联系方式

如有问题，请联系：

- **开发团队**：[团队联系方式]
- **DBA**：[DBA 联系方式]
- **紧急联系人**：[紧急联系人]

---

**最后更新：** 2025-01-07
**负责人：** [负责人名称]
**状态：** ✅ 迁移脚本已创建，待测试验证
