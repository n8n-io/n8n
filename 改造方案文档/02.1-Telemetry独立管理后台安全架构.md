# Telemetry ç‹¬ç«‹ç®¡ç†åå° - å®‰å…¨æ¶æ„æ–¹æ¡ˆ

> **ç‰ˆæœ¬ï¼š** v1.0
> **æ—¥æœŸï¼š** 2025-11-04
> **ç›®æ ‡ï¼š** é˜²æ­¢æ™®é€šç”¨æˆ·é€šè¿‡ URL è®¿é—®åå°ç®¡ç†ç³»ç»Ÿ

---

## ğŸ¯ å®‰å…¨ç›®æ ‡

1. **åªæœ‰ç®¡ç†å‘˜è§’è‰²å¯ä»¥è®¿é—®åå°**
2. **æ™®é€šç”¨æˆ·æ— æ³•é€šè¿‡ä¿®æ”¹ URL è®¿é—®**
3. **å‰ç«¯å’Œåç«¯åŒé‡éªŒè¯**
4. **æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼**

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ–¹æ¡ˆ Aï¼šåŒåŸŸåä¸åŒè·¯å¾„ï¼ˆæ¨èï¼‰

```
æ¶æ„å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åŒä¸€ä¸ªåŸŸå                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  https://yourdomain.com/                                â”‚
â”‚  â”œâ”€â”€ /                       (n8n ä¸»åº”ç”¨)                â”‚
â”‚  â”œâ”€â”€ /workflow/              (å·¥ä½œæµé¡µé¢)                â”‚
â”‚  â”œâ”€â”€ /settings/              (ç”¨æˆ·è®¾ç½®)                  â”‚
â”‚  â””â”€â”€ /admin/telemetry/       (åå°ç®¡ç†ï¼Œä»…ç®¡ç†å‘˜)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¿é—®æ§åˆ¶:
1. å‰ç«¯è·¯ç”±å®ˆå« (router.beforeEach)
2. åç«¯ API æƒé™éªŒè¯ (@GlobalScope('admin'))
3. å¦‚æœéç®¡ç†å‘˜è®¿é—® /admin/* â†’ é‡å®šå‘åˆ° 403 é¡µé¢
```

### æ–¹æ¡ˆ Bï¼šç‹¬ç«‹å­åŸŸåï¼ˆæ›´å®‰å…¨ï¼‰

```
æ¶æ„å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  https://app.yourdomain.com          (n8n ä¸»åº”ç”¨)        â”‚
â”‚  - æ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜éƒ½å¯ä»¥è®¿é—®                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  https://telemetry.yourdomain.com    (åå°ç®¡ç†)          â”‚
â”‚  - ä»…ç®¡ç†å‘˜å¯ä»¥è®¿é—®                                       â”‚
â”‚  - ç‹¬ç«‹çš„å‰ç«¯åº”ç”¨                                         â”‚
â”‚  - ç‹¬ç«‹çš„æ„å»ºå’Œéƒ¨ç½²                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¿é—®æ§åˆ¶:
1. Nginx é…ç½®åªå…è®¸ç®¡ç†å‘˜ IP è®¿é—®
2. åç«¯ API æƒé™éªŒè¯
3. Cookie è·¨åŸŸå…±äº«ï¼ˆsame-siteï¼‰
```

### æ–¹æ¡ˆ Cï¼šç‹¬ç«‹ç«¯å£ï¼ˆå¼€å‘ç¯å¢ƒæ¨èï¼‰

```
æ¶æ„å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  http://localhost:5678                (n8n ä¸»åº”ç”¨)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  http://localhost:5679                (åå°ç®¡ç†)         â”‚
â”‚  - ä»…ç®¡ç†å‘˜å¯ä»¥è®¿é—®                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¿é—®æ§åˆ¶:
1. å‰ç«¯è·¯ç”±å®ˆå«
2. åç«¯ API æƒé™éªŒè¯
3. é˜²ç«å¢™é™åˆ¶ç«¯å£è®¿é—®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
```

---

## ğŸ”’ å®‰å…¨æ§åˆ¶å±‚çº§

### ç¬¬ä¸€å±‚ï¼šå‰ç«¯è·¯ç”±å®ˆå«

**ç›®çš„ï¼š** æ‹¦æˆªéç®¡ç†å‘˜ç”¨æˆ·çš„è®¿é—®ï¼Œæä¾›å‹å¥½çš„é”™è¯¯æç¤º

**å®ç°ä½ç½®ï¼š** `/packages/frontend/telemetry-admin/src/router/index.ts`

```typescript
router.beforeEach(async (to, from, next) => {
  const userStore = useUserStore();

  // 1. æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  if (!userStore.isLoggedIn) {
    // è·³è½¬åˆ° n8n ç™»å½•é¡µé¢
    window.location.href = '/signin?redirect=/admin/telemetry';
    return;
  }

  // 2. æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
  if (!userStore.isAdmin) {
    // éç®¡ç†å‘˜ï¼šæ˜¾ç¤º 403 é¡µé¢
    next({ name: 'Forbidden' });
    return;
  }

  next();
});
```

### ç¬¬äºŒå±‚ï¼šåç«¯ API æƒé™éªŒè¯

**ç›®çš„ï¼š** ç¡®ä¿å³ä½¿ç»•è¿‡å‰ç«¯ï¼Œåç«¯ API ä¹Ÿä¼šæ‹’ç»éç®¡ç†å‘˜è¯·æ±‚

**å®ç°æ–¹å¼ 1ï¼šä½¿ç”¨è£…é¥°å™¨ï¼ˆæ¨èï¼‰**

```typescript
// packages/cli/src/decorators/admin-only.decorator.ts
import { UnauthorizedError } from '@n8n/errors';

export function AdminOnly() {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;

    descriptor.value = async function (...args: any[]) {
      const req = args[0]; // AuthenticatedRequest

      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
      if (!req.user.isOwner && !req.user.globalScopes?.includes('admin')) {
        throw new UnauthorizedError('Admin access required');
      }

      return originalMethod.apply(this, args);
    };

    return descriptor;
  };
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
@RestController('/telemetry')
export class TelemetryManagementController {

  // åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
  @Get('/events')
  @AdminOnly()
  async getEvents(req: AuthenticatedRequest, @Query query: EventsQuery) {
    // ...
  }

  @Get('/stats/overview')
  @AdminOnly()
  async getOverview(req: AuthenticatedRequest, @Query query: OverviewQuery) {
    // ...
  }
}
```

**å®ç°æ–¹å¼ 2ï¼šä½¿ç”¨ä¸­é—´ä»¶**

```typescript
// packages/cli/src/middlewares/admin-only.middleware.ts
import type { RequestHandler } from 'express';
import { UnauthorizedError } from '@n8n/errors';

export const adminOnly: RequestHandler = (req, res, next) => {
  const user = (req as any).user;

  if (!user) {
    throw new UnauthorizedError('Authentication required');
  }

  // æ£€æŸ¥æ˜¯å¦æ˜¯ Owner æˆ–æœ‰ admin æƒé™
  if (!user.isOwner && !user.globalScopes?.includes('admin')) {
    throw new UnauthorizedError('Admin access required');
  }

  next();
};
```

**åœ¨è·¯ç”±ä¸­ä½¿ç”¨ï¼š**

```typescript
// packages/cli/src/server.ts
app.use('/api/telemetry', adminOnly, telemetryRouter);
```

### ç¬¬ä¸‰å±‚ï¼šæ•°æ®åº“è§’è‰²éªŒè¯

**ç›®çš„ï¼š** ä»æ•°æ®åº“å±‚é¢ç¡®ä¿ç”¨æˆ·è§’è‰²

**n8n ç°æœ‰è§’è‰²ç³»ç»Ÿï¼š**

```typescript
// User entity
interface User {
  id: string;
  email: string;
  role: 'global:owner' | 'global:admin' | 'global:member';
  globalScopes?: string[];
}
```

**æƒé™åˆ¤æ–­é€»è¾‘ï¼š**

```typescript
export function isAdmin(user: User): boolean {
  return (
    user.role === 'global:owner' ||
    user.role === 'global:admin' ||
    user.globalScopes?.includes('admin')
  );
}
```

---

## ğŸš€ æ¨èå®æ–½æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆ A + å¤šå±‚éªŒè¯ï¼‰

### æ¶æ„è®¾è®¡

```
URL ç»“æ„:
https://yourdomain.com/admin/telemetry/

å‰ç«¯åº”ç”¨:
/packages/frontend/telemetry-admin/
â”œâ”€â”€ ç‹¬ç«‹çš„ Vue åº”ç”¨
â”œâ”€â”€ ç‹¬ç«‹çš„æ„å»ºé…ç½®
â””â”€â”€ æ„å»ºäº§ç‰©è¾“å‡ºåˆ° /public/admin/telemetry/

åç«¯ API:
/api/telemetry/* (å·²æœ‰)
â”œâ”€â”€ æ·»åŠ  @AdminOnly() è£…é¥°å™¨
â””â”€â”€ æ‰€æœ‰ç«¯ç‚¹éƒ½éœ€è¦ç®¡ç†å‘˜æƒé™

è®¿é—®æµç¨‹:
1. ç”¨æˆ·è®¿é—® /admin/telemetry
2. å‰ç«¯æ£€æŸ¥ç™»å½•çŠ¶æ€ â†’ æœªç™»å½•è·³è½¬åˆ° /signin
3. å‰ç«¯æ£€æŸ¥ç®¡ç†å‘˜è§’è‰² â†’ éç®¡ç†å‘˜æ˜¾ç¤º 403
4. å‰ç«¯è°ƒç”¨ API â†’ åç«¯å†æ¬¡éªŒè¯ç®¡ç†å‘˜è§’è‰²
5. API è¿”å›æ•°æ® â†’ å‰ç«¯å±•ç¤º
```

### å®‰å…¨ç‰¹æ€§

âœ… **å‰ç«¯æ‹¦æˆª**ï¼šéç®¡ç†å‘˜æ— æ³•çœ‹åˆ°é¡µé¢å†…å®¹
âœ… **åç«¯éªŒè¯**ï¼šå³ä½¿ç»•è¿‡å‰ç«¯ï¼ŒAPI ä¹Ÿä¼šæ‹’ç»è¯·æ±‚
âœ… **è§’è‰²æ£€æŸ¥**ï¼šåŸºäº n8n ç°æœ‰çš„è§’è‰²ç³»ç»Ÿ
âœ… **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰åå°è®¿é—®è¡Œä¸º
âœ… **å‹å¥½æç¤º**ï¼šæ˜¾ç¤º 403 é¡µé¢è€Œä¸æ˜¯ç›´æ¥æŠ¥é”™

---

## ğŸ“ å®æ–½æ­¥éª¤

### Phase 1: åç«¯æƒé™æ§åˆ¶ï¼ˆ1-2 å¤©ï¼‰

#### 1.1 åˆ›å»ºç®¡ç†å‘˜éªŒè¯è£…é¥°å™¨

```bash
packages/cli/src/decorators/admin-only.decorator.ts
```

#### 1.2 ä¿®æ”¹ Telemetry Controller

```typescript
// ç»™æ‰€æœ‰æŸ¥è¯¢ç«¯ç‚¹æ·»åŠ  @AdminOnly()
@Get('/events')
@AdminOnly()
async getEvents() { ... }
```

#### 1.3 åˆ›å»ºå®¡è®¡æ—¥å¿—

```typescript
// è®°å½•åå°è®¿é—®è¡Œä¸º
@Post('/events')
async trackEvent(req: AuthenticatedRequest) {
  await auditLogService.log({
    action: 'telemetry.access',
    userId: req.user.id,
    resource: 'telemetry_admin',
    timestamp: new Date(),
  });
}
```

### Phase 2: ç‹¬ç«‹å‰ç«¯åº”ç”¨ï¼ˆ2-3 å¤©ï¼‰

#### 2.1 åˆ›å»ºé¡¹ç›®ç»“æ„

```bash
mkdir -p packages/frontend/telemetry-admin/src
```

#### 2.2 é…ç½®è·¯ç”±å®ˆå«

```typescript
// router/index.ts
router.beforeEach(async (to, from, next) => {
  // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
});
```

#### 2.3 åˆ›å»º 403 é¡µé¢

```vue
<!-- views/Forbidden.vue -->
<template>
  <div class="forbidden">
    <h1>403 - è®¿é—®è¢«æ‹’ç»</h1>
    <p>æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢</p>
    <p>åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—® Telemetry ç®¡ç†åå°</p>
  </div>
</template>
```

### Phase 3: é›†æˆå’Œéƒ¨ç½²ï¼ˆ1 å¤©ï¼‰

#### 3.1 Nginx é…ç½®ï¼ˆå¯é€‰ï¼Œé¢å¤–å®‰å…¨å±‚ï¼‰

```nginx
# åªå…è®¸ç®¡ç†å‘˜ IP è®¿é—®åå°
location /admin/telemetry {
  # IP ç™½åå•ï¼ˆå¯é€‰ï¼‰
  # allow 192.168.1.100;
  # deny all;

  # ä»£ç†åˆ°å‰ç«¯åº”ç”¨
  try_files $uri $uri/ /admin/telemetry/index.html;
}
```

#### 3.2 æ„å»ºé…ç½®

```typescript
// vite.config.ts
export default defineConfig({
  base: '/admin/telemetry/',
  build: {
    outDir: '../../cli/dist/public/admin/telemetry',
  },
});
```

---

## ğŸ” é¢å¤–å®‰å…¨å»ºè®®

### 1. åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰

```typescript
// è®¿é—®åå°å‰è¦æ±‚ 2FA
if (user.isAdmin && !req.session.verified2FA) {
  return res.redirect('/admin/verify-2fa');
}
```

### 2. IP ç™½åå•

```typescript
// é…ç½®æ–‡ä»¶
{
  "telemetry": {
    "adminIpWhitelist": ["192.168.1.100", "10.0.0.0/8"]
  }
}

// ä¸­é—´ä»¶
if (!isIpAllowed(req.ip, config.telemetry.adminIpWhitelist)) {
  throw new ForbiddenError('IP not allowed');
}
```

### 3. è®¿é—®æ—¥å¿—å’Œå‘Šè­¦

```typescript
// è®°å½•æ‰€æœ‰åå°è®¿é—®
logger.info('Telemetry admin access', {
  userId: user.id,
  ip: req.ip,
  userAgent: req.headers['user-agent'],
  endpoint: req.path,
});

// å¼‚å¸¸è®¿é—®å‘Šè­¦
if (!user.isAdmin && req.path.startsWith('/admin/telemetry')) {
  await alertService.send({
    type: 'security',
    message: `Unauthorized telemetry admin access attempt by ${user.email}`,
  });
}
```

### 4. Session è¶…æ—¶

```typescript
// åå°ç®¡ç† session è®¾ç½®æ›´çŸ­çš„è¶…æ—¶æ—¶é—´
app.use('/admin/telemetry', session({
  cookie: {
    maxAge: 30 * 60 * 1000, // 30 åˆ†é’Ÿ
    secure: true,
    httpOnly: true,
    sameSite: 'strict',
  },
}));
```

---

## ğŸ“Š å®‰å…¨å¯¹æ¯”è¡¨

| å®‰å…¨æªæ–½ | æ–¹æ¡ˆ Aï¼ˆåŒåŸŸåï¼‰ | æ–¹æ¡ˆ Bï¼ˆå­åŸŸåï¼‰ | æ–¹æ¡ˆ Cï¼ˆç‹¬ç«‹ç«¯å£ï¼‰ |
|---------|----------------|-----------------|-------------------|
| **å‰ç«¯è·¯ç”±å®ˆå«** | âœ… | âœ… | âœ… |
| **åç«¯æƒé™éªŒè¯** | âœ… | âœ… | âœ… |
| **URL éš”ç¦»** | âš ï¸ å¼± | âœ… å¼º | âœ… å¼º |
| **IP ç™½åå•** | âœ… | âœ… | âœ… |
| **Cookie éš”ç¦»** | âŒ | âœ… | âœ… |
| **éƒ¨ç½²å¤æ‚åº¦** | ğŸŸ¢ ç®€å• | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¡ ä¸­ç­‰ |
| **å¼€å‘ä¾¿åˆ©æ€§** | ğŸŸ¢ é«˜ | ğŸŸ¡ ä¸­ | ğŸŸ¢ é«˜ |
| **ç”Ÿäº§ç¯å¢ƒæ¨è** | âœ… | âœ…âœ…âœ… | âŒ |

---

## âœ… æœ€ç»ˆæ¨è

### å¼€å‘ç¯å¢ƒï¼š**æ–¹æ¡ˆ Aï¼ˆåŒåŸŸåï¼‰**

- ç®€å•æ˜“ç”¨
- å¿«é€Ÿå¼€å‘
- å‰åç«¯åŒé‡éªŒè¯å·²è¶³å¤Ÿ

### ç”Ÿäº§ç¯å¢ƒï¼š**æ–¹æ¡ˆ Bï¼ˆå­åŸŸåï¼‰+ IP ç™½åå•**

- æœ€é«˜å®‰å…¨æ€§
- ç‰©ç†éš”ç¦»
- å¯ç‹¬ç«‹æ‰©å±•

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2025-11-04
