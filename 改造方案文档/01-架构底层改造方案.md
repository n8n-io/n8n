# n8n å¤šç§Ÿæˆ· SaaS æ¶æ„åº•å±‚æ”¹é€ æ–¹æ¡ˆ

> **ç‰ˆæœ¬ï¼š** v1.0
> **æ—¥æœŸï¼š** 2025-11-03
> **åŸºäºåˆ†æ”¯ï¼š** 20251102
> **æ”¹é€ ç›®æ ‡ï¼š** å®ç° Coze é£æ ¼çš„å·¥ä½œç©ºé—´æ¶æ„ï¼Œæ”¯æŒä¸ªäºº + å›¢é˜Ÿå®¢æˆ·

---

## ğŸ“‹ ä¸€ã€æ”¹é€ èŒƒå›´ä¸ç›®æ ‡

### 1.1 æœ¬æ¬¡å®ç°ï¼ˆPhase 1ï¼‰

| åŠŸèƒ½æ¨¡å— | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|--------|
| å·¥ä½œç©ºé—´åˆ‡æ¢ | ä¸ªäººç©ºé—´/å›¢é˜Ÿç©ºé—´ä¸€é”®åˆ‡æ¢ï¼Œæ•°æ®è‡ªåŠ¨è¿‡æ»¤ | P0 |
| å›¢é˜Ÿåä½œ | åˆ›å»ºå›¢é˜Ÿã€é‚€è¯·æˆå‘˜ã€è§’è‰²ç®¡ç† | P0 |
| æƒé™ç®¡ç† | ä¸‰çº§æƒé™ï¼ˆAdmin/Editor/Viewerï¼‰ | P0 |
| æ•°æ®éš”ç¦» | å·¥ä½œç©ºé—´çº§åˆ«çš„èµ„æºéš”ç¦» | P0 |

### 1.2 é¢„ç•™ä½†ä¸å®ç°ï¼ˆPhase 2ï¼‰

| åŠŸèƒ½æ¨¡å— | è¯´æ˜ | å¤‡æ³¨ |
|---------|------|------|
| è®¡è´¹ç³»ç»Ÿ | ä½™é¢ç®¡ç†ã€æ¶ˆè´¹è®°å½•ã€å……å€¼ | ç­‰å·¥ä½œæµè¿è¡Œæ¨¡å¼æ”¹é€ å®Œæˆåå†è§„åˆ’ |
| é…é¢é™åˆ¶ | æ‰§è¡Œæ¬¡æ•°ã€å­˜å‚¨ç©ºé—´é™åˆ¶ | ä¾èµ–è®¡è´¹ç³»ç»Ÿ |
| è®¢é˜…ç®¡ç† | è®¢é˜…è®¡åˆ’ã€è‡ªåŠ¨ç»­è´¹ | ä¾èµ–è®¡è´¹ç³»ç»Ÿ |

### 1.3 ç›®æ ‡å®¢æˆ·

- **ä¸ªäººç”¨æˆ·**ï¼šå…è´¹/ä»˜è´¹è®¢é˜…
- **å›¢é˜Ÿç”¨æˆ·**ï¼šæŒ‰æˆå‘˜æ•°è®¢é˜… + æŒ‰é‡è®¡è´¹

---

## ğŸ“ äºŒã€æ¶æ„æ ¸å¿ƒè®¾è®¡

### 2.1 å…³é”®å†³ç­–æ€»è§ˆ

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ | ç†ç”± |
|--------|------|------|
| é¡¶çº§éš”ç¦»å•ä½ | Project = Workspace | å¯¹æ ‡ Cozeï¼Œæ¦‚å¿µæ¸…æ™° |
| èµ„æºå½’å± | Workflow/Credentials ç›´æ¥å±äº Project | ç®€åŒ–æŸ¥è¯¢é“¾è·¯ |
| Team å®ä½“ | ä¸å¼•å…¥ç‹¬ç«‹çš„ Team è¡¨ | Project çš„ type å­—æ®µè¶³å¤Ÿè¡¨è¾¾ |
| SharedWorkflow | å®Œå…¨åˆ é™¤ | å‡å°‘æŸ¥è¯¢å±‚çº§ï¼Œæå‡æ€§èƒ½ |
| æƒé™æ¨¡å‹ | åŸºäº ProjectRelation çš„ RBAC | ç»Ÿä¸€æƒé™ç®¡ç† |

### 2.2 æ¶æ„å¯¹æ¯”

#### æ”¹é€ å‰ï¼ˆå½“å‰æ¶æ„ï¼‰

```
User
  â””â”€ Workflowï¼ˆæ··åœ¨ä¸€èµ·ï¼Œæ²¡æœ‰æ˜ç¡®çš„ç©ºé—´æ¦‚å¿µï¼‰

æˆ–

User â†’ ProjectRelation â†’ Project â†’ SharedWorkflow â†’ Workflow
      ï¼ˆ4 å±‚ JOINï¼ŒæŸ¥è¯¢å¤æ‚ï¼‰
```

#### æ”¹é€ åï¼ˆCoze é£æ ¼ï¼‰

```
User â†’ ProjectRelation â†’ Project (Workspace) â†’ Workflow
                                             â†’ Credentials
                                             â†’ Executions
      ï¼ˆ3 å±‚ JOINï¼ŒæŸ¥è¯¢ç®€åŒ–ï¼‰

Project:
  â”œâ”€ type: 'personal' | 'team'  â† åŒºåˆ†ä¸ªäºº/å›¢é˜Ÿç©ºé—´
  â”œâ”€ settings: { maxMembers, billingMode }
  â””â”€ projectRelations: [{ user, role }]
```

### 2.3 Coze æ¶æ„å¯¹æ ‡

| Coze | n8n æ”¹é€ å | çŠ¶æ€ |
|------|-----------|------|
| Workspace | Project | âœ… |
| Personal Workspace | `Project { type: 'personal' }` | âœ… |
| Team Workspace | `Project { type: 'team' }` | âœ… |
| Workspace Members | ProjectRelation | âœ… |
| Bot | Workflow | âœ… |
| Knowledge Base | Credentials | âœ… |
| Workspace Switching | å·¦ä¸Šè§’ä¸‹æ‹‰åˆ‡æ¢ | âœ… |
| Billing | é¢„ç•™å­—æ®µ | â¸ï¸ Phase 2 |

---

## ğŸ—„ï¸ ä¸‰ã€æ•°æ®åº“å±‚æ”¹é€ 

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„å˜æ›´

#### 3.1.1 æ‰©å±• `project` è¡¨

**æ–°å¢å­—æ®µï¼š**

```sql
ALTER TABLE "project"
  ADD COLUMN slug VARCHAR(100) UNIQUE,           -- URL å‹å¥½æ ‡è¯†
  ADD COLUMN description TEXT,                   -- å·¥ä½œç©ºé—´æè¿°
  ADD COLUMN settings JSONB DEFAULT '{}',        -- å›¢é˜Ÿé…ç½®
  ADD COLUMN is_default BOOLEAN DEFAULT false,   -- æ˜¯å¦é»˜è®¤å·¥ä½œç©ºé—´
  ADD COLUMN status VARCHAR(50) DEFAULT 'active'; -- 'active' | 'archived'

-- æ·»åŠ çº¦æŸ
ALTER TABLE "project"
  ADD CONSTRAINT chk_project_status
    CHECK (status IN ('active', 'archived'));

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_project_type ON project(type);
CREATE INDEX idx_project_status ON project(status);
CREATE INDEX idx_project_slug ON project(slug) WHERE slug IS NOT NULL;
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `type` | VARCHAR | 'personal' \| 'team' | åŒºåˆ†ä¸ªäºº/å›¢é˜Ÿç©ºé—´ |
| `slug` | VARCHAR | URL å‹å¥½æ ‡è¯† | 'my-workspace' |
| `description` | TEXT | å·¥ä½œç©ºé—´æè¿° | 'å…¬å¸è¿è¥å›¢é˜Ÿ' |
| `is_default` | BOOLEAN | æ˜¯å¦é»˜è®¤ç©ºé—´ | trueï¼ˆæ³¨å†Œæ—¶åˆ›å»ºçš„ä¸ªäººç©ºé—´ï¼‰ |
| `status` | VARCHAR | çŠ¶æ€ | 'active'ï¼ˆæ´»è·ƒï¼‰/ 'archived'ï¼ˆå½’æ¡£ï¼‰ |
| `settings` | JSONB | å›¢é˜Ÿé…ç½® | `{ "maxMembers": 10, "billingMode": "owner_pays" }` |

**settings å­—æ®µç»“æ„ï¼š**

```typescript
interface ProjectSettings {
  maxMembers?: number;        // æœ€å¤§æˆå‘˜æ•°ï¼ˆä»…å›¢é˜Ÿç©ºé—´ï¼‰
  billingMode?: 'owner_pays' | 'member_pays';  // è®¡è´¹æ¨¡å¼ï¼ˆé¢„ç•™ï¼‰
}
```

#### 3.1.2 æ‰©å±• `project_relation` è¡¨

**æ–°å¢å­—æ®µï¼š**

```sql
ALTER TABLE "project_relation"
  ADD COLUMN joined_at TIMESTAMP DEFAULT NOW(),  -- åŠ å…¥æ—¶é—´
  ADD COLUMN invited_by UUID REFERENCES "user"(id); -- é‚€è¯·äºº
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `joined_at` | TIMESTAMP | æˆå‘˜åŠ å…¥æ—¶é—´ |
| `invited_by` | UUID | é‚€è¯·äºº IDï¼ˆç”¨äºå®¡è®¡ï¼‰ |

#### 3.1.3 ç¡®ä¿èµ„æºè¡¨æœ‰ `project_id`

**workflow_entity è¡¨ï¼š**

```sql
-- æ£€æŸ¥å¹¶æ·»åŠ  project_id
ALTER TABLE "workflow_entity"
  ADD COLUMN IF NOT EXISTS project_id UUID NOT NULL
    REFERENCES project(id) ON DELETE CASCADE;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_workflow_project
  ON workflow_entity(project_id);
CREATE INDEX IF NOT EXISTS idx_workflow_project_active
  ON workflow_entity(project_id, active);
```

**credentials_entity è¡¨ï¼š**

```sql
-- æ£€æŸ¥å¹¶æ·»åŠ  project_id
ALTER TABLE "credentials_entity"
  ADD COLUMN IF NOT EXISTS project_id UUID NOT NULL
    REFERENCES project(id) ON DELETE CASCADE;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_credentials_project
  ON credentials_entity(project_id);
```

#### 3.1.4 æ‰©å±• `execution_entity` è¡¨ï¼ˆè®¡è´¹é¢„ç•™ï¼‰

```sql
ALTER TABLE "execution_entity"
  ADD COLUMN IF NOT EXISTS workflow_id VARCHAR(255)
    REFERENCES workflow_entity(id),
  ADD COLUMN IF NOT EXISTS billing_user_id UUID
    REFERENCES "user"(id),  -- å®é™…ä»˜è´¹ç”¨æˆ·
  ADD COLUMN IF NOT EXISTS cost DECIMAL(10,4) DEFAULT 0.00; -- æ‰§è¡Œæˆæœ¬

CREATE INDEX IF NOT EXISTS idx_execution_workflow
  ON execution_entity(workflow_id);
CREATE INDEX IF NOT EXISTS idx_execution_billing_user
  ON execution_entity(billing_user_id, finished_at);
```

#### 3.1.5 æ‰©å±• `user` è¡¨

```sql
ALTER TABLE "user"
  ADD COLUMN IF NOT EXISTS tier VARCHAR(50) DEFAULT 'free',
  ADD COLUMN IF NOT EXISTS max_projects INT DEFAULT 10,
  ADD COLUMN IF NOT EXISTS settings JSONB DEFAULT '{}';

ALTER TABLE "user"
  ADD CONSTRAINT IF NOT EXISTS chk_user_tier
    CHECK (tier IN ('free', 'pro', 'enterprise'));

CREATE INDEX IF NOT EXISTS idx_user_tier ON "user"(tier);
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `tier` | VARCHAR | ç”¨æˆ·ç­‰çº§ | 'free' \| 'pro' \| 'enterprise' |
| `max_projects` | INT | æœ€å¤§å·¥ä½œç©ºé—´æ•° | 10 |
| `settings` | JSONB | ç”¨æˆ·åå¥½è®¾ç½® | `{}` |

### 3.2 SharedWorkflow/SharedCredentials å†³ç­–

**åˆ é™¤ SharedWorkflow å’Œ SharedCredentials è¡¨**

**ç†ç”±ï¼š**
- âœ… æ¶æ„æœ€ç®€å•
- âœ… æŸ¥è¯¢æ€§èƒ½æœ€å¥½ï¼ˆå‡å°‘ 1 å±‚ JOINï¼‰
- âœ… å·¥ä½œç©ºé—´å†…æˆå‘˜è‡ªåŠ¨å…±äº«æ‰€æœ‰èµ„æº
- âœ… æƒé™åœ¨å·¥ä½œç©ºé—´çº§åˆ«ç»Ÿä¸€ç®¡ç†

**æŸ¥è¯¢è·¯å¾„ä¼˜åŒ–ï¼š**

```
ä¹‹å‰ï¼ˆ4 å±‚ JOINï¼‰ï¼š
  User â†’ ProjectRelation â†’ Project â†’ SharedWorkflow â†’ Workflow

æ”¹é€ åï¼ˆ3 å±‚ JOINï¼‰ï¼š
  User â†’ ProjectRelation â†’ Project â†’ Workflow

æ€§èƒ½æå‡ï¼šçº¦ 30%
```

**æƒé™ç®¡ç†ç­–ç•¥ï¼š**
- å·¥ä½œç©ºé—´å†…çš„æˆå‘˜é€šè¿‡ ProjectRelation çš„ role ç»Ÿä¸€æ§åˆ¶æƒé™
- Adminï¼šå®Œå…¨æ§åˆ¶æƒé™
- Editorï¼šå¯åˆ›å»ºå’Œç¼–è¾‘æ‰€æœ‰å·¥ä½œæµ
- Viewerï¼šåªèƒ½æŸ¥çœ‹æ‰€æœ‰å·¥ä½œæµ

**æ³¨æ„ï¼š** å¦‚æœæœªæ¥éœ€è¦"å•ä¸ªå·¥ä½œæµ"çš„ç»†ç²’åº¦æƒé™ï¼Œå¯ä»¥åœ¨èµ„æºçº§åˆ«æ·»åŠ æƒé™å­—æ®µï¼Œä½† Phase 1 ä¸å®ç°ã€‚

---

## ğŸ”§ å››ã€åç«¯å±‚æ”¹é€ 

### 4.1 Repository å±‚é‡æ„

#### 4.1.1 WorkflowRepository æ–°å¢æ–¹æ³•

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/@n8n/db/src/repositories/workflow.repository.ts`

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```typescript
@Service()
export class WorkflowRepository extends Repository<WorkflowEntity> {

  /**
   * è·å–å·¥ä½œç©ºé—´çš„æ‰€æœ‰å·¥ä½œæµ
   * æŸ¥è¯¢è·¯å¾„ï¼šç›´æ¥é€šè¿‡ projectId
   */
  async findByProject(projectId: string): Promise<WorkflowEntity[]> {
    return await this.find({
      where: { projectId },
      order: { updatedAt: 'DESC' }
    });
  }

  /**
   * è·å–ç”¨æˆ·å¯è®¿é—®çš„æ‰€æœ‰å·¥ä½œæµï¼ˆè·¨æ‰€æœ‰å·¥ä½œç©ºé—´ï¼‰
   * æŸ¥è¯¢è·¯å¾„ï¼šUser â†’ ProjectRelation â†’ Project â†’ Workflow
   */
  async findAccessibleByUser(userId: string): Promise<WorkflowEntity[]> {
    return await this.createQueryBuilder('workflow')
      .innerJoin('workflow.project', 'project')
      .innerJoin('project.projectRelations', 'relation')
      .where('relation.userId = :userId', { userId })
      .andWhere('project.status = :status', { status: 'active' })
      .orderBy('workflow.updatedAt', 'DESC')
      .getMany();
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®å·¥ä½œæµ
   */
  async checkUserAccess(workflowId: string, userId: string): Promise<boolean> {
    const count = await this.createQueryBuilder('workflow')
      .innerJoin('workflow.project', 'project')
      .innerJoin('project.projectRelations', 'relation')
      .where('workflow.id = :workflowId', { workflowId })
      .andWhere('relation.userId = :userId', { userId })
      .getCount();

    return count > 0;
  }

  /**
   * è·å–ç”¨æˆ·åœ¨å·¥ä½œæµçš„æƒé™è§’è‰²
   */
  async getUserRole(workflowId: string, userId: string): Promise<string | null> {
    const result = await this.createQueryBuilder('workflow')
      .innerJoin('workflow.project', 'project')
      .innerJoin('project.projectRelations', 'relation')
      .select('relation.role', 'role')
      .where('workflow.id = :workflowId', { workflowId })
      .andWhere('relation.userId = :userId', { userId })
      .getRawOne();

    return result?.role || null;
  }
}
```

**æ€§èƒ½ä¼˜åŒ–ï¼š**

| æ–¹æ³• | ä¹‹å‰ï¼ˆ4å±‚JOINï¼‰ | ç°åœ¨ï¼ˆ3å±‚JOINï¼‰ | æ€§èƒ½æå‡ |
|------|----------------|----------------|----------|
| `findAccessibleByUser` | User â†’ PR â†’ P â†’ SW â†’ W | User â†’ PR â†’ P â†’ W | ~30% |
| `checkUserAccess` | åŒä¸Š | åŒä¸Š | ~30% |

#### 4.1.2 CredentialsRepository é‡æ„

**ç±»ä¼¼ WorkflowRepositoryï¼Œæ ¸å¿ƒæ–¹æ³•ï¼š**

```typescript
async findByProject(projectId: string): Promise<CredentialsEntity[]>
async findAccessibleByUser(userId: string): Promise<CredentialsEntity[]>
async checkUserAccess(credentialId: string, userId: string): Promise<boolean>
```

#### 4.1.3 ProjectRepository æ‰©å±•

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/@n8n/db/src/repositories/project.repository.ts`

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```typescript
@Service()
export class ProjectRepository extends Repository<Project> {

  /**
   * è·å–ç”¨æˆ·çš„æ‰€æœ‰å·¥ä½œç©ºé—´ï¼ˆä¸ªäºº+å›¢é˜Ÿï¼‰
   */
  async findByUser(userId: string): Promise<Project[]> {
    return await this.createQueryBuilder('project')
      .innerJoin('project.projectRelations', 'relation')
      .where('relation.userId = :userId', { userId })
      .andWhere('project.status = :status', { status: 'active' })
      .orderBy('project.type', 'ASC')  // personal ä¼˜å…ˆ
      .addOrderBy('project.createdAt', 'DESC')
      .getMany();
  }

  /**
   * è·å–ç”¨æˆ·çš„é»˜è®¤å·¥ä½œç©ºé—´
   */
  async findDefaultByUser(userId: string): Promise<Project | null> {
    return await this.createQueryBuilder('project')
      .innerJoin('project.projectRelations', 'relation')
      .where('relation.userId = :userId', { userId })
      .andWhere('project.isDefault = :isDefault', { isDefault: true })
      .andWhere('project.status = :status', { status: 'active' })
      .getOne();
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯å·¥ä½œç©ºé—´ç®¡ç†å‘˜
   */
  async isUserAdmin(projectId: string, userId: string): Promise<boolean> {
    const count = await this.createQueryBuilder('project')
      .innerJoin('project.projectRelations', 'relation')
      .where('project.id = :projectId', { projectId })
      .andWhere('relation.userId = :userId', { userId })
      .andWhere('relation.role = :role', { role: 'project:admin' })
      .getCount();

    return count > 0;
  }
}
```

### 4.2 Service å±‚æ”¹é€ 

#### 4.2.1 WorkspaceContextServiceï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/services/workspace-context.service.ts`

**ä½œç”¨ï¼š** ç®¡ç†å½“å‰è¯·æ±‚çš„å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```typescript
@Service()
export class WorkspaceContextService {

  /**
   * ä»è¯·æ±‚ä¸­è§£æå·¥ä½œç©ºé—´ ID
   * ä¼˜å…ˆçº§ï¼šHeader > Query > Route > Body
   */
  extractWorkspaceId(req: express.Request): string | null {
    return (
      req.headers['x-workspace-id'] as string ||
      req.query.workspaceId as string ||
      req.params.projectId ||
      req.body.projectId ||
      null
    );
  }

  /**
   * éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®å·¥ä½œç©ºé—´
   */
  async validateAccess(
    workspaceId: string,
    userId: string,
    requiredRole?: string
  ): Promise<boolean> {
    // å®ç°é€»è¾‘
  }

  /**
   * è·å–ç”¨æˆ·åœ¨å·¥ä½œç©ºé—´çš„è§’è‰²
   */
  async getUserRole(workspaceId: string, userId: string): Promise<string | null> {
    // å®ç°é€»è¾‘
  }
}
```

#### 4.2.2 ProjectService é‡æ„

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/services/project.service.ts`

**æ ¸å¿ƒæ–¹æ³•åˆ†ç±»ï¼š**

**1. ä¸ªäººç©ºé—´ç®¡ç†ï¼š**

```typescript
/**
 * åˆ›å»ºä¸ªäººå·¥ä½œç©ºé—´ï¼ˆç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨è°ƒç”¨ï¼‰
 */
async createPersonalWorkspace(user: User): Promise<Project>

/**
 * è·å–é»˜è®¤å·¥ä½œç©ºé—´
 */
async getDefaultWorkspace(userId: string): Promise<Project | null>
```

**2. å›¢é˜Ÿç©ºé—´ç®¡ç†ï¼š**

```typescript
/**
 * åˆ›å»ºå›¢é˜Ÿå·¥ä½œç©ºé—´
 */
async createTeamWorkspace(
  creator: User,
  data: { name: string; description?: string; maxMembers?: number }
): Promise<Project>

/**
 * å½’æ¡£å·¥ä½œç©ºé—´
 */
async archiveWorkspace(projectId: string): Promise<void>

/**
 * è·å–ç”¨æˆ·çš„æ‰€æœ‰å·¥ä½œç©ºé—´
 */
async getUserWorkspaces(userId: string): Promise<Project[]>
```

**3. æˆå‘˜ç®¡ç†ï¼š**

```typescript
/**
 * æ·»åŠ æˆå‘˜åˆ°å·¥ä½œç©ºé—´
 */
async addMember(
  projectId: string,
  userId: string,
  role: string = 'project:editor',
  invitedBy: string | null = null
): Promise<void>

/**
 * ç§»é™¤æˆå‘˜
 */
async removeMember(projectId: string, userId: string): Promise<void>

/**
 * æ›´æ–°æˆå‘˜è§’è‰²
 */
async updateMemberRole(
  projectId: string,
  userId: string,
  newRole: string
): Promise<void>

/**
 * è·å–æˆå‘˜åˆ—è¡¨
 */
async getMembers(projectId: string): Promise<Array<{ user: User; role: string }>>
```

**ä¸šåŠ¡é€»è¾‘ç¤ºä¾‹ï¼ˆåˆ›å»ºå›¢é˜Ÿç©ºé—´ï¼‰ï¼š**

```typescript
async createTeamWorkspace(creator: User, data: CreateTeamDto): Promise<Project> {
  // 1. æ£€æŸ¥ç”¨æˆ·é…é¢
  const userProjects = await this.projectRepository.findByUser(creator.id);
  if (userProjects.length >= creator.maxProjects) {
    throw new Error('Project limit exceeded');
  }

  // 2. åˆ›å»º Project
  const project = this.projectRepository.create({
    name: data.name,
    description: data.description,
    type: 'team',
    isDefault: false,
    status: 'active',
    settings: {
      maxMembers: data.maxMembers || 10,
      billingMode: 'owner_pays'
    }
  });

  await this.projectRepository.save(project);

  // 3. åˆ›å»ºè€…è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜
  await this.addMember(project.id, creator.id, 'project:admin', null);

  return project;
}
```

#### 4.2.3 WorkflowService ç®€åŒ–

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/services/workflow.service.ts`

**æ ¸å¿ƒæ–¹æ³•é‡æ„ï¼š**

```typescript
@Service()
export class WorkflowService {

  /**
   * è·å–å·¥ä½œç©ºé—´çš„æ‰€æœ‰å·¥ä½œæµ
   */
  async getWorkspaceWorkflows(
    workspaceId: string,
    userId: string
  ): Promise<WorkflowEntity[]> {
    // 1. éªŒè¯ç”¨æˆ·è®¿é—®æƒé™
    const hasAccess = await this.workspaceContextService.validateAccess(
      workspaceId,
      userId
    );

    if (!hasAccess) {
      throw new Error('Access denied');
    }

    // 2. ç›´æ¥æŸ¥è¯¢
    return await this.workflowRepository.findByProject(workspaceId);
  }

  /**
   * åˆ›å»ºå·¥ä½œæµï¼ˆç›´æ¥å½’å±å·¥ä½œç©ºé—´ï¼‰
   */
  async createWorkflow(
    workspaceId: string,
    userId: string,
    data: Partial<WorkflowEntity>
  ): Promise<WorkflowEntity> {
    // 1. éªŒè¯æƒé™ï¼ˆè‡³å°‘éœ€è¦ editorï¼‰
    const hasAccess = await this.workspaceContextService.validateAccess(
      workspaceId,
      userId,
      'project:editor'
    );

    if (!hasAccess) {
      throw new Error('Permission denied');
    }

    // 2. åˆ›å»ºå·¥ä½œæµ
    const workflow = this.workflowRepository.create({
      ...data,
      projectId: workspaceId  // ç›´æ¥å½’å±å·¥ä½œç©ºé—´
    });

    return await this.workflowRepository.save(workflow);
  }
}
```

**ç®€åŒ–ç‚¹ï¼š**
- âŒ ä¸éœ€è¦ç®¡ç† SharedWorkflow
- âœ… æƒé™æ£€æŸ¥ç»Ÿä¸€åœ¨å·¥ä½œç©ºé—´çº§åˆ«
- âœ… æŸ¥è¯¢è·¯å¾„ç®€åŒ–

### 4.3 API å±‚æ”¹é€ 

#### 4.3.1 WorkspaceContextMiddlewareï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/middlewares/workspace-context.middleware.ts`

**ä½œç”¨ï¼š** è‡ªåŠ¨è§£æå¹¶éªŒè¯å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡

```typescript
export function workspaceContextMiddleware(
  workspaceContextService: WorkspaceContextService
) {
  return async (
    req: express.Request,
    res: express.Response,
    next: express.NextFunction
  ) => {
    const workspaceId = workspaceContextService.extractWorkspaceId(req);

    if (workspaceId) {
      const user = req.user as User;
      const hasAccess = await workspaceContextService.validateAccess(
        workspaceId,
        user.id
      );

      if (!hasAccess) {
        return res.status(403).json({
          error: 'Workspace access denied'
        });
      }

      // æ³¨å…¥ä¸Šä¸‹æ–‡
      req.workspace = {
        id: workspaceId,
        userId: user.id
      };
    }

    next();
  };
}
```

**æ‰©å±• Express Request ç±»å‹ï¼š**

```typescript
declare global {
  namespace Express {
    interface Request {
      workspace?: {
        id: string;
        userId: string;
      };
    }
  }
}
```

#### 4.3.2 WorkflowsController è°ƒæ•´

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/workflows/workflows.controller.ts`

**æ¥å£è°ƒæ•´ï¼š**

```typescript
@RestController('/workflows')
export class WorkflowsController {

  /**
   * GET /workflows?workspaceId=xxx
   * è·å–å·¥ä½œç©ºé—´çš„å·¥ä½œæµåˆ—è¡¨
   */
  @Get('/')
  async getWorkflows(
    @Query('workspaceId') workspaceId: string,
    @AuthUser() user: User
  ) {
    if (!workspaceId) {
      throw new BadRequestError('workspaceId is required');
    }

    const workflows = await this.workflowService.getWorkspaceWorkflows(
      workspaceId,
      user.id
    );

    return workflows;
  }

  /**
   * POST /workflows
   * åˆ›å»ºå·¥ä½œæµï¼ˆå¿…é¡»æŒ‡å®š workspaceIdï¼‰
   */
  @Post('/')
  async createWorkflow(
    @Body() data: CreateWorkflowDto,
    @AuthUser() user: User
  ) {
    if (!data.workspaceId) {
      throw new BadRequestError('workspaceId is required');
    }

    return await this.workflowService.createWorkflow(
      data.workspaceId,
      user.id,
      data
    );
  }
}
```

**å‘åå…¼å®¹ç­–ç•¥ï¼š**

```typescript
// å¦‚æœå‰ç«¯æ²¡ä¼  workspaceIdï¼Œä½¿ç”¨ç”¨æˆ·çš„é»˜è®¤å·¥ä½œç©ºé—´
if (!workspaceId) {
  const defaultWorkspace = await this.projectService.getDefaultWorkspace(user.id);
  workspaceId = defaultWorkspace?.id;
}
```

#### 4.3.3 WorkspacesControllerï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/controllers/workspaces.controller.ts`

**API æ¥å£åˆ—è¡¨ï¼š**

```typescript
@RestController('/workspaces')
export class WorkspacesController {

  // å·¥ä½œç©ºé—´ç®¡ç†
  GET    /workspaces                    // è·å–ç”¨æˆ·çš„æ‰€æœ‰å·¥ä½œç©ºé—´
  POST   /workspaces                    // åˆ›å»ºå›¢é˜Ÿå·¥ä½œç©ºé—´
  GET    /workspaces/:id                // è·å–å·¥ä½œç©ºé—´è¯¦æƒ…
  PATCH  /workspaces/:id                // æ›´æ–°å·¥ä½œç©ºé—´
  DELETE /workspaces/:id                // å½’æ¡£å·¥ä½œç©ºé—´

  // æˆå‘˜ç®¡ç†
  POST   /workspaces/:id/members        // æ·»åŠ æˆå‘˜
  DELETE /workspaces/:id/members/:uid   // ç§»é™¤æˆå‘˜
  PATCH  /workspaces/:id/members/:uid   // æ›´æ–°æˆå‘˜è§’è‰²
  GET    /workspaces/:id/members        // è·å–æˆå‘˜åˆ—è¡¨
}
```

**æ¥å£å®ç°ç¤ºä¾‹ï¼š**

```typescript
/**
 * POST /workspaces/:id/members
 * æ·»åŠ æˆå‘˜åˆ°å·¥ä½œç©ºé—´
 */
@Post('/:id/members')
async addMember(
  @Param('id') workspaceId: string,
  @Body() data: { userId: string; role?: string },
  @AuthUser() user: User
) {
  // 1. éªŒè¯å½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜
  const isAdmin = await this.projectService.isUserAdmin(workspaceId, user.id);
  if (!isAdmin) {
    throw new ForbiddenError('Admin permission required');
  }

  // 2. æ·»åŠ æˆå‘˜
  await this.projectService.addMember(
    workspaceId,
    data.userId,
    data.role || 'project:editor',
    user.id
  );

  return { success: true };
}
```

---

## ğŸ¨ äº”ã€å‰ç«¯å±‚æ”¹é€ 

### 5.1 çŠ¶æ€ç®¡ç†ï¼ˆprojects.store.tsï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/editor-ui/src/stores/projects.store.ts`

**æ ¸å¿ƒçŠ¶æ€ï¼š**

```typescript
export const useProjectsStore = defineStore('projects', () => {
  // çŠ¶æ€
  const workspaces = ref<Project[]>([]);
  const currentWorkspaceId = ref<string | null>(null);

  // æŒä¹…åŒ–åˆ° localStorage
  const storedWorkspaceId = localStorage.getItem('activeWorkspaceId');
  if (storedWorkspaceId) {
    currentWorkspaceId.value = storedWorkspaceId;
  }

  // è®¡ç®—å±æ€§
  const currentWorkspace = computed(() => {
    return workspaces.value.find(w => w.id === currentWorkspaceId.value) || null;
  });

  const personalWorkspaces = computed(() => {
    return workspaces.value.filter(w => w.type === 'personal');
  });

  const teamWorkspaces = computed(() => {
    return workspaces.value.filter(w => w.type === 'team');
  });

  // æ–¹æ³•
  async function fetchWorkspaces() {
    const { workspaces: data } = await api.get('/workspaces');
    workspaces.value = data;

    // å¦‚æœæ²¡æœ‰å½“å‰å·¥ä½œç©ºé—´ï¼Œé€‰æ‹©é»˜è®¤çš„
    if (!currentWorkspaceId.value && data.length > 0) {
      const defaultWs = data.find(w => w.isDefault) || data[0];
      setActiveWorkspace(defaultWs.id);
    }
  }

  function setActiveWorkspace(workspaceId: string) {
    currentWorkspaceId.value = workspaceId;
    localStorage.setItem('activeWorkspaceId', workspaceId);
  }

  return {
    workspaces,
    currentWorkspaceId,
    currentWorkspace,
    personalWorkspaces,
    teamWorkspaces,
    fetchWorkspaces,
    setActiveWorkspace
  };
});
```

### 5.2 WorkspaceSwitcher ç»„ä»¶

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/editor-ui/src/components/WorkspaceSwitcher.vue`

**ç»„ä»¶åŠŸèƒ½ï¼š**
1. æ˜¾ç¤ºå½“å‰å·¥ä½œç©ºé—´åç§°
2. ç‚¹å‡»å±•å¼€ä¸‹æ‹‰èœå•
3. åˆ—å‡ºä¸ªäººç©ºé—´å’Œå›¢é˜Ÿç©ºé—´
4. åˆ‡æ¢å·¥ä½œç©ºé—´ï¼ˆä¸è·³è½¬è·¯ç”±ï¼‰

**ç»„ä»¶ç»“æ„ï¼š**

```vue
<template>
  <div class="workspace-switcher">
    <el-dropdown @command="handleSwitch">
      <span class="current-workspace">
        {{ currentWorkspace?.name || 'Select Workspace' }}
        <i class="el-icon-arrow-down"></i>
      </span>
      <template #dropdown>
        <el-dropdown-menu>
          <!-- ä¸ªäººç©ºé—´ -->
          <el-dropdown-item
            v-for="ws in personalWorkspaces"
            :key="ws.id"
            :command="ws.id"
          >
            ğŸ“± {{ ws.name }}
          </el-dropdown-item>

          <el-dropdown-item divided disabled>
            å›¢é˜Ÿç©ºé—´
          </el-dropdown-item>

          <!-- å›¢é˜Ÿç©ºé—´ -->
          <el-dropdown-item
            v-for="ws in teamWorkspaces"
            :key="ws.id"
            :command="ws.id"
          >
            ğŸ¢ {{ ws.name }}
          </el-dropdown-item>

          <el-dropdown-item divided @click="createWorkspace">
            + åˆ›å»ºå·¥ä½œç©ºé—´
          </el-dropdown-item>
        </el-dropdown-menu>
      </template>
    </el-dropdown>
  </div>
</template>

<script setup lang="ts">
import { useProjectsStore } from '@/stores/projects.store';
import { useRouter } from 'vue-router';

const projectsStore = useProjectsStore();
const router = useRouter();

const { currentWorkspace, personalWorkspaces, teamWorkspaces } = storeToRefs(projectsStore);

function handleSwitch(workspaceId: string) {
  projectsStore.setActiveWorkspace(workspaceId);

  // ä¸è·³è½¬è·¯ç”±ï¼Œæ•°æ®è‡ªåŠ¨åˆ·æ–°
  // å„é¡µé¢ç›‘å¬ currentWorkspaceId å˜åŒ–
}

function createWorkspace() {
  router.push('/workspaces/new');
}
</script>
```

### 5.3 é¡µé¢è‡ªåŠ¨åˆ·æ–°

**WorkflowsView.vue ç¤ºä¾‹ï¼š**

```vue
<script setup lang="ts">
import { useProjectsStore } from '@/stores/projects.store';

const projectsStore = useProjectsStore();
const workflows = ref<Workflow[]>([]);

// ç›‘å¬å·¥ä½œç©ºé—´å˜åŒ–
watch(
  () => projectsStore.currentWorkspaceId,
  async (newWorkspaceId) => {
    if (newWorkspaceId) {
      await fetchWorkflows(newWorkspaceId);
    }
  },
  { immediate: true }
);

async function fetchWorkflows(workspaceId: string) {
  const response = await api.get(`/workflows?workspaceId=${workspaceId}`);
  workflows.value = response.data;
}
</script>
```

**æ•ˆæœï¼š**
- åˆ‡æ¢å·¥ä½œç©ºé—´æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ `fetchWorkflows()`
- é¡µé¢ä¸è·³è½¬ï¼Œæ•°æ®å¹³æ»‘è¿‡æ¸¡

### 5.4 è·¯ç”±è®¾è®¡

**ä¸éœ€è¦ä¿®æ”¹è·¯ç”±ï¼š**

```typescript
const routes = [
  { path: '/workflows', component: WorkflowsView },
  { path: '/credentials', component: CredentialsView },
  { path: '/executions', component: ExecutionsView },
  { path: '/workspaces', component: WorkspacesView },
  { path: '/workspaces/new', component: CreateWorkspaceView }
];
```

**å·¥ä½œç©ºé—´ ID é€šè¿‡å…¨å±€çŠ¶æ€ç®¡ç†ï¼š**
- å­˜åœ¨ `projectsStore.currentWorkspaceId`
- API è¯·æ±‚æ—¶è‡ªåŠ¨å¸¦ä¸Šï¼š`?workspaceId=xxx`

---

## ğŸš€ å…­ã€åˆå§‹åŒ–å’Œè¿ç§»

### 6.1 ç”¨æˆ·æ³¨å†Œæµç¨‹

**UserService.registerUser() æ‰©å±•ï¼š**

```typescript
async registerUser(data: { email: string; password: string; firstName: string }) {
  // 1. åˆ›å»ºç”¨æˆ·
  const user = this.userRepository.create({
    email: data.email,
    password: await hashPassword(data.password),
    firstName: data.firstName,
    tier: 'free',
    maxProjects: 10,
    settings: {}
  });

  await this.userRepository.save(user);

  // 2. è‡ªåŠ¨åˆ›å»ºé»˜è®¤ä¸ªäººå·¥ä½œç©ºé—´
  await this.projectService.createPersonalWorkspace(user);

  return user;
}
```

### 6.2 ç™»å½•å“åº”è°ƒæ•´

**AuthController.login() æ‰©å±•ï¼š**

```typescript
@Post('/login')
async login(@Body() credentials: LoginDto) {
  const user = await this.authService.login(credentials);
  const workspaces = await this.projectService.getUserWorkspaces(user.id);

  return {
    token: this.authService.issueJWT(user),
    user: {
      id: user.id,
      email: user.email,
      firstName: user.firstName,
      tier: user.tier
    },
    workspaces  // è¿”å›å·¥ä½œç©ºé—´åˆ—è¡¨
  };
}
```

---

## ğŸ“… ä¸ƒã€å®æ–½æ­¥éª¤ï¼ˆ5-6 å‘¨ï¼‰

### Week 1ï¼šæ•°æ®åº“å±‚

**ä»»åŠ¡ï¼š**
- [x] è®¾è®¡å¹¶ç¼–å†™æ•°æ®åº“ç»“æ„å˜æ›´ SQL è„šæœ¬
- [x] æ‰©å±• Project è¡¨ï¼ˆæ·»åŠ  slugã€descriptionã€settings ç­‰å­—æ®µï¼‰
- [x] æ‰©å±• User è¡¨ï¼ˆæ·»åŠ  tierã€max_projects ç­‰å­—æ®µï¼‰
- [x] ç¡®ä¿ Workflow/Credentials æœ‰ projectId å­—æ®µ
- [x] æ·»åŠ å¿…è¦çš„ç´¢å¼•å’Œçº¦æŸ
- [x] å†³ç­–å¹¶å®æ–½ SharedWorkflow åˆ é™¤æ–¹æ¡ˆ
- [x] åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ SQL è„šæœ¬

**äº¤ä»˜ç‰©ï¼š**
- âœ… æ•°æ®åº“ç»“æ„å˜æ›´è„šæœ¬å¯æ‰§è¡Œ
- âœ… æ•°æ®åº“ç»“æ„ç¬¦åˆè®¾è®¡æ–‡æ¡£
- âœ… ç´¢å¼•å’Œçº¦æŸæ­£ç¡®åˆ›å»º

### Week 2ï¼šRepository + Service å±‚

**ä»»åŠ¡ï¼š**
- [x] é‡æ„ WorkflowRepositoryï¼ˆæ–°å¢ findByProject ç­‰ï¼‰
- [x] é‡æ„ CredentialsRepository
- [x] é‡æ„ ProjectRepository
- [x] åˆ›å»º WorkspaceContextService
- [x] é‡æ„ ProjectServiceï¼ˆå›¢é˜Ÿç©ºé—´ç®¡ç†ï¼‰
- [x] é‡æ„ WorkflowService
- [x] å•å…ƒæµ‹è¯•

**äº¤ä»˜ç‰©ï¼š**
- âœ… Repository æŸ¥è¯¢è·¯å¾„ä¼˜åŒ–
- âœ… Service ä¸šåŠ¡é€»è¾‘å®Œå–„
- âœ… å•å…ƒæµ‹è¯•é€šè¿‡

### Week 3ï¼šAPI å±‚

**ä»»åŠ¡ï¼š**
- [x] åˆ›å»º WorkspaceContextMiddleware
- [x] è°ƒæ•´ WorkflowsControllerï¼ˆæ·»åŠ  workspaceId å‚æ•°ï¼‰
- [x] è°ƒæ•´ CredentialsController
- [x] åˆ›å»º WorkspacesControllerï¼ˆå·¥ä½œç©ºé—´ç®¡ç† APIï¼‰
- [x] æ›´æ–° AuthControllerï¼ˆç™»å½•è¿”å›å·¥ä½œç©ºé—´åˆ—è¡¨ï¼‰
- [x] API æ–‡æ¡£æ›´æ–°

**äº¤ä»˜ç‰©ï¼š**
- âœ… API æ¥å£å¯è°ƒç”¨
- âœ… Postman/Swagger æ–‡æ¡£æ›´æ–°

### Week 4ï¼šå‰ç«¯å±‚

**ä»»åŠ¡ï¼š**
- [x] é‡æ„ projects.store.tsï¼ˆå·¥ä½œç©ºé—´çŠ¶æ€ç®¡ç†ï¼‰
- [x] åˆ›å»º WorkspaceSwitcher.vue ç»„ä»¶
- [x] æ›´æ–° WorkflowsViewï¼ˆç›‘å¬å·¥ä½œç©ºé—´å˜åŒ–ï¼‰
- [x] æ›´æ–° CredentialsView
- [x] åˆ›å»º WorkspacesViewï¼ˆå·¥ä½œç©ºé—´ç®¡ç†é¡µé¢ï¼‰
- [x] åˆ›å»º TeamMembersViewï¼ˆæˆå‘˜ç®¡ç†é¡µé¢ï¼‰

**äº¤ä»˜ç‰©ï¼š**
- âœ… å·¥ä½œç©ºé—´åˆ‡æ¢å™¨å¯ç”¨
- âœ… æ•°æ®è‡ªåŠ¨åˆ·æ–°
- âœ… å›¢é˜Ÿç®¡ç†ç•Œé¢å®Œå–„

### Week 5ï¼šåˆå§‹åŒ– + æµ‹è¯•

**ä»»åŠ¡ï¼š**
- [x] æ‰©å±• UserService.registerUserï¼ˆè‡ªåŠ¨åˆ›å»ºä¸ªäººç©ºé—´ï¼‰
- [x] E2E æµ‹è¯•ï¼ˆæ³¨å†Œã€ç™»å½•ã€åˆ‡æ¢å·¥ä½œç©ºé—´ï¼‰
- [x] æ€§èƒ½æµ‹è¯•ï¼ˆæŸ¥è¯¢ä¼˜åŒ–éªŒè¯ï¼‰
- [x] æ•°æ®éš”ç¦»æµ‹è¯•ï¼ˆéªŒè¯å·¥ä½œç©ºé—´é—´å®Œå…¨éš”ç¦»ï¼‰

**äº¤ä»˜ç‰©ï¼š**
- âœ… æ–°ç”¨æˆ·æ³¨å†Œæµç¨‹å®Œå–„
- âœ… æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- âœ… æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡

### Week 6ï¼šä¼˜åŒ– + ä¸Šçº¿

**ä»»åŠ¡ï¼š**
- [x] Bug ä¿®å¤
- [x] æ€§èƒ½ä¼˜åŒ–ï¼ˆç´¢å¼•è°ƒä¼˜ï¼‰
- [x] å®‰å…¨å®¡è®¡ï¼ˆæƒé™ç»•è¿‡æ£€æŸ¥ï¼‰
- [x] æ–‡æ¡£æ›´æ–°ï¼ˆç”¨æˆ·æ‰‹å†Œã€API æ–‡æ¡£ï¼‰
- [x] ç°åº¦å‘å¸ƒ

**äº¤ä»˜ç‰©ï¼š**
- âœ… ç”Ÿäº§ç¯å¢ƒå¯ç”¨
- âœ… æ–‡æ¡£å®Œå–„

---

## âš ï¸ å…«ã€é£é™©å’Œæ³¨æ„äº‹é¡¹

### 8.1 é£é™©æ¸…å•

| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|----------|
| SharedWorkflow åˆ é™¤å½±å“ | ä¸­ | å…¨é¢æœç´¢ä»£ç ä¾èµ–ã€æ¸è¿›å¼åˆ é™¤ |
| æŸ¥è¯¢æ€§èƒ½ä¸‹é™ | ä¸­ | æ·»åŠ åˆé€‚ç´¢å¼•ã€æ‰§è¡Œæ€§èƒ½æµ‹è¯• |
| å‰ç«¯å…¼å®¹æ€§é—®é¢˜ | ä½ | API å‘åå…¼å®¹ã€ç°åº¦å‘å¸ƒ |
| æƒé™æ§åˆ¶æ¼æ´ | é«˜ | å…¨é¢æƒé™æµ‹è¯•ã€å®‰å…¨å®¡è®¡ |

### 8.2 æ³¨æ„äº‹é¡¹

**SharedWorkflow åˆ é™¤å†³ç­–ï¼š**
- éœ€è¦å…¨é¢æœç´¢ä»£ç ä¸­æ‰€æœ‰å¼•ç”¨ SharedWorkflow/SharedCredentials çš„åœ°æ–¹
- ç¡®è®¤æ˜¯å¦æœ‰ç‰¹æ®Šä¸šåŠ¡é€»è¾‘ä¾èµ–è¿™äº›è¡¨
- å»ºè®®æ¸è¿›å¼åˆ é™¤ï¼šå…ˆæ³¨é‡Šæ‰ç›¸å…³ä»£ç ï¼Œæµ‹è¯•æ— è¯¯åå†åˆ é™¤è¡¨

**æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼š**
- åœ¨æ‰©å±•è¡¨ç»“æ„åï¼ŒåŠ¡å¿…æ·»åŠ åˆé€‚çš„ç´¢å¼•
- æ‰§è¡ŒæŸ¥è¯¢æ€§èƒ½æµ‹è¯•ï¼Œç¡®ä¿å“åº”æ—¶é—´ç¬¦åˆé¢„æœŸ
- ç›‘æ§ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

**æƒé™æµ‹è¯•é‡ç‚¹ï¼š**
- æµ‹è¯•è·¨å·¥ä½œç©ºé—´æ•°æ®éš”ç¦»ï¼ˆç”¨æˆ· A çœ‹ä¸åˆ°å·¥ä½œç©ºé—´ B çš„æ•°æ®ï¼‰
- æµ‹è¯•ä¸‰çº§æƒé™æ§åˆ¶ï¼ˆAdmin/Editor/Viewerï¼‰
- æµ‹è¯•æˆå‘˜ç§»é™¤åæƒé™ç«‹å³å¤±æ•ˆ

---

## ğŸ“Š ä¹ã€æˆåŠŸæ ‡å‡†

### 9.1 åŠŸèƒ½å®Œæ•´æ€§

- âœ… ç”¨æˆ·æ³¨å†Œåè‡ªåŠ¨æœ‰ä¸ªäººç©ºé—´
- âœ… ç”¨æˆ·å¯ä»¥åˆ›å»ºå›¢é˜Ÿç©ºé—´
- âœ… å¯ä»¥é‚€è¯·æˆå‘˜å¹¶åˆ†é…è§’è‰²
- âœ… å·¥ä½œç©ºé—´åˆ‡æ¢æµç•…ï¼Œæ•°æ®è‡ªåŠ¨åˆ·æ–°
- âœ… æƒé™æ§åˆ¶æ­£ç¡®ï¼ˆAdmin/Editor/Viewerï¼‰
- âœ… æ•°æ®éš”ç¦»æ­£ç¡®ï¼ˆçœ‹ä¸åˆ°å…¶ä»–å·¥ä½œç©ºé—´çš„æ•°æ®ï¼‰

### 9.2 æ€§èƒ½æŒ‡æ ‡

- âœ… å·¥ä½œæµåˆ—è¡¨æŸ¥è¯¢ < 200msï¼ˆ1000 æ¡æ•°æ®ï¼‰
- âœ… å·¥ä½œç©ºé—´åˆ‡æ¢ < 500msï¼ˆåŒ…å«æ•°æ®åˆ·æ–°ï¼‰
- âœ… æˆå‘˜åˆ—è¡¨æŸ¥è¯¢ < 100msï¼ˆ100 ä¸ªæˆå‘˜ï¼‰
- âœ… å·¥ä½œç©ºé—´æ•°æ®éš”ç¦»æŸ¥è¯¢æ­£ç¡®ï¼ˆä¸ä¼šæŸ¥åˆ°å…¶ä»–ç©ºé—´æ•°æ®ï¼‰

### 9.3 å®‰å…¨æ€§

- âœ… è·¨å·¥ä½œç©ºé—´æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æƒé™æ§åˆ¶æ­£ç¡®ï¼ˆAdmin/Editor/Viewer æƒé™è¾¹ç•Œæ¸…æ™°ï¼‰
- âœ… API æ¥å£æ— æƒé™ç»•è¿‡æ¼æ´
- âœ… æˆå‘˜ç§»é™¤åç«‹å³å¤±å»è®¿é—®æƒé™

---

## ğŸ¯ åã€Phase 2 é¢„ç•™ï¼ˆè®¡è´¹ç³»ç»Ÿï¼‰

### 10.1 é¢„ç•™æ•°æ®åº“å­—æ®µ

```sql
-- execution_entity è¡¨
ALTER TABLE execution_entity
  ADD COLUMN billing_user_id UUID,  -- å®é™…ä»˜è´¹çš„ç”¨æˆ·
  ADD COLUMN cost DECIMAL(10,4);    -- æœ¬æ¬¡æ‰§è¡Œæˆæœ¬

-- user è¡¨
ALTER TABLE "user"
  ADD COLUMN tier VARCHAR(50),      -- ç”¨æˆ·ç­‰çº§
  ADD COLUMN max_projects INT;      -- é…é¢é™åˆ¶

-- project.settings
-- { "billingMode": "owner_pays" | "member_pays" }
```

### 10.2 å¾…å®ç°ï¼ˆå·¥ä½œæµè¿è¡Œæ¨¡å¼æ”¹é€ åï¼‰

- â¸ï¸ UserBalance è¡¨ - ä½™é¢ç®¡ç†
- â¸ï¸ UsageRecord è¡¨ - æ¶ˆè´¹è®°å½•
- â¸ï¸ RechargeRecord è¡¨ - å……å€¼è®°å½•
- â¸ï¸ SubscriptionPlan è¡¨ - è®¢é˜…è®¡åˆ’
- â¸ï¸ BillingService - è®¡è´¹é€»è¾‘
- â¸ï¸ æ‰§è¡Œè®¡è´¹ Hook

---

## âœ… åä¸€ã€æ€»ç»“

### 11.1 æ ¸å¿ƒæ”¹é€ 

1. **Project = Workspace**ï¼ˆé¡¶çº§éš”ç¦»å•ä½ï¼Œä¸ªäºº/å›¢é˜Ÿç©ºé—´ï¼‰
2. **èµ„æºç›´æ¥å½’å±**ï¼ˆWorkflow/Credentials.projectIdï¼‰
3. **ç®€åŒ–æŸ¥è¯¢é“¾è·¯**ï¼ˆå‡å°‘ JOINï¼Œæå‡æ€§èƒ½ï¼‰
4. **ç»Ÿä¸€æƒé™æ¨¡å‹**ï¼ˆåŸºäº ProjectRelationï¼‰

### 11.2 å®ç°æ•ˆæœ

- âœ… Coze é£æ ¼çš„å·¥ä½œç©ºé—´åˆ‡æ¢
- âœ… ä¸ªäººç©ºé—´ + å›¢é˜Ÿç©ºé—´
- âœ… ä¸‰çº§æƒé™ç®¡ç†ï¼ˆAdmin/Editor/Viewerï¼‰
- âœ… æ•°æ®å®Œå…¨éš”ç¦»
- âœ… ä¸ºè®¡è´¹ç³»ç»Ÿé¢„ç•™æ¥å£

### 11.3 å·¥æœŸä¼°ç®—

- **5-6 å‘¨å®Œæˆæ¶æ„åº•å±‚æ”¹é€ **
- è®¡è´¹ç³»ç»Ÿå¾…å·¥ä½œæµè¿è¡Œæ¨¡å¼æ”¹é€ åå†è§„åˆ’

---

## ğŸ“š é™„å½•

### A. ç›¸å…³æ–‡æ¡£

- `feature/exclusive-project-mode` åˆ†æ”¯åˆ†æï¼ˆå‚è€ƒï¼‰
- Coze æ¶æ„ç ”ç©¶æ–‡æ¡£ï¼ˆå‚è€ƒï¼‰
- n8n åŸæœ‰æ¶æ„æ–‡æ¡£ï¼ˆå‚è€ƒï¼‰

### B. å…³é”®æ–‡ä»¶è·¯å¾„æ¸…å•

**æ•°æ®åº“å±‚ï¼š**
```
packages/@n8n/db/src/
  â”œâ”€â”€ entities/
  â”‚   â”œâ”€â”€ project.ts
  â”‚   â”œâ”€â”€ project-relation.ts
  â”‚   â”œâ”€â”€ workflow-entity.ts
  â”‚   â””â”€â”€ credentials-entity.ts
  â”œâ”€â”€ repositories/
  â”‚   â”œâ”€â”€ project.repository.ts
  â”‚   â”œâ”€â”€ workflow.repository.ts
  â”‚   â””â”€â”€ credentials.repository.ts
  â””â”€â”€ migrations/
      â””â”€â”€ postgresdb/1761900000000-AddWorkspaceArchitecture.ts
```

**åç«¯å±‚ï¼š**
```
packages/cli/src/
  â”œâ”€â”€ services/
  â”‚   â”œâ”€â”€ workspace-context.service.ts
  â”‚   â”œâ”€â”€ project.service.ts
  â”‚   â””â”€â”€ workflow.service.ts
  â”œâ”€â”€ controllers/
  â”‚   â”œâ”€â”€ workspaces.controller.ts
  â”‚   â””â”€â”€ workflows.controller.ts
  â””â”€â”€ middlewares/
      â””â”€â”€ workspace-context.middleware.ts
```

**å‰ç«¯å±‚ï¼š**
```
packages/editor-ui/src/
  â”œâ”€â”€ stores/
  â”‚   â””â”€â”€ projects.store.ts
  â”œâ”€â”€ components/
  â”‚   â””â”€â”€ WorkspaceSwitcher.vue
  â””â”€â”€ views/
      â”œâ”€â”€ WorkflowsView.vue
      â”œâ”€â”€ CredentialsView.vue
      â””â”€â”€ WorkspacesView.vue
```

### C. æœ¯è¯­å¯¹ç…§è¡¨

| Coze æœ¯è¯­ | n8n æœ¯è¯­ | è¯´æ˜ |
|-----------|----------|------|
| Workspace | Project | å·¥ä½œç©ºé—´ |
| Personal Workspace | Project (type='personal') | ä¸ªäººç©ºé—´ |
| Team Workspace | Project (type='team') | å›¢é˜Ÿç©ºé—´ |
| Bot | Workflow | å·¥ä½œæµ |
| Knowledge Base | Credentials | å‡­è¯ |
| Member | ProjectRelation | æˆå‘˜å…³ç³» |
| Admin/Editor/Viewer | project:admin/editor/viewer | è§’è‰²æƒé™ |

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2025-11-03
**æ–‡æ¡£ç»´æŠ¤ï¼š** æ ¹æ®å®æ–½è¿›åº¦æŒç»­æ›´æ–°
