# n8n å¤šç§Ÿæˆ· SaaS æ¶æ„åº•å±‚æ”¹é€ æ–¹æ¡ˆï¼ˆæ¿€è¿›ç‰ˆï¼‰

> **ç‰ˆæœ¬ï¼š** v4.0ï¼ˆæ¿€è¿›æ”¹é€ ç‰ˆ + ç”¨æˆ·æ³¨å†Œç³»ç»Ÿï¼‰
> **æ—¥æœŸï¼š** 2025-01-07
> **åŸºäºåˆ†æ”¯ï¼š** 20251102
> **æ”¹é€ ç›®æ ‡ï¼š** å¯¹æ ‡ Coze å•†ä¸šç‰ˆ - å·¥ä½œç©ºé—´æ¶æ„ + AI æŒ‰é‡è®¡è´¹ï¼ˆäººæ°‘å¸ï¼‰+ å®Œæ•´ç”¨æˆ·æ³¨å†Œä½“ç³»
> **å‰ææ¡ä»¶ï¼š** é¡¹ç›®æœªéƒ¨ç½²ç”Ÿäº§ç¯å¢ƒï¼Œå¯æ¿€è¿›æ”¹é€ 

---

## ğŸ“‹ ä¸€ã€æ”¹é€ ç›®æ ‡ä¸ Coze å¯¹æ ‡

### 1.1 Coze å•†ä¸šç‰ˆæ ¸å¿ƒç‰¹æ€§ï¼ˆ2025ï¼‰

**å®šä»·ä½“ç³»ï¼š**
- **ä¸ªäººè¿›é˜¶ç‰ˆ**: Â¥9.9/æœˆ
- **å›¢é˜Ÿç‰ˆ**: Â¥178/æœˆ
- **ä¼ä¸šç‰ˆ**: Â¥4,980/æœˆ
- **ä¸“ä¸šç‰ˆ**: åŒ…å¹´åŒ…æœˆ + **æŒ‰é‡ä»˜è´¹**ï¼ˆè¶…å‡ºå¥—é¤è‡ªåŠ¨è®¡è´¹ï¼‰

**è®¡è´¹ç»´åº¦ï¼ˆ7å¤§ç±»ï¼‰ï¼š**
1. âœ… æ¨¡å‹è°ƒç”¨ï¼ˆæŒ‰ tokens è®¡è´¹ï¼‰
2. âœ… æ’ä»¶ä½¿ç”¨ï¼ˆæŒ‰è°ƒç”¨æ¬¡æ•°ï¼‰
3. âœ… éŸ³è§†é¢‘æœåŠ¡
4. âœ… çŸ¥è¯†åº“å­˜å‚¨
5. âœ… å·¥ä½œæµæ‰§è¡Œ
6. âœ… è¯­éŸ³è½¬æ–‡å­—
7. âœ… å›¾ç‰‡ç”Ÿæˆ

**å·¥ä½œç©ºé—´æ¨¡å¼ï¼š**
- **ä¸ªäººç©ºé—´**ï¼šé»˜è®¤åˆ›å»ºï¼Œå•äººä½¿ç”¨
- **å›¢é˜Ÿç©ºé—´**ï¼šå¤šäººåä½œï¼Œèµ„æºå…±äº«
- **ä¼ä¸šç©ºé—´**ï¼šç§æœ‰éƒ¨ç½²ï¼Œå®šåˆ¶å¼€å‘

### 1.2 n8n æ”¹é€ å¯¹æ ‡

| Coze ç‰¹æ€§ | n8n æ”¹é€ å | å®æ–½ä¼˜å…ˆçº§ |
|----------|-----------|----------|
| ä¸ªäººç©ºé—´ | Project (type='personal') | P0 |
| å›¢é˜Ÿç©ºé—´ | Project (type='team') | P0 |
| å·¥ä½œç©ºé—´åˆ‡æ¢ | å·¦ä¸Šè§’ä¸‹æ‹‰åˆ‡æ¢å™¨ | P0 |
| Bot | Workflow | P0 |
| æŒ‰é‡è®¡è´¹ | äººæ°‘å¸ç›´æ¥è®¡è´¹ | P0 |
| AI æ¨¡å‹è°ƒç”¨ | å¹³å°ç»Ÿä¸€é…ç½® | P0 |
| **å¹³å° RAG æœåŠ¡** | å‚ç›´é¢†åŸŸçŸ¥è¯†åº“æ’ä»¶ | P0 |
| çŸ¥è¯†åº“å­˜å‚¨ | âš ï¸ ä¸åšå¹³å°æä¾›ï¼Œç”¨æˆ·è‡ªå·±é…ç½® | - |

---

## ğŸš€ äºŒã€æ¿€è¿›æ”¹é€ ç­–ç•¥

### 2.1 ä¸ºä»€ä¹ˆå¯ä»¥æ¿€è¿›ï¼Ÿ

âœ… **é¡¹ç›®æœªéƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ** - æ— å†å²æ•°æ®åŒ…è¢±
âœ… **æ— éœ€å‘åå…¼å®¹** - å¯å¤§åˆ€é˜”æ–§é‡æ„
âœ… **è¿½æ±‚æœ€ä¼˜æ¶æ„** - ä¸ç•™æŠ€æœ¯å€º

### 2.2 æ ¸å¿ƒå†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ | ç†ç”± |
|--------|------|------|
| SharedWorkflow/SharedCredentials | **ç›´æ¥åˆ é™¤** | ç®€åŒ–æ¶æ„ï¼Œæå‡æ€§èƒ½ 30-40% |
| èµ„æºå½’å± | Workflow/Credentials ç›´æ¥å±äº Project | å‡å°‘æŸ¥è¯¢å±‚çº§ |
| è®¡è´¹è´§å¸ | **ç›´æ¥äººæ°‘å¸** | ä¸æç§¯åˆ†ï¼Œç®€å•ç›´æ¥ |
| çŸ¥è¯†åº“ | **å¹³å° RAG æœåŠ¡æ’ä»¶** | æŒ‰æ¬¡è®¡è´¹ï¼Œç”¨æˆ·æ•°æ®åº“è‡ªå·±é… |
| Team å®ä½“ | ä¸å¼•å…¥ç‹¬ç«‹ Team è¡¨ | Project çš„ type å­—æ®µè¶³å¤Ÿ |

---

## ğŸ—„ï¸ ä¸‰ã€æ•°æ®åº“å±‚æ”¹é€ ï¼ˆæ¿€è¿›ç‰ˆï¼‰

### 3.1 æ ¸å¿ƒæ¶æ„å˜åŒ–

#### æ”¹é€ å‰ï¼ˆå½“å‰æ¶æ„ï¼‰
```
User â†’ ProjectRelation â†’ Project â†’ SharedWorkflow â†’ Workflow
                                 â†’ SharedCredentials â†’ Credentials
ï¼ˆ4 å±‚ JOINï¼ŒæŸ¥è¯¢å¤æ‚ï¼‰
```

#### æ”¹é€ åï¼ˆæ¿€è¿›ç®€åŒ–ï¼‰
```
User â†’ ProjectRelation â†’ Project (Workspace) â†’ Workflow
                                              â†’ Credentials
                                              â†’ Usage Records
ï¼ˆ3 å±‚ JOINï¼Œæ€§èƒ½æå‡ 30-40%ï¼‰
```

### 3.2 æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆæ¿€è¿›ç‰ˆï¼‰

```sql
-- ========================================
-- ç¬¬ä¸€æ­¥ï¼šæ·»åŠ æ–°å­—æ®µ
-- ========================================

-- 1. èµ„æºè¡¨æ·»åŠ  projectIdï¼ˆç›´æ¥å½’å±ï¼‰
ALTER TABLE workflow_entity
  ADD COLUMN project_id UUID NOT NULL
    REFERENCES project(id) ON DELETE CASCADE;

ALTER TABLE credentials_entity
  ADD COLUMN project_id UUID NOT NULL
    REFERENCES project(id) ON DELETE CASCADE;

-- 2. æ‰©å±• Project è¡¨ï¼ˆå¯¹æ ‡ Coze å·¥ä½œç©ºé—´ï¼‰
ALTER TABLE project
  ADD COLUMN slug VARCHAR(100) UNIQUE,           -- URL å‹å¥½æ ‡è¯†
  ADD COLUMN settings JSONB DEFAULT '{}',        -- å›¢é˜Ÿé…ç½®
  ADD COLUMN is_default BOOLEAN DEFAULT false,   -- æ˜¯å¦é»˜è®¤ç©ºé—´
  ADD COLUMN status VARCHAR(50) DEFAULT 'active', -- çŠ¶æ€

  -- è®¡è´¹å­—æ®µï¼ˆç›´æ¥äººæ°‘å¸ï¼‰
  ADD COLUMN balance_cny DECIMAL(10, 2) DEFAULT 0.00,        -- è´¦æˆ·ä½™é¢
  ADD COLUMN low_balance_threshold DECIMAL(10, 2) DEFAULT 100.00;  -- ä½ä½™é¢è­¦å‘Š

-- 3. æ‰©å±• ProjectRelation è¡¨
ALTER TABLE project_relation
  ADD COLUMN joined_at TIMESTAMP DEFAULT NOW(),
  ADD COLUMN invited_by UUID REFERENCES "user"(id);

-- 4. æ‰©å±• User è¡¨ï¼ˆå®Œæ•´ç‰ˆ - æ”¯æŒæ³¨å†Œã€éªŒè¯ã€OAuthï¼‰
ALTER TABLE "user"
  -- ç”¨æˆ·å±‚çº§å’Œé…é¢
  ADD COLUMN tier VARCHAR(50) DEFAULT 'free',
  ADD COLUMN max_projects INT DEFAULT 10,

  -- é‚®ç®±éªŒè¯
  ADD COLUMN email_verified BOOLEAN DEFAULT FALSE,
  ADD COLUMN email_verify_token VARCHAR(255),
  ADD COLUMN email_verify_expires_at TIMESTAMP,

  -- æ‰‹æœºå·ï¼ˆä¸­å›½ SaaS åˆè§„å¯èƒ½éœ€è¦ï¼‰
  ADD COLUMN phone_number VARCHAR(20),
  ADD COLUMN phone_verified BOOLEAN DEFAULT FALSE,
  ADD COLUMN phone_verify_code VARCHAR(10),
  ADD COLUMN phone_verify_expires_at TIMESTAMP,

  -- å®åè®¤è¯ï¼ˆå¯é€‰ï¼‰
  ADD COLUMN real_name VARCHAR(100),
  ADD COLUMN id_card_number VARCHAR(50),  -- åŠ å¯†å­˜å‚¨
  ADD COLUMN verified_status VARCHAR(50) DEFAULT 'unverified',

  -- ç”¨æˆ·æ¥æº
  ADD COLUMN registration_source VARCHAR(50) DEFAULT 'direct',
  ADD COLUMN invited_by UUID REFERENCES "user"(id),
  ADD COLUMN invite_code VARCHAR(50),

  -- ç”¨æˆ·åå¥½
  ADD COLUMN language VARCHAR(10) DEFAULT 'zh-CN',
  ADD COLUMN timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',

  -- æœ€åæ´»è·ƒ
  ADD COLUMN last_active_at TIMESTAMP DEFAULT NOW(),
  ADD COLUMN last_workspace_id UUID REFERENCES project(id),

  -- Onboarding çŠ¶æ€
  ADD COLUMN onboarding_completed BOOLEAN DEFAULT FALSE,
  ADD COLUMN onboarding_step INT DEFAULT 0,

  -- è´¦æˆ·çŠ¶æ€
  ADD COLUMN account_status VARCHAR(50) DEFAULT 'active',
  ADD COLUMN suspended_reason TEXT,
  ADD COLUMN suspended_at TIMESTAMP,

  -- OAuth å…³è”
  ADD COLUMN oauth_wechat_openid VARCHAR(100),
  ADD COLUMN oauth_github_id VARCHAR(100);

-- 5. å…¶ä»–èµ„æºè¡¨æ·»åŠ  projectIdï¼ˆå·¥ä½œç©ºé—´éš”ç¦»ï¼‰
ALTER TABLE execution_entity
  ADD COLUMN project_id UUID NOT NULL
    REFERENCES project(id) ON DELETE CASCADE;

ALTER TABLE variables_entity
  ADD COLUMN project_id UUID NOT NULL
    REFERENCES project(id) ON DELETE CASCADE;

-- ========================================
-- ç¬¬äºŒæ­¥ï¼šæ·»åŠ çº¦æŸå’Œç´¢å¼•
-- ========================================

-- çº¦æŸ
ALTER TABLE project
  ADD CONSTRAINT chk_project_status
    CHECK (status IN ('active', 'archived'));

ALTER TABLE "user"
  ADD CONSTRAINT chk_user_tier CHECK (tier IN ('free', 'pro', 'enterprise')),
  ADD CONSTRAINT chk_user_verified_status CHECK (verified_status IN ('unverified', 'pending', 'verified')),
  ADD CONSTRAINT chk_user_account_status CHECK (account_status IN ('active', 'suspended', 'deleted')),
  ADD CONSTRAINT chk_user_registration_source CHECK (registration_source IN ('direct', 'invite', 'oauth_wechat', 'oauth_github'));

-- ç´¢å¼•ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
CREATE INDEX idx_workflow_project ON workflow_entity(project_id);
CREATE INDEX idx_workflow_project_active ON workflow_entity(project_id, active);
CREATE INDEX idx_credentials_project ON credentials_entity(project_id);
CREATE INDEX idx_execution_project ON execution_entity(project_id, finished_at DESC);
CREATE INDEX idx_variables_project ON variables_entity(project_id);
CREATE INDEX idx_project_type ON project(type);
CREATE INDEX idx_project_status ON project(status);
CREATE INDEX idx_project_slug ON project(slug) WHERE slug IS NOT NULL;

-- User è¡¨ç´¢å¼•
CREATE INDEX idx_user_tier ON "user"(tier);
CREATE INDEX idx_user_email_verified ON "user"(email_verified);
CREATE INDEX idx_user_phone_number ON "user"(phone_number) WHERE phone_number IS NOT NULL;
CREATE INDEX idx_user_oauth_wechat ON "user"(oauth_wechat_openid) WHERE oauth_wechat_openid IS NOT NULL;
CREATE INDEX idx_user_oauth_github ON "user"(oauth_github_id) WHERE oauth_github_id IS NOT NULL;
CREATE INDEX idx_user_last_active ON "user"(last_active_at DESC);
CREATE INDEX idx_user_account_status ON "user"(account_status);

-- ========================================
-- ç¬¬ä¸‰æ­¥ï¼šç›´æ¥åˆ é™¤ SharedWorkflow/SharedCredentials
-- ========================================

-- âš ï¸ æ¿€è¿›æ“ä½œï¼šç›´æ¥åˆ é™¤ï¼ˆå› ä¸ºæ²¡æœ‰ç”Ÿäº§æ•°æ®ï¼‰
DROP TABLE IF EXISTS shared_workflow CASCADE;
DROP TABLE IF EXISTS shared_credentials CASCADE;

-- ========================================
-- ç¬¬å››æ­¥ï¼šåˆ›å»ºè®¡è´¹ç³»ç»Ÿè¡¨
-- ========================================

-- å¹³å° AI æœåŠ¡é…ç½®
CREATE TABLE platform_services (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  service_key VARCHAR(100) UNIQUE NOT NULL,  -- 'openai-gpt4', 'claude-3-opus'
  service_name VARCHAR(200) NOT NULL,
  service_type VARCHAR(50) NOT NULL,  -- 'ai_model', 'embeddings', 'rag_service', 'tts', 'stt', 'image_gen'

  -- API é…ç½®ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
  api_config JSONB NOT NULL,

  -- å®šä»·ï¼ˆç›´æ¥äººæ°‘å¸ï¼‰
  price_per_1k_tokens DECIMAL(10, 4),  -- AI æ¨¡å‹ï¼šæ¯ 1K tokens ä»·æ ¼
  price_per_call DECIMAL(10, 4),       -- RAG æœåŠ¡/å…¶ä»–ï¼šæ¯æ¬¡è°ƒç”¨ä»·æ ¼
  currency VARCHAR(10) DEFAULT 'CNY',

  -- çŠ¶æ€
  enabled BOOLEAN DEFAULT TRUE,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  CONSTRAINT chk_service_type CHECK (service_type IN (
    'ai_model', 'embeddings', 'rag_service', 'tts', 'stt', 'image_gen'
  ))
);

CREATE INDEX idx_platform_services_type ON platform_services(service_type);
CREATE INDEX idx_platform_services_enabled ON platform_services(enabled);

-- å¹³å° RAG çŸ¥è¯†åº“æœåŠ¡
CREATE TABLE platform_rag_services (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  service_key VARCHAR(100) UNIQUE NOT NULL,  -- 'legal-rag-cn', 'medical-rag-cn'
  service_name VARCHAR(200) NOT NULL,
  category VARCHAR(50) NOT NULL,  -- 'legal', 'medical', 'finance'
  description TEXT,

  -- å‘é‡æ•°æ®åº“é…ç½®ï¼ˆå¹³å°çš„ï¼‰
  vector_store_config JSONB NOT NULL,

  -- RAG é…ç½®
  rag_config JSONB NOT NULL,

  -- ç»Ÿè®¡
  total_documents INT DEFAULT 0,
  total_vectors BIGINT DEFAULT 0,
  last_updated_at TIMESTAMP,

  -- å®šä»·
  price_per_query DECIMAL(10, 4) NOT NULL,  -- æ¯æ¬¡æŸ¥è¯¢ä»·æ ¼
  currency VARCHAR(10) DEFAULT 'CNY',

  -- çŠ¶æ€
  enabled BOOLEAN DEFAULT TRUE,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_rag_services_category ON platform_rag_services(category);
CREATE INDEX idx_rag_services_enabled ON platform_rag_services(enabled);

-- ä½¿ç”¨é‡è®°å½•è¡¨
CREATE TABLE usage_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES "user"(id),

  workflow_id VARCHAR(255) REFERENCES workflow_entity(id),
  execution_id VARCHAR(255) REFERENCES execution_entity(id),

  -- æœåŠ¡ä¿¡æ¯
  service_key VARCHAR(100) NOT NULL,
  service_type VARCHAR(50) NOT NULL,

  -- ä½¿ç”¨é‡
  tokens_used INT,      -- AI æ¨¡å‹ç”¨
  calls_count INT,      -- RAG æœåŠ¡ç”¨

  -- è´¹ç”¨ï¼ˆç›´æ¥äººæ°‘å¸ï¼‰
  cost_cny DECIMAL(10, 4) NOT NULL,

  -- å…ƒæ•°æ®
  metadata JSONB,

  created_at TIMESTAMP DEFAULT NOW(),

  CONSTRAINT chk_tokens_or_calls CHECK (tokens_used IS NOT NULL OR calls_count IS NOT NULL)
);

CREATE INDEX idx_usage_workspace_created ON usage_records(workspace_id, created_at DESC);
CREATE INDEX idx_usage_service ON usage_records(service_key, created_at DESC);
CREATE INDEX idx_usage_execution ON usage_records(execution_id);

-- æœˆåº¦ä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆç”¨äºæŠ¥è¡¨ï¼‰
CREATE TABLE monthly_usage_summary (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,

  month VARCHAR(7) NOT NULL,  -- '2025-01'
  service_key VARCHAR(100) NOT NULL,

  total_tokens BIGINT DEFAULT 0,
  total_calls INT DEFAULT 0,
  total_cost_cny DECIMAL(10, 2) DEFAULT 0.00,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  CONSTRAINT uq_workspace_service_month UNIQUE (workspace_id, service_key, month)
);

CREATE INDEX idx_monthly_summary_workspace ON monthly_usage_summary(workspace_id, month DESC);

-- å……å€¼è®°å½•è¡¨ï¼ˆå¯é€‰ï¼‰
CREATE TABLE recharge_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,

  amount_cny DECIMAL(10, 2) NOT NULL,
  payment_method VARCHAR(50),  -- 'alipay', 'wechat', 'bank_transfer'
  payment_id VARCHAR(255),     -- ç¬¬ä¸‰æ–¹æ”¯ä»˜æµæ°´å·
  status VARCHAR(50) DEFAULT 'pending',  -- 'pending', 'completed', 'failed'

  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP
);

CREATE INDEX idx_recharge_workspace ON recharge_records(workspace_id, created_at DESC);

-- ========================================
-- ç¬¬äº”æ­¥ï¼šç”¨æˆ·æ³¨å†Œå’Œç®¡ç†ç³»ç»Ÿè¡¨
-- ========================================

-- é‚€è¯·ç è¡¨
CREATE TABLE invite_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  workspace_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,

  code VARCHAR(50) UNIQUE NOT NULL,

  -- ä½¿ç”¨é™åˆ¶
  max_uses INT DEFAULT 1,
  used_count INT DEFAULT 0,
  expires_at TIMESTAMP,

  -- å¥–åŠ±è®¾ç½®
  bonus_amount_cny DECIMAL(10, 2) DEFAULT 5.00,

  status VARCHAR(50) DEFAULT 'active',

  created_at TIMESTAMP DEFAULT NOW(),

  CONSTRAINT chk_invite_status CHECK (status IN ('active', 'expired', 'disabled'))
);

CREATE INDEX idx_invite_code ON invite_codes(code);
CREATE INDEX idx_invite_user ON invite_codes(user_id);
CREATE INDEX idx_invite_status ON invite_codes(status, expires_at);

-- é‚€è¯·è®°å½•è¡¨
CREATE TABLE invite_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  invite_code_id UUID NOT NULL REFERENCES invite_codes(id) ON DELETE CASCADE,

  inviter_id UUID NOT NULL REFERENCES "user"(id),
  invitee_id UUID NOT NULL REFERENCES "user"(id),

  bonus_amount DECIMAL(10, 2) NOT NULL,

  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_invite_record_inviter ON invite_records(inviter_id);
CREATE INDEX idx_invite_record_invitee ON invite_records(invitee_id);

-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID REFERENCES project(id) ON DELETE CASCADE,
  user_id UUID REFERENCES "user"(id),

  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50),
  resource_id VARCHAR(255),

  metadata JSONB,
  ip_address VARCHAR(50),
  user_agent TEXT,

  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_audit_workspace_time ON audit_logs(workspace_id, created_at DESC);
CREATE INDEX idx_audit_user ON audit_logs(user_id, created_at DESC);
CREATE INDEX idx_audit_action ON audit_logs(action);

-- å·¥ä½œç©ºé—´é…é¢è¡¨
CREATE TABLE workspace_quotas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID UNIQUE REFERENCES project(id) ON DELETE CASCADE,

  -- é…é¢é™åˆ¶
  max_workflows INT DEFAULT 50,
  max_credentials INT DEFAULT 100,
  max_executions_per_day INT DEFAULT 1000,
  max_concurrent_executions INT DEFAULT 5,

  -- å½“å‰ä½¿ç”¨é‡ï¼ˆç¼“å­˜ï¼‰
  current_workflows INT DEFAULT 0,
  current_credentials INT DEFAULT 0,
  current_executions_today INT DEFAULT 0,

  -- é‡ç½®æ—¶é—´
  executions_reset_at TIMESTAMP DEFAULT NOW(),

  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_quota_workspace ON workspace_quotas(workspace_id);

-- ç”¨æˆ·æ³¨å†Œç»Ÿè®¡è¡¨ï¼ˆç”¨äºç®¡ç†åå°åˆ†æï¼‰
CREATE TABLE registration_stats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  date DATE UNIQUE NOT NULL DEFAULT CURRENT_DATE,

  total_registrations INT DEFAULT 0,

  -- æ¥æºåˆ†æ
  direct_registrations INT DEFAULT 0,
  invite_registrations INT DEFAULT 0,
  oauth_wechat_registrations INT DEFAULT 0,
  oauth_github_registrations INT DEFAULT 0,

  -- éªŒè¯æƒ…å†µ
  email_verified_count INT DEFAULT 0,
  phone_verified_count INT DEFAULT 0,

  -- ç”¨æˆ·å±‚çº§
  free_tier_count INT DEFAULT 0,
  pro_tier_count INT DEFAULT 0,
  enterprise_tier_count INT DEFAULT 0,

  -- æ´»è·ƒæƒ…å†µ
  active_on_day1 INT DEFAULT 0,
  active_on_day7 INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_registration_stats_date ON registration_stats(date DESC);

-- ========================================
-- ç¬¬å…­æ­¥ï¼šæ’å…¥ç¤ºä¾‹æ•°æ®
-- ========================================

-- ç¤ºä¾‹ï¼šå¹³å° AI æœåŠ¡
INSERT INTO platform_services (service_key, service_name, service_type, api_config, price_per_1k_tokens, currency) VALUES
('openai-gpt4', 'OpenAI GPT-4 Turbo', 'ai_model', '{"apiKey": "encrypted", "model": "gpt-4-turbo"}', 0.30, 'CNY'),
('openai-gpt35', 'OpenAI GPT-3.5 Turbo', 'ai_model', '{"apiKey": "encrypted", "model": "gpt-3.5-turbo"}', 0.01, 'CNY'),
('claude-3-opus', 'Claude 3 Opus', 'ai_model', '{"apiKey": "encrypted", "model": "claude-3-opus"}', 0.50, 'CNY'),
('openai-embedding', 'OpenAI Embeddings', 'embeddings', '{"apiKey": "encrypted", "model": "text-embedding-3-large"}', 0.001, 'CNY');

-- ç¤ºä¾‹ï¼šå¹³å° RAG æœåŠ¡
INSERT INTO platform_rag_services (service_key, service_name, category, description, vector_store_config, rag_config, total_documents, price_per_query) VALUES
('legal-rag-cn', 'ä¸­å›½æ³•å¾‹çŸ¥è¯†åº“', 'legal', 'åŒ…å«ä¸­å›½æ³•å¾‹æ³•è§„ã€å¸æ³•è§£é‡Šã€å…¸å‹æ¡ˆä¾‹ç­‰ä¸“ä¸šæ³•å¾‹çŸ¥è¯†',
  '{"type": "pinecone", "index": "legal-kb-cn", "namespace": "cn-law"}',
  '{"embedding_model": "text-embedding-3-large", "top_k": 5, "rerank": true}',
  50000, 0.10),

('medical-rag-cn', 'åŒ»ç–—å¥åº·çŸ¥è¯†åº“', 'medical', 'åŒ»å­¦æ•™æã€ä¸´åºŠæŒ‡å—ã€è¯å“è¯´æ˜ä¹¦ã€ç–¾ç—…ç™¾ç§‘',
  '{"type": "pinecone", "index": "medical-kb-cn"}',
  '{"embedding_model": "text-embedding-3-large", "top_k": 5}',
  30000, 0.15),

('finance-rag-cn', 'é‡‘èè´¢ç»çŸ¥è¯†åº“', 'finance', 'é‡‘èæ”¿ç­–ã€æŠ•èµ„ç†è´¢ã€ç»æµåˆ†æã€å¸‚åœºç ”æŠ¥',
  '{"type": "pinecone", "index": "finance-kb-cn"}',
  '{"embedding_model": "text-embedding-3-large", "top_k": 5}',
  20000, 0.12);
```

---

## ğŸ”§ å››ã€åç«¯å±‚æ”¹é€ ï¼ˆæ¿€è¿›ç‰ˆï¼‰

### 4.1 Repository å±‚ï¼ˆç®€åŒ–é‡å†™ï¼‰

#### 4.1.1 WorkflowRepositoryï¼ˆåˆ é™¤æ‰€æœ‰ SharedWorkflow å¼•ç”¨ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/@n8n/db/src/repositories/workflow.repository.ts`

```typescript
@Service()
export class WorkflowRepository extends Repository<WorkflowEntity> {

  /**
   * è·å–å·¥ä½œç©ºé—´çš„æ‰€æœ‰å·¥ä½œæµï¼ˆç›´æ¥æŸ¥è¯¢ï¼‰
   */
  async findByProject(projectId: string): Promise<WorkflowEntity[]> {
    return await this.find({
      where: { projectId },
      order: { updatedAt: 'DESC' }
    });
  }

  /**
   * è·å–ç”¨æˆ·å¯è®¿é—®çš„æ‰€æœ‰å·¥ä½œæµ
   * âœ… ç®€åŒ–åï¼šUser â†’ ProjectRelation â†’ Project â†’ Workflowï¼ˆ3å±‚JOINï¼‰
   */
  async findAccessibleByUser(userId: string): Promise<WorkflowEntity[]> {
    return await this.createQueryBuilder('workflow')
      .innerJoin('workflow.project', 'project')  // âœ… ç›´æ¥ JOIN Project
      .innerJoin('project.projectRelations', 'relation')
      .where('relation.userId = :userId', { userId })
      .andWhere('project.status = :status', { status: 'active' })
      .orderBy('workflow.updatedAt', 'DESC')
      .getMany();
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆç®€åŒ–ç‰ˆï¼‰
   */
  async checkUserAccess(workflowId: string, userId: string): Promise<boolean> {
    const count = await this.createQueryBuilder('workflow')
      .innerJoin('workflow.project', 'project')
      .innerJoin('project.projectRelations', 'relation')
      .where('workflow.id = :workflowId', { workflowId })
      .andWhere('relation.userId = :userId', { userId })
      .getCount();

    return count > 0;
  }

  /**
   * è·å–ç”¨æˆ·åœ¨å·¥ä½œæµæ‰€å±å·¥ä½œç©ºé—´çš„è§’è‰²
   */
  async getUserRole(workflowId: string, userId: string): Promise<string | null> {
    const result = await this.createQueryBuilder('workflow')
      .innerJoin('workflow.project', 'project')
      .innerJoin('project.projectRelations', 'relation')
      .select('relation.role', 'role')
      .where('workflow.id = :workflowId', { workflowId })
      .andWhere('relation.userId = :userId', { userId })
      .getRawOne();

    return result?.role || null;
  }
}
```

#### 4.1.2 CredentialsRepositoryï¼ˆç±»ä¼¼ç®€åŒ–ï¼‰

```typescript
@Service()
export class CredentialsRepository extends Repository<CredentialsEntity> {

  async findByProject(projectId: string): Promise<CredentialsEntity[]> {
    return await this.find({
      where: { projectId },
      order: { name: 'ASC' }
    });
  }

  async findAccessibleByUser(userId: string): Promise<CredentialsEntity[]> {
    return await this.createQueryBuilder('credentials')
      .innerJoin('credentials.project', 'project')
      .innerJoin('project.projectRelations', 'relation')
      .where('relation.userId = :userId', { userId })
      .andWhere('project.status = :status', { status: 'active' })
      .orderBy('credentials.name', 'ASC')
      .getMany();
  }
}
```

### 4.2 Service å±‚ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰

#### 4.2.1 BillingServiceï¼ˆè®¡è´¹æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/services/billing.service.ts`

```typescript
@Service()
export class BillingService {
  constructor(
    private readonly projectRepository: ProjectRepository,
    private readonly platformServiceRepository: PlatformServiceRepository,
    private readonly platformRagServiceRepository: PlatformRagServiceRepository,
    private readonly usageRecordRepository: UsageRecordRepository,
    private readonly monthlySummaryRepository: MonthlySummaryRepository,
    private readonly notificationService: NotificationService,
    private readonly logger: Logger
  ) {}

  /**
   * æ£€æŸ¥å·¥ä½œåŒºä½™é¢ï¼ˆè°ƒç”¨å‰ï¼‰
   */
  async checkBalance(workspaceId: string, estimatedCostCny: number = 1.00): Promise<void> {
    const workspace = await this.projectRepository.findOne({
      where: { id: workspaceId },
      select: ['balanceCny', 'status']
    });

    if (!workspace) {
      throw new NotFoundError('Workspace not found');
    }

    if (workspace.status !== 'active') {
      throw new BadRequestError('Workspace is not active');
    }

    // ä½™é¢ä¸è¶³
    if (workspace.balanceCny < estimatedCostCny) {
      throw new InsufficientBalanceError(
        `ä½™é¢ä¸è¶³ã€‚å½“å‰ä½™é¢: Â¥${workspace.balanceCny.toFixed(2)}, ` +
        `é¢„è®¡æ¶ˆè€—: Â¥${estimatedCostCny.toFixed(2)}ã€‚è¯·å……å€¼ã€‚`
      );
    }
  }

  /**
   * è®°å½•ä½¿ç”¨é‡å¹¶æ‰£è´¹ï¼ˆè°ƒç”¨åï¼‰
   */
  async recordUsageAndCharge(params: {
    workspaceId: string;
    userId: string;
    workflowId?: string;
    executionId?: string;
    serviceKey: string;
    serviceType: 'ai_model' | 'rag_service' | 'tts' | 'stt' | 'image_gen';
    tokensUsed?: number;      // AI æ¨¡å‹ç”¨
    callsCount?: number;      // RAG æœåŠ¡ç”¨
    metadata?: any;
  }): Promise<void> {

    // 1. è·å–æœåŠ¡é…ç½®å’Œå®šä»·
    let costCny: number;

    if (params.serviceType === 'ai_model') {
      const service = await this.platformServiceRepository.findOne({
        where: { serviceKey: params.serviceKey, enabled: true }
      });

      if (!service) {
        throw new NotFoundError(`Service ${params.serviceKey} not found`);
      }

      // è®¡ç®—è´¹ç”¨ï¼štokens / 1000 * å•ä»·
      costCny = (params.tokensUsed! / 1000) * parseFloat(service.pricePerKTokens);

    } else if (params.serviceType === 'rag_service') {
      const ragService = await this.platformRagServiceRepository.findOne({
        where: { serviceKey: params.serviceKey, enabled: true }
      });

      if (!ragService) {
        throw new NotFoundError(`RAG service ${params.serviceKey} not found`);
      }

      // RAG æŒ‰æ¬¡è®¡è´¹
      costCny = params.callsCount! * parseFloat(ragService.pricePerQuery);
    }

    // 2. ä½¿ç”¨äº‹åŠ¡æ‰£è´¹å¹¶è®°å½•
    await this.projectRepository.manager.transaction(async (trx) => {

      // æ‰£é™¤ä½™é¢
      await trx.decrement(
        Project,
        { id: params.workspaceId },
        'balanceCny',
        costCny
      );

      // åˆ›å»ºä½¿ç”¨è®°å½•
      await trx.save(UsageRecord, {
        workspaceId: params.workspaceId,
        userId: params.userId,
        workflowId: params.workflowId,
        executionId: params.executionId,
        serviceKey: params.serviceKey,
        serviceType: params.serviceType,
        tokensUsed: params.tokensUsed,
        callsCount: params.callsCount,
        costCny: costCny,
        metadata: params.metadata
      });

      // æ£€æŸ¥ä½™é¢å¹¶å‘é€ä½ä½™é¢è­¦å‘Š
      const workspace = await trx.findOne(Project, {
        where: { id: params.workspaceId },
        select: ['balanceCny', 'lowBalanceThreshold']
      });

      if (workspace && workspace.balanceCny <= workspace.lowBalanceThreshold) {
        // å¼‚æ­¥å‘é€ä½ä½™é¢é€šçŸ¥
        setImmediate(() => {
          this.notificationService.sendLowBalanceAlert({
            workspaceId: params.workspaceId,
            currentBalance: workspace.balanceCny,
            threshold: workspace.lowBalanceThreshold
          });
        });
      }
    });

    // 3. å¼‚æ­¥æ›´æ–°æœˆåº¦ç»Ÿè®¡
    setImmediate(() => {
      this.updateMonthlySummary(
        params.workspaceId,
        params.serviceKey,
        params.tokensUsed || 0,
        params.callsCount || 0,
        costCny
      ).catch(err => {
        this.logger.error('Failed to update monthly summary', err);
      });
    });
  }

  /**
   * è·å–å·¥ä½œåŒºè´¦å•ï¼ˆæŒ‰æœˆï¼‰
   */
  async getMonthlyBill(workspaceId: string, month: string) {
    const summary = await this.monthlySummaryRepository.find({
      where: { workspaceId, month },
      order: { totalCostCny: 'DESC' }
    });

    const totalCost = summary.reduce((sum, item) =>
      sum + parseFloat(item.totalCostCny.toString()), 0
    );

    return {
      month,
      items: summary,
      totalCostCny: totalCost
    };
  }

  /**
   * å……å€¼
   */
  async recharge(workspaceId: string, amountCny: number, paymentData: {
    paymentMethod: string;
    paymentId: string;
  }) {
    await this.projectRepository.manager.transaction(async (trx) => {
      // å¢åŠ ä½™é¢
      await trx.increment(
        Project,
        { id: workspaceId },
        'balanceCny',
        amountCny
      );

      // è®°å½•å……å€¼è®°å½•
      await trx.save(RechargeRecord, {
        workspaceId,
        amountCny,
        paymentMethod: paymentData.paymentMethod,
        paymentId: paymentData.paymentId,
        status: 'completed',
        completedAt: new Date()
      });
    });
  }

  private async updateMonthlySummary(
    workspaceId: string,
    serviceKey: string,
    tokensUsed: number,
    callsCount: number,
    costCny: number
  ): Promise<void> {
    const month = new Date().toISOString().slice(0, 7);

    const existing = await this.monthlySummaryRepository.findOne({
      where: { workspaceId, serviceKey, month }
    });

    if (existing) {
      // æ›´æ–°
      await this.monthlySummaryRepository.increment(
        { workspaceId, serviceKey, month },
        'totalTokens',
        tokensUsed
      );
      await this.monthlySummaryRepository.increment(
        { workspaceId, serviceKey, month },
        'totalCalls',
        callsCount
      );
      await this.monthlySummaryRepository.increment(
        { workspaceId, serviceKey, month },
        'totalCostCny',
        costCny
      );
    } else {
      // åˆ›å»º
      await this.monthlySummaryRepository.save({
        workspaceId,
        serviceKey,
        month,
        totalTokens: tokensUsed,
        totalCalls: callsCount,
        totalCostCny: costCny
      });
    }
  }
}
```

#### 4.2.2 PlatformRagServiceï¼ˆå¹³å° RAG æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/services/platform-rag.service.ts`

```typescript
@Service()
export class PlatformRagService {
  constructor(
    private readonly platformRagServiceRepository: PlatformRagServiceRepository,
    private readonly billingService: BillingService,
    private readonly vectorStoreService: VectorStoreService,
    private readonly llmService: LLMService
  ) {}

  /**
   * è°ƒç”¨å¹³å° RAG æœåŠ¡æŸ¥è¯¢
   */
  async query(
    workspaceId: string,
    userId: string,
    serviceKey: string,
    query: string,
    options?: { topK?: number; rerank?: boolean }
  ): Promise<{ answer: string; sources: any[]; cost: number }> {

    // 1. æ£€æŸ¥ä½™é¢ï¼ˆé¢„ä¼° Â¥0.10/æ¬¡ï¼‰
    await this.billingService.checkBalance(workspaceId, 0.20);

    // 2. è·å– RAG æœåŠ¡é…ç½®
    const ragService = await this.platformRagServiceRepository.findOne({
      where: { serviceKey, enabled: true }
    });

    if (!ragService) {
      throw new NotFoundError(`RAG service ${serviceKey} not found`);
    }

    // 3. è°ƒç”¨å‘é‡æ•°æ®åº“æ£€ç´¢
    const vectorStoreConfig = ragService.vectorStoreConfig;
    const ragConfig = ragService.ragConfig;

    const searchResults = await this.vectorStoreService.search({
      type: vectorStoreConfig.type,  // 'pinecone', 'qdrant', 'weaviate'
      index: vectorStoreConfig.index,
      namespace: vectorStoreConfig.namespace,
      query,
      topK: options?.topK || ragConfig.top_k,
      embeddingModel: ragConfig.embedding_model
    });

    // 4. ä½¿ç”¨ LLM ç”Ÿæˆç­”æ¡ˆ
    const answer = await this.llmService.generateAnswer(query, searchResults, {
      model: ragConfig.llm_model || 'gpt-4-turbo',
      temperature: ragConfig.temperature || 0.7
    });

    // 5. è®°å½•ä½¿ç”¨é‡å¹¶æ‰£è´¹
    await this.billingService.recordUsageAndCharge({
      workspaceId,
      userId,
      serviceKey,
      serviceType: 'rag_service',
      callsCount: 1,
      metadata: {
        query,
        resultsCount: searchResults.length,
        topK: options?.topK || ragConfig.top_k,
        rerank: options?.rerank
      }
    });

    return {
      answer,
      sources: searchResults.map(r => ({
        text: r.text,
        metadata: r.metadata,
        score: r.score
      })),
      cost: parseFloat(ragService.pricePerQuery)
    };
  }

  /**
   * è·å–å¯ç”¨çš„ RAG æœåŠ¡åˆ—è¡¨
   */
  async listAvailableServices(): Promise<PlatformRagService[]> {
    return await this.platformRagServiceRepository.find({
      where: { enabled: true },
      select: ['serviceKey', 'serviceName', 'category', 'description', 'pricePerQuery', 'totalDocuments'],
      order: { category: 'ASC', serviceName: 'ASC' }
    });
  }
}
```

---

## ğŸ¨ äº”ã€API å±‚æ”¹é€ 

### 5.1 AuthControllerï¼ˆç”¨æˆ·æ³¨å†Œå’Œè®¤è¯ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/controllers/auth.controller.ts`

```typescript
@RestController('/auth')
export class AuthController {
  constructor(
    private readonly userService: UserService,
    private readonly emailVerificationService: EmailVerificationService
  ) {}

  /**
   * POST /auth/register - ç”¨æˆ·æ³¨å†Œ
   */
  @Post('/register')
  async register(@Body() data: {
    email: string;
    password: string;
    firstName?: string;
    inviteCode?: string;
  }) {
    const result = await this.userService.register(data);

    setImmediate(() => {
      this.emailVerificationService.sendVerificationEmail(result.user.id);
    });

    return {
      user: { id: result.user.id, email: result.user.email, firstName: result.user.firstName },
      workspace: { id: result.workspace.id, name: result.workspace.name, balanceCny: result.workspace.balanceCny },
      token: result.token
    };
  }

  /** GET /auth/verify-email - éªŒè¯é‚®ç®± */
  @Get('/verify-email')
  async verifyEmail(@Query('token') token: string) {
    await this.emailVerificationService.verifyEmail(token);
    return { success: true, message: 'é‚®ç®±éªŒè¯æˆåŠŸï¼Œå·²å¥–åŠ± Â¥2' };
  }

  /** GET /auth/oauth/wechat/callback - å¾®ä¿¡ç™»å½• */
  @Get('/oauth/wechat/callback')
  async wechatCallback(@Query('code') code: string) {
    const wechatUser = await this.wechatService.getUserInfo(code);
    let user = await this.userRepository.findOne({ where: { oauthWechatOpenid: wechatUser.openid } });

    if (!user) {
      const result = await this.userService.register({
        email: `wechat_${wechatUser.openid}@placeholder.com`,
        password: crypto.randomBytes(32).toString('hex'),
        firstName: wechatUser.nickname
      });
      user = result.user;
      await this.userRepository.update(user.id, {
        oauthWechatOpenid: wechatUser.openid,
        registrationSource: 'oauth_wechat'
      });
      return { needBindEmail: true, token: result.token };
    }

    const token = this.jwtService.sign({ userId: user.id, email: user.email });
    return { token };
  }
}
```

#### 5.1.1 OnboardingController

```typescript
@RestController('/onboarding')
export class OnboardingController {

  /** GET /onboarding/steps */
  @Get('/steps')
  async getSteps(@AuthUser() user: User) {
    return { steps: await this.onboardingService.getOnboardingSteps(user.id) };
  }
}
```

### 5.2 WorkspacesControllerï¼ˆå·¥ä½œç©ºé—´ç®¡ç†ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/controllers/workspaces.controller.ts`

```typescript
@RestController('/workspaces')
export class WorkspacesController {
  constructor(
    private readonly projectService: ProjectService,
    private readonly projectRepository: ProjectRepository
  ) {}

  /**
   * GET /workspaces
   * è·å–ç”¨æˆ·çš„æ‰€æœ‰å·¥ä½œç©ºé—´
   */
  @Get('/')
  async getUserWorkspaces(@AuthUser() user: User) {
    const workspaces = await this.projectRepository.find({
      where: {
        projectRelations: { userId: user.id },
        status: 'active'
      },
      relations: ['projectRelations'],
      order: { type: 'ASC', createdAt: 'DESC' }  // ä¸ªäººç©ºé—´ä¼˜å…ˆ
    });

    return {
      workspaces: workspaces.map(ws => ({
        id: ws.id,
        name: ws.name,
        type: ws.type,
        icon: ws.icon,
        description: ws.description,
        balanceCny: ws.balanceCny,  // âœ… è¿”å›ä½™é¢
        isDefault: ws.isDefault,
        memberCount: ws.projectRelations?.length || 0
      }))
    };
  }

  /**
   * POST /workspaces
   * åˆ›å»ºå›¢é˜Ÿç©ºé—´
   */
  @Post('/')
  async createTeamWorkspace(
    @AuthUser() user: User,
    @Body() data: { name: string; description?: string; icon?: any }
  ) {
    const workspace = await this.projectService.createTeamProject(user, data);
    return workspace;
  }

  /**
   * GET /workspaces/:id/balance
   * è·å–å·¥ä½œç©ºé—´ä½™é¢
   */
  @Get('/:id/balance')
  async getBalance(@Param('id') workspaceId: string, @AuthUser() user: User) {
    await this.validateAccess(workspaceId, user.id);

    const workspace = await this.projectRepository.findOne({
      where: { id: workspaceId },
      select: ['balanceCny', 'lowBalanceThreshold']
    });

    return {
      balanceCny: workspace.balanceCny,
      lowBalanceThreshold: workspace.lowBalanceThreshold,
      isLowBalance: workspace.balanceCny <= workspace.lowBalanceThreshold,
      currency: 'CNY'
    };
  }

  /**
   * POST /workspaces/:id/recharge
   * å……å€¼
   */
  @Post('/:id/recharge')
  async recharge(
    @Param('id') workspaceId: string,
    @Body() data: { amountCny: number; paymentMethod: string; paymentId: string },
    @AuthUser() user: User
  ) {
    // éªŒè¯ç®¡ç†å‘˜æƒé™
    const isAdmin = await this.projectService.isUserAdmin(workspaceId, user.id);
    if (!isAdmin) {
      throw new ForbiddenError('Only admin can recharge');
    }

    await this.billingService.recharge(workspaceId, data.amountCny, {
      paymentMethod: data.paymentMethod,
      paymentId: data.paymentId
    });

    return { success: true };
  }

  /**
   * GET /workspaces/:id/usage/:month
   * è·å–æœˆåº¦è´¦å•
   */
  @Get('/:id/usage/:month')
  async getMonthlyUsage(
    @Param('id') workspaceId: string,
    @Param('month') month: string,  // '2025-01'
    @AuthUser() user: User
  ) {
    await this.validateAccess(workspaceId, user.id);

    const bill = await this.billingService.getMonthlyBill(workspaceId, month);
    return bill;
  }

  // ... å…¶ä»– APIï¼ˆæˆå‘˜ç®¡ç†ç­‰ï¼‰
}
```

### 5.2 RagControllerï¼ˆå¹³å° RAG æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/controllers/rag.controller.ts`

```typescript
@RestController('/rag')
export class RagController {
  constructor(
    private readonly platformRagService: PlatformRagService,
    private readonly workspaceContextService: WorkspaceContextService
  ) {}

  /**
   * GET /rag/services
   * è·å–å¯ç”¨çš„å¹³å° RAG æœåŠ¡åˆ—è¡¨
   */
  @Get('/services')
  async listServices() {
    const services = await this.platformRagService.listAvailableServices();

    return {
      services: services.map(s => ({
        serviceKey: s.serviceKey,
        serviceName: s.serviceName,
        category: s.category,
        description: s.description,
        pricePerQuery: s.pricePerQuery,
        currency: 'CNY',
        totalDocuments: s.totalDocuments
      }))
    };
  }

  /**
   * POST /rag/query
   * æŸ¥è¯¢å¹³å° RAG æœåŠ¡
   */
  @Post('/query')
  async query(
    @Body() data: {
      workspaceId: string;
      serviceKey: string;
      query: string;
      topK?: number;
      rerank?: boolean;
    },
    @AuthUser() user: User
  ) {
    // éªŒè¯æƒé™
    await this.workspaceContextService.validateAccess(data.workspaceId, user.id);

    // è°ƒç”¨ RAG æœåŠ¡
    const result = await this.platformRagService.query(
      data.workspaceId,
      user.id,
      data.serviceKey,
      data.query,
      { topK: data.topK, rerank: data.rerank }
    );

    return {
      answer: result.answer,
      sources: result.sources,
      cost: result.cost,
      currency: 'CNY',
      service: data.serviceKey
    };
  }
}
```

---

## ğŸ–¥ï¸ å…­ã€åå°ç®¡ç†ç³»ç»Ÿè®¾è®¡

### 6.1 åŠŸèƒ½æ¨¡å—

#### 6.1.1 å¹³å°æœåŠ¡ç®¡ç†

**PlatformServicesControllerï¼ˆç®¡ç†ç«¯ï¼‰**

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/cli/src/controllers/admin/platform-services.controller.ts`

```typescript
@RestController('/admin/platform-services')
@RequireRole('global:admin')  // âš ï¸ ä»…å…¨å±€ç®¡ç†å‘˜
export class AdminPlatformServicesController {

  /**
   * GET /admin/platform-services/ai-models
   * è·å–æ‰€æœ‰ AI æ¨¡å‹æœåŠ¡
   */
  @Get('/ai-models')
  async listAIModels() {
    return await this.platformServiceRepository.find({
      where: { serviceType: 'ai_model' },
      order: { serviceName: 'ASC' }
    });
  }

  /**
   * POST /admin/platform-services/ai-models
   * åˆ›å»º AI æ¨¡å‹æœåŠ¡
   */
  @Post('/ai-models')
  async createAIModel(@Body() data: {
    serviceKey: string;
    serviceName: string;
    apiConfig: { apiKey: string; model: string; baseUrl?: string };
    pricePerKTokens: number;
  }) {
    // åŠ å¯† API Key
    const encryptedConfig = this.encryptService.encrypt(data.apiConfig);

    const service = await this.platformServiceRepository.save({
      serviceKey: data.serviceKey,
      serviceName: data.serviceName,
      serviceType: 'ai_model',
      apiConfig: encryptedConfig,
      pricePerKTokens: data.pricePerKTokens,
      currency: 'CNY',
      enabled: true
    });

    return service;
  }

  /**
   * PATCH /admin/platform-services/ai-models/:key
   * æ›´æ–° AI æ¨¡å‹æœåŠ¡
   */
  @Patch('/ai-models/:key')
  async updateAIModel(
    @Param('key') serviceKey: string,
    @Body() data: {
      serviceName?: string;
      apiConfig?: any;
      pricePerKTokens?: number;
      enabled?: boolean;
    }
  ) {
    const service = await this.platformServiceRepository.findOne({
      where: { serviceKey }
    });

    if (!service) {
      throw new NotFoundError('Service not found');
    }

    if (data.apiConfig) {
      service.apiConfig = this.encryptService.encrypt(data.apiConfig);
    }
    if (data.serviceName) {
      service.serviceName = data.serviceName;
    }
    if (typeof data.pricePerKTokens === 'number') {
      service.pricePerKTokens = data.pricePerKTokens;
    }
    if (typeof data.enabled === 'boolean') {
      service.enabled = data.enabled;
    }

    await this.platformServiceRepository.save(service);

    // æ¸…é™¤ç¼“å­˜
    await this.cacheService.delete(`platform:service:${serviceKey}`);

    return service;
  }

  /**
   * GET /admin/platform-services/rag-services
   * è·å–æ‰€æœ‰å¹³å° RAG æœåŠ¡
   */
  @Get('/rag-services')
  async listRagServices() {
    return await this.platformRagServiceRepository.find({
      order: { category: 'ASC', serviceName: 'ASC' }
    });
  }

  /**
   * POST /admin/platform-services/rag-services
   * åˆ›å»ºå¹³å° RAG æœåŠ¡
   */
  @Post('/rag-services')
  async createRagService(@Body() data: {
    serviceKey: string;
    serviceName: string;
    category: string;
    description: string;
    vectorStoreConfig: any;
    ragConfig: any;
    pricePerQuery: number;
    totalDocuments?: number;
  }) {
    const service = await this.platformRagServiceRepository.save({
      serviceKey: data.serviceKey,
      serviceName: data.serviceName,
      category: data.category,
      description: data.description,
      vectorStoreConfig: data.vectorStoreConfig,
      ragConfig: data.ragConfig,
      pricePerQuery: data.pricePerQuery,
      totalDocuments: data.totalDocuments || 0,
      currency: 'CNY',
      enabled: true
    });

    return service;
  }

  /**
   * DELETE /admin/platform-services/rag-services/:key
   * åˆ é™¤å¹³å° RAG æœåŠ¡
   */
  @Delete('/rag-services/:key')
  async deleteRagService(@Param('key') serviceKey: string) {
    const result = await this.platformRagServiceRepository.delete({ serviceKey });

    if (!result.affected) {
      throw new NotFoundError('Service not found');
    }

    return { success: true };
  }
}
```

#### 6.1.2 ç”¨æˆ·å’Œå·¥ä½œç©ºé—´ç®¡ç†

**AdminWorkspacesController**

```typescript
@RestController('/admin/workspaces')
@RequireRole('global:admin')
export class AdminWorkspacesController {

  /**
   * GET /admin/workspaces
   * è·å–æ‰€æœ‰å·¥ä½œç©ºé—´ï¼ˆåˆ†é¡µï¼‰
   */
  @Get('/')
  async listWorkspaces(
    @Query('page') page: number = 1,
    @Query('limit') limit: number = 20,
    @Query('type') type?: 'personal' | 'team',
    @Query('search') search?: string
  ) {
    const where: any = {};

    if (type) {
      where.type = type;
    }

    if (search) {
      where.name = Like(`%${search}%`);
    }

    const [workspaces, total] = await this.projectRepository.findAndCount({
      where,
      relations: ['projectRelations'],
      order: { createdAt: 'DESC' },
      skip: (page - 1) * limit,
      take: limit
    });

    return {
      workspaces: workspaces.map(ws => ({
        id: ws.id,
        name: ws.name,
        type: ws.type,
        balanceCny: ws.balanceCny,
        status: ws.status,
        memberCount: ws.projectRelations?.length || 0,
        createdAt: ws.createdAt
      })),
      pagination: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit)
      }
    };
  }

  /**
   * POST /admin/workspaces/:id/recharge
   * ç®¡ç†å‘˜ç»™å·¥ä½œç©ºé—´å……å€¼ï¼ˆèµ é€ï¼‰
   */
  @Post('/:id/recharge')
  async adminRecharge(
    @Param('id') workspaceId: string,
    @Body() data: { amountCny: number; reason: string },
    @AuthUser() admin: User
  ) {
    await this.billingService.recharge(workspaceId, data.amountCny, {
      paymentMethod: 'admin_gift',
      paymentId: `admin-${admin.id}-${Date.now()}`
    });

    // è®°å½•æ“ä½œæ—¥å¿—
    await this.auditLogService.log({
      action: 'admin_recharge',
      adminId: admin.id,
      workspaceId,
      metadata: {
        amountCny: data.amountCny,
        reason: data.reason
      }
    });

    return { success: true };
  }

  /**
   * GET /admin/workspaces/:id/usage
   * æŸ¥çœ‹å·¥ä½œç©ºé—´ä½¿ç”¨é‡
   */
  @Get('/:id/usage')
  async getWorkspaceUsage(
    @Param('id') workspaceId: string,
    @Query('startDate') startDate?: string,
    @Query('endDate') endDate?: string
  ) {
    const where: any = { workspaceId };

    if (startDate && endDate) {
      where.createdAt = Between(new Date(startDate), new Date(endDate));
    }

    const records = await this.usageRecordRepository.find({
      where,
      order: { createdAt: 'DESC' },
      take: 100
    });

    const totalCost = records.reduce((sum, r) => sum + parseFloat(r.costCny.toString()), 0);

    return {
      records,
      totalCost,
      currency: 'CNY'
    };
  }
}
```

#### 6.1.3 ç³»ç»Ÿç»Ÿè®¡å’Œç›‘æ§

**AdminStatsController**

```typescript
@RestController('/admin/stats')
@RequireRole('global:admin')
export class AdminStatsController {

  /**
   * GET /admin/stats/overview
   * ç³»ç»Ÿæ¦‚è§ˆç»Ÿè®¡
   */
  @Get('/overview')
  async getOverview() {
    const [
      totalUsers,
      totalWorkspaces,
      totalWorkflows,
      activeWorkflows,
      totalRevenue
    ] = await Promise.all([
      this.userRepository.count(),
      this.projectRepository.count(),
      this.workflowRepository.count(),
      this.workflowRepository.count({ where: { active: true } }),
      this.usageRecordRepository
        .createQueryBuilder('ur')
        .select('SUM(ur.costCny)', 'total')
        .getRawOne()
    ]);

    return {
      totalUsers,
      totalWorkspaces,
      totalWorkflows,
      activeWorkflows,
      totalRevenueCny: parseFloat(totalRevenue?.total || '0'),
      currency: 'CNY'
    };
  }

  /**
   * GET /admin/stats/revenue-trend
   * æ”¶å…¥è¶‹åŠ¿ï¼ˆæŒ‰æœˆï¼‰
   */
  @Get('/revenue-trend')
  async getRevenueTrend(@Query('months') months: number = 6) {
    const result = await this.usageRecordRepository
      .createQueryBuilder('ur')
      .select("DATE_TRUNC('month', ur.created_at)", 'month')
      .addSelect('SUM(ur.cost_cny)', 'revenue')
      .groupBy("DATE_TRUNC('month', ur.created_at)")
      .orderBy("DATE_TRUNC('month', ur.created_at)", 'DESC')
      .limit(months)
      .getRawMany();

    return {
      trend: result.map(r => ({
        month: r.month,
        revenueCny: parseFloat(r.revenue),
        currency: 'CNY'
      }))
    };
  }

  /**
   * GET /admin/stats/popular-services
   * æœ€å—æ¬¢è¿çš„æœåŠ¡
   */
  @Get('/popular-services')
  async getPopularServices() {
    const result = await this.usageRecordRepository
      .createQueryBuilder('ur')
      .select('ur.service_key', 'serviceKey')
      .addSelect('ur.service_type', 'serviceType')
      .addSelect('COUNT(*)', 'callCount')
      .addSelect('SUM(ur.cost_cny)', 'totalRevenue')
      .groupBy('ur.service_key, ur.service_type')
      .orderBy('COUNT(*)', 'DESC')
      .limit(10)
      .getRawMany();

    return {
      services: result.map(r => ({
        serviceKey: r.serviceKey,
        serviceType: r.serviceType,
        callCount: parseInt(r.callCount),
        totalRevenueCny: parseFloat(r.totalRevenue),
        currency: 'CNY'
      }))
    };
  }
}
```

### 6.2 åå°ç®¡ç†å‰ç«¯é¡µé¢ç»“æ„

```
packages/admin-ui/  ï¼ˆæ–°å»ºç®¡ç†åå°å‰ç«¯ï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”œâ”€â”€ Dashboard.vue              // ç³»ç»Ÿæ¦‚è§ˆ
â”‚   â”‚   â”œâ”€â”€ PlatformServices/
â”‚   â”‚   â”‚   â”œâ”€â”€ AIModels.vue           // AI æ¨¡å‹ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ RagServices.vue        // RAG æœåŠ¡ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ CreateService.vue      // åˆ›å»ºæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ Workspaces/
â”‚   â”‚   â”‚   â”œâ”€â”€ List.vue               // å·¥ä½œç©ºé—´åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ Detail.vue             // å·¥ä½œç©ºé—´è¯¦æƒ…
â”‚   â”‚   â”‚   â””â”€â”€ Usage.vue              // ä½¿ç”¨é‡æŸ¥çœ‹
â”‚   â”‚   â”œâ”€â”€ Users/
â”‚   â”‚   â”‚   â”œâ”€â”€ List.vue               // ç”¨æˆ·åˆ—è¡¨
â”‚   â”‚   â”‚   â””â”€â”€ Detail.vue             // ç”¨æˆ·è¯¦æƒ…
â”‚   â”‚   â”œâ”€â”€ Billing/
â”‚   â”‚   â”‚   â”œâ”€â”€ Revenue.vue            // æ”¶å…¥ç»Ÿè®¡
â”‚   â”‚   â”‚   â”œâ”€â”€ UsageRecords.vue       // ä½¿ç”¨è®°å½•
â”‚   â”‚   â”‚   â””â”€â”€ Recharge.vue           // å……å€¼ç®¡ç†
â”‚   â”‚   â””â”€â”€ Settings/
â”‚   â”‚       â”œâ”€â”€ Pricing.vue            // å®šä»·è®¾ç½®
â”‚   â”‚       â””â”€â”€ System.vue             // ç³»ç»Ÿè®¾ç½®
â”‚   â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ stores/
â”‚   â””â”€â”€ api/
```

---

## ğŸ¨ ä¸ƒã€å‰ç«¯å±‚æ”¹é€ 

### 7.1 WorkspaceSwitcherï¼ˆå¯¹æ ‡ Cozeï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/editor-ui/src/components/WorkspaceSwitcher.vue`

```vue
<template>
  <div class="workspace-switcher">
    <el-dropdown @command="handleSwitch" trigger="click" size="large">
      <div class="current-workspace">
        <div class="workspace-icon">{{ currentWorkspace?.icon?.value || 'ğŸ“' }}</div>
        <div class="workspace-info">
          <div class="workspace-name">{{ currentWorkspace?.name || 'é€‰æ‹©å·¥ä½œç©ºé—´' }}</div>
          <div class="workspace-balance" :class="{ 'low': isLowBalance }">
            ä½™é¢: Â¥{{ currentBalance.toFixed(2) }}
          </div>
        </div>
        <i class="el-icon-arrow-down"></i>
      </div>

      <template #dropdown>
        <el-dropdown-menu>
          <!-- ä¸ªäººç©ºé—´ -->
          <el-dropdown-item disabled divided>ä¸ªäººç©ºé—´</el-dropdown-item>
          <el-dropdown-item
            v-for="ws in personalWorkspaces"
            :key="ws.id"
            :command="ws.id"
            :class="{ 'is-active': ws.id === currentWorkspaceId }"
          >
            <div class="workspace-item">
              <span>{{ ws.icon?.value || 'ğŸ‘¤' }} {{ ws.name }}</span>
              <span class="balance-tag" :class="{ 'low': ws.balanceCny < 10 }">
                Â¥{{ ws.balanceCny.toFixed(2) }}
              </span>
            </div>
          </el-dropdown-item>

          <!-- å›¢é˜Ÿç©ºé—´ -->
          <el-dropdown-item disabled divided>å›¢é˜Ÿç©ºé—´</el-dropdown-item>
          <el-dropdown-item
            v-for="ws in teamWorkspaces"
            :key="ws.id"
            :command="ws.id"
            :class="{ 'is-active': ws.id === currentWorkspaceId }"
          >
            <div class="workspace-item">
              <span>{{ ws.icon?.value || 'ğŸ¢' }} {{ ws.name }}</span>
              <span class="balance-tag" :class="{ 'low': ws.balanceCny < 10 }">
                Â¥{{ ws.balanceCny.toFixed(2) }}
              </span>
            </div>
          </el-dropdown-item>

          <el-dropdown-item divided @click="createWorkspace">
            <i class="el-icon-plus"></i> åˆ›å»ºå›¢é˜Ÿç©ºé—´
          </el-dropdown-item>
        </el-dropdown-menu>
      </template>
    </el-dropdown>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { storeToRefs } from 'pinia';
import { useProjectsStore } from '@/stores/projects.store';
import { useRouter } from 'vue-router';

const projectsStore = useProjectsStore();
const router = useRouter();

const { currentWorkspace, currentWorkspaceId, personalWorkspaces, teamWorkspaces } = storeToRefs(projectsStore);

const currentBalance = computed(() => currentWorkspace.value?.balanceCny || 0);
const isLowBalance = computed(() => currentBalance.value < (currentWorkspace.value?.lowBalanceThreshold || 100));

function handleSwitch(workspaceId: string) {
  projectsStore.setActiveWorkspace(workspaceId);
}

function createWorkspace() {
  router.push('/workspaces/new');
}
</script>

<style scoped>
.current-workspace {
  display: flex;
  align-items: center;
  gap: var(--spacing--xs);
  padding: var(--spacing--xs) var(--spacing--sm);
  cursor: pointer;
  border-radius: var(--radius);
  transition: background-color 0.2s;
}

.workspace-balance {
  font-size: var(--font-size--2xs);
  color: var(--color--text--tint-2);
}

.workspace-balance.low {
  color: var(--color--danger);
  font-weight: var(--font-weight--bold);
}

.balance-tag {
  margin-left: auto;
  padding: 2px var(--spacing--3xs);
  background: var(--color--success--tint-4);
  color: var(--color--success--shade-1);
  border-radius: var(--radius--sm);
  font-size: var(--font-size--3xs);
}

.balance-tag.low {
  background: var(--color--danger--tint-3);
  color: var(--color--danger);
}
</style>
```

### 7.2 UsageViewï¼ˆè´¦å•ä¸­å¿ƒï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/editor-ui/src/views/UsageView.vue`

```vue
<template>
  <div class="usage-view">
    <!-- ä½™é¢å¡ç‰‡ -->
    <el-card class="balance-card">
      <template #header>
        <div class="card-header">
          <h2>è´¦æˆ·ä½™é¢</h2>
          <el-button type="primary" @click="showRechargeDialog = true">
            å……å€¼
          </el-button>
        </div>
      </template>

      <div class="balance-display">
        <div class="balance-amount" :class="{ 'low': isLowBalance }">
          Â¥{{ currentBalance.toFixed(2) }}
        </div>
        <div class="balance-info">
          <span>å¸ç§: äººæ°‘å¸ (CNY)</span>
          <span>ä½ä½™é¢è­¦å‘Šé˜ˆå€¼: Â¥{{ lowBalanceThreshold.toFixed(2) }}</span>
        </div>
      </div>

      <el-alert
        v-if="isLowBalance"
        type="warning"
        title="ä½™é¢ä¸è¶³ï¼Œè¯·åŠæ—¶å……å€¼ä»¥é¿å…æœåŠ¡ä¸­æ–­"
        :closable="false"
        show-icon
      />
    </el-card>

    <!-- æœˆåº¦ä½¿ç”¨ç»Ÿè®¡ -->
    <el-card class="usage-card">
      <template #header>
        <div class="card-header">
          <h2>ä½¿ç”¨ç»Ÿè®¡</h2>
          <el-date-picker
            v-model="selectedMonth"
            type="month"
            placeholder="é€‰æ‹©æœˆä»½"
            format="YYYY-MM"
            @change="fetchMonthlyUsage"
          />
        </div>
      </template>

      <el-table :data="monthlyUsage" style="width: 100%" :default-sort="{ prop: 'totalCostCny', order: 'descending' }">
        <el-table-column prop="serviceKey" label="æœåŠ¡" width="200" />
        <el-table-column prop="serviceType" label="ç±»å‹" width="120">
          <template #default="{ row }">
            <el-tag :type="getServiceTypeColor(row.serviceType)">
              {{ getServiceTypeName(row.serviceType) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="totalTokens" label="Tokens ä½¿ç”¨" width="150">
          <template #default="{ row }">
            {{ row.totalTokens ? row.totalTokens.toLocaleString() : '-' }}
          </template>
        </el-table-column>
        <el-table-column prop="totalCalls" label="è°ƒç”¨æ¬¡æ•°" width="120">
          <template #default="{ row }">
            {{ row.totalCalls || '-' }}
          </template>
        </el-table-column>
        <el-table-column prop="totalCostCny" label="è´¹ç”¨ï¼ˆÂ¥ï¼‰" sortable>
          <template #default="{ row }">
            Â¥{{ row.totalCostCny.toFixed(2) }}
          </template>
        </el-table-column>
      </el-table>

      <div class="total-summary">
        <span class="summary-label">æœ¬æœˆæ€»è´¹ç”¨:</span>
        <span class="summary-value">Â¥{{ totalMonthCost.toFixed(2) }}</span>
      </div>
    </el-card>

    <!-- å……å€¼å¯¹è¯æ¡† -->
    <el-dialog v-model="showRechargeDialog" title="è´¦æˆ·å……å€¼" width="500px">
      <el-form :model="rechargeForm" label-width="100px">
        <el-form-item label="å……å€¼é‡‘é¢">
          <el-input-number
            v-model="rechargeForm.amount"
            :min="10"
            :step="10"
            :precision="2"
          />
          <span class="input-suffix">å…ƒ</span>
        </el-form-item>

        <el-form-item label="æ”¯ä»˜æ–¹å¼">
          <el-radio-group v-model="rechargeForm.paymentMethod">
            <el-radio label="alipay">
              <img src="@/assets/alipay-icon.png" class="payment-icon" />
              æ”¯ä»˜å®
            </el-radio>
            <el-radio label="wechat">
              <img src="@/assets/wechat-icon.png" class="payment-icon" />
              å¾®ä¿¡æ”¯ä»˜
            </el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item>
          <el-alert
            type="info"
            title="å……å€¼åä½™é¢å°†ç«‹å³åˆ°è´¦ï¼Œå¯ç”¨äºå¹³å°æ‰€æœ‰ä»˜è´¹æœåŠ¡"
            :closable="false"
            show-icon
          />
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="showRechargeDialog = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleRecharge" :loading="recharging">
          ç«‹å³æ”¯ä»˜ Â¥{{ rechargeForm.amount.toFixed(2) }}
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { storeToRefs } from 'pinia';
import { useProjectsStore } from '@/stores/projects.store';
import { usageApi } from '@/api/usage';

const projectsStore = useProjectsStore();
const { currentWorkspace, currentWorkspaceId } = storeToRefs(projectsStore);

const currentBalance = computed(() => currentWorkspace.value?.balanceCny || 0);
const lowBalanceThreshold = computed(() => currentWorkspace.value?.lowBalanceThreshold || 100);
const isLowBalance = computed(() => currentBalance.value <= lowBalanceThreshold.value);

const selectedMonth = ref(new Date());
const monthlyUsage = ref([]);
const totalMonthCost = ref(0);

const showRechargeDialog = ref(false);
const recharging = ref(false);
const rechargeForm = ref({
  amount: 100,
  paymentMethod: 'alipay'
});

onMounted(() => {
  fetchMonthlyUsage();
});

async function fetchMonthlyUsage() {
  const month = selectedMonth.value.toISOString().slice(0, 7);
  const result = await usageApi.getMonthlyBill(currentWorkspaceId.value, month);

  monthlyUsage.value = result.items;
  totalMonthCost.value = result.totalCostCny;
}

async function handleRecharge() {
  recharging.value = true;

  try {
    // è°ƒç”¨å……å€¼ APIï¼ˆè¿™é‡Œåº”è¯¥è·³è½¬åˆ°æ”¯ä»˜é¡µé¢ï¼‰
    const paymentUrl = await usageApi.createRecharge(
      currentWorkspaceId.value,
      rechargeForm.value.amount,
      rechargeForm.value.paymentMethod
    );

    // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
    window.open(paymentUrl, '_blank');

    showRechargeDialog.value = false;
  } finally {
    recharging.value = false;
  }
}

function getServiceTypeColor(type: string) {
  const colors = {
    ai_model: 'primary',
    rag_service: 'success',
    embeddings: 'info',
    tts: 'warning',
    stt: 'warning',
    image_gen: 'danger'
  };
  return colors[type] || '';
}

function getServiceTypeName(type: string) {
  const names = {
    ai_model: 'AI æ¨¡å‹',
    rag_service: 'RAG æœåŠ¡',
    embeddings: 'å‘é‡åŒ–',
    tts: 'æ–‡å­—è½¬è¯­éŸ³',
    stt: 'è¯­éŸ³è½¬æ–‡å­—',
    image_gen: 'å›¾ç‰‡ç”Ÿæˆ'
  };
  return names[type] || type;
}
</script>

<style scoped>
.usage-view {
  padding: var(--spacing--lg);
  max-width: 1200px;
  margin: 0 auto;
}

.balance-card {
  margin-bottom: var(--spacing--lg);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.balance-display {
  text-align: center;
  padding: var(--spacing--xl) 0;
}

.balance-amount {
  font-size: var(--font-size--2xl);
  font-weight: var(--font-weight--bold);
  color: var(--color--success);
  margin-bottom: var(--spacing--xs);
}

.balance-amount.low {
  color: var(--color--danger);
}

.total-summary {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-top: var(--spacing--md);
  padding: var(--spacing--sm);
  background: var(--color--background--light-2);
  border-radius: var(--radius);
}

.summary-value {
  font-size: var(--font-size--xl);
  font-weight: var(--font-weight--bold);
  color: var(--color--primary);
  margin-left: var(--spacing--sm);
}

.payment-icon {
  width: 24px;
  height: 24px;
  margin-right: var(--spacing--3xs);
  vertical-align: middle;
}
</style>
```

### 7.3 RegisterViewï¼ˆç”¨æˆ·æ³¨å†Œé¡µé¢ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/editor-ui/src/views/auth/RegisterView.vue`

```vue
<template>
  <div class="register-view">
    <el-card class="register-card">
      <template #header>
        <h2>æ³¨å†Œ n8n è´¦æˆ·</h2>
        <p class="subtitle">æ³¨å†Œå³é€ Â¥10ï¼Œç«‹å³å¼€å§‹è‡ªåŠ¨åŒ–ä¹‹æ—…</p>
      </template>

      <el-form :model="form" :rules="rules" ref="formRef" label-position="top">
        <el-form-item label="é‚®ç®±" prop="email">
          <el-input v-model="form.email" placeholder="your@email.com" />
        </el-form-item>

        <el-form-item label="å¯†ç " prop="password">
          <el-input v-model="form.password" type="password" placeholder="è‡³å°‘ 8 ä½" show-password />
        </el-form-item>

        <el-form-item label="å§“å" prop="firstName">
          <el-input v-model="form.firstName" placeholder="æ‚¨çš„åå­—" />
        </el-form-item>

        <el-form-item label="é‚€è¯·ç ï¼ˆå¯é€‰ï¼‰" prop="inviteCode">
          <el-input v-model="form.inviteCode" placeholder="æœ‰é‚€è¯·ç ï¼ŸåŒæ–¹å„å¾— Â¥5" />
        </el-form-item>

        <el-form-item>
          <el-checkbox v-model="form.agreedToTerms">
            æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="/terms" target="_blank">æœåŠ¡æ¡æ¬¾</a> å’Œ <a href="/privacy" target="_blank">éšç§æ”¿ç­–</a>
          </el-checkbox>
        </el-form-item>

        <el-button
          type="primary"
          size="large"
          :loading="loading"
          :disabled="!form.agreedToTerms"
          @click="handleRegister"
          block
        >
          å…è´¹æ³¨å†Œ
        </el-button>
      </el-form>

      <div class="oauth-divider"><span>æˆ–ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ³¨å†Œ</span></div>

      <div class="oauth-buttons">
        <el-button @click="oauthLogin('wechat')">å¾®ä¿¡ç™»å½•</el-button>
        <el-button @click="oauthLogin('github')">GitHub ç™»å½•</el-button>
      </div>

      <div class="login-link">å·²æœ‰è´¦æˆ·ï¼Ÿ<router-link to="/login">ç«‹å³ç™»å½•</router-link></div>
    </el-card>

    <!-- æ³¨å†ŒæˆåŠŸå¼•å¯¼ -->
    <el-dialog v-model="showSuccessDialog" title="ğŸ‰ æ³¨å†ŒæˆåŠŸï¼" width="500px">
      <div class="success-content">
        <p>æ­å–œæ‚¨æˆåŠŸæ³¨å†Œ n8n è´¦æˆ·ï¼</p>
        <ul>
          <li>âœ… å·²ä¸ºæ‚¨åˆ›å»ºä¸ªäººå·¥ä½œç©ºé—´</li>
          <li>âœ… èµ é€ Â¥{{ initialBonus }} ä½™é¢</li>
          <li>âœ… å®Œæˆæ–°æ‰‹ä»»åŠ¡å¯å†è·å¾— Â¥15</li>
        </ul>
        <el-alert type="warning" title="è¯·éªŒè¯é‚®ç®±ä»¥äº«å—å®Œæ•´åŠŸèƒ½" :closable="false" show-icon />
      </div>
      <template #footer>
        <el-button type="primary" @click="goToOnboarding">å¼€å§‹ä½¿ç”¨</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { useRouter } from 'vue-router';
import { authApi } from '@/api/auth';

const router = useRouter();
const formRef = ref();
const loading = ref(false);
const showSuccessDialog = ref(false);
const initialBonus = ref(10);

const form = ref({
  email: '',
  password: '',
  firstName: '',
  inviteCode: '',
  agreedToTerms: false
});

const rules = {
  email: [{ required: true, type: 'email', message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±' }],
  password: [{ required: true, min: 8, message: 'å¯†ç è‡³å°‘ 8 ä½' }],
  firstName: [{ required: true, message: 'è¯·è¾“å…¥å§“å' }]
};

async function handleRegister() {
  const valid = await formRef.value.validate();
  if (!valid) return;

  loading.value = true;
  try {
    const result = await authApi.register(form.value);
    localStorage.setItem('token', result.token);
    if (form.value.inviteCode) initialBonus.value = 15;
    showSuccessDialog.value = true;
  } catch (error) {
    ElMessage.error(error.message || 'æ³¨å†Œå¤±è´¥');
  } finally {
    loading.value = false;
  }
}

function goToOnboarding() {
  router.push('/onboarding');
}

function oauthLogin(provider: 'wechat' | 'github') {
  window.location.href = `/api/auth/oauth/${provider}`;
}
</script>

<style scoped>
.register-view {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: var(--color--background--light-2);
}

.register-card {
  width: 100%;
  max-width: 500px;
}

.subtitle {
  color: var(--color--text--tint-2);
  margin-top: var(--spacing--xs);
}

.oauth-divider {
  text-align: center;
  margin: var(--spacing--lg) 0;
  color: var(--color--text--tint-2);
}

.oauth-buttons {
  display: flex;
  gap: var(--spacing--sm);
}

.login-link {
  text-align: center;
  margin-top: var(--spacing--md);
  color: var(--color--text--tint-2);
}
</style>
```

---

## ğŸ“… å…«ã€æ¿€è¿›å®æ–½è®¡åˆ’ï¼ˆ17-18å‘¨ï¼‰

### Week 1-2: æ•°æ®åº“å±‚æ”¹é€ 
**ç›®æ ‡ï¼š** å®Œæˆæ•°æ®åº“ç»“æ„å˜æ›´

- [ ] æ‰§è¡Œ SQL è¿ç§»è„šæœ¬
- [ ] æ‰©å±• User è¡¨ï¼ˆé‚®ç®±éªŒè¯ã€OAuthã€Onboarding ç­‰ï¼‰
- [ ] æ·»åŠ  execution_entity å’Œ variables_entity çš„ project_id
- [ ] ç›´æ¥åˆ é™¤ SharedWorkflow/SharedCredentials è¡¨
- [ ] åˆ›å»ºè®¡è´¹ç³»ç»Ÿè¡¨
- [ ] åˆ›å»ºå¹³å° RAG æœåŠ¡è¡¨
- [ ] åˆ›å»ºç”¨æˆ·æ³¨å†Œç³»ç»Ÿè¡¨ï¼ˆé‚€è¯·ç ã€å®¡è®¡æ—¥å¿—ã€é…é¢ã€æ³¨å†Œç»Ÿè®¡ï¼‰
- [ ] æ•°æ®å®Œæ•´æ€§æµ‹è¯•

**äº¤ä»˜ç‰©ï¼š**
- âœ… æ•°æ®åº“ç»“æ„ç¬¦åˆè®¾è®¡
- âœ… æ‰€æœ‰ç´¢å¼•åˆ›å»ºå®Œæˆ
- âœ… ç¤ºä¾‹æ•°æ®æ’å…¥æˆåŠŸ

### Week 3-5: Repository + Service å±‚
**ç›®æ ‡ï¼š** æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°

- [ ] å®ç° UserServiceï¼ˆå®Œæ•´æ³¨å†Œæµç¨‹ï¼‰
- [ ] å®ç° EmailVerificationService
- [ ] å®ç° OnboardingService
- [ ] é‡å†™ WorkflowRepositoryï¼ˆåˆ é™¤ SharedWorkflow å¼•ç”¨ï¼‰
- [ ] é‡å†™ CredentialsRepository
- [ ] å®ç° BillingService
- [ ] å®ç° PlatformRagService
- [ ] å®ç° VectorStoreService
- [ ] å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ > 80%ï¼‰

**äº¤ä»˜ç‰©ï¼š**
- âœ… Repository æŸ¥è¯¢æ­£ç¡®
- âœ… Service ä¸šåŠ¡é€»è¾‘å®Œæ•´
- âœ… å•å…ƒæµ‹è¯•é€šè¿‡

### Week 6-8: API å±‚
**ç›®æ ‡ï¼š** REST API å®ç°

- [ ] AuthControllerï¼ˆæ³¨å†Œã€ç™»å½•ã€é‚®ç®±éªŒè¯ï¼‰
- [ ] OAuthControllerï¼ˆå¾®ä¿¡ã€GitHub ç™»å½•ï¼‰
- [ ] OnboardingController
- [ ] WorkspacesController
- [ ] RagController
- [ ] AdminPlatformServicesController
- [ ] AdminWorkspacesController
- [ ] AdminStatsController
- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] é›†æˆæµ‹è¯•

**äº¤ä»˜ç‰©ï¼š**
- âœ… API æ¥å£å¯è°ƒç”¨
- âœ… Swagger æ–‡æ¡£å®Œæ•´
- âœ… é›†æˆæµ‹è¯•é€šè¿‡

### Week 9-12: å‰ç«¯å±‚
**ç›®æ ‡ï¼š** ç”¨æˆ·ç•Œé¢å®ç°

- [ ] RegisterViewï¼ˆç”¨æˆ·æ³¨å†Œé¡µé¢ï¼‰
- [ ] OnboardingViewï¼ˆæ–°æ‰‹å¼•å¯¼é¡µé¢ï¼‰
- [ ] EmailVerificationViewï¼ˆé‚®ç®±éªŒè¯é¡µé¢ï¼‰
- [ ] WorkspaceSwitcher ç»„ä»¶
- [ ] UsageViewï¼ˆè´¦å•ä¸­å¿ƒï¼‰
- [ ] WorkflowsView é‡æ„ï¼ˆå·¥ä½œç©ºé—´éš”ç¦»ï¼‰
- [ ] CredentialsView é‡æ„ï¼ˆå·¥ä½œç©ºé—´éš”ç¦»ï¼‰
- [ ] RagServicesViewï¼ˆå¹³å° RAG æœåŠ¡åˆ—è¡¨ï¼‰
- [ ] å·¥ä½œç©ºé—´åˆ‡æ¢äº¤äº’ä¼˜åŒ–
- [ ] è·¯ç”±å®ˆå«ï¼ˆæƒé™éªŒè¯ï¼‰

**äº¤ä»˜ç‰©ï¼š**
- âœ… å·¥ä½œç©ºé—´åˆ‡æ¢æµç•…
- âœ… ä½™é¢æ˜¾ç¤ºæ­£ç¡®
- âœ… è´¦å•æ•°æ®å±•ç¤ºå®Œæ•´

### Week 13-14: åå°ç®¡ç†ç³»ç»Ÿ
**ç›®æ ‡ï¼š** ç®¡ç†åå°å®ç°

- [ ] ç®¡ç†åå°å‰ç«¯æ¡†æ¶æ­å»º
- [ ] å¹³å°æœåŠ¡ç®¡ç†é¡µé¢
- [ ] å·¥ä½œç©ºé—´ç®¡ç†é¡µé¢
- [ ] ç”¨æˆ·ç®¡ç†é¡µé¢
- [ ] ç»Ÿè®¡æŠ¥è¡¨é¡µé¢
- [ ] æƒé™æ§åˆ¶

**äº¤ä»˜ç‰©ï¼š**
- âœ… ç®¡ç†åå°å¯ç”¨
- âœ… æ•°æ®å¯è§†åŒ–æ¸…æ™°
- âœ… æ“ä½œå®¡è®¡æ—¥å¿—å®Œæ•´

### Week 15-16: æµ‹è¯• + ä¸Šçº¿
**ç›®æ ‡ï¼š** å…¨æµç¨‹æµ‹è¯•å’Œéƒ¨ç½²

- [ ] å…¨æµç¨‹ E2E æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆæŸ¥è¯¢ä¼˜åŒ–éªŒè¯ï¼‰
- [ ] å®‰å…¨æµ‹è¯•ï¼ˆæƒé™ã€SQLæ³¨å…¥ç­‰ï¼‰
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆå¹¶å‘åœºæ™¯ï¼‰
- [ ] ç°åº¦å‘å¸ƒå‡†å¤‡
- [ ] ç›‘æ§å‘Šè­¦é…ç½®

**äº¤ä»˜ç‰©ï¼š**
- âœ… æµ‹è¯•æŠ¥å‘Š
- âœ… æ€§èƒ½åŸºå‡†è¾¾æ ‡
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å°±ç»ª

---

## âš ï¸ ä¹ã€é£é™©æ§åˆ¶

### 9.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|----------|
| åˆ é™¤ SharedWorkflow å½±å“æœªçŸ¥ä»£ç  | é«˜ | å…¨å±€æœç´¢ + ä»£ç å®¡æŸ¥ + å……åˆ†æµ‹è¯• |
| å¹¶å‘æ‰£è´¹å¯¼è‡´ä½™é¢é€æ”¯ | ä¸­ | ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ + æ‚²è§‚é” |
| RAG æœåŠ¡å“åº”æ…¢ | ä¸­ | å‘é‡æ•°æ®åº“ä¼˜åŒ– + ç¼“å­˜ + å¼‚æ­¥å¤„ç† |
| æ”¯ä»˜é›†æˆå¤æ‚ | ä½ | å…ˆå®ç°æ‰‹åŠ¨å……å€¼ï¼Œæ”¯ä»˜åæœŸè¿­ä»£ |

### 9.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|----------|
| è®¡è´¹é”™è¯¯å¯¼è‡´çº çº· | é«˜ | è¯¦ç»†çš„ä½¿ç”¨è®°å½• + å¯è¿½æº¯ + æµ‹è¯•å……åˆ† |
| ä½™é¢ä¸è¶³å½±å“ç”¨æˆ·ä½“éªŒ | ä¸­ | ä½ä½™é¢è­¦å‘Š + è‡ªåŠ¨é€šçŸ¥ |
| å¹³å° RAG æœåŠ¡è´¨é‡å·® | ä¸­ | å……åˆ†æµ‹è¯• + ç”¨æˆ·åé¦ˆæ¸ é“ |

---

## âœ… åã€æˆåŠŸæ ‡å‡†

### 10.1 åŠŸèƒ½å®Œæ•´æ€§

- âœ… ç”¨æˆ·æ³¨å†Œåè‡ªåŠ¨åˆ›å»ºä¸ªäººç©ºé—´
- âœ… å¯åˆ›å»ºå›¢é˜Ÿç©ºé—´å¹¶é‚€è¯·æˆå‘˜
- âœ… å·¥ä½œç©ºé—´åˆ‡æ¢æµç•…ï¼ˆ< 500msï¼‰
- âœ… æƒé™æ§åˆ¶æ­£ç¡®ï¼ˆAdmin/Editor/Viewerï¼‰
- âœ… æ•°æ®å®Œå…¨éš”ç¦»ï¼ˆè·¨ç©ºé—´ä¸å¯è§ï¼‰
- âœ… AI æœåŠ¡æŒ‰é‡è®¡è´¹å‡†ç¡®
- âœ… å¹³å° RAG æœåŠ¡å¯ç”¨
- âœ… ä½™é¢ç®¡ç†åŠŸèƒ½å®Œæ•´
- âœ… åå°ç®¡ç†ç³»ç»Ÿå¯ç”¨

### 10.2 æ€§èƒ½æŒ‡æ ‡

- âœ… å·¥ä½œæµåˆ—è¡¨æŸ¥è¯¢ < 100msï¼ˆvs åŸæ¥ 150msï¼Œæå‡ 33%ï¼‰
- âœ… å·¥ä½œç©ºé—´åˆ‡æ¢ < 500ms
- âœ… ä½™é¢æ‰£è´¹ < 50ms
- âœ… RAG æŸ¥è¯¢å“åº” < 2s
- âœ… å¹¶å‘ 100 ç”¨æˆ·æ— å‹åŠ›

### 10.3 å®‰å…¨æ€§

- âœ… è·¨å·¥ä½œç©ºé—´æ•°æ®å®Œå…¨éš”ç¦»
- âœ… æƒé™ç»•è¿‡æ¼æ´æ£€æŸ¥é€šè¿‡
- âœ… API Key åŠ å¯†å­˜å‚¨
- âœ… SQL æ³¨å…¥æ£€æŸ¥é€šè¿‡
- âœ… XSS æ”»å‡»é˜²æŠ¤

---

## ğŸ“š åä¸€ã€é™„å½•

### 11.1 å…³é”®æ–‡ä»¶è·¯å¾„æ¸…å•

**æ•°æ®åº“å±‚ï¼š**
```
packages/@n8n/db/src/
â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ project.ts ï¼ˆæ‰©å±•ï¼‰
â”‚   â”œâ”€â”€ workflow-entity.ts ï¼ˆæ·»åŠ  projectIdï¼‰
â”‚   â”œâ”€â”€ credentials-entity.ts ï¼ˆæ·»åŠ  projectIdï¼‰
â”‚   â”œâ”€â”€ platform-service.ts ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ platform-rag-service.ts ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ usage-record.ts ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ monthly-usage-summary.ts ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ workflow.repository.ts ï¼ˆé‡å†™ï¼‰
â”‚   â”œâ”€â”€ credentials.repository.ts ï¼ˆé‡å†™ï¼‰
â”‚   â”œâ”€â”€ platform-service.repository.ts ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ platform-rag-service.repository.ts ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ migrations/
    â””â”€â”€ 1736236800000-AggressiveMultiTenantRefactor.ts
```

**åç«¯å±‚ï¼š**
```
packages/cli/src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ billing.service.ts ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ platform-rag.service.ts ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ vector-store.service.ts ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ project.service.ee.ts ï¼ˆç®€åŒ–ï¼‰
â”‚   â””â”€â”€ workflow.service.ts ï¼ˆç®€åŒ–ï¼‰
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ workspaces.controller.ts ï¼ˆç®€åŒ–ï¼‰
â”‚   â”œâ”€â”€ rag.controller.ts ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ admin/
â”‚       â”œâ”€â”€ platform-services.controller.ts ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ workspaces.controller.ts ï¼ˆæ–°å¢ï¼‰
â”‚       â””â”€â”€ stats.controller.ts ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ middlewares/
    â””â”€â”€ workspace-context.middleware.ts ï¼ˆç®€åŒ–ï¼‰
```

**å‰ç«¯å±‚ï¼š**
```
packages/editor-ui/src/
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ projects.store.ts ï¼ˆæ‰©å±•ï¼‰
â”œâ”€â”€ components/
â”‚   â””â”€â”€ WorkspaceSwitcher.vue ï¼ˆå¯¹æ ‡ Cozeï¼‰
â””â”€â”€ views/
    â”œâ”€â”€ UsageView.vue ï¼ˆæ–°å¢ï¼‰
    â”œâ”€â”€ RagServicesView.vue ï¼ˆæ–°å¢ï¼‰
    â””â”€â”€ WorkflowsView.vue ï¼ˆç›‘å¬å·¥ä½œç©ºé—´åˆ‡æ¢ï¼‰
```

**ç®¡ç†åå°ï¼š**
```
packages/admin-ui/  ï¼ˆå…¨æ–°ï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”œâ”€â”€ Dashboard.vue
â”‚   â”‚   â”œâ”€â”€ PlatformServices/
â”‚   â”‚   â”œâ”€â”€ Workspaces/
â”‚   â”‚   â”œâ”€â”€ Users/
â”‚   â”‚   â”œâ”€â”€ Billing/
â”‚   â”‚   â””â”€â”€ Settings/
â”‚   â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ stores/
â”‚   â””â”€â”€ api/
```

### 11.2 æœ¯è¯­å¯¹ç…§è¡¨

| Coze æœ¯è¯­ | n8n æ”¹é€ å | æ•°æ®åº“è¡¨/å­—æ®µ |
|----------|-----------|-------------|
| Workspace | Project | project |
| Personal Workspace | Project (type='personal') | project.type |
| Team Workspace | Project (type='team') | project.type |
| Bot | Workflow | workflow_entity |
| Knowledge Base | ä¸åšå¹³å°æä¾› | - |
| Plugin | å¹³å° RAG æœåŠ¡ | platform_rag_services |
| Member | ProjectRelation | project_relation |
| Admin/Editor/Viewer | role | project_relation.role |
| Balance | balanceCny | project.balance_cny |
| Usage | usageRecords | usage_records |

---

## ğŸ¯ åäºŒã€ä¼ä¸šç‰ˆåŠŸèƒ½ç®¡ç†æ–¹æ¡ˆ

### 12.1 ç°çŠ¶è¯´æ˜

å½“å‰å•ç§Ÿæˆ·ç‰ˆæœ¬å·²è§£é”æ‰€æœ‰ n8n ä¼ä¸šç‰ˆåŠŸèƒ½ï¼ˆè¯¦è§ `/docs/FEATURES.md`ï¼‰ï¼ŒåŒ…æ‹¬ï¼š
- âœ… LDAP/SAML/OIDC å•ç‚¹ç™»å½•
- âœ… å¤šå› ç´ è®¤è¯ (MFA)
- âœ… å·¥ä½œæµç‰ˆæœ¬å†å²ï¼ˆæ— é™åˆ¶ï¼‰
- âœ… å¤–éƒ¨å¯†é’¥ç®¡ç†
- âœ… æ—¥å¿—æµ (Log Streaming)
- âœ… Insights åˆ†æï¼ˆæ— æ—¥æœŸé™åˆ¶ï¼‰
- âœ… Worker View
- âœ… ç¯å¢ƒå˜é‡ç®¡ç†ï¼ˆæ— é™åˆ¶ï¼‰
- âœ… Public APIï¼ˆå®Œå…¨å¼€æ”¾ï¼‰
- âœ… å®¡è®¡æ—¥å¿—
- âœ… è‡ªå®šä¹‰è§’è‰²

**æ”¹é€ ä¸ºå¤šç§Ÿæˆ·åçš„æ ¸å¿ƒé—®é¢˜ï¼š** è¿™äº›åŠŸèƒ½åº”è¯¥å¦‚ä½•ç®¡ç†ï¼Ÿæ˜¯å¦éœ€è¦é™åˆ¶ï¼Ÿç”±è°æ¥æ§åˆ¶ï¼Ÿ

### 12.2 åŠŸèƒ½ç®¡ç†åˆ†å±‚è®¾è®¡

#### åˆ†å±‚åŸåˆ™

å¤šç§Ÿæˆ· SaaS çš„åŠŸèƒ½ç®¡ç†åº”è¯¥åˆ†ä¸º **ä¸‰ä¸ªå±‚çº§**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚çº§1: å¹³å°ç®¡ç†å‘˜ï¼ˆå…¨å±€æ§åˆ¶ï¼‰              â”‚
â”‚ â””â”€ å½±å“æ•´ä¸ªå¹³å°ã€æ¶ˆè€—å¹³å°èµ„æºçš„åŠŸèƒ½        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å±‚çº§2: å·¥ä½œç©ºé—´ç®¡ç†å‘˜ï¼ˆå›¢é˜Ÿæ§åˆ¶ï¼‰          â”‚
â”‚ â””â”€ å·¥ä½œç©ºé—´çº§é…ç½®ã€å›¢é˜Ÿåä½œåŠŸèƒ½            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å±‚çº§3: æ™®é€šç”¨æˆ·ï¼ˆä¸ªäººæ§åˆ¶ï¼‰                â”‚
â”‚ â””â”€ ä¸ªäººåå¥½è®¾ç½®                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 åŠŸèƒ½åˆ†ç±»ä¸ç®¡ç†ç­–ç•¥

#### 12.3.1 å±‚çº§1ï¼šå¹³å°ç®¡ç†å‘˜æ§åˆ¶

è¿™äº›åŠŸèƒ½å½±å“**æ•´ä¸ªå¹³å°**æˆ–éœ€è¦**å¹³å°èµ„æº**ï¼Œå¿…é¡»ç”±å¹³å°ç®¡ç†å‘˜ç»Ÿä¸€æ§åˆ¶ï¼š

| åŠŸèƒ½ | å¤šç§Ÿæˆ·åå¤„ç† | ç®¡ç†æ–¹å¼ | ç†ç”± |
|------|------------|---------|------|
| **LDAP/SAML/OIDC** | âŒ å…¨å±€ç¦ç”¨ | åå°ç®¡ç†ç³»ç»Ÿå¼€å…³ | å°å›¢é˜Ÿ SaaS ç”¨ä¸ä¸Šï¼Œå¢åŠ å¤æ‚åº¦ |
| **å¤–éƒ¨å¯†é’¥ç®¡ç†** | âŒ å…¨å±€ç¦ç”¨ | åå°ç®¡ç†ç³»ç»Ÿå¼€å…³ | ä¸é€‚åˆå¤šç§Ÿæˆ· SaaS |
| **æ—¥å¿—æµ** | âŒ å…¨å±€ç¦ç”¨ | åå°ç®¡ç†ç³»ç»Ÿå¼€å…³ | å¹³å°è‡ªå·±çš„è¿ç»´åŠŸèƒ½ |
| **Worker View** | âš ï¸ ä»…ç®¡ç†å‘˜å¯è§ | åå°ç®¡ç†ç³»ç»Ÿç‹¬å  | å¹³å°è¿ç»´ç›‘æ§ |
| **Public API é™æµ** | âœ… å¹³å°é…ç½® | åå°ç®¡ç†ç³»ç»Ÿé…ç½® | é˜²æ­¢æ»¥ç”¨ï¼Œä¿æŠ¤å¹³å° |
| **å·¥ä½œæµç‰ˆæœ¬å†å²** | âœ… ä¿ç•™ï¼ˆæ— é™åˆ¶ï¼‰ | åå°ç®¡ç†ç³»ç»Ÿé…ç½®ä¿ç•™ç­–ç•¥ | æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†å¯é…ç½®æ¸…ç†ç­–ç•¥ |
| **Insights åˆ†æ** | âœ… ä¿ç•™ï¼ˆæ— é™åˆ¶ï¼‰ | æ— éœ€æ§åˆ¶ | æŸ¥çœ‹å†å²ä¸äº§ç”Ÿæˆæœ¬ |

**å®ç°æ–¹å¼ï¼š**

```sql
-- å¹³å°çº§åŠŸèƒ½å¼€å…³é…ç½®è¡¨
CREATE TABLE platform_feature_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feature_key VARCHAR(100) UNIQUE NOT NULL,  -- 'ldap', 'saml', 'log_streaming', 'public_api'

  -- å…¨å±€å¼€å…³
  enabled BOOLEAN DEFAULT FALSE,

  -- åŠŸèƒ½é…ç½®ï¼ˆJSONï¼‰
  config JSONB DEFAULT '{}',
  -- ä¾‹å¦‚: {
  --   "public_api": {
  --     "rate_limit_per_hour": 1000,
  --     "max_api_keys_per_workspace": 5
  --   },
  --   "workflow_history": {
  --     "retention_days": 90,  -- -1 è¡¨ç¤ºæ— é™åˆ¶
  --     "auto_cleanup_enabled": true
  --   }
  -- }

  description TEXT,
  updated_at TIMESTAMP DEFAULT NOW()
);

-- åˆå§‹åŒ–æ•°æ®
INSERT INTO platform_feature_config (feature_key, enabled, config, description) VALUES
('ldap', FALSE, '{}', 'LDAP å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('saml', FALSE, '{}', 'SAML å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('oidc', FALSE, '{}', 'OIDC å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('external_secrets', FALSE, '{}', 'å¤–éƒ¨å¯†é’¥ç®¡ç†ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('log_streaming', FALSE, '{}', 'æ—¥å¿—æµï¼ˆä»…å¹³å°ä½¿ç”¨ï¼‰'),
('worker_view', FALSE, '{}', 'Worker ç›‘æ§ï¼ˆä»…ç®¡ç†å‘˜ï¼‰'),
('public_api', TRUE, '{"rate_limit_per_hour": 1000, "max_api_keys": 5}', 'Public APIï¼ˆå¯ç”¨ + é™æµï¼‰'),
('workflow_history', TRUE, '{"retention_days": -1}', 'å·¥ä½œæµç‰ˆæœ¬å†å²ï¼ˆæ— é™åˆ¶ï¼‰'),
('insights', TRUE, '{"date_range_limit_days": -1}', 'Insights åˆ†æï¼ˆæ— é™åˆ¶ï¼‰'),
('audit_logs', TRUE, '{"retention_days": 365}', 'å®¡è®¡æ—¥å¿—ï¼ˆä¿ç•™1å¹´ï¼‰');
```

**åå°ç®¡ç†ç³»ç»Ÿ APIï¼š**

```typescript
// packages/cli/src/controllers/admin/platform-features.controller.ts
@RestController('/admin/platform-features')
@RequireRole('global:admin')
export class AdminPlatformFeaturesController {

  constructor(
    private readonly platformFeatureConfigRepository: PlatformFeatureConfigRepository,
    private readonly cacheService: CacheService
  ) {}

  /**
   * GET /admin/platform-features
   * è·å–æ‰€æœ‰åŠŸèƒ½é…ç½®
   */
  @Get('/')
  async listFeatures() {
    const features = await this.platformFeatureConfigRepository.find({
      order: { featureKey: 'ASC' }
    });

    return {
      features: features.map(f => ({
        featureKey: f.featureKey,
        enabled: f.enabled,
        config: f.config,
        description: f.description,
        updatedAt: f.updatedAt
      }))
    };
  }

  /**
   * PATCH /admin/platform-features/:key
   * æ›´æ–°åŠŸèƒ½é…ç½®
   */
  @Patch('/:key')
  async updateFeature(
    @Param('key') featureKey: string,
    @Body() data: {
      enabled?: boolean;
      config?: any;
    },
    @AuthUser() admin: User
  ) {
    const feature = await this.platformFeatureConfigRepository.findOne({
      where: { featureKey }
    });

    if (!feature) {
      throw new NotFoundError(`Feature ${featureKey} not found`);
    }

    // æ›´æ–°é…ç½®
    if (typeof data.enabled === 'boolean') {
      feature.enabled = data.enabled;
    }
    if (data.config) {
      feature.config = { ...feature.config, ...data.config };
    }
    feature.updatedAt = new Date();

    await this.platformFeatureConfigRepository.save(feature);

    // æ¸…é™¤ç¼“å­˜
    await this.cacheService.delete(`platform:feature:${featureKey}`);

    // è®°å½•æ“ä½œæ—¥å¿—
    await this.auditLogService.log({
      action: 'platform_feature_updated',
      userId: admin.id,
      metadata: {
        featureKey,
        enabled: feature.enabled,
        config: feature.config
      }
    });

    return { success: true, feature };
  }

  /**
   * GET /admin/platform-features/:key/usage
   * è·å–åŠŸèƒ½ä½¿ç”¨ç»Ÿè®¡
   */
  @Get('/:key/usage')
  async getFeatureUsage(
    @Param('key') featureKey: string,
    @Query('startDate') startDate?: string,
    @Query('endDate') endDate?: string
  ) {
    // ä¾‹å¦‚ï¼šç»Ÿè®¡ Public API çš„è°ƒç”¨é‡
    if (featureKey === 'public_api') {
      const stats = await this.usageRecordRepository
        .createQueryBuilder('ur')
        .select('ur.workspace_id', 'workspaceId')
        .addSelect('COUNT(*)', 'apiCalls')
        .where('ur.service_type = :type', { type: 'public_api' })
        .andWhere('ur.created_at BETWEEN :start AND :end', {
          start: startDate || new Date(Date.now() - 30 * 86400000),
          end: endDate || new Date()
        })
        .groupBy('ur.workspace_id')
        .orderBy('COUNT(*)', 'DESC')
        .limit(100)
        .getRawMany();

      return { stats };
    }

    return { message: 'Usage stats not available for this feature' };
  }
}
```

**åå°ç®¡ç†å‰ç«¯ç•Œé¢ï¼š**

```vue
<!-- packages/admin-ui/src/views/PlatformFeatures/FeaturesList.vue -->
<template>
  <div class="platform-features-page">
    <el-card>
      <template #header>
        <h2>å¹³å°åŠŸèƒ½ç®¡ç†</h2>
      </template>

      <el-table :data="features" style="width: 100%">
        <el-table-column prop="featureKey" label="åŠŸèƒ½æ ‡è¯†" width="200" />
        <el-table-column prop="description" label="è¯´æ˜" />

        <el-table-column label="çŠ¶æ€" width="120">
          <template #default="{ row }">
            <el-switch
              v-model="row.enabled"
              @change="handleToggle(row)"
              :disabled="isDisabledFeature(row.featureKey)"
            />
          </template>
        </el-table-column>

        <el-table-column label="é…ç½®" width="150">
          <template #default="{ row }">
            <el-button
              size="small"
              @click="showConfigDialog(row)"
              :disabled="!row.enabled"
            >
              é…ç½®
            </el-button>
          </template>
        </el-table-column>

        <el-table-column label="ä½¿ç”¨ç»Ÿè®¡" width="150">
          <template #default="{ row }">
            <el-button
              size="small"
              @click="showUsageStats(row)"
              v-if="hasUsageStats(row.featureKey)"
            >
              æŸ¥çœ‹
            </el-button>
            <span v-else>-</span>
          </template>
        </el-table-column>
      </el-table>

      <div class="features-summary">
        <el-alert type="info" :closable="false">
          <template #title>
            <strong>è¯´æ˜ï¼š</strong>
            <ul>
              <li>âŒ å·²ç¦ç”¨åŠŸèƒ½ï¼šLDAP/SAML/OIDCï¼ˆå°å›¢é˜Ÿ SaaS ç”¨ä¸ä¸Šï¼‰</li>
              <li>âŒ å·²ç¦ç”¨åŠŸèƒ½ï¼šå¤–éƒ¨å¯†é’¥ç®¡ç†ã€æ—¥å¿—æµï¼ˆä¸é€‚åˆå¤šç§Ÿæˆ·ï¼‰</li>
              <li>âœ… ä¿ç•™åŠŸèƒ½ï¼šå·¥ä½œæµç‰ˆæœ¬å†å²ã€Insights åˆ†æï¼ˆæ— é™åˆ¶ï¼‰</li>
              <li>âš ï¸ API é™æµï¼šé˜²æ­¢æ»¥ç”¨ï¼Œé»˜è®¤ 1000æ¬¡/å°æ—¶/å·¥ä½œç©ºé—´</li>
            </ul>
          </template>
        </el-alert>
      </div>
    </el-card>

    <!-- é…ç½®å¯¹è¯æ¡† -->
    <el-dialog v-model="showConfig" :title="`é…ç½® ${currentFeature?.description}`" width="600px">
      <el-form v-if="currentFeature" label-width="150px">
        <!-- Public API é…ç½® -->
        <template v-if="currentFeature.featureKey === 'public_api'">
          <el-form-item label="é™æµï¼ˆæ¬¡/å°æ—¶ï¼‰">
            <el-input-number v-model="configForm.rate_limit_per_hour" :min="100" :step="100" />
          </el-form-item>
          <el-form-item label="æœ€å¤§å¯†é’¥æ•°">
            <el-input-number v-model="configForm.max_api_keys" :min="1" :max="20" />
          </el-form-item>
        </template>

        <!-- å·¥ä½œæµç‰ˆæœ¬å†å²é…ç½® -->
        <template v-if="currentFeature.featureKey === 'workflow_history'">
          <el-form-item label="ä¿ç•™å¤©æ•°">
            <el-input-number
              v-model="configForm.retention_days"
              :min="-1"
              :step="30"
            />
            <span class="tip">-1 è¡¨ç¤ºæ— é™åˆ¶</span>
          </el-form-item>
          <el-form-item label="è‡ªåŠ¨æ¸…ç†">
            <el-switch v-model="configForm.auto_cleanup_enabled" />
          </el-form-item>
        </template>
      </el-form>

      <template #footer>
        <el-button @click="showConfig = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="saveConfig">ä¿å­˜</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { adminApi } from '@/api/admin';
import { ElMessage } from 'element-plus';

const features = ref([]);
const showConfig = ref(false);
const currentFeature = ref(null);
const configForm = ref({});

onMounted(async () => {
  await fetchFeatures();
});

async function fetchFeatures() {
  const res = await adminApi.getPlatformFeatures();
  features.value = res.features;
}

async function handleToggle(feature: any) {
  try {
    await adminApi.updatePlatformFeature(feature.featureKey, {
      enabled: feature.enabled
    });
    ElMessage.success(`åŠŸèƒ½ ${feature.description} å·²${feature.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
  } catch (error) {
    ElMessage.error('æ“ä½œå¤±è´¥');
    feature.enabled = !feature.enabled; // å›æ»š
  }
}

function showConfigDialog(feature: any) {
  currentFeature.value = feature;
  configForm.value = { ...feature.config };
  showConfig.value = true;
}

async function saveConfig() {
  try {
    await adminApi.updatePlatformFeature(currentFeature.value.featureKey, {
      config: configForm.value
    });
    ElMessage.success('é…ç½®å·²ä¿å­˜');
    showConfig.value = false;
    await fetchFeatures();
  } catch (error) {
    ElMessage.error('ä¿å­˜å¤±è´¥');
  }
}

function isDisabledFeature(key: string) {
  // æŸäº›åŠŸèƒ½ç¦æ­¢å¯ç”¨
  return ['ldap', 'saml', 'oidc', 'external_secrets', 'log_streaming'].includes(key);
}

function hasUsageStats(key: string) {
  return ['public_api'].includes(key);
}
</script>

<style scoped>
.platform-features-page {
  padding: var(--spacing--lg);
}

.features-summary {
  margin-top: var(--spacing--lg);
}

.features-summary ul {
  margin: var(--spacing--xs) 0 0 var(--spacing--md);
  padding: 0;
}

.features-summary li {
  margin: var(--spacing--3xs) 0;
}

.tip {
  margin-left: var(--spacing--xs);
  font-size: var(--font-size--2xs);
  color: var(--color--text--tint-2);
}
</style>
```

---

#### 12.3.2 å±‚çº§2ï¼šå·¥ä½œç©ºé—´ç®¡ç†å‘˜æ§åˆ¶

è¿™äº›åŠŸèƒ½æ˜¯**å·¥ä½œç©ºé—´çº§åˆ«**çš„é…ç½®ï¼Œåº”è¯¥è®©å·¥ä½œç©ºé—´çš„ Admin è‡ªå·±ç®¡ç†ï¼š

| åŠŸèƒ½ | å¤šç§Ÿæˆ·åå¤„ç† | ç®¡ç†æ–¹å¼ | ç†ç”± |
|------|------------|---------|------|
| **è‡ªå®šä¹‰è§’è‰²** | âœ… ä¿ç•™ | å·¥ä½œç©ºé—´è®¾ç½®é¡µé¢ | å›¢é˜Ÿè‡ªå·±å®šä¹‰è§’è‰²ä½“ç³» |
| **ç¯å¢ƒå˜é‡** | âœ… ä¿ç•™ï¼ˆå·¥ä½œç©ºé—´éš”ç¦»ï¼‰ | å·¥ä½œç©ºé—´è®¾ç½®é¡µé¢ | æ¯ä¸ªå›¢é˜Ÿé…ç½®ä¸åŒ |
| **å®¡è®¡æ—¥å¿—** | âœ… ä¿ç•™ï¼ˆå·¥ä½œç©ºé—´éš”ç¦»ï¼‰ | å·¥ä½œç©ºé—´è®¾ç½®é¡µé¢ | æŸ¥çœ‹æœ¬å›¢é˜Ÿæ“ä½œè®°å½• |
| **å·¥ä½œæµåˆ†äº«æƒé™** | âœ… ä¿ç•™ï¼ˆé‡æ–°å®ç°ï¼‰ | å·¥ä½œæµç¼–è¾‘å™¨ | å›¢é˜Ÿå†…éƒ¨åä½œ |
| **API å¯†é’¥ç®¡ç†** | âœ… ä¿ç•™ï¼ˆé™åˆ¶æ•°é‡ï¼‰ | å·¥ä½œç©ºé—´è®¾ç½®é¡µé¢ | æ¯ä¸ªå›¢é˜Ÿç®¡ç†è‡ªå·±çš„APIå¯†é’¥ |

**å®ç°æ–¹å¼ï¼š**

```sql
-- å·¥ä½œç©ºé—´åŠŸèƒ½é…ç½®ï¼ˆæ‰©å±• project è¡¨ï¼‰
ALTER TABLE project ADD COLUMN feature_config JSONB DEFAULT '{}';

-- ä¾‹å¦‚å­˜å‚¨ï¼š
-- {
--   "custom_roles": {
--     "enabled": true,
--     "roles": [
--       { "name": "é«˜çº§ç¼–è¾‘è€…", "permissions": ["workflow:read", "workflow:write", "workflow:execute"] },
--       { "name": "å®¡æ‰¹è€…", "permissions": ["workflow:read", "workflow:approve"] }
--     ]
--   },
--   "api_keys": {
--     "max_count": 5,
--     "current_count": 2
--   }
-- }
```

**å·¥ä½œç©ºé—´è®¾ç½® APIï¼š**

```typescript
// packages/cli/src/controllers/workspaces.controller.ts
@RestController('/workspaces')
export class WorkspacesController {

  /**
   * GET /workspaces/:id/features
   * è·å–å·¥ä½œç©ºé—´åŠŸèƒ½é…ç½®
   */
  @Get('/:id/features')
  async getWorkspaceFeatures(
    @Param('id') workspaceId: string,
    @AuthUser() user: User
  ) {
    await this.validateAccess(workspaceId, user.id);

    const workspace = await this.projectRepository.findOne({
      where: { id: workspaceId },
      select: ['featureConfig']
    });

    return {
      features: workspace.featureConfig || {}
    };
  }

  /**
   * PATCH /workspaces/:id/features
   * æ›´æ–°å·¥ä½œç©ºé—´åŠŸèƒ½é…ç½®ï¼ˆä»… Adminï¼‰
   */
  @Patch('/:id/features')
  async updateWorkspaceFeatures(
    @Param('id') workspaceId: string,
    @Body() featureConfig: any,
    @AuthUser() user: User
  ) {
    // éªŒè¯ Admin æƒé™
    const isAdmin = await this.projectService.isUserAdmin(workspaceId, user.id);
    if (!isAdmin) {
      throw new ForbiddenError('åªæœ‰å·¥ä½œç©ºé—´ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹åŠŸèƒ½é…ç½®');
    }

    await this.projectRepository.update(
      { id: workspaceId },
      { featureConfig }
    );

    // å®¡è®¡æ—¥å¿—
    await this.auditLogService.log({
      action: 'workspace_features_updated',
      workspaceId,
      userId: user.id,
      metadata: { featureConfig }
    });

    return { success: true };
  }

  /**
   * GET /workspaces/:id/variables
   * è·å–å·¥ä½œç©ºé—´ç¯å¢ƒå˜é‡
   */
  @Get('/:id/variables')
  async getVariables(
    @Param('id') workspaceId: string,
    @AuthUser() user: User
  ) {
    await this.validateAccess(workspaceId, user.id);

    const variables = await this.variablesRepository.find({
      where: { projectId: workspaceId },
      order: { key: 'ASC' }
    });

    return {
      variables: variables.map(v => ({
        id: v.id,
        key: v.key,
        value: v.value, // æ•æ„Ÿå€¼åº”è¯¥è„±æ•æ˜¾ç¤º
        type: v.type,
        createdAt: v.createdAt
      }))
    };
  }

  /**
   * POST /workspaces/:id/variables
   * åˆ›å»ºç¯å¢ƒå˜é‡ï¼ˆä»… Adminï¼‰
   */
  @Post('/:id/variables')
  async createVariable(
    @Param('id') workspaceId: string,
    @Body() data: { key: string; value: string; type: string },
    @AuthUser() user: User
  ) {
    const isAdmin = await this.projectService.isUserAdmin(workspaceId, user.id);
    if (!isAdmin) {
      throw new ForbiddenError('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºç¯å¢ƒå˜é‡');
    }

    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºé…é¢
    const count = await this.variablesRepository.count({
      where: { projectId: workspaceId }
    });

    const maxCount = await this.getVariableQuota(workspaceId);
    if (count >= maxCount) {
      throw new BadRequestError(`ç¯å¢ƒå˜é‡æ•°é‡å·²è¾¾ä¸Šé™ï¼ˆ${maxCount}ä¸ªï¼‰`);
    }

    const variable = await this.variablesRepository.save({
      projectId: workspaceId,
      key: data.key,
      value: data.value,
      type: data.type
    });

    return variable;
  }

  /**
   * GET /workspaces/:id/audit-logs
   * è·å–å·¥ä½œç©ºé—´å®¡è®¡æ—¥å¿—
   */
  @Get('/:id/audit-logs')
  async getAuditLogs(
    @Param('id') workspaceId: string,
    @Query('page') page: number = 1,
    @Query('limit') limit: number = 50,
    @AuthUser() user: User
  ) {
    const isAdmin = await this.projectService.isUserAdmin(workspaceId, user.id);
    if (!isAdmin) {
      throw new ForbiddenError('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å®¡è®¡æ—¥å¿—');
    }

    const [logs, total] = await this.auditLogRepository.findAndCount({
      where: { workspaceId },
      order: { createdAt: 'DESC' },
      skip: (page - 1) * limit,
      take: limit
    });

    return {
      logs,
      pagination: { page, limit, total }
    };
  }
}
```

**å·¥ä½œç©ºé—´è®¾ç½®å‰ç«¯é¡µé¢ï¼š**

```vue
<!-- packages/editor-ui/src/views/WorkspaceSettings.vue -->
<template>
  <div class="workspace-settings-page">
    <el-tabs v-model="activeTab">

      <!-- ç¯å¢ƒå˜é‡ -->
      <el-tab-pane label="ç¯å¢ƒå˜é‡" name="variables">
        <div class="variables-section">
          <div class="section-header">
            <h3>ç¯å¢ƒå˜é‡ç®¡ç†</h3>
            <el-button type="primary" @click="showCreateVariable = true" v-if="isAdmin">
              + æ·»åŠ å˜é‡
            </el-button>
          </div>

          <el-table :data="variables" style="width: 100%">
            <el-table-column prop="key" label="å˜é‡å" width="200" />
            <el-table-column prop="value" label="å€¼">
              <template #default="{ row }">
                <span v-if="row.type === 'string'">{{ row.value }}</span>
                <span v-else class="sensitive">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
              </template>
            </el-table-column>
            <el-table-column label="æ“ä½œ" width="150" v-if="isAdmin">
              <template #default="{ row }">
                <el-button size="small" @click="editVariable(row)">ç¼–è¾‘</el-button>
                <el-button size="small" type="danger" @click="deleteVariable(row)">åˆ é™¤</el-button>
              </template>
            </el-table-column>
          </el-table>

          <div class="quota-info">
            å·²ä½¿ç”¨ {{ variables.length }} / {{ variableQuota }} ä¸ªç¯å¢ƒå˜é‡
          </div>
        </div>
      </el-tab-pane>

      <!-- å®¡è®¡æ—¥å¿— -->
      <el-tab-pane label="å®¡è®¡æ—¥å¿—" name="audit-logs" v-if="isAdmin">
        <div class="audit-logs-section">
          <el-table :data="auditLogs" style="width: 100%">
            <el-table-column prop="createdAt" label="æ—¶é—´" width="180">
              <template #default="{ row }">
                {{ formatDate(row.createdAt) }}
              </template>
            </el-table-column>
            <el-table-column prop="action" label="æ“ä½œ" width="200" />
            <el-table-column prop="userId" label="ç”¨æˆ·" width="150">
              <template #default="{ row }">
                {{ getUserName(row.userId) }}
              </template>
            </el-table-column>
            <el-table-column prop="metadata" label="è¯¦æƒ…">
              <template #default="{ row }">
                {{ formatMetadata(row.metadata) }}
              </template>
            </el-table-column>
          </el-table>

          <el-pagination
            v-model:current-page="auditLogPage"
            :page-size="50"
            :total="auditLogTotal"
            @current-change="fetchAuditLogs"
          />
        </div>
      </el-tab-pane>

      <!-- è‡ªå®šä¹‰è§’è‰² -->
      <el-tab-pane label="è‡ªå®šä¹‰è§’è‰²" name="custom-roles" v-if="isAdmin">
        <div class="custom-roles-section">
          <p class="feature-description">
            åˆ›å»ºè‡ªå®šä¹‰è§’è‰²ï¼Œçµæ´»åˆ†é…å›¢é˜Ÿæˆå‘˜æƒé™
          </p>

          <!-- è‡ªå®šä¹‰è§’è‰²åˆ—è¡¨ -->
          <el-button type="primary" @click="showCreateRole = true">
            + åˆ›å»ºè§’è‰²
          </el-button>

          <!-- è§’è‰²åˆ—è¡¨å±•ç¤º... -->
        </div>
      </el-tab-pane>

    </el-tabs>
  </div>
</template>
```

---

#### 12.3.3 å±‚çº§3ï¼šæ™®é€šç”¨æˆ·æ§åˆ¶

è¿™äº›åŠŸèƒ½æ˜¯**ç”¨æˆ·ä¸ªäºº**çš„åå¥½ï¼Œæ¯ä¸ªç”¨æˆ·è‡ªå·±å†³å®šï¼š

| åŠŸèƒ½ | å¤šç§Ÿæˆ·åå¤„ç† | ç®¡ç†æ–¹å¼ | ç†ç”± |
|------|------------|---------|------|
| **MFAï¼ˆå¤šå› ç´ è®¤è¯ï¼‰** | âœ… ä¿ç•™ | ä¸ªäººè®¾ç½®é¡µé¢ | ç”¨æˆ·è‡ªå·±å†³å®šæ˜¯å¦åŒé‡éªŒè¯ |
| **è¯­è¨€åˆ‡æ¢** | âœ… ä¿ç•™ | ä¸ªäººè®¾ç½®é¡µé¢ | ä¸ªäººåå¥½ |
| **AI åŠ©æ‰‹** | âœ… ä¿ç•™ | ä¸ªäººè®¾ç½®é¡µé¢ | å¼€å‘è€…å·¥å…·ï¼Œä¸ªäººåå¥½ |
| **è°ƒè¯•æ¨¡å¼** | âœ… ä¿ç•™ | å·¥ä½œæµç¼–è¾‘å™¨ | å¼€å‘è€…å·¥å…· |

**å®ç°æ–¹å¼ï¼š**

```sql
-- ç”¨æˆ·ä¸ªäººåŠŸèƒ½é…ç½®ï¼ˆæ‰©å±• user è¡¨ï¼‰
ALTER TABLE "user" ADD COLUMN feature_preferences JSONB DEFAULT '{}';

-- ä¾‹å¦‚å­˜å‚¨ï¼š
-- {
--   "mfa_enabled": false,
--   "ai_assistant_enabled": true,
--   "language": "zh-CN",
--   "debug_mode": false
-- }
```

**ç”¨æˆ·è®¾ç½® APIï¼š**

```typescript
// packages/cli/src/controllers/users.controller.ts
@RestController('/users')
export class UsersController {

  /**
   * GET /users/me/preferences
   * è·å–å½“å‰ç”¨æˆ·åå¥½è®¾ç½®
   */
  @Get('/me/preferences')
  async getPreferences(@AuthUser() user: User) {
    return {
      preferences: user.featurePreferences || {}
    };
  }

  /**
   * PATCH /users/me/preferences
   * æ›´æ–°ç”¨æˆ·åå¥½è®¾ç½®
   */
  @Patch('/me/preferences')
  async updatePreferences(
    @AuthUser() user: User,
    @Body() preferences: any
  ) {
    await this.userRepository.update(
      { id: user.id },
      { featurePreferences: { ...user.featurePreferences, ...preferences } }
    );

    return { success: true };
  }

  /**
   * POST /users/me/mfa/enable
   * å¯ç”¨ MFA
   */
  @Post('/me/mfa/enable')
  async enableMFA(@AuthUser() user: User) {
    const secret = this.mfaService.generateSecret(user.email);
    const qrCode = await this.mfaService.generateQRCode(secret);

    // ä¸´æ—¶å­˜å‚¨ secretï¼ˆç”¨æˆ·éªŒè¯åå†æ­£å¼ä¿å­˜ï¼‰
    await this.cacheService.set(
      `mfa:setup:${user.id}`,
      secret,
      { ttl: 600 } // 10åˆ†é’Ÿæœ‰æ•ˆ
    );

    return {
      secret,
      qrCode
    };
  }

  /**
   * POST /users/me/mfa/verify
   * éªŒè¯å¹¶æ¿€æ´» MFA
   */
  @Post('/me/mfa/verify')
  async verifyMFA(
    @AuthUser() user: User,
    @Body() data: { code: string }
  ) {
    const secret = await this.cacheService.get(`mfa:setup:${user.id}`);
    if (!secret) {
      throw new BadRequestError('MFA è®¾ç½®å·²è¿‡æœŸï¼Œè¯·é‡æ–°å¼€å§‹');
    }

    const isValid = this.mfaService.verifyToken(secret, data.code);
    if (!isValid) {
      throw new BadRequestError('éªŒè¯ç é”™è¯¯');
    }

    // ä¿å­˜åˆ°ç”¨æˆ·é…ç½®
    await this.userRepository.update(
      { id: user.id },
      {
        mfaSecret: this.encryptService.encrypt(secret),
        featurePreferences: {
          ...user.featurePreferences,
          mfa_enabled: true
        }
      }
    );

    // ç”Ÿæˆæ¢å¤ä»£ç 
    const recoveryCodes = this.mfaService.generateRecoveryCodes();
    await this.userRepository.update(
      { id: user.id },
      { mfaRecoveryCodes: this.encryptService.encrypt(JSON.stringify(recoveryCodes)) }
    );

    return {
      success: true,
      recoveryCodes // åªæ˜¾ç¤ºä¸€æ¬¡
    };
  }
}
```

**ä¸ªäººè®¾ç½®å‰ç«¯é¡µé¢ï¼š**

```vue
<!-- packages/editor-ui/src/views/PersonalSettings.vue -->
<template>
  <div class="personal-settings-page">
    <el-card>
      <template #header>
        <h2>ä¸ªäººè®¾ç½®</h2>
      </template>

      <el-form label-width="150px">

        <!-- è¯­è¨€è®¾ç½® -->
        <el-form-item label="ç•Œé¢è¯­è¨€">
          <el-radio-group v-model="preferences.language" @change="updateLanguage">
            <el-radio label="zh-CN">ç®€ä½“ä¸­æ–‡</el-radio>
            <el-radio label="en-US">English</el-radio>
          </el-radio-group>
        </el-form-item>

        <!-- MFA è®¾ç½® -->
        <el-form-item label="å¤šå› ç´ è®¤è¯">
          <div class="mfa-setting">
            <el-switch
              v-model="preferences.mfa_enabled"
              @change="toggleMFA"
              :disabled="mfaLoading"
            />
            <span class="setting-tip">
              å¯ç”¨åï¼Œç™»å½•æ—¶éœ€è¦é¢å¤–è¾“å…¥åŠ¨æ€éªŒè¯ç ï¼Œæé«˜è´¦å·å®‰å…¨æ€§
            </span>
          </div>
        </el-form-item>

        <!-- AI åŠ©æ‰‹ -->
        <el-form-item label="AI åŠ©æ‰‹">
          <el-switch
            v-model="preferences.ai_assistant_enabled"
            @change="updatePreferences"
          />
          <span class="setting-tip">
            åœ¨å·¥ä½œæµç¼–è¾‘å™¨ä¸­æä¾› AI ä»£ç è¡¥å…¨å’Œæ™ºèƒ½å»ºè®®
          </span>
        </el-form-item>

        <!-- è°ƒè¯•æ¨¡å¼ -->
        <el-form-item label="è°ƒè¯•æ¨¡å¼">
          <el-switch
            v-model="preferences.debug_mode"
            @change="updatePreferences"
          />
          <span class="setting-tip">
            åœ¨å·¥ä½œæµç¼–è¾‘å™¨ä¸­æ˜¾ç¤ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯å’Œæ–­ç‚¹åŠŸèƒ½
          </span>
        </el-form-item>

      </el-form>
    </el-card>

    <!-- MFA è®¾ç½®å¯¹è¯æ¡† -->
    <el-dialog v-model="showMFASetup" title="å¯ç”¨å¤šå› ç´ è®¤è¯" width="500px">
      <div class="mfa-setup-content">
        <p>1. ä½¿ç”¨ Google Authenticator æˆ–ç±»ä¼¼åº”ç”¨æ‰«æäºŒç»´ç ï¼š</p>
        <div class="qr-code">
          <img :src="mfaQRCode" />
        </div>

        <p>2. è¾“å…¥åº”ç”¨ä¸­æ˜¾ç¤ºçš„ 6 ä½éªŒè¯ç ï¼š</p>
        <el-input
          v-model="mfaVerifyCode"
          placeholder="000000"
          maxlength="6"
        />
      </div>

      <template #footer>
        <el-button @click="showMFASetup = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="verifyMFA" :loading="mfaLoading">
          éªŒè¯å¹¶å¯ç”¨
        </el-button>
      </template>
    </el-dialog>

    <!-- æ¢å¤ä»£ç å±•ç¤º -->
    <el-dialog v-model="showRecoveryCodes" title="MFA æ¢å¤ä»£ç " width="500px">
      <el-alert type="warning" :closable="false">
        <template #title>
          è¯·å¦¥å–„ä¿å­˜ä»¥ä¸‹æ¢å¤ä»£ç ï¼å¦‚æœä¸¢å¤±æ‰‹æœºï¼Œå¯ç”¨è¿™äº›ä»£ç æ¢å¤è®¿é—®ã€‚
        </template>
      </el-alert>

      <div class="recovery-codes">
        <code v-for="code in recoveryCodes" :key="code">{{ code }}</code>
      </div>

      <template #footer>
        <el-button @click="copyRecoveryCodes">å¤åˆ¶æ‰€æœ‰ä»£ç </el-button>
        <el-button type="primary" @click="showRecoveryCodes = false">æˆ‘å·²ä¿å­˜</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { userApi } from '@/api/users';
import { ElMessage } from 'element-plus';
import { useI18n } from 'vue-i18n';

const { locale } = useI18n();

const preferences = ref({
  language: 'zh-CN',
  mfa_enabled: false,
  ai_assistant_enabled: true,
  debug_mode: false
});

const showMFASetup = ref(false);
const mfaLoading = ref(false);
const mfaQRCode = ref('');
const mfaSecret = ref('');
const mfaVerifyCode = ref('');
const showRecoveryCodes = ref(false);
const recoveryCodes = ref([]);

onMounted(async () => {
  const res = await userApi.getPreferences();
  preferences.value = res.preferences;
});

async function updateLanguage() {
  locale.value = preferences.value.language;
  await updatePreferences();
}

async function updatePreferences() {
  await userApi.updatePreferences(preferences.value);
  ElMessage.success('è®¾ç½®å·²ä¿å­˜');
}

async function toggleMFA(enabled: boolean) {
  if (enabled) {
    // å¯ç”¨ MFA
    mfaLoading.value = true;
    try {
      const res = await userApi.enableMFA();
      mfaQRCode.value = res.qrCode;
      mfaSecret.value = res.secret;
      showMFASetup.value = true;
    } finally {
      mfaLoading.value = false;
    }
  } else {
    // ç¦ç”¨ MFAï¼ˆéœ€è¦ç¡®è®¤ï¼‰
    await ElMessageBox.confirm('ç¡®å®šè¦ç¦ç”¨å¤šå› ç´ è®¤è¯å—ï¼Ÿè¿™ä¼šé™ä½è´¦å·å®‰å…¨æ€§ã€‚', 'è­¦å‘Š', {
      type: 'warning'
    });

    await userApi.disableMFA();
    ElMessage.success('MFA å·²ç¦ç”¨');
  }
}

async function verifyMFA() {
  mfaLoading.value = true;
  try {
    const res = await userApi.verifyMFA({ code: mfaVerifyCode.value });
    showMFASetup.value = false;
    recoveryCodes.value = res.recoveryCodes;
    showRecoveryCodes.value = true;
    ElMessage.success('MFA å·²å¯ç”¨');
  } catch (error) {
    ElMessage.error('éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•');
    preferences.value.mfa_enabled = false;
  } finally {
    mfaLoading.value = false;
  }
}

function copyRecoveryCodes() {
  navigator.clipboard.writeText(recoveryCodes.value.join('\n'));
  ElMessage.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}
</script>

<style scoped>
.personal-settings-page {
  max-width: 800px;
  margin: var(--spacing--lg) auto;
  padding: var(--spacing--lg);
}

.mfa-setting,
.setting-tip {
  display: flex;
  align-items: center;
  gap: var(--spacing--sm);
}

.setting-tip {
  font-size: var(--font-size--2xs);
  color: var(--color--text--tint-2);
  margin-left: var(--spacing--sm);
}

.mfa-setup-content {
  text-align: center;
}

.qr-code {
  margin: var(--spacing--lg) 0;
}

.qr-code img {
  width: 200px;
  height: 200px;
}

.recovery-codes {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing--xs);
  margin: var(--spacing--lg) 0;
}

.recovery-codes code {
  padding: var(--spacing--xs);
  background: var(--color--background--light-2);
  border-radius: var(--radius--sm);
  font-family: monospace;
  font-size: var(--font-size--sm);
}
</style>
```

### 12.4 åŠŸèƒ½é…ç½®æ€»ç»“è¡¨

| åŠŸèƒ½ | æ§åˆ¶å±‚çº§ | é»˜è®¤çŠ¶æ€ | æ˜¯å¦å¯é…ç½® | è¯´æ˜ |
|------|---------|---------|----------|------|
| **LDAP/SAML/OIDC** | å¹³å°ç®¡ç†å‘˜ | âŒ ç¦ç”¨ | âœ… æ˜¯ | å°å›¢é˜Ÿ SaaS ä¸éœ€è¦ |
| **å¤–éƒ¨å¯†é’¥ç®¡ç†** | å¹³å°ç®¡ç†å‘˜ | âŒ ç¦ç”¨ | âœ… æ˜¯ | ä¸é€‚åˆå¤šç§Ÿæˆ· |
| **æ—¥å¿—æµ** | å¹³å°ç®¡ç†å‘˜ | âŒ ç¦ç”¨ | âœ… æ˜¯ | å¹³å°è¿ç»´åŠŸèƒ½ |
| **Worker View** | å¹³å°ç®¡ç†å‘˜ | âš ï¸ ä»…ç®¡ç†å‘˜ | âŒ å¦ | å¹³å°ç›‘æ§ |
| **Public API** | å¹³å°ç®¡ç†å‘˜ | âœ… å¯ç”¨ + é™æµ | âœ… æ˜¯ | 1000æ¬¡/å°æ—¶/å·¥ä½œç©ºé—´ |
| **å·¥ä½œæµç‰ˆæœ¬å†å²** | å¹³å°ç®¡ç†å‘˜ | âœ… æ— é™åˆ¶ | âœ… æ˜¯ | å¯é…ç½®æ¸…ç†ç­–ç•¥ |
| **Insights åˆ†æ** | - | âœ… æ— é™åˆ¶ | âŒ å¦ | æŸ¥çœ‹å†å²ä¸äº§ç”Ÿæˆæœ¬ |
| **å®¡è®¡æ—¥å¿—** | å·¥ä½œç©ºé—´ç®¡ç†å‘˜ | âœ… å¯ç”¨ | âŒ å¦ | å·¥ä½œç©ºé—´éš”ç¦» |
| **è‡ªå®šä¹‰è§’è‰²** | å·¥ä½œç©ºé—´ç®¡ç†å‘˜ | âœ… å¯ç”¨ | âœ… æ˜¯ | å›¢é˜Ÿè‡ªå®šä¹‰ |
| **ç¯å¢ƒå˜é‡** | å·¥ä½œç©ºé—´ç®¡ç†å‘˜ | âœ… å¯ç”¨ | âœ… æ˜¯ | å·¥ä½œç©ºé—´éš”ç¦» |
| **å·¥ä½œæµåˆ†äº«** | å·¥ä½œç©ºé—´ç®¡ç†å‘˜ | âœ… å¯ç”¨ | âŒ å¦ | æ ¸å¿ƒåä½œåŠŸèƒ½ |
| **MFA** | æ™®é€šç”¨æˆ· | âŒ é»˜è®¤å…³é—­ | âœ… æ˜¯ | ç”¨æˆ·è‡ªé€‰ |
| **è¯­è¨€åˆ‡æ¢** | æ™®é€šç”¨æˆ· | ä¸­æ–‡ | âœ… æ˜¯ | ç”¨æˆ·åå¥½ |
| **AI åŠ©æ‰‹** | æ™®é€šç”¨æˆ· | âœ… é»˜è®¤å¼€å¯ | âœ… æ˜¯ | ç”¨æˆ·åå¥½ |
| **è°ƒè¯•æ¨¡å¼** | æ™®é€šç”¨æˆ· | âŒ é»˜è®¤å…³é—­ | âœ… æ˜¯ | å¼€å‘è€…å·¥å…· |

### 12.5 å®æ–½è®¡åˆ’

å°†ä¼ä¸šç‰ˆåŠŸèƒ½ç®¡ç†çº³å…¥æ•´ä½“æ”¹é€ æ—¶é—´çº¿ï¼š

**Week 7-8: ä¼ä¸šç‰ˆåŠŸèƒ½ç®¡ç†ç³»ç»Ÿ**
- [ ] åˆ›å»º `platform_feature_config` è¡¨
- [ ] å®ç° `AdminPlatformFeaturesController`
- [ ] å®ç°å·¥ä½œç©ºé—´åŠŸèƒ½é…ç½® API
- [ ] å®ç°ç”¨æˆ·åå¥½è®¾ç½® API
- [ ] åå°ç®¡ç†å‰ç«¯ï¼šå¹³å°åŠŸèƒ½ç®¡ç†é¡µé¢
- [ ] ç”¨æˆ·å‰ç«¯ï¼šå·¥ä½œç©ºé—´è®¾ç½®é¡µé¢
- [ ] ç”¨æˆ·å‰ç«¯ï¼šä¸ªäººè®¾ç½®é¡µé¢
- [ ] MFA å¯ç”¨/ç¦ç”¨æµç¨‹å®ç°
- [ ] ç¯å¢ƒå˜é‡ç®¡ç†ç•Œé¢

**Week 9: åŠŸèƒ½å¼€å…³å®æ–½**
- [ ] ç¦ç”¨ LDAP/SAML/OIDC åŠŸèƒ½ï¼ˆä»£ç çº§ï¼‰
- [ ] ç¦ç”¨å¤–éƒ¨å¯†é’¥ç®¡ç†åŠŸèƒ½
- [ ] ç¦ç”¨æ—¥å¿—æµåŠŸèƒ½ï¼ˆä¿ç•™å¹³å°å†…éƒ¨ä½¿ç”¨ï¼‰
- [ ] Worker View é™åˆ¶ä¸ºä»…ç®¡ç†å‘˜å¯è§
- [ ] Public API é™æµä¸­é—´ä»¶å®ç°
- [ ] ç¯å¢ƒå˜é‡å·¥ä½œç©ºé—´éš”ç¦»éªŒè¯
- [ ] å®¡è®¡æ—¥å¿—å·¥ä½œç©ºé—´éš”ç¦»éªŒè¯

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v5.0ï¼ˆæ¿€è¿›æ”¹é€ ç‰ˆ + å®Œæ•´ç”¨æˆ·æ³¨å†Œç³»ç»Ÿ + ä¼ä¸šç‰ˆåŠŸèƒ½ç®¡ç†ï¼‰
**æœ€åæ›´æ–°ï¼š** 2025-01-07
**é…å¥—æ–‡æ¡£ï¼š** 02-æ¶æ„å›¾å’Œæµç¨‹å›¾.md, 03-åå°ç®¡ç†ç³»ç»Ÿè®¾è®¡.md, 04-å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ.md

## ğŸ“ v4.0 æ›´æ–°å†…å®¹

### æ–°å¢å†…å®¹
1. **ç”¨æˆ·æ³¨å†Œç³»ç»Ÿ**
   - å®Œæ•´çš„ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼ˆåŸå­æ€§äº‹åŠ¡ï¼‰
   - é‚®ç®±éªŒè¯ç³»ç»Ÿ
   - æ‰‹æœºå·éªŒè¯ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰
   - OAuth ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ã€GitHubï¼‰
   - Onboarding æ–°æ‰‹å¼•å¯¼

2. **æ•°æ®åº“æ‰©å±•**
   - User è¡¨å®Œæ•´æ‰©å±•ï¼ˆ20+ æ–°å­—æ®µï¼‰
   - é‚€è¯·ç ç³»ç»Ÿè¡¨ï¼ˆinvite_codes, invite_recordsï¼‰
   - å®¡è®¡æ—¥å¿—è¡¨ï¼ˆaudit_logsï¼‰
   - å·¥ä½œç©ºé—´é…é¢è¡¨ï¼ˆworkspace_quotasï¼‰
   - æ³¨å†Œç»Ÿè®¡è¡¨ï¼ˆregistration_statsï¼‰
   - execution_entity å’Œ variables_entity æ·»åŠ  project_id

3. **åç«¯æœåŠ¡**
   - UserServiceï¼ˆå®Œæ•´æ³¨å†Œæµç¨‹ï¼‰
   - EmailVerificationService
   - PhoneVerificationServiceï¼ˆå¯é€‰ï¼‰
   - OnboardingService

4. **API æ¥å£**
   - AuthControllerï¼ˆæ³¨å†Œã€ç™»å½•ã€éªŒè¯ï¼‰
   - OAuthControllerï¼ˆç¬¬ä¸‰æ–¹ç™»å½•ï¼‰
   - OnboardingController

5. **å‰ç«¯é¡µé¢**
   - RegisterViewï¼ˆæ³¨å†Œé¡µé¢ï¼‰
   - OnboardingViewï¼ˆå¼•å¯¼é¡µé¢ï¼‰
   - EmailVerificationView

### å…³é”®ç‰¹æ€§
- âœ… æ³¨å†Œå³é€ Â¥10
- âœ… é‚€è¯·ç åŒæ–¹å„å¾— Â¥5
- âœ… é‚®ç®±éªŒè¯å¥–åŠ± Â¥2
- âœ… Onboarding ä»»åŠ¡æœ€å¤šå¯è·å¾— Â¥15
- âœ… è‡ªåŠ¨åˆ›å»ºä¸ªäººå·¥ä½œç©ºé—´
- âœ… æ”¯æŒå¾®ä¿¡ã€GitHub ç¬¬ä¸‰æ–¹ç™»å½•
