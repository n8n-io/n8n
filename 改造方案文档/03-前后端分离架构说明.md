# n8n å‰åç«¯åˆ†ç¦»æ¶æ„è¯´æ˜ï¼ˆå¤šç§Ÿæˆ·æ”¹é€ é€‚é…ï¼‰

> **é…å¥—æ–‡æ¡£ï¼š** 01-æ¶æ„åº•å±‚æ”¹é€ æ–¹æ¡ˆ.md (v3.0), 02-æ¶æ„å›¾å’Œæµç¨‹å›¾.md (v2.0)
> **ç‰ˆæœ¬ï¼š** v1.0
> **æ—¥æœŸï¼š** 2025-11-07

---

## ğŸ“‹ ä¸€ã€å‰åç«¯åˆ†ç¦»æ¶æ„ç°çŠ¶

### 1.1 å½“å‰æ¶æ„

ä½ ä»¬å·²ç»å®ç°äº†å®Œæ•´çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¼€å‘ç¯å¢ƒæ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  ä¸»åº”ç”¨å‰ç«¯      â”‚         â”‚  ç®¡ç†åå°å‰ç«¯    â”‚         â”‚
â”‚  â”‚  (editor-ui)     â”‚         â”‚  (admin-panel)   â”‚         â”‚
â”‚  â”‚  Vite Dev        â”‚         â”‚  Vite Dev        â”‚         â”‚
â”‚  â”‚  Port: 8080      â”‚         â”‚  Port: 5679      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚            â”‚                             â”‚                   â”‚
â”‚            â”‚  Vite Proxy                â”‚  Vite Proxy      â”‚
â”‚            â”‚  /rest, /webhook, etc.     â”‚  /rest           â”‚
â”‚            â”‚                             â”‚                   â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                       â”‚                                       â”‚
â”‚                       â†“                                       â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚            â”‚   åç«¯ API æœåŠ¡       â”‚                          â”‚
â”‚            â”‚   Express Server      â”‚                          â”‚
â”‚            â”‚   Port: 5678          â”‚                          â”‚
â”‚            â”‚   - REST API          â”‚                          â”‚
â”‚            â”‚   - WebSocket         â”‚                          â”‚
â”‚            â”‚   - Webhook           â”‚                          â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                       â”‚                                       â”‚
â”‚                       â†“                                       â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚            â”‚   PostgreSQL         â”‚                          â”‚
â”‚            â”‚   Port: 5432         â”‚                          â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å…³é”®é…ç½®

**å‰ç«¯ï¼ˆVite Proxyï¼‰ï¼š**
```typescript
// packages/frontend/editor-ui/vite.config.mts
server: {
  host: '0.0.0.0',
  port: 8080,
  proxy: {
    '/rest': {
      target: 'http://localhost:5678',
      changeOrigin: true,
      ws: true, // WebSocket æ”¯æŒ
    },
    '/webhook': { ... },
    '/webhook-test': { ... },
    '/webhook-waiting': { ... },
    '/form': { ... },
    // ... æ›´å¤šç«¯ç‚¹
  }
}
```

**åç«¯ï¼ˆCORSï¼‰ï¼š**
```typescript
// packages/cli/src/middlewares/cors.ts
const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [];
const isDevelopment = process.env.NODE_ENV === 'development';

if (isDevelopment || allowedOrigins.includes(origin)) {
  res.header('Access-Control-Allow-Origin', origin);
  res.header('Access-Control-Allow-Credentials', 'true');
  res.header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');
}
```

---

## äºŒã€å¯¹å¤šç§Ÿæˆ·æ”¹é€ æ–¹æ¡ˆçš„å½±å“åˆ†æ

### 2.1 âœ… æœ‰åˆ©å½±å“ï¼ˆæ€»ä½“ç§¯æï¼‰

#### 1. **å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡ä¼ é€’æ›´æ¸…æ™°**

å‰åç«¯åˆ†ç¦»åï¼Œå·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡ä¼ é€’æœ‰æ˜ç¡®çš„æ–¹å¼ï¼š

**æ–¹å¼ Aï¼šé€šè¿‡ HTTP Headerï¼ˆæ¨èï¼‰**
```typescript
// å‰ç«¯ï¼ˆæ¯æ¬¡ API è¯·æ±‚è‡ªåŠ¨é™„åŠ ï¼‰
axios.interceptors.request.use((config) => {
  const activeWorkspaceId = projectsStore.currentWorkspaceId;
  if (activeWorkspaceId) {
    config.headers['X-Workspace-Id'] = activeWorkspaceId;
  }
  return config;
});

// åç«¯ï¼ˆä¸­é—´ä»¶æå–ï¼‰
export const workspaceContextMiddleware: RequestHandler = (req, res, next) => {
  const workspaceId = req.headers['x-workspace-id'] as string;
  if (workspaceId) {
    req.workspaceContext = { workspaceId };
  }
  next();
};
```

**æ–¹å¼ Bï¼šé€šè¿‡ Query Parameterï¼ˆå¤‡é€‰ï¼‰**
```typescript
// å‰ç«¯
GET /rest/workflows?workspaceId=abc-123

// åç«¯
router.get('/workflows', (req, res) => {
  const workspaceId = req.query.workspaceId;
  // ...
});
```

#### 2. **åå°ç®¡ç†ç³»ç»Ÿç‹¬ç«‹éƒ¨ç½²**

```
ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·åŸŸï¼ˆuser.example.comï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚  Nginx       â”‚                                    â”‚
â”‚  â”‚  Static      â”‚ â† ä¸»åº”ç”¨å‰ç«¯é™æ€æ–‡ä»¶               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚         â”‚                                            â”‚
â”‚         â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚  API Server  â”‚                                    â”‚
â”‚  â”‚  Port: 5678  â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡ç†å‘˜åŸŸï¼ˆadmin.example.comï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚  Nginx       â”‚                                    â”‚
â”‚  â”‚  Static      â”‚ â† åå°ç®¡ç†å‰ç«¯é™æ€æ–‡ä»¶              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚         â”‚                                            â”‚
â”‚         â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚  API Server  â”‚ â† å…±äº«åŒä¸€ä¸ªåç«¯                   â”‚
â”‚  â”‚  Port: 5678  â”‚   é€šè¿‡ isAdmin æƒé™åŒºåˆ†            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿ï¼š**
- ç”¨æˆ·å‰ç«¯å’Œç®¡ç†å‘˜å‰ç«¯å®Œå…¨éš”ç¦»
- ä¸åŒåŸŸåã€ä¸åŒéƒ¨ç½²ã€ä¸åŒæƒé™
- åç«¯ API é€šè¿‡ `req.user.isAdmin` åŒºåˆ†æƒé™

#### 3. **WebSocket è¿æ¥ç®¡ç†æ›´ç®€å•**

```typescript
// å‰ç«¯ï¼šç›´æ¥é€šè¿‡ /rest/push å»ºç«‹ WebSocket
const ws = new WebSocket('ws://localhost:8080/rest/push');

// Vite Proxy è‡ªåŠ¨è½¬å‘åˆ°åç«¯
// ws://localhost:8080/rest/push â†’ ws://localhost:5678/rest/push

// åç«¯ï¼šæ— éœ€é¢å¤–é…ç½®ï¼ŒåŸæœ‰é€»è¾‘ä¿æŒä¸å˜
app.get('/rest/push', pushConnection);
```

**å·¥ä½œç©ºé—´åˆ‡æ¢æ—¶çš„ WebSocket å¤„ç†ï¼š**
```typescript
// å‰ç«¯ï¼šåˆ‡æ¢å·¥ä½œç©ºé—´æ—¶ï¼Œå…³é—­æ—§è¿æ¥ï¼Œå»ºç«‹æ–°è¿æ¥
watch(() => projectsStore.currentWorkspaceId, (newWorkspaceId) => {
  // å…³é—­æ—§çš„ WebSocket è¿æ¥
  if (pushConnection) {
    pushConnection.close();
  }

  // å»ºç«‹æ–°çš„ WebSocket è¿æ¥ï¼ˆå¸¦ä¸Šæ–°çš„ workspaceIdï¼‰
  const ws = new WebSocket(`ws://localhost:8080/rest/push?workspaceId=${newWorkspaceId}`);

  // åç«¯å¯ä»¥ä» query parameter æˆ–åˆå§‹æ¡æ‰‹æ¶ˆæ¯ä¸­è·å– workspaceId
});
```

#### 4. **API è·¯ç”±è®¾è®¡æ›´æ¸…æ™°**

å‰åç«¯åˆ†ç¦»å¼ºåˆ¶ API è®¾è®¡éµå¾ª RESTful è§„èŒƒï¼š

```typescript
// å·¥ä½œç©ºé—´ç›¸å…³ API
GET    /rest/workspaces              // è·å–å½“å‰ç”¨æˆ·æ‰€æœ‰å·¥ä½œç©ºé—´
POST   /rest/workspaces              // åˆ›å»ºæ–°å·¥ä½œç©ºé—´
GET    /rest/workspaces/:id          // è·å–å·¥ä½œç©ºé—´è¯¦æƒ…
PATCH  /rest/workspaces/:id          // æ›´æ–°å·¥ä½œç©ºé—´ä¿¡æ¯
DELETE /rest/workspaces/:id          // åˆ é™¤/å½’æ¡£å·¥ä½œç©ºé—´

// å·¥ä½œç©ºé—´æˆå‘˜ç®¡ç†
GET    /rest/workspaces/:id/members  // è·å–æˆå‘˜åˆ—è¡¨
POST   /rest/workspaces/:id/members  // æ·»åŠ æˆå‘˜
DELETE /rest/workspaces/:id/members/:userId  // ç§»é™¤æˆå‘˜

// å·¥ä½œæµ APIï¼ˆå·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡é€šè¿‡ Header ä¼ é€’ï¼‰
GET    /rest/workflows               // è·å–å½“å‰å·¥ä½œç©ºé—´çš„å·¥ä½œæµ
POST   /rest/workflows               // åœ¨å½“å‰å·¥ä½œç©ºé—´åˆ›å»ºå·¥ä½œæµ
GET    /rest/workflows/:id           // è·å–å·¥ä½œæµè¯¦æƒ…
PATCH  /rest/workflows/:id           // æ›´æ–°å·¥ä½œæµ
DELETE /rest/workflows/:id           // åˆ é™¤å·¥ä½œæµ

// è®¡è´¹ç›¸å…³ API
GET    /rest/billing/balance         // è·å–å½“å‰å·¥ä½œç©ºé—´ä½™é¢
POST   /rest/billing/recharge        // å‘èµ·å……å€¼
GET    /rest/billing/usage           // è·å–æ¶ˆè´¹è®°å½•
GET    /rest/billing/recharges       // è·å–å……å€¼è®°å½•

// å¹³å°æœåŠ¡ APIï¼ˆç”¨æˆ·è°ƒç”¨ï¼‰
GET    /rest/platform-services       // è·å–å¯ç”¨å¹³å°æœåŠ¡åˆ—è¡¨
POST   /rest/platform-rag/query      // è°ƒç”¨å¹³å° RAG æœåŠ¡

// åå°ç®¡ç† APIï¼ˆä»…ç®¡ç†å‘˜ï¼‰
GET    /rest/admin/platform-services           // ç®¡ç†å¹³å°æœåŠ¡
POST   /rest/admin/platform-services           // åˆ›å»ºå¹³å°æœåŠ¡
PATCH  /rest/admin/platform-services/:key      // æ›´æ–°å¹³å°æœåŠ¡
GET    /rest/admin/workspaces                  // æœç´¢æ‰€æœ‰å·¥ä½œç©ºé—´
POST   /rest/admin/workspaces/:id/recharge     // ç®¡ç†å‘˜å……å€¼
GET    /rest/admin/stats/overview              // å¹³å°ç»Ÿè®¡æ•°æ®
```

#### 5. **è®¤è¯å’Œé‰´æƒæ›´æ ‡å‡†åŒ–**

```typescript
// JWT Token æµç¨‹ï¼ˆæ¨èï¼‰

// 1. ç™»å½•è·å– token
POST /rest/auth/login
Response: {
  token: "eyJhbGciOiJIUzI1...",
  user: { id, email, isAdmin },
  workspaces: [...]
}

// 2. å‰ç«¯å­˜å‚¨ tokenï¼ˆlocalStorage æˆ– httpOnly cookieï¼‰
localStorage.setItem('n8n_token', token);

// 3. æ¯æ¬¡è¯·æ±‚æºå¸¦ token
axios.interceptors.request.use((config) => {
  const token = localStorage.getItem('n8n_token');
  config.headers['Authorization'] = `Bearer ${token}`;
  config.headers['X-Workspace-Id'] = currentWorkspaceId;
  return config;
});

// 4. åç«¯éªŒè¯ token + å·¥ä½œç©ºé—´æƒé™
export const authMiddleware: RequestHandler = async (req, res, next) => {
  const token = req.headers['authorization']?.replace('Bearer ', '');
  const workspaceId = req.headers['x-workspace-id'];

  // éªŒè¯ JWT token
  const decoded = jwt.verify(token, process.env.JWT_SECRET);
  req.user = decoded;

  // éªŒè¯å·¥ä½œç©ºé—´æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
  if (workspaceId) {
    const hasAccess = await workspaceContextService.validateAccess(
      decoded.userId,
      workspaceId,
    );
    if (!hasAccess) {
      return res.status(403).json({ error: 'Forbidden' });
    }
    req.workspaceContext = { workspaceId };
  }

  next();
};
```

---

### 2.2 âš ï¸ éœ€è¦æ³¨æ„çš„å½±å“

#### 1. **CORS é…ç½®**

**å¼€å‘ç¯å¢ƒï¼ˆå½“å‰å·²è§£å†³ï¼‰ï¼š**
```typescript
// å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰æº
if (isDevelopment) {
  res.header('Access-Control-Allow-Origin', origin);
  res.header('Access-Control-Allow-Credentials', 'true');
}
```

**ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦é…ç½®ï¼‰ï¼š**
```bash
# .env
ALLOWED_ORIGINS=https://user.example.com,https://admin.example.com
```

**å»ºè®®ï¼š**
- ç”Ÿäº§ç¯å¢ƒæ˜ç¡®é…ç½®å…è®¸çš„å‰ç«¯åŸŸå
- ä¸è¦ä½¿ç”¨é€šé…ç¬¦ `*`ï¼ˆå®‰å…¨é—®é¢˜ï¼‰
- ç¡®ä¿ `Access-Control-Allow-Credentials: true`ï¼ˆæ”¯æŒ Cookie/Sessionï¼‰

#### 2. **Cookie å’Œ Session å¤„ç†**

**é—®é¢˜ï¼š** å‰åç«¯åˆ†ç¦»åï¼ŒCookie çš„åŸŸåéœ€è¦ç‰¹æ®Šå¤„ç†

**æ–¹æ¡ˆ Aï¼šä½¿ç”¨ JWTï¼ˆæ¨èï¼‰**
```typescript
// æ— éœ€ Cookieï¼Œtoken å­˜å‚¨åœ¨ localStorage
// æ¯æ¬¡è¯·æ±‚é€šè¿‡ Authorization header ä¼ é€’
```

**æ–¹æ¡ˆ Bï¼šè·¨åŸŸ Cookie**
```typescript
// åç«¯è®¾ç½® Cookie æ—¶
res.cookie('n8n_session', sessionId, {
  httpOnly: true,
  secure: true, // ä»… HTTPS
  sameSite: 'none', // å…è®¸è·¨åŸŸ
  domain: '.example.com', // ä¸»åŸŸåï¼ˆå…è®¸å­åŸŸåå…±äº«ï¼‰
});

// å‰ç«¯è¯·æ±‚æ—¶
axios.defaults.withCredentials = true;
```

#### 3. **WebSocket å·¥ä½œç©ºé—´éš”ç¦»**

**é—®é¢˜ï¼š** WebSocket è¿æ¥éœ€è¦æºå¸¦å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// æ–¹å¼ Aï¼šé€šè¿‡ Query Parameter
const ws = new WebSocket(`ws://api.example.com/rest/push?workspaceId=${workspaceId}`);

// æ–¹å¼ Bï¼šé€šè¿‡åˆå§‹æ¡æ‰‹æ¶ˆæ¯
const ws = new WebSocket('ws://api.example.com/rest/push');
ws.onopen = () => {
  ws.send(JSON.stringify({
    type: 'auth',
    token: authToken,
    workspaceId: currentWorkspaceId,
  }));
};

// åç«¯éªŒè¯
io.on('connection', (socket) => {
  socket.on('auth', async (data) => {
    const { token, workspaceId } = data;
    const user = await verifyToken(token);
    const hasAccess = await validateWorkspaceAccess(user.id, workspaceId);

    if (hasAccess) {
      socket.workspaceId = workspaceId;
      socket.userId = user.id;
      // åŠ å…¥å·¥ä½œç©ºé—´æˆ¿é—´ï¼ˆç”¨äºå¹¿æ’­ï¼‰
      socket.join(`workspace:${workspaceId}`);
    } else {
      socket.disconnect();
    }
  });
});
```

**å·¥ä½œç©ºé—´åˆ‡æ¢æ—¶çš„å¤„ç†ï¼š**
```typescript
// å‰ç«¯ï¼šåˆ‡æ¢å·¥ä½œç©ºé—´
function switchWorkspace(newWorkspaceId: string) {
  // 1. æ›´æ–° store
  projectsStore.setActiveWorkspace(newWorkspaceId);

  // 2. å…³é—­æ—§ WebSocket è¿æ¥
  if (pushConnection) {
    pushConnection.close();
  }

  // 3. å»ºç«‹æ–° WebSocket è¿æ¥ï¼ˆå¸¦æ–° workspaceIdï¼‰
  pushConnection = new WebSocket(`ws://api.example.com/rest/push?workspaceId=${newWorkspaceId}`);

  // 4. åˆ·æ–°é¡µé¢æ•°æ®
  await workflowsStore.fetchWorkflows();
  await credentialsStore.fetchCredentials();
}
```

#### 4. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„**

**æ–¹æ¡ˆ Aï¼šNginx åå‘ä»£ç†ï¼ˆæ¨èï¼‰**

```nginx
# /etc/nginx/sites-available/n8n

# ç”¨æˆ·å‰ç«¯
server {
    listen 443 ssl http2;
    server_name user.example.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # å‰ç«¯é™æ€æ–‡ä»¶
    root /var/www/n8n/editor-ui/dist;
    index index.html;

    # SPA è·¯ç”±æ”¯æŒ
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API ä»£ç†åˆ°åç«¯
    location /rest {
        proxy_pass http://localhost:5678;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket æ”¯æŒ
    location /rest/push {
        proxy_pass http://localhost:5678;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Webhook ç«¯ç‚¹
    location /webhook {
        proxy_pass http://localhost:5678;
    }
}

# ç®¡ç†åå°å‰ç«¯
server {
    listen 443 ssl http2;
    server_name admin.example.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # åå°ç®¡ç†å‰ç«¯é™æ€æ–‡ä»¶
    root /var/www/n8n/admin-panel/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # API ä»£ç†åˆ°åç«¯ï¼ˆä¸ç”¨æˆ·å‰ç«¯å…±äº«åç«¯ï¼‰
    location /rest {
        proxy_pass http://localhost:5678;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**æ–¹æ¡ˆ Bï¼šCDN + API Gateway**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CDN (Cloudflare)â”‚
â”‚  é™æ€æ–‡ä»¶æ‰˜ç®¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway     â”‚
â”‚  (AWS/é˜¿é‡Œäº‘)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  n8n Backend     â”‚
â”‚  Express Server  â”‚
â”‚  Port: 5678      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ”¹é€ æ–¹æ¡ˆé€‚é…è°ƒæ•´

### 3.1 å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡æœåŠ¡ï¼ˆWorkspaceContextServiceï¼‰

**å¢å¼ºï¼šæ·»åŠ  HTTP Header æ”¯æŒ**

```typescript
// packages/cli/src/services/workspace-context.service.ts

@Service()
export class WorkspaceContextService {
  constructor(
    private readonly projectService: ProjectService,
    private readonly projectRelationRepository: ProjectRelationRepository,
  ) {}

  /**
   * ä» HTTP è¯·æ±‚ä¸­æå–å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡
   */
  extractWorkspaceContext(req: Request): string | undefined {
    // ä¼˜å…ˆçº§ 1: HTTP Header
    const headerWorkspaceId = req.headers['x-workspace-id'] as string;
    if (headerWorkspaceId) {
      return headerWorkspaceId;
    }

    // ä¼˜å…ˆçº§ 2: Query Parameter
    const queryWorkspaceId = req.query.workspaceId as string;
    if (queryWorkspaceId) {
      return queryWorkspaceId;
    }

    // ä¼˜å…ˆçº§ 3: ç”¨æˆ·é»˜è®¤å·¥ä½œç©ºé—´
    if (req.user) {
      return this.getUserDefaultWorkspace(req.user.id);
    }

    return undefined;
  }

  /**
   * éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®å·¥ä½œç©ºé—´çš„æƒé™
   */
  async validateAccess(
    userId: string,
    workspaceId: string,
    requiredRole?: 'project:admin' | 'project:editor' | 'project:viewer',
  ): Promise<boolean> {
    const relation = await this.projectRelationRepository.findOne({
      where: { userId, projectId: workspaceId },
    });

    if (!relation) {
      return false;
    }

    // å¦‚æœæ²¡æœ‰æŒ‡å®šæ‰€éœ€è§’è‰²ï¼Œåªè¦æ˜¯æˆå‘˜å°±é€šè¿‡
    if (!requiredRole) {
      return true;
    }

    // è§’è‰²æƒé™æ£€æŸ¥
    const roleHierarchy = {
      'project:admin': 3,
      'project:editor': 2,
      'project:viewer': 1,
    };

    return roleHierarchy[relation.role] >= roleHierarchy[requiredRole];
  }

  /**
   * ä¸­é—´ä»¶ï¼šéªŒè¯å·¥ä½œç©ºé—´è®¿é—®æƒé™
   */
  createValidationMiddleware(
    requiredRole?: 'project:admin' | 'project:editor' | 'project:viewer',
  ): RequestHandler {
    return async (req: AuthenticatedRequest, res, next) => {
      const workspaceId = this.extractWorkspaceContext(req);

      if (!workspaceId) {
        return res.status(400).json({
          error: 'Missing workspace context',
          message: 'X-Workspace-Id header or workspaceId query parameter required',
        });
      }

      const hasAccess = await this.validateAccess(
        req.user.id,
        workspaceId,
        requiredRole,
      );

      if (!hasAccess) {
        return res.status(403).json({
          error: 'Forbidden',
          message: `You do not have ${requiredRole || 'access'} to this workspace`,
        });
      }

      // å°†å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
      req.workspaceContext = { workspaceId };
      next();
    };
  }
}
```

### 3.2 å‰ç«¯ Axios æ‹¦æˆªå™¨

**è‡ªåŠ¨é™„åŠ å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡**

```typescript
// packages/frontend/editor-ui/src/plugins/axios.ts

import axios from 'axios';
import { useProjectsStore } from '@/stores/projects.store';

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨é™„åŠ å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡
axios.interceptors.request.use(
  (config) => {
    const projectsStore = useProjectsStore();
    const activeWorkspaceId = projectsStore.currentWorkspaceId;

    // é™„åŠ å·¥ä½œç©ºé—´ ID
    if (activeWorkspaceId) {
      config.headers['X-Workspace-Id'] = activeWorkspaceId;
    }

    // é™„åŠ è®¤è¯ token
    const token = localStorage.getItem('n8n_token');
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`;
    }

    return config;
  },
  (error) => Promise.reject(error),
);

// å“åº”æ‹¦æˆªå™¨ï¼šå¤„ç†å·¥ä½œç©ºé—´ç›¸å…³é”™è¯¯
axios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 403) {
      const message = error.response.data?.message;
      if (message?.includes('workspace')) {
        // å·¥ä½œç©ºé—´æƒé™ä¸è¶³ï¼Œè·³è½¬åˆ°å·¥ä½œç©ºé—´é€‰æ‹©é¡µ
        router.push('/workspaces');
      }
    }
    return Promise.reject(error);
  },
);
```

### 3.3 åç«¯è·¯ç”±åº”ç”¨ä¸­é—´ä»¶

```typescript
// packages/cli/src/controllers/workspaces.controller.ts

import { Get, Post, Patch, Delete, RestController } from '@/decorators';
import { WorkspaceContextService } from '@/services/workspace-context.service';

@RestController('/workspaces')
export class WorkspacesController {
  constructor(
    private readonly projectService: ProjectService,
    private readonly workspaceContextService: WorkspaceContextService,
  ) {}

  /**
   * è·å–å½“å‰ç”¨æˆ·æ‰€æœ‰å·¥ä½œç©ºé—´ï¼ˆæ— éœ€å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡ï¼‰
   */
  @Get('/')
  async listWorkspaces(req: AuthenticatedRequest) {
    return await this.projectService.getProjectsForUser(req.user.id);
  }

  /**
   * åˆ›å»ºæ–°å·¥ä½œç©ºé—´
   */
  @Post('/')
  async createWorkspace(req: AuthenticatedRequest) {
    const { name, type } = req.body;
    return await this.projectService.createTeamWorkspace(req.user, { name, type });
  }

  /**
   * è·å–å·¥ä½œç©ºé—´è¯¦æƒ…ï¼ˆéœ€è¦è®¿é—®æƒé™ï¼‰
   */
  @Get('/:id')
  @UseMiddleware(workspaceContextService.createValidationMiddleware())
  async getWorkspace(req: AuthenticatedRequest) {
    const { id } = req.params;
    return await this.projectService.getProject(id);
  }

  /**
   * æ›´æ–°å·¥ä½œç©ºé—´ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
   */
  @Patch('/:id')
  @UseMiddleware(workspaceContextService.createValidationMiddleware('project:admin'))
  async updateWorkspace(req: AuthenticatedRequest) {
    const { id } = req.params;
    const updates = req.body;
    return await this.projectService.updateProject(id, updates);
  }

  /**
   * æ·»åŠ æˆå‘˜ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
   */
  @Post('/:id/members')
  @UseMiddleware(workspaceContextService.createValidationMiddleware('project:admin'))
  async addMember(req: AuthenticatedRequest) {
    const { id } = req.params;
    const { userId, role } = req.body;
    return await this.projectService.addMember(id, userId, role);
  }
}
```

### 3.4 WebSocket å·¥ä½œç©ºé—´éš”ç¦»

```typescript
// packages/cli/src/push/push.service.ts

import type { Server as SocketIOServer, Socket } from 'socket.io';

@Service()
export class PushService {
  constructor(
    private readonly workspaceContextService: WorkspaceContextService,
  ) {}

  setupHandlers(io: SocketIOServer) {
    io.on('connection', async (socket: Socket) => {
      this.logger.debug('New WebSocket connection', { socketId: socket.id });

      // ç­‰å¾…å®¢æˆ·ç«¯å‘é€è®¤è¯ä¿¡æ¯
      socket.on('auth', async (data: { token: string; workspaceId: string }) => {
        try {
          // éªŒè¯ JWT token
          const user = await this.verifyToken(data.token);

          // éªŒè¯å·¥ä½œç©ºé—´è®¿é—®æƒé™
          const hasAccess = await this.workspaceContextService.validateAccess(
            user.id,
            data.workspaceId,
          );

          if (!hasAccess) {
            socket.emit('auth-error', { message: 'Workspace access denied' });
            socket.disconnect();
            return;
          }

          // è®¤è¯æˆåŠŸï¼Œè®¾ç½® socket ä¸Šä¸‹æ–‡
          socket.data.userId = user.id;
          socket.data.workspaceId = data.workspaceId;

          // åŠ å…¥å·¥ä½œç©ºé—´æˆ¿é—´ï¼ˆç”¨äºå¹¿æ’­ï¼‰
          socket.join(`workspace:${data.workspaceId}`);
          socket.join(`user:${user.id}`);

          socket.emit('auth-success');
          this.logger.debug('WebSocket authenticated', {
            userId: user.id,
            workspaceId: data.workspaceId,
          });
        } catch (error) {
          socket.emit('auth-error', { message: error.message });
          socket.disconnect();
        }
      });

      // ç›‘å¬å·¥ä½œæµæ‰§è¡Œäº‹ä»¶ï¼ˆåªæ¨é€åˆ°å¯¹åº”å·¥ä½œç©ºé—´ï¼‰
      socket.on('subscribe-workflow', async (workflowId: string) => {
        const workspaceId = socket.data.workspaceId;

        // éªŒè¯è¯¥å·¥ä½œæµæ˜¯å¦å±äºå½“å‰å·¥ä½œç©ºé—´
        const workflow = await this.workflowRepository.findOne({
          where: { id: workflowId, projectId: workspaceId },
        });

        if (workflow) {
          socket.join(`workflow:${workflowId}`);
        }
      });

      socket.on('disconnect', () => {
        this.logger.debug('WebSocket disconnected', { socketId: socket.id });
      });
    });
  }

  /**
   * æ¨é€å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€æ›´æ–°ï¼ˆåªå‘é€åˆ°å¯¹åº”å·¥ä½œç©ºé—´ï¼‰
   */
  sendWorkflowExecutionUpdate(workflowId: string, executionData: any) {
    // åªæ¨é€ç»™è®¢é˜…äº†è¯¥å·¥ä½œæµçš„è¿æ¥
    this.io.to(`workflow:${workflowId}`).emit('workflow-execution-update', {
      workflowId,
      ...executionData,
    });
  }

  /**
   * å¹¿æ’­åˆ°æ•´ä¸ªå·¥ä½œç©ºé—´
   */
  broadcastToWorkspace(workspaceId: string, event: string, data: any) {
    this.io.to(`workspace:${workspaceId}`).emit(event, data);
  }
}
```

**å‰ç«¯ WebSocket è¿æ¥ï¼š**

```typescript
// packages/frontend/editor-ui/src/composables/usePushConnection.ts

import { ref, watch } from 'vue';
import { io, type Socket } from 'socket.io-client';
import { useProjectsStore } from '@/stores/projects.store';
import { useAuthStore } from '@/stores/auth.store';

export function usePushConnection() {
  const socket = ref<Socket | null>(null);
  const projectsStore = useProjectsStore();
  const authStore = useAuthStore();

  function connect(workspaceId: string) {
    // å…³é—­æ—§è¿æ¥
    if (socket.value) {
      socket.value.disconnect();
    }

    // å»ºç«‹æ–°è¿æ¥
    socket.value = io('/rest/push', {
      transports: ['websocket'],
      auth: {
        token: authStore.token,
        workspaceId,
      },
    });

    socket.value.on('connect', () => {
      console.log('WebSocket connected', { workspaceId });
    });

    socket.value.on('auth-success', () => {
      console.log('WebSocket authenticated');
    });

    socket.value.on('auth-error', (error) => {
      console.error('WebSocket auth failed', error);
    });

    socket.value.on('disconnect', () => {
      console.log('WebSocket disconnected');
    });
  }

  // ç›‘å¬å·¥ä½œç©ºé—´åˆ‡æ¢ï¼Œè‡ªåŠ¨é‡è¿
  watch(
    () => projectsStore.currentWorkspaceId,
    (newWorkspaceId) => {
      if (newWorkspaceId) {
        connect(newWorkspaceId);
      }
    },
    { immediate: true },
  );

  return {
    socket,
    connect,
  };
}
```

---

## å››ã€ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•

### 4.1 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .envï¼ˆåç«¯ï¼‰

# æ•°æ®åº“
DATABASE_TYPE=postgresdb
DB_POSTGRESDB_HOST=localhost
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n
DB_POSTGRESDB_PASSWORD=<your-password>

# CORSï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»é…ç½®ï¼‰
ALLOWED_ORIGINS=https://user.example.com,https://admin.example.com

# JWTï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»é…ç½®å¼ºå¯†é’¥ï¼‰
JWT_SECRET=<your-strong-jwt-secret>
JWT_EXPIRES_IN=7d

# API åŸºç¡€ URL
N8N_HOST=user.example.com
N8N_PROTOCOL=https
N8N_PORT=443

# å·¥ä½œç©ºé—´ç›¸å…³
DEFAULT_WORKSPACE_TYPE=personal
MAX_WORKSPACES_PER_USER=10

# è®¡è´¹ç³»ç»Ÿ
BILLING_ENABLED=true
BILLING_CURRENCY=CNY
LOW_BALANCE_THRESHOLD=10

# æ”¯ä»˜ç½‘å…³
PAYMENT_PROVIDER=alipay
ALIPAY_APP_ID=<your-alipay-app-id>
ALIPAY_PRIVATE_KEY=<your-alipay-private-key>

# å¹³å°æœåŠ¡
PLATFORM_SERVICES_ENABLED=true
OPENAI_API_KEY=<your-openai-api-key>

# åå°ç®¡ç†
ADMIN_PANEL_ENABLED=true
```

### 4.2 Nginx é…ç½®ç¤ºä¾‹

è§ä¸Šæ–‡ 2.2.4 èŠ‚ã€‚

### 4.3 éƒ¨ç½²æ­¥éª¤

```bash
# 1. æ„å»ºå‰ç«¯
cd packages/frontend/editor-ui
pnpm build
# è¾“å‡ºï¼šdist/

cd ../admin-panel
pnpm build
# è¾“å‡ºï¼šdist/

# 2. æ„å»ºåç«¯
cd ../../..
pnpm build
# è¾“å‡ºï¼špackages/cli/dist/

# 3. éƒ¨ç½²å‰ç«¯é™æ€æ–‡ä»¶åˆ° Nginx
cp -r packages/frontend/editor-ui/dist/* /var/www/n8n/user/
cp -r packages/frontend/admin-panel/dist/* /var/www/n8n/admin/

# 4. å¯åŠ¨åç«¯æœåŠ¡ï¼ˆPM2ï¼‰
pm2 start packages/cli/dist/index.js --name n8n-backend

# 5. é…ç½® Nginx åå‘ä»£ç†
sudo ln -s /etc/nginx/sites-available/n8n /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# 6. é…ç½® SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰
sudo certbot --nginx -d user.example.com -d admin.example.com
```

---

## äº”ã€æ€»ç»“

### 5.1 å½±å“æ€»ç»“

| æ–¹é¢ | å½±å“ | ä¸¥é‡æ€§ | è§£å†³æ–¹æ¡ˆ |
|------|------|--------|----------|
| **å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡ä¼ é€’** | âœ… æ›´æ¸…æ™°ï¼ˆHTTP Headerï¼‰ | ä½ | å·²è§£å†³ |
| **åå°ç®¡ç†ç‹¬ç«‹éƒ¨ç½²** | âœ… æ›´çµæ´» | ä½ | å¤©ç„¶æ”¯æŒ |
| **WebSocket éš”ç¦»** | âš ï¸ éœ€è¦æ”¹é€  | ä¸­ | è§ 3.4 èŠ‚ |
| **CORS é…ç½®** | âš ï¸ ç”Ÿäº§ç¯å¢ƒéœ€é…ç½® | ä¸­ | è§ 2.2.1 èŠ‚ |
| **Cookie/Session** | âš ï¸ è·¨åŸŸé—®é¢˜ | ä½ | ä½¿ç”¨ JWTï¼ˆæ¨èï¼‰ |
| **API è·¯ç”±è®¾è®¡** | âœ… æ›´æ¸…æ™° | ä½ | è§ 2.1.4 èŠ‚ |

### 5.2 æœ€ç»ˆç»“è®º

**å‰åç«¯åˆ†ç¦»å¯¹å¤šç§Ÿæˆ·æ”¹é€ æ–¹æ¡ˆæ˜¯ç§¯æçš„å½±å“ï¼**

**ä¸»è¦ä¼˜åŠ¿ï¼š**
1. âœ… å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡ä¼ é€’æ›´æ¸…æ™°ï¼ˆHTTP Headerï¼‰
2. âœ… åå°ç®¡ç†ç³»ç»Ÿå¤©ç„¶ç‹¬ç«‹éƒ¨ç½²
3. âœ… API è·¯ç”±è®¾è®¡æ›´è§„èŒƒ
4. âœ… è®¤è¯é‰´æƒæ›´æ ‡å‡†åŒ–ï¼ˆJWTï¼‰
5. âœ… ä¾¿äºæœªæ¥æ‰©å±•ï¼ˆCDNã€è´Ÿè½½å‡è¡¡ï¼‰

**éœ€è¦æ³¨æ„ï¼š**
1. âš ï¸ WebSocket éœ€è¦å¢åŠ å·¥ä½œç©ºé—´éš”ç¦»é€»è¾‘
2. âš ï¸ ç”Ÿäº§ç¯å¢ƒéœ€è¦æ­£ç¡®é…ç½® CORS
3. âš ï¸ æ¨èä½¿ç”¨ JWT è€Œé Cookie/Session

**å®æ–½å»ºè®®ï¼š**
- åœ¨ç°æœ‰å‰åç«¯åˆ†ç¦»æ¶æ„åŸºç¡€ä¸Šè¿›è¡Œæ”¹é€ 
- ä¼˜å…ˆä½¿ç”¨ HTTP Header ä¼ é€’å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡
- WebSocket è¿æ¥å¢åŠ è®¤è¯å’Œå·¥ä½œç©ºé—´éªŒè¯
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Nginx åå‘ä»£ç†

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2025-11-07
**é…å¥—æ–‡æ¡£ï¼š** 01-æ¶æ„åº•å±‚æ”¹é€ æ–¹æ¡ˆ.md (v3.0), 02-æ¶æ„å›¾å’Œæµç¨‹å›¾.md (v2.0)
