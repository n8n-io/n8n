# n8n å¤šç§Ÿæˆ·æ¶æ„ - æ•°æ®åº“åˆå§‹åŒ–æ–¹æ¡ˆï¼ˆå…¨æ–°é¡¹ç›®ï¼‰

> **é…å¥—æ–‡æ¡£ï¼š** 01-æ¶æ„åº•å±‚æ”¹é€ æ–¹æ¡ˆ.md (v3.0), 02-æ¶æ„å›¾å’Œæµç¨‹å›¾.md (v2.0)
> **ç‰ˆæœ¬ï¼š** v1.0
> **æ—¥æœŸï¼š** 2025-11-07
> **çŠ¶æ€ï¼š** âœ… é€‚ç”¨äºæœªä¸Šçº¿é¡¹ç›®

---

## ğŸ“‹ ä¸€ã€é¡¹ç›®ç°çŠ¶è¯´æ˜

### 1.1 å½“å‰æƒ…å†µ

- âœ… **é¡¹ç›®æœªä¸Šçº¿ç”Ÿäº§ç¯å¢ƒ**
- âœ… **æ— çœŸå®ç”¨æˆ·æ•°æ®**
- âœ… **å¼€å‘ç¯å¢ƒå¯ä»¥é‡ç½®**
- âœ… **å¯ä»¥ç›´æ¥æŒ‰æ–°æ¶æ„åˆ›å»ºæ•°æ®åº“**

### 1.2 å®æ–½ç­–ç•¥

æ—¢ç„¶æ˜¯å…¨æ–°é¡¹ç›®ï¼Œæˆ‘ä»¬é‡‡ç”¨**ç›´æ¥åˆ›å»ºæ–°æ¶æ„**çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯å¤æ‚çš„æ•°æ®è¿ç§»ï¼š

```
âŒ é”™è¯¯åšæ³•ï¼ˆä¸éœ€è¦ï¼‰:
1. å¤‡ä»½ shared_workflow
2. è¿ç§»æ•°æ®
3. æ·»åŠ çº¦æŸ
4. åˆ é™¤æ—§è¡¨

âœ… æ­£ç¡®åšæ³•ï¼ˆä½ ä»¬çš„æƒ…å†µï¼‰:
1. ç›´æ¥åˆ é™¤ shared_workflow å’Œ shared_credentials è¡¨
2. åœ¨ workflow_entity å’Œ credentials_entity æ·»åŠ  project_id å­—æ®µ
3. åˆ›å»ºæ–°çš„å¤šç§Ÿæˆ·ç›¸å…³è¡¨
4. TypeORM è‡ªåŠ¨åŒæ­¥æ•°æ®åº“ç»“æ„
```

---

## äºŒã€æ•°æ®åº“æ¸…ç†è„šæœ¬ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

### 2.1 æ¸…ç†æ—§è¡¨ï¼ˆæ¿€è¿›æ”¹é€ ï¼‰

```sql
-- ============================================
-- æ¸…ç†æ—§çš„å¤šå¯¹å¤šå…³ç³»è¡¨
-- âš ï¸ ä»…é€‚ç”¨äºå¼€å‘ç¯å¢ƒï¼Œæœªä¸Šçº¿é¡¹ç›®
-- ============================================

-- åˆ é™¤ shared_workflow è¡¨åŠå…¶ç›¸å…³çº¦æŸ
DROP TABLE IF EXISTS shared_workflow CASCADE;

-- åˆ é™¤ shared_credentials è¡¨åŠå…¶ç›¸å…³çº¦æŸ
DROP TABLE IF EXISTS shared_credentials CASCADE;

-- æ¸…ç†ç›¸å…³ç´¢å¼•ï¼ˆå¦‚æœæœ‰ï¼‰
DROP INDEX IF EXISTS idx_shared_workflow_workflow_id;
DROP INDEX IF EXISTS idx_shared_workflow_project_id;
DROP INDEX IF EXISTS idx_shared_credentials_credentials_id;
DROP INDEX IF EXISTS idx_shared_credentials_project_id;

-- âœ… å®Œæˆï¼æ—§è¡¨å·²åˆ é™¤
```

### 2.2 éªŒè¯æ¸…ç†ç»“æœ

```sql
-- éªŒè¯æ—§è¡¨å·²åˆ é™¤
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('shared_workflow', 'shared_credentials');

-- é¢„æœŸç»“æœï¼šè¿”å› 0 è¡Œ
```

---

## ä¸‰ã€æ–°æ¶æ„æ•°æ®åº“åˆå§‹åŒ–

### 3.1 æ–¹å¼ä¸€ï¼šä½¿ç”¨ TypeORM Migrationï¼ˆæ¨èï¼‰

åˆ›å»º TypeORM migration æ–‡ä»¶è‡ªåŠ¨å¤„ç†æ•°æ®åº“ç»“æ„ï¼š

```typescript
// packages/cli/src/databases/migrations/1731000000000-AddMultiTenantSupport.ts

import type { MigrationContext, ReversibleMigration } from '@/databases/types';

export class AddMultiTenantSupport1731000000000 implements ReversibleMigration {
  async up({ queryRunner, tablePrefix }: MigrationContext): Promise<void> {
    // 1. ä¸º workflow_entity æ·»åŠ  project_id
    await queryRunner.query(`
      ALTER TABLE ${tablePrefix}workflow_entity
      ADD COLUMN project_id UUID NOT NULL,
      ADD CONSTRAINT fk_workflow_project
        FOREIGN KEY (project_id)
        REFERENCES ${tablePrefix}project(id)
        ON DELETE CASCADE
    `);

    // 2. ä¸º credentials_entity æ·»åŠ  project_id å’Œ is_managed
    await queryRunner.query(`
      ALTER TABLE ${tablePrefix}credentials_entity
      ADD COLUMN project_id UUID NOT NULL,
      ADD COLUMN is_managed BOOLEAN DEFAULT false,
      ADD CONSTRAINT fk_credentials_project
        FOREIGN KEY (project_id)
        REFERENCES ${tablePrefix}project(id)
        ON DELETE CASCADE
    `);

    // 3. ä¸º execution_entity æ·»åŠ  workspace_id
    await queryRunner.query(`
      ALTER TABLE ${tablePrefix}execution_entity
      ADD COLUMN workspace_id UUID,
      ADD CONSTRAINT fk_execution_workspace
        FOREIGN KEY (workspace_id)
        REFERENCES ${tablePrefix}project(id)
        ON DELETE SET NULL
    `);

    // 4. ä¸º variables_entity æ·»åŠ  project_id
    await queryRunner.query(`
      ALTER TABLE ${tablePrefix}variables_entity
      ADD COLUMN project_id UUID,
      ADD CONSTRAINT fk_variables_project
        FOREIGN KEY (project_id)
        REFERENCES ${tablePrefix}project(id)
        ON DELETE CASCADE
    `);

    // 5. åˆ›å»ºç´¢å¼•
    await queryRunner.query(`
      CREATE INDEX idx_workflow_project_id ON ${tablePrefix}workflow_entity(project_id);
      CREATE INDEX idx_workflow_project_active ON ${tablePrefix}workflow_entity(project_id, active);
      CREATE INDEX idx_credentials_project_id ON ${tablePrefix}credentials_entity(project_id);
      CREATE INDEX idx_execution_workspace_id ON ${tablePrefix}execution_entity(workspace_id);
    `);

    // 6. åˆ›å»ºè®¡è´¹ç›¸å…³è¡¨
    await queryRunner.query(`
      CREATE TABLE ${tablePrefix}workspace_balance (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        workspace_id UUID NOT NULL UNIQUE,
        balance_cny NUMERIC(12, 4) DEFAULT 0.0000,
        low_balance_threshold_cny NUMERIC(10, 4) DEFAULT 10.0000,
        currency VARCHAR(3) DEFAULT 'CNY',
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW(),
        CONSTRAINT fk_workspace_balance_workspace
          FOREIGN KEY (workspace_id)
          REFERENCES ${tablePrefix}project(id)
          ON DELETE CASCADE
      );
    `);

    await queryRunner.query(`
      CREATE TABLE ${tablePrefix}usage_record (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        workspace_id UUID NOT NULL,
        user_id UUID NOT NULL,
        service_key VARCHAR(100) NOT NULL,
        service_type VARCHAR(50) NOT NULL,
        tokens_used INT,
        calls_count INT DEFAULT 1,
        amount_cny NUMERIC(10, 4) NOT NULL,
        metadata JSONB,
        created_at TIMESTAMP DEFAULT NOW(),
        CONSTRAINT fk_usage_workspace
          FOREIGN KEY (workspace_id)
          REFERENCES ${tablePrefix}project(id)
          ON DELETE CASCADE,
        CONSTRAINT fk_usage_user
          FOREIGN KEY (user_id)
          REFERENCES ${tablePrefix}user(id)
          ON DELETE CASCADE
      );
    `);

    // åˆ›å»ºç´¢å¼•
    await queryRunner.query(`
      CREATE INDEX idx_usage_workspace ON ${tablePrefix}usage_record(workspace_id);
      CREATE INDEX idx_usage_workspace_date ON ${tablePrefix}usage_record(workspace_id, created_at DESC);
      CREATE INDEX idx_usage_service ON ${tablePrefix}usage_record(service_key);
    `);

    // 7. åˆ›å»ºå¹³å°æœåŠ¡è¡¨
    await queryRunner.query(`
      CREATE TABLE ${tablePrefix}platform_service (
        service_key VARCHAR(100) PRIMARY KEY,
        service_type VARCHAR(50) NOT NULL,
        name VARCHAR(200) NOT NULL,
        pricing_config JSONB NOT NULL,
        is_active BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
      );
    `);

    await queryRunner.query(`
      CREATE TABLE ${tablePrefix}platform_rag_service (
        service_key VARCHAR(100) PRIMARY KEY,
        name VARCHAR(200) NOT NULL,
        domain VARCHAR(50) NOT NULL,
        price_per_query_cny NUMERIC(10, 4) NOT NULL,
        metadata JSONB,
        is_active BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
      );
    `);

    // 8. åˆ›å»ºå……å€¼è®°å½•è¡¨
    await queryRunner.query(`
      CREATE TABLE ${tablePrefix}recharge_record (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        workspace_id UUID NOT NULL,
        user_id UUID NOT NULL,
        amount_cny NUMERIC(10, 2) NOT NULL,
        payment_method VARCHAR(50) NOT NULL,
        transaction_id VARCHAR(200),
        status VARCHAR(20) DEFAULT 'pending',
        completed_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT NOW(),
        CONSTRAINT fk_recharge_workspace
          FOREIGN KEY (workspace_id)
          REFERENCES ${tablePrefix}project(id)
          ON DELETE CASCADE,
        CONSTRAINT fk_recharge_user
          FOREIGN KEY (user_id)
          REFERENCES ${tablePrefix}user(id)
          ON DELETE CASCADE
      );
    `);

    await queryRunner.query(`
      CREATE INDEX idx_recharge_workspace ON ${tablePrefix}recharge_record(workspace_id);
      CREATE INDEX idx_recharge_status ON ${tablePrefix}recharge_record(workspace_id, status);
    `);

    // 9. åˆ›å»ºå¹³å°åŠŸèƒ½é…ç½®è¡¨ï¼ˆä¼ä¸šç‰ˆåŠŸèƒ½ç®¡ç†ï¼‰
    await queryRunner.query(`
      CREATE TABLE ${tablePrefix}platform_feature_config (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        feature_key VARCHAR(100) UNIQUE NOT NULL,
        enabled BOOLEAN DEFAULT FALSE,
        config JSONB DEFAULT '{}',
        description TEXT,
        updated_at TIMESTAMP DEFAULT NOW()
      );
    `);

    // åˆå§‹åŒ–å¹³å°åŠŸèƒ½é…ç½®æ•°æ®
    await queryRunner.query(`
      INSERT INTO ${tablePrefix}platform_feature_config (feature_key, enabled, config, description) VALUES
      ('ldap', FALSE, '{}', 'LDAP å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
      ('saml', FALSE, '{}', 'SAML å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
      ('oidc', FALSE, '{}', 'OIDC å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
      ('external_secrets', FALSE, '{}', 'å¤–éƒ¨å¯†é’¥ç®¡ç†ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
      ('log_streaming', FALSE, '{}', 'æ—¥å¿—æµï¼ˆä»…å¹³å°ä½¿ç”¨ï¼‰'),
      ('worker_view', FALSE, '{}', 'Worker ç›‘æ§ï¼ˆä»…ç®¡ç†å‘˜ï¼‰'),
      ('public_api', TRUE, '{"rate_limit_per_hour": 1000, "max_api_keys": 5}', 'Public APIï¼ˆå¯ç”¨ + é™æµï¼‰'),
      ('workflow_history', TRUE, '{"retention_days": -1}', 'å·¥ä½œæµç‰ˆæœ¬å†å²ï¼ˆæ— é™åˆ¶ï¼‰'),
      ('insights', TRUE, '{"date_range_limit_days": -1}', 'Insights åˆ†æï¼ˆæ— é™åˆ¶ï¼‰'),
      ('audit_logs', TRUE, '{"retention_days": 365}', 'å®¡è®¡æ—¥å¿—ï¼ˆä¿ç•™1å¹´ï¼‰');
    `);

    // 10. æ·»åŠ  User è¡¨çš„æ‰©å±•å­—æ®µ
    await queryRunner.query(`
      ALTER TABLE ${tablePrefix}user
      ADD COLUMN is_admin BOOLEAN DEFAULT false,
      ADD COLUMN feature_preferences JSONB DEFAULT '{}';
    `);

    // 11. æ·»åŠ  Project è¡¨çš„å·¥ä½œç©ºé—´åŠŸèƒ½é…ç½®å­—æ®µ
    await queryRunner.query(`
      ALTER TABLE ${tablePrefix}project
      ADD COLUMN feature_config JSONB DEFAULT '{}';
    `);
  }

  async down({ queryRunner, tablePrefix }: MigrationContext): Promise<void> {
    // å›æ»šæ“ä½œï¼ˆå¼€å‘ç¯å¢ƒä¸€èˆ¬ç”¨ä¸åˆ°ï¼‰
    await queryRunner.query(`ALTER TABLE ${tablePrefix}user DROP COLUMN IF EXISTS is_admin`);
    await queryRunner.query(`DROP TABLE IF EXISTS ${tablePrefix}recharge_record`);
    await queryRunner.query(`DROP TABLE IF EXISTS ${tablePrefix}platform_rag_service`);
    await queryRunner.query(`DROP TABLE IF EXISTS ${tablePrefix}platform_service`);
    await queryRunner.query(`DROP TABLE IF EXISTS ${tablePrefix}usage_record`);
    await queryRunner.query(`DROP TABLE IF EXISTS ${tablePrefix}workspace_balance`);

    await queryRunner.query(`ALTER TABLE ${tablePrefix}variables_entity DROP COLUMN IF EXISTS project_id`);
    await queryRunner.query(`ALTER TABLE ${tablePrefix}execution_entity DROP COLUMN IF EXISTS workspace_id`);
    await queryRunner.query(`ALTER TABLE ${tablePrefix}credentials_entity DROP COLUMN IF EXISTS project_id, DROP COLUMN IF EXISTS is_managed`);
    await queryRunner.query(`ALTER TABLE ${tablePrefix}workflow_entity DROP COLUMN IF EXISTS project_id`);
  }
}
```

**æ‰§è¡Œ migrationï¼š**
```bash
# è¿è¡Œ migration
pnpm --filter @n8n/cli db:migrate

# æˆ–è€…åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨ synchronizeï¼ˆè°¨æ…ï¼ï¼‰
# åœ¨ packages/cli/src/databases/config.ts ä¸­è®¾ç½® synchronize: true
```

---

### 3.2 æ–¹å¼äºŒï¼šç›´æ¥ SQL è„šæœ¬ï¼ˆå¿«é€Ÿï¼‰

å¦‚æœä½ æƒ³å¿«é€Ÿåœ¨å¼€å‘ç¯å¢ƒåˆå§‹åŒ–ï¼Œç›´æ¥æ‰§è¡Œå®Œæ•´ SQLï¼š

```bash
# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
psql -U n8n -d n8n < æ”¹é€ æ–¹æ¡ˆæ–‡æ¡£/scripts/init-multi-tenant-db.sql
```

**init-multi-tenant-db.sql:**
```sql
-- ============================================
-- n8n å¤šç§Ÿæˆ·æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
-- é€‚ç”¨äºï¼šæœªä¸Šçº¿çš„å…¨æ–°é¡¹ç›®
-- ============================================

BEGIN;

-- 1. åˆ é™¤æ—§è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP TABLE IF EXISTS shared_workflow CASCADE;
DROP TABLE IF EXISTS shared_credentials CASCADE;

-- 2. ä¿®æ”¹ workflow_entity
ALTER TABLE workflow_entity
ADD COLUMN IF NOT EXISTS project_id UUID;

ALTER TABLE workflow_entity
ADD CONSTRAINT fk_workflow_project
FOREIGN KEY (project_id)
REFERENCES project(id)
ON DELETE CASCADE;

CREATE INDEX IF NOT EXISTS idx_workflow_project_id ON workflow_entity(project_id);
CREATE INDEX IF NOT EXISTS idx_workflow_project_active ON workflow_entity(project_id, active);

-- 3. ä¿®æ”¹ credentials_entity
ALTER TABLE credentials_entity
ADD COLUMN IF NOT EXISTS project_id UUID,
ADD COLUMN IF NOT EXISTS is_managed BOOLEAN DEFAULT false;

ALTER TABLE credentials_entity
ADD CONSTRAINT fk_credentials_project
FOREIGN KEY (project_id)
REFERENCES project(id)
ON DELETE CASCADE;

CREATE INDEX IF NOT EXISTS idx_credentials_project_id ON credentials_entity(project_id);

-- 4. ä¿®æ”¹ execution_entity
ALTER TABLE execution_entity
ADD COLUMN IF NOT EXISTS workspace_id UUID;

ALTER TABLE execution_entity
ADD CONSTRAINT fk_execution_workspace
FOREIGN KEY (workspace_id)
REFERENCES project(id)
ON DELETE SET NULL;

CREATE INDEX IF NOT EXISTS idx_execution_workspace_id ON execution_entity(workspace_id);

-- 5. ä¿®æ”¹ variables_entity
ALTER TABLE variables_entity
ADD COLUMN IF NOT EXISTS project_id UUID;

ALTER TABLE variables_entity
ADD CONSTRAINT fk_variables_project
FOREIGN KEY (project_id)
REFERENCES project(id)
ON DELETE CASCADE;

-- 6. åˆ›å»ºè®¡è´¹ç³»ç»Ÿè¡¨
CREATE TABLE IF NOT EXISTS workspace_balance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL UNIQUE,
  balance_cny NUMERIC(12, 4) DEFAULT 0.0000,
  low_balance_threshold_cny NUMERIC(10, 4) DEFAULT 10.0000,
  currency VARCHAR(3) DEFAULT 'CNY',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_workspace_balance_workspace
    FOREIGN KEY (workspace_id)
    REFERENCES project(id)
    ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS usage_record (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL,
  user_id UUID NOT NULL,
  service_key VARCHAR(100) NOT NULL,
  service_type VARCHAR(50) NOT NULL,
  tokens_used INT,
  calls_count INT DEFAULT 1,
  amount_cny NUMERIC(10, 4) NOT NULL,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_usage_workspace
    FOREIGN KEY (workspace_id)
    REFERENCES project(id)
    ON DELETE CASCADE,
  CONSTRAINT fk_usage_user
    FOREIGN KEY (user_id)
    REFERENCES "user"(id)
    ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_usage_workspace ON usage_record(workspace_id);
CREATE INDEX IF NOT EXISTS idx_usage_workspace_date ON usage_record(workspace_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_usage_service ON usage_record(service_key);

CREATE TABLE IF NOT EXISTS platform_service (
  service_key VARCHAR(100) PRIMARY KEY,
  service_type VARCHAR(50) NOT NULL,
  name VARCHAR(200) NOT NULL,
  pricing_config JSONB NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS platform_rag_service (
  service_key VARCHAR(100) PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  domain VARCHAR(50) NOT NULL,
  price_per_query_cny NUMERIC(10, 4) NOT NULL,
  metadata JSONB,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS recharge_record (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL,
  user_id UUID NOT NULL,
  amount_cny NUMERIC(10, 2) NOT NULL,
  payment_method VARCHAR(50) NOT NULL,
  transaction_id VARCHAR(200),
  status VARCHAR(20) DEFAULT 'pending',
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT fk_recharge_workspace
    FOREIGN KEY (workspace_id)
    REFERENCES project(id)
    ON DELETE CASCADE,
  CONSTRAINT fk_recharge_user
    FOREIGN KEY (user_id)
    REFERENCES "user"(id)
    ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_recharge_workspace ON recharge_record(workspace_id);
CREATE INDEX IF NOT EXISTS idx_recharge_status ON recharge_record(workspace_id, status);

-- 7. åˆ›å»ºå¹³å°åŠŸèƒ½é…ç½®è¡¨ï¼ˆä¼ä¸šç‰ˆåŠŸèƒ½ç®¡ç†ï¼‰
CREATE TABLE IF NOT EXISTS platform_feature_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feature_key VARCHAR(100) UNIQUE NOT NULL,
  enabled BOOLEAN DEFAULT FALSE,
  config JSONB DEFAULT '{}',
  description TEXT,
  updated_at TIMESTAMP DEFAULT NOW()
);

-- åˆå§‹åŒ–å¹³å°åŠŸèƒ½é…ç½®æ•°æ®
INSERT INTO platform_feature_config (feature_key, enabled, config, description) VALUES
('ldap', FALSE, '{}', 'LDAP å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('saml', FALSE, '{}', 'SAML å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('oidc', FALSE, '{}', 'OIDC å•ç‚¹ç™»å½•ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('external_secrets', FALSE, '{}', 'å¤–éƒ¨å¯†é’¥ç®¡ç†ï¼ˆå¤šç§Ÿæˆ· SaaS ç¦ç”¨ï¼‰'),
('log_streaming', FALSE, '{}', 'æ—¥å¿—æµï¼ˆä»…å¹³å°ä½¿ç”¨ï¼‰'),
('worker_view', FALSE, '{}', 'Worker ç›‘æ§ï¼ˆä»…ç®¡ç†å‘˜ï¼‰'),
('public_api', TRUE, '{"rate_limit_per_hour": 1000, "max_api_keys": 5}', 'Public APIï¼ˆå¯ç”¨ + é™æµï¼‰'),
('workflow_history', TRUE, '{"retention_days": -1}', 'å·¥ä½œæµç‰ˆæœ¬å†å²ï¼ˆæ— é™åˆ¶ï¼‰'),
('insights', TRUE, '{"date_range_limit_days": -1}', 'Insights åˆ†æï¼ˆæ— é™åˆ¶ï¼‰'),
('audit_logs', TRUE, '{"retention_days": 365}', 'å®¡è®¡æ—¥å¿—ï¼ˆä¿ç•™1å¹´ï¼‰')
ON CONFLICT (feature_key) DO NOTHING;

-- 8. ä¿®æ”¹ user è¡¨ï¼ˆæ‰©å±•å­—æ®µï¼‰
ALTER TABLE "user"
ADD COLUMN IF NOT EXISTS is_admin BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS feature_preferences JSONB DEFAULT '{}';

-- 9. ä¿®æ”¹ project è¡¨ï¼ˆå·¥ä½œç©ºé—´åŠŸèƒ½é…ç½®ï¼‰
ALTER TABLE project
ADD COLUMN IF NOT EXISTS feature_config JSONB DEFAULT '{}';

COMMIT;

-- âœ… å¤šç§Ÿæˆ·æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼
```

---

## å››ã€å¼€å‘ç¯å¢ƒé‡ç½®æµç¨‹

å¦‚æœä½ çš„å¼€å‘ç¯å¢ƒå·²ç»æœ‰ä¸€äº›æµ‹è¯•æ•°æ®ï¼Œéœ€è¦å®Œå…¨é‡ç½®ï¼š

### 4.1 å®Œå…¨é‡ç½®ï¼ˆæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼‰

```bash
# æ–¹å¼1: åˆ é™¤æ•°æ®åº“é‡å»º
psql -U postgres << EOF
DROP DATABASE IF EXISTS n8n;
CREATE DATABASE n8n;
GRANT ALL PRIVILEGES ON DATABASE n8n TO n8n;
EOF

# æ–¹å¼2: ä½¿ç”¨ TypeORM é‡ç½®
pnpm --filter @n8n/cli db:drop
pnpm --filter @n8n/cli db:migrate
```

### 4.2 ä¿ç•™éƒ¨åˆ†æ•°æ®é‡ç½®

```sql
-- åªåˆ é™¤å·¥ä½œæµå’Œå‡­è¯æ•°æ®ï¼Œä¿ç•™ç”¨æˆ·å’Œé¡¹ç›®
TRUNCATE TABLE workflow_entity CASCADE;
TRUNCATE TABLE credentials_entity CASCADE;
TRUNCATE TABLE execution_entity CASCADE;
```

---

## äº”ã€åˆå§‹åŒ–æ•°æ®ç§å­

### 5.1 åˆ›å»ºåˆå§‹å¹³å°æœåŠ¡

```sql
-- ============================================
-- æ’å…¥åˆå§‹å¹³å°æœåŠ¡æ•°æ®
-- ============================================

-- AI æ¨¡å‹æœåŠ¡
INSERT INTO platform_service (service_key, service_type, name, pricing_config, is_active)
VALUES
  ('gpt-4-turbo', 'ai_model', 'GPT-4 Turbo', '{"pricePerToken": 0.00001, "currency": "CNY"}', true),
  ('gpt-3.5-turbo', 'ai_model', 'GPT-3.5 Turbo', '{"pricePerToken": 0.000001, "currency": "CNY"}', true),
  ('claude-3-opus', 'ai_model', 'Claude 3 Opus', '{"pricePerToken": 0.000015, "currency": "CNY"}', true);

-- RAG æœåŠ¡
INSERT INTO platform_rag_service (service_key, name, domain, price_per_query_cny, is_active)
VALUES
  ('legal-rag-cn', 'ä¸­å›½æ³•å¾‹çŸ¥è¯†åº“', 'legal', 0.50, true),
  ('medical-rag-cn', 'åŒ»ç–—å¥åº·çŸ¥è¯†åº“', 'medical', 0.80, true),
  ('finance-rag-cn', 'é‡‘èè´¢åŠ¡çŸ¥è¯†åº“', 'finance', 0.60, true);
```

### 5.2 åˆ›å»ºæµ‹è¯•ç®¡ç†å‘˜

```sql
-- åˆ›å»ºæµ‹è¯•ç®¡ç†å‘˜è´¦æˆ·ï¼ˆå¯†ç éœ€è¦åŠ å¯†ï¼‰
INSERT INTO "user" (id, email, first_name, password, is_admin, created_at)
VALUES
  (gen_random_uuid(), 'admin@example.com', 'Admin', '<hashed-password>', true, NOW());
```

---

## å…­ã€éªŒè¯æ¸…å•

### 6.1 æ•°æ®åº“ç»“æ„éªŒè¯

```sql
-- éªŒè¯1: æ£€æŸ¥æ—§è¡¨å·²åˆ é™¤
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('shared_workflow', 'shared_credentials');
-- âœ… é¢„æœŸï¼š0è¡Œ

-- éªŒè¯2: æ£€æŸ¥æ–°å­—æ®µå·²æ·»åŠ 
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'workflow_entity'
  AND column_name = 'project_id';
-- âœ… é¢„æœŸï¼šè¿”å› project_id, uuid

-- éªŒè¯3: æ£€æŸ¥å¤–é”®çº¦æŸ
SELECT
  conname as constraint_name,
  conrelid::regclass as table_name
FROM pg_constraint
WHERE contype = 'f'
  AND conname LIKE 'fk_workflow_project%';
-- âœ… é¢„æœŸï¼šè¿”å›å¤–é”®çº¦æŸ

-- éªŒè¯4: æ£€æŸ¥æ–°è¡¨å·²åˆ›å»º
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('workspace_balance', 'usage_record', 'platform_service', 'recharge_record', 'platform_feature_config');
-- âœ… é¢„æœŸï¼š5è¡Œ

-- éªŒè¯5: æ£€æŸ¥ platform_feature_config åˆå§‹æ•°æ®
SELECT feature_key, enabled, description
FROM platform_feature_config
ORDER BY feature_key;
-- âœ… é¢„æœŸï¼š10è¡Œï¼ˆldap, saml, oidcç­‰ï¼‰

-- éªŒè¯6: æ£€æŸ¥ user è¡¨æ‰©å±•å­—æ®µ
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'user'
  AND column_name IN ('is_admin', 'feature_preferences');
-- âœ… é¢„æœŸï¼š2è¡Œ

-- éªŒè¯7: æ£€æŸ¥ project è¡¨æ‰©å±•å­—æ®µ
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'project'
  AND column_name = 'feature_config';
-- âœ… é¢„æœŸï¼š1è¡Œï¼ˆfeature_config, jsonbï¼‰

-- éªŒè¯5: æ£€æŸ¥ç´¢å¼•å·²åˆ›å»º
SELECT indexname
FROM pg_indexes
WHERE indexname LIKE 'idx_workflow_project%'
   OR indexname LIKE 'idx_credentials_project%'
   OR indexname LIKE 'idx_usage_%';
-- âœ… é¢„æœŸï¼šè¿”å›æ‰€æœ‰ç´¢å¼•
```

### 6.2 åŠŸèƒ½éªŒè¯

```bash
# å¯åŠ¨åç«¯
pnpm dev

# æµ‹è¯•1: ç”¨æˆ·æ³¨å†Œ
curl -X POST http://localhost:5678/rest/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123456","firstName":"Test"}'

# æµ‹è¯•2: åˆ›å»ºå·¥ä½œç©ºé—´
curl -X POST http://localhost:5678/rest/workspaces \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"name":"My Workspace","type":"personal"}'

# æµ‹è¯•3: åˆ›å»ºå·¥ä½œæµï¼ˆéœ€è¦ X-Workspace-Id headerï¼‰
curl -X POST http://localhost:5678/rest/workflows \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -H "X-Workspace-Id: <workspace-id>" \
  -d '{"name":"Test Workflow","nodes":[],"connections":{}}'
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å®Œå…¨é‡ç½®å¼€å‘ç¯å¢ƒï¼Ÿ

```bash
# 1. åœæ­¢æœåŠ¡
pm2 stop n8n-backend

# 2. åˆ é™¤æ•°æ®åº“
psql -U postgres -c "DROP DATABASE n8n"
psql -U postgres -c "CREATE DATABASE n8n"

# 3. è¿è¡Œ migration
pnpm --filter @n8n/cli db:migrate

# 4. æ’å…¥åˆå§‹æ•°æ®
psql -U n8n -d n8n < init-seed-data.sql

# 5. é‡å¯æœåŠ¡
pm2 start n8n-backend
```

### Q2: TypeORM synchronize å’Œ migration å“ªä¸ªå¥½ï¼Ÿ

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåœºæ™¯ |
|------|------|------|---------|
| **synchronize: true** | è‡ªåŠ¨åŒæ­¥ï¼Œå¿«é€Ÿ | ä¸å®‰å…¨ï¼Œå¯èƒ½ä¸¢æ•°æ® | ä»…å¼€å‘ç¯å¢ƒ |
| **migration** | å®‰å…¨ï¼Œå¯æ§ï¼Œå¯å›æ»š | éœ€è¦æ‰‹åŠ¨ç¼–å†™ | ç”Ÿäº§ç¯å¢ƒã€å›¢é˜Ÿåä½œ |

**å»ºè®®ï¼š**
- å¼€å‘ç¯å¢ƒï¼šsynchronize: trueï¼ˆå¿«é€Ÿè¿­ä»£ï¼‰
- ç”Ÿäº§ç¯å¢ƒï¼šå¿…é¡»ä½¿ç”¨ migration

### Q3: å¦‚ä½•å¤„ç† Entity å®šä¹‰å’Œæ•°æ®åº“ä¸ä¸€è‡´ï¼Ÿ

```typescript
// æ–¹å¼1: å¼ºåˆ¶åŒæ­¥ï¼ˆå±é™©ï¼Œä»…å¼€å‘ç¯å¢ƒï¼‰
await dataSource.synchronize(true);

// æ–¹å¼2: ç”Ÿæˆ migrationï¼ˆå®‰å…¨ï¼‰
pnpm --filter @n8n/cli migration:generate MyChanges
pnpm --filter @n8n/cli db:migrate
```

---

## å…«ã€ä¸‹ä¸€æ­¥

### 8.1 å®Œæˆæ•°æ®åº“åˆå§‹åŒ–å

1. âœ… æ›´æ–° Entity å®šä¹‰ï¼ˆWorkflow, Credentials, Executionï¼‰
2. âœ… åˆ é™¤ SharedWorkflow, SharedCredentials Entity
3. âœ… æ›´æ–° Repository å±‚æŸ¥è¯¢é€»è¾‘
4. âœ… æ›´æ–° Service å±‚ä¸šåŠ¡é€»è¾‘
5. âœ… æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

### 8.2 æ¨èçš„å¼€å‘æµç¨‹

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin 20251102

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. åˆå§‹åŒ–æ•°æ®åº“
pnpm --filter @n8n/cli db:migrate

# 4. æ’å…¥åˆå§‹æ•°æ®
psql -U n8n -d n8n < init-seed-data.sql

# 5. å¯åŠ¨å¼€å‘ç¯å¢ƒ
pnpm dev

# 6. è¿è¡Œæµ‹è¯•
pnpm test
```

---

## ä¹ã€æ€»ç»“

### 9.1 å…³é”®è¦ç‚¹

1. âœ… **æ— éœ€æ•°æ®è¿ç§»** - é¡¹ç›®æœªä¸Šçº¿ï¼Œç›´æ¥æŒ‰æ–°æ¶æ„åˆ›å»º
2. âœ… **åˆ é™¤æ—§è¡¨** - ç›´æ¥åˆ é™¤ shared_workflow å’Œ shared_credentials
3. âœ… **ä½¿ç”¨ TypeORM Migration** - è§„èŒƒçš„æ•°æ®åº“å˜æ›´ç®¡ç†
4. âœ… **åˆå§‹åŒ–ç§å­æ•°æ®** - å¹³å°æœåŠ¡ã€æµ‹è¯•è´¦æˆ·

### 9.2 ä¸"è¿ç§»æ–¹æ¡ˆ"çš„åŒºåˆ«

| é¡¹ç›® | æ•°æ®è¿ç§»æ–¹æ¡ˆ | æ•°æ®åº“åˆå§‹åŒ–æ–¹æ¡ˆï¼ˆä½ ä»¬ï¼‰ |
|------|-------------|---------------------|
| **é€‚ç”¨åœºæ™¯** | å·²ä¸Šçº¿ç”Ÿäº§ç¯å¢ƒ | âœ… æœªä¸Šçº¿å…¨æ–°é¡¹ç›® |
| **æ•°æ®å¤‡ä»½** | âœ… å¿…é¡» | âŒ ä¸éœ€è¦ |
| **è¿ç§»è„šæœ¬** | âœ… å¤æ‚ | âŒ ä¸éœ€è¦ |
| **å›æ»šæ–¹æ¡ˆ** | âœ… å¿…é¡»å‡†å¤‡ | âŒ ä¸éœ€è¦ï¼ˆé‡ç½®å³å¯ï¼‰ |
| **å®æ–½æ—¶é—´** | 2-4å°æ—¶ | âœ… 10-20åˆ†é’Ÿ |
| **é£é™©ç­‰çº§** | ğŸŸ¡ ä¸­é£é™© | âœ… ğŸŸ¢ æ— é£é™© |

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2025-11-07
**é€‚ç”¨åœºæ™¯ï¼š** âœ… æœªä¸Šçº¿çš„å…¨æ–°é¡¹ç›®
**é¢„è®¡å·¥æ—¶ï¼š** 1-2å¤©
