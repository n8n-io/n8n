# n8n 二次开发版 - 快速概览

## 🎯 项目目的

移除 n8n 所有许可证限制和云服务依赖，解锁全部企业版功能，打造完全本地化的工作流自动化平台，仅供内部团队使用。

## 📊 核心差异对比

| 方面 | 原版 n8n | 二次开发版 |
|------|----------|-----------|
| **许可证验证** | 连接 license.n8n.io 验证 | ✅ 完全移除，无网络验证 |
| **企业功能** | 需要付费许可证 | ✅ 全部默认启用 |
| **版本通知** | 从云端获取更新提示 | ✅ 已移除 |
| **动态横幅** | 从 api.n8n.io 获取 | ✅ 已移除 |
| **功能限制** | 根据许可证类型限制 | ✅ 无任何限制 |
| **团队项目数** | 有配额限制 | ✅ 无限制 |
| **云服务依赖** | 多个云端 API | ✅ 完全本地化 |

## 🚀 已启用的企业功能

### 认证与安全
- ✅ LDAP 登录
- ✅ SAML SSO
- ✅ OIDC SSO
- ✅ 高级权限管理
- ✅ MFA 强制执行

### 协作与管理
- ✅ 工作流分享
- ✅ 无限团队项目
- ✅ 环境变量管理
- ✅ 外部密钥管理

### 开发工具
- ✅ Source Control (Git 集成)
- ✅ 工作流版本历史
- ✅ AI 助手
- ✅ 高级执行过滤

### 监控与分析
- ✅ Insights & Analytics
- ✅ 日志流
- ✅ 审计日志
- ✅ Provisioning
- ✅ **Telemetry 独立管理平台**（全新）
  - 实时事件监控仪表板
  - 活跃用户趋势分析
  - 热门事件 Top 排行
  - 高级搜索和筛选
  - 数据导出（CSV/JSON）

### API 功能
- ✅ 完整 Public API
- ✅ API 密钥管理
- ✅ API 密钥作用域

### 本地化与用户体验
- ✅ 中文界面完整支持
- ✅ 3,795+ 翻译键完整中文化
- ✅ 中文作为默认语言
- ✅ 语言切换功能（支持中文/英文）
- ✅ 日期时间中文本地化
- ✅ 持久化语言偏好设置

## 📈 改动规模

| 指标 | 数量 |
|------|------|
| 修改文件 | 250+ 个 |
| 删除代码 | 6,000+ 行 |
| 新增代码 | 12,000+ 行 |
| 删除核心文件 | 30+ 个 |
| 翻译条目 | 3,795+ 条 |
| 新增模块 | 1 个（Admin Panel）|

## 🛠️ 快速开始

```bash
# 安装依赖（依赖版本已通过 overrides 精确锁定）
pnpm install

# 开发模式 - 分别启动各服务
pnpm dev:be              # 启动后端 API (5678)
pnpm dev:fe:main         # 启动主应用前端 (8080)
pnpm dev:fe:admin        # 启动管理后台 (5679)

# 访问地址
# - 主应用：http://localhost:8080
# - 管理后台：http://localhost:5679/admin/
# - 后端 API：http://localhost:5678/rest

# 生产构建
pnpm build

# 启动服务
pnpm start
```

### 📌 开发架构说明

本项目采用**前后端分离架构**（参考 [Coze Studio](https://github.com/coze-dev/coze-studio)）：
- **主应用前端**：独立 Vite 开发服务器 (8080)，使用 Vite proxy 代理 API 请求
- **后端 API**：Express 服务器 (5678)，纯 API 服务
- **管理后台前端**：独立 Vite 开发服务器 (5679)，使用 Vite proxy 代理 API 请求

#### 开发架构
开发环境下各服务完全独立运行：
- **主应用** (8080) → Vite proxy → 后端 API (5678)
- **管理后台** (5679) → Vite proxy → 后端 API (5678)
- **后端** (5678) → 提供 REST API

这样的好处：
- ✅ 各服务职责清晰，完全解耦
- ✅ 启动时立即检测后端是否可用
- ✅ 避免 CORS 跨域问题
- ✅ 调试更简单，日志分开
- ✅ 与生产环境架构（前端 CDN + 后端 API）保持一致

### ⚠️ 依赖管理重要说明

本项目使用 `pnpm overrides` 精确锁定了所有关键依赖版本，以确保：
- ✅ 与原始 n8n 仓库版本完全一致
- ✅ 避免依赖自动升级导致的构建问题
- ✅ 类型定义与运行时库完全匹配

**请勿：**
- ❌ 使用 `pnpm update` 命令
- ❌ 删除或修改 `pnpm.overrides` 配置
- ❌ 随意重新生成 `pnpm-lock.yaml`

详见 **[构建修复说明](./BUILD-FIXES.md)**

## 📚 详细文档

- **[核心变更](./CHANGES.md)** - 详细的代码变更和删除内容
- **[企业功能](./FEATURES.md)** - 所有启用功能的详细说明
- **[技术细节](./TECHNICAL-DETAILS.md)** - 实现策略和代码示例
- **[构建修复](./BUILD-FIXES.md)** - 依赖管理和构建问题解决方案
- **[更新日志](./CHANGELOG.md)** - 完整的开发历史

## ⚠️ 重要提醒

1. **仅供内部使用** - 不得对外发布或商业使用
2. **安全责任** - 需自行实现必要的访问控制
3. **更新风险** - 与上游同步时注意不要恢复许可证检查
4. **法律合规** - 确保使用场景符合开源许可证要求

## 🔧 当前状态

- ✅ **构建状态**: 完全通过（0 错误）
- ✅ **类型检查**: 完全通过
- ✅ **代码检查**: 完全通过
- ✅ **提交钩子**: 全部通过
- ✅ **功能测试**: 待验证

---

**当前分支**: `20251102`
**最后更新**: 2025-11-05
**维护者**: 开发团队

## 📝 最近更新

### 2025-11-05 - 前后端分离架构完善
- ✅ 完成开发环境架构优化：三服务独立运行，职责清晰
- ✅ 统一 API 端点为 `/rest`（与原版 n8n 一致）
- ✅ 主应用和管理后台都使用 Vite proxy 代理 API 请求
- ✅ 修复 CSS 变量语法错误（design-system）
- ✅ 修复 Express 路由语法兼容性问题（path-to-regexp@8.x）
- ✅ 清理冗余配置和文档，统一访问地址说明
- ✅ 构建状态：42/42 包全部通过 ✨

### 2025-11-04 晚上 - 构建系统修复
- ✅ 对比原始 n8n 仓库 pnpm-lock.yaml，发现 8 个依赖版本不匹配
- ✅ 使用 pnpm overrides 精确锁定所有关键依赖版本
- ✅ 修复 @types/amqplib 版本不匹配导致的 RabbitMQ 类型错误
- ✅ 统一 admin-panel 和 editor-ui 的 chart.js/vue-chartjs 版本
- ✅ 添加 psl 包类型定义，配置 TypeScript types 选项
- ✅ 移除所有临时 workaround（@ts-expect-error）
- ✅ 构建成功：42/42 包全部通过 ✨

### 2025-11-04 傍晚 - Telemetry 独立管理平台
- ✅ 完成自托管 Telemetry 数据采集系统
- ✅ 实现数据库层（2 个实体 + 1 个迁移）
- ✅ 实现后端模块（Repository + Service + Controller）
- ✅ 恢复前端遥测功能（批量上报 + 持久化 + 重试）
- ✅ 集成配置系统和 API 类型
- ✅ 所有遥测数据存储本地数据库
- 🚧 管理界面待开发

### 2025-11-04 下午 - 跟踪系统清理
- 完全移除 CloudPlan Store（云订阅状态追踪）
- 完全移除 PostHog Store（外部分析服务）
- 提取独立 Feature Flags Store（220 行，无外部依赖）
- 迁移 17 个文件的 Feature Flags 调用

### 2025-11-04 - 中文本地化
- 完成全面中文界面翻译（3,795+ 翻译键）
- 实现语言切换功能（中文/英文）
- 设置中文为默认语言
- 添加语言偏好持久化
- 优化日期时间格式本地化
